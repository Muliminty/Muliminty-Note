# äº‹ä»¶æœºåˆ¶ï¼ˆEvent Mechanismï¼‰

> JavaScript äº‹ä»¶æœºåˆ¶æ˜¯å‰ç«¯äº¤äº’çš„æ ¸å¿ƒï¼ŒåŒ…æ‹¬äº‹ä»¶æ•è·ã€äº‹ä»¶å†’æ³¡ã€äº‹ä»¶å§”æ‰˜ç­‰é‡è¦æ¦‚å¿µã€‚
> 
> **å‚è€ƒè§„èŒƒ**ï¼š[DOM Events](https://dom.spec.whatwg.org/#events)

---

## ğŸ“š ç›®å½•

- [1. äº‹ä»¶æ¦‚è¿°](#1-äº‹ä»¶æ¦‚è¿°)
- [2. äº‹ä»¶æµ](#2-äº‹ä»¶æµ)
- [3. äº‹ä»¶å¯¹è±¡](#3-äº‹ä»¶å¯¹è±¡)
- [4. äº‹ä»¶å§”æ‰˜](#4-äº‹ä»¶å§”æ‰˜)
- [5. äº‹ä»¶ç±»å‹](#5-äº‹ä»¶ç±»å‹)
- [6. è‡ªå®šä¹‰äº‹ä»¶](#6-è‡ªå®šä¹‰äº‹ä»¶)
- [7. äº‹ä»¶æ€§èƒ½ä¼˜åŒ–](#7-äº‹ä»¶æ€§èƒ½ä¼˜åŒ–)

---

## 1. äº‹ä»¶æ¦‚è¿°

### 1.1 ä»€ä¹ˆæ˜¯äº‹ä»¶

**äº‹ä»¶**æ˜¯ç”¨æˆ·æˆ–æµè§ˆå™¨æ‰§è¡Œçš„æŸç§åŠ¨ä½œï¼Œå¦‚ç‚¹å‡»ã€æ»šåŠ¨ã€é”®ç›˜è¾“å…¥ç­‰ã€‚

```javascript
// äº‹ä»¶ä¸‰è¦ç´ 
// 1. äº‹ä»¶æºï¼šè§¦å‘äº‹ä»¶çš„å…ƒç´ 
// 2. äº‹ä»¶ç±»å‹ï¼šclickã€scrollã€keydown ç­‰
// 3. äº‹ä»¶å¤„ç†å‡½æ•°ï¼šäº‹ä»¶å‘ç”Ÿæ—¶è¦æ‰§è¡Œçš„å‡½æ•°
```

### 1.2 äº‹ä»¶ç»‘å®šæ–¹å¼

```javascript
// æ–¹å¼ 1ï¼šHTML å±æ€§ï¼ˆä¸æ¨èï¼‰
// <button onclick="handleClick()">Click</button>

// æ–¹å¼ 2ï¼šDOM å±æ€§ï¼ˆä¸æ¨èï¼Œåªèƒ½ç»‘å®šä¸€ä¸ªï¼‰
element.onclick = function() {
  console.log('Clicked');
};

// æ–¹å¼ 3ï¼šaddEventListenerï¼ˆæ¨èï¼‰
element.addEventListener('click', function(event) {
  console.log('Clicked');
});
```

---

## 2. äº‹ä»¶æµ

### 2.1 äº‹ä»¶æµçš„ä¸‰ä¸ªé˜¶æ®µ

äº‹ä»¶æµæè¿°äº†äº‹ä»¶ä»è§¦å‘åˆ°å¤„ç†çš„å®Œæ•´è¿‡ç¨‹ï¼ŒåŒ…å«ä¸‰ä¸ªé˜¶æ®µï¼š

1. **æ•è·é˜¶æ®µï¼ˆCapture Phaseï¼‰**ï¼šä» window åˆ°ç›®æ ‡å…ƒç´ 
2. **ç›®æ ‡é˜¶æ®µï¼ˆTarget Phaseï¼‰**ï¼šåœ¨ç›®æ ‡å…ƒç´ ä¸Š
3. **å†’æ³¡é˜¶æ®µï¼ˆBubble Phaseï¼‰**ï¼šä»ç›®æ ‡å…ƒç´ åˆ° window

```
window â†’ document â†’ html â†’ body â†’ div â†’ button
  â†“                                    â†‘
  æ•è·é˜¶æ®µ                          å†’æ³¡é˜¶æ®µ
```

### 2.2 äº‹ä»¶æ•è·

```javascript
// åœ¨æ•è·é˜¶æ®µè§¦å‘ï¼ˆç¬¬ä¸‰ä¸ªå‚æ•°ä¸º trueï¼‰
element.addEventListener('click', function(event) {
  console.log('Capture phase');
}, true);

// äº‹ä»¶æ•è·é¡ºåºï¼šwindow â†’ document â†’ html â†’ body â†’ div â†’ button
```

### 2.3 äº‹ä»¶å†’æ³¡

```javascript
// åœ¨å†’æ³¡é˜¶æ®µè§¦å‘ï¼ˆé»˜è®¤ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°ä¸º falseï¼‰
element.addEventListener('click', function(event) {
  console.log('Bubble phase');
});

// äº‹ä»¶å†’æ³¡é¡ºåºï¼šbutton â†’ div â†’ body â†’ html â†’ document â†’ window
```

### 2.4 é˜»æ­¢äº‹ä»¶ä¼ æ’­

```javascript
element.addEventListener('click', function(event) {
  // é˜»æ­¢äº‹ä»¶ç»§ç»­ä¼ æ’­ï¼ˆæ•è·æˆ–å†’æ³¡ï¼‰
  event.stopPropagation();
  
  // é˜»æ­¢ç«‹å³ä¼ æ’­ï¼ˆç«‹å³åœæ­¢ï¼ŒåŒ…æ‹¬åŒä¸€å…ƒç´ çš„å…¶ä»–ç›‘å¬å™¨ï¼‰
  event.stopImmediatePropagation();
});
```

### 2.5 äº‹ä»¶ç›®æ ‡

```javascript
element.addEventListener('click', function(event) {
  // event.target - å®é™…è§¦å‘äº‹ä»¶çš„å…ƒç´ 
  console.log('Target:', event.target);
  
  // event.currentTarget - å½“å‰å¤„ç†äº‹ä»¶çš„å…ƒç´ ï¼ˆthis æŒ‡å‘ï¼‰
  console.log('Current target:', event.currentTarget);
  
  // event.target === event.currentTarget æ—¶ï¼Œäº‹ä»¶åœ¨ç›®æ ‡å…ƒç´ ä¸Šè§¦å‘
});
```

---

## 3. äº‹ä»¶å¯¹è±¡

### 3.1 Event å¯¹è±¡

æ‰€æœ‰äº‹ä»¶å¯¹è±¡éƒ½ç»§æ‰¿è‡ª `Event` å¯¹è±¡ã€‚

```javascript
element.addEventListener('click', function(event) {
  // äº‹ä»¶ç±»å‹
  event.type;  // "click"
  
  // äº‹ä»¶ç›®æ ‡
  event.target;        // è§¦å‘äº‹ä»¶çš„å…ƒç´ 
  event.currentTarget; // å½“å‰å¤„ç†äº‹ä»¶çš„å…ƒç´ 
  
  // äº‹ä»¶é˜¶æ®µ
  event.eventPhase;    // 1=æ•è·, 2=ç›®æ ‡, 3=å†’æ³¡
  
  // æ—¶é—´æˆ³
  event.timeStamp;     // äº‹ä»¶å‘ç”Ÿçš„æ—¶é—´æˆ³
  
  // æ˜¯å¦å¯å†’æ³¡
  event.bubbles;       // true/false
  
  // æ˜¯å¦å¯å–æ¶ˆ
  event.cancelable;    // true/false
});
```

### 3.2 é˜»æ­¢é»˜è®¤è¡Œä¸º

```javascript
// é˜»æ­¢é»˜è®¤è¡Œä¸ºï¼ˆå¦‚é“¾æ¥è·³è½¬ã€è¡¨å•æäº¤ï¼‰
element.addEventListener('click', function(event) {
  event.preventDefault();
  
  // æ£€æŸ¥æ˜¯å¦å·²é˜»æ­¢
  event.defaultPrevented;  // true
});

// ç¤ºä¾‹ï¼šé˜»æ­¢é“¾æ¥è·³è½¬
link.addEventListener('click', function(event) {
  event.preventDefault();
  console.log('Link click prevented');
});
```

### 3.3 é¼ æ ‡äº‹ä»¶å¯¹è±¡

```javascript
element.addEventListener('click', function(event) {
  // é¼ æ ‡ä½ç½®ï¼ˆç›¸å¯¹äºè§†å£ï¼‰
  event.clientX;  // X åæ ‡
  event.clientY;  // Y åæ ‡
  
  // é¼ æ ‡ä½ç½®ï¼ˆç›¸å¯¹äºé¡µé¢ï¼‰
  event.pageX;    // X åæ ‡
  event.pageY;    // Y åæ ‡
  
  // é¼ æ ‡ä½ç½®ï¼ˆç›¸å¯¹äºå±å¹•ï¼‰
  event.screenX;  // X åæ ‡
  event.screenY;  // Y åæ ‡
  
  // é¼ æ ‡æŒ‰é’®
  event.button;   // 0=å·¦é”®, 1=ä¸­é”®, 2=å³é”®
  event.buttons;  // æŒ‰ä¸‹çš„æŒ‰é’®ç»„åˆï¼ˆä½æ©ç ï¼‰
  
  // ä¿®é¥°é”®
  event.ctrlKey;   // Ctrl é”®
  event.shiftKey;  // Shift é”®
  event.altKey;    // Alt é”®
  event.metaKey;   // Meta é”®ï¼ˆMac çš„ Cmdï¼‰
});
```

### 3.4 é”®ç›˜äº‹ä»¶å¯¹è±¡

```javascript
element.addEventListener('keydown', function(event) {
  // æŒ‰é”®ä»£ç 
  event.key;        // "a", "Enter", "ArrowUp" ç­‰ï¼ˆæ¨èï¼‰
  event.code;       // "KeyA", "Enter", "ArrowUp" ç­‰
  event.keyCode;    // æ•°å­—ä»£ç ï¼ˆå·²åºŸå¼ƒï¼‰
  
  // ä¿®é¥°é”®
  event.ctrlKey;
  event.shiftKey;
  event.altKey;
  event.metaKey;
  
  // æ˜¯å¦é‡å¤æŒ‰é”®
  event.repeat;     // true/false
});
```

---

## 4. äº‹ä»¶å§”æ‰˜

### 4.1 ä»€ä¹ˆæ˜¯äº‹ä»¶å§”æ‰˜

**äº‹ä»¶å§”æ‰˜**ï¼ˆEvent Delegationï¼‰æ˜¯å°†äº‹ä»¶ç›‘å¬å™¨ç»‘å®šåˆ°çˆ¶å…ƒç´ ï¼Œåˆ©ç”¨äº‹ä»¶å†’æ³¡æœºåˆ¶å¤„ç†å­å…ƒç´ çš„äº‹ä»¶ã€‚

### 4.2 äº‹ä»¶å§”æ‰˜çš„ä¼˜åŠ¿

```javascript
// âŒ ä¸å¥½ï¼šä¸ºæ¯ä¸ªå­å…ƒç´ ç»‘å®šäº‹ä»¶
const items = document.querySelectorAll('.item');
items.forEach(item => {
  item.addEventListener('click', handleClick);
});

// âœ… å¥½ï¼šäº‹ä»¶å§”æ‰˜
const list = document.querySelector('.list');
list.addEventListener('click', function(event) {
  // event.target æ˜¯å®é™…ç‚¹å‡»çš„å…ƒç´ 
  if (event.target.matches('.item')) {
    handleClick(event);
  }
});
```

**ä¼˜åŠ¿**ï¼š
- å‡å°‘äº‹ä»¶ç›‘å¬å™¨æ•°é‡ï¼ˆæ€§èƒ½æ›´å¥½ï¼‰
- åŠ¨æ€æ·»åŠ çš„å…ƒç´ è‡ªåŠ¨æ”¯æŒäº‹ä»¶
- å‡å°‘å†…å­˜å ç”¨

### 4.3 äº‹ä»¶å§”æ‰˜å®ç°

```javascript
// æ–¹å¼ 1ï¼šä½¿ç”¨ matches
parent.addEventListener('click', function(event) {
  if (event.target.matches('.item')) {
    console.log('Item clicked');
  }
});

// æ–¹å¼ 2ï¼šä½¿ç”¨ closestï¼ˆå‘ä¸ŠæŸ¥æ‰¾ï¼‰
parent.addEventListener('click', function(event) {
  const item = event.target.closest('.item');
  if (item) {
    console.log('Item clicked:', item);
  }
});

// æ–¹å¼ 3ï¼šæ£€æŸ¥ç±»å
parent.addEventListener('click', function(event) {
  if (event.target.classList.contains('item')) {
    console.log('Item clicked');
  }
});
```

---

## 5. äº‹ä»¶ç±»å‹

### 5.1 é¼ æ ‡äº‹ä»¶

```javascript
// click - å•å‡»
element.addEventListener('click', handler);

// dblclick - åŒå‡»
element.addEventListener('dblclick', handler);

// mousedown - é¼ æ ‡æŒ‰ä¸‹
element.addEventListener('mousedown', handler);

// mouseup - é¼ æ ‡é‡Šæ”¾
element.addEventListener('mouseup', handler);

// mousemove - é¼ æ ‡ç§»åŠ¨
element.addEventListener('mousemove', handler);

// mouseenter - é¼ æ ‡è¿›å…¥ï¼ˆä¸å†’æ³¡ï¼‰
element.addEventListener('mouseenter', handler);

// mouseleave - é¼ æ ‡ç¦»å¼€ï¼ˆä¸å†’æ³¡ï¼‰
element.addEventListener('mouseleave', handler);

// mouseover - é¼ æ ‡æ‚¬åœï¼ˆå†’æ³¡ï¼‰
element.addEventListener('mouseover', handler);

// mouseout - é¼ æ ‡ç§»å‡ºï¼ˆå†’æ³¡ï¼‰
element.addEventListener('mouseout', handler);

// contextmenu - å³é”®èœå•
element.addEventListener('contextmenu', handler);
```

### 5.2 é”®ç›˜äº‹ä»¶

```javascript
// keydown - æŒ‰é”®æŒ‰ä¸‹
element.addEventListener('keydown', handler);

// keyup - æŒ‰é”®é‡Šæ”¾
element.addEventListener('keyup', handler);

// keypress - æŒ‰é”®æŒ‰ä¸‹ï¼ˆå·²åºŸå¼ƒï¼Œä¸æ¨èï¼‰
element.addEventListener('keypress', handler);
```

### 5.3 è¡¨å•äº‹ä»¶

```javascript
// submit - è¡¨å•æäº¤
form.addEventListener('submit', function(event) {
  event.preventDefault();  // é˜»æ­¢é»˜è®¤æäº¤
});

// change - å€¼æ”¹å˜ï¼ˆå¤±å»ç„¦ç‚¹æ—¶ï¼‰
input.addEventListener('change', handler);

// input - å€¼æ”¹å˜ï¼ˆå®æ—¶ï¼‰
input.addEventListener('input', handler);

// focus - è·å¾—ç„¦ç‚¹
input.addEventListener('focus', handler);

// blur - å¤±å»ç„¦ç‚¹
input.addEventListener('blur', handler);
```

### 5.4 æ»šåŠ¨äº‹ä»¶

```javascript
// scroll - æ»šåŠ¨
window.addEventListener('scroll', function(event) {
  console.log('Scrolled:', window.scrollY);
});

// âš ï¸ æ€§èƒ½ä¼˜åŒ–ï¼šä½¿ç”¨èŠ‚æµ
let ticking = false;
window.addEventListener('scroll', function() {
  if (!ticking) {
    window.requestAnimationFrame(function() {
      // æ»šåŠ¨å¤„ç†é€»è¾‘
      ticking = false;
    });
    ticking = true;
  }
});
```

### 5.5 çª—å£äº‹ä»¶

```javascript
// resize - çª—å£å¤§å°æ”¹å˜
window.addEventListener('resize', handler);

// load - é¡µé¢åŠ è½½å®Œæˆ
window.addEventListener('load', handler);

// DOMContentLoaded - DOM åŠ è½½å®Œæˆ
document.addEventListener('DOMContentLoaded', handler);

// beforeunload - é¡µé¢å¸è½½å‰
window.addEventListener('beforeunload', handler);
```

---

## 6. è‡ªå®šä¹‰äº‹ä»¶

### 6.1 åˆ›å»ºè‡ªå®šä¹‰äº‹ä»¶

```javascript
// æ–¹å¼ 1ï¼šä½¿ç”¨ Event æ„é€ å‡½æ•°
const event = new Event('customEvent', {
  bubbles: true,
  cancelable: true
});

// æ–¹å¼ 2ï¼šä½¿ç”¨ CustomEvent æ„é€ å‡½æ•°ï¼ˆå¯ä¼ é€’æ•°æ®ï¼‰
const customEvent = new CustomEvent('customEvent', {
  detail: { message: 'Hello' },
  bubbles: true,
  cancelable: true
});

// è§¦å‘äº‹ä»¶
element.dispatchEvent(customEvent);
```

### 6.2 ç›‘å¬è‡ªå®šä¹‰äº‹ä»¶

```javascript
element.addEventListener('customEvent', function(event) {
  console.log('Custom event:', event.detail);
});
```

### 6.3 äº‹ä»¶æ€»çº¿æ¨¡å¼

```javascript
// ç®€å•çš„äº‹ä»¶æ€»çº¿å®ç°
class EventBus {
  constructor() {
    this.events = {};
  }
  
  on(event, handler) {
    if (!this.events[event]) {
      this.events[event] = [];
    }
    this.events[event].push(handler);
  }
  
  off(event, handler) {
    if (this.events[event]) {
      this.events[event] = this.events[event].filter(h => h !== handler);
    }
  }
  
  emit(event, data) {
    if (this.events[event]) {
      this.events[event].forEach(handler => handler(data));
    }
  }
}

// ä½¿ç”¨
const bus = new EventBus();
bus.on('userLogin', (user) => console.log('User logged in:', user));
bus.emit('userLogin', { name: 'John' });
```

---

## 7. äº‹ä»¶æ€§èƒ½ä¼˜åŒ–

### 7.1 äº‹ä»¶èŠ‚æµï¼ˆThrottleï¼‰

```javascript
// èŠ‚æµï¼šé™åˆ¶å‡½æ•°æ‰§è¡Œé¢‘ç‡
function throttle(func, delay) {
  let lastTime = 0;
  return function(...args) {
    const now = Date.now();
    if (now - lastTime >= delay) {
      func.apply(this, args);
      lastTime = now;
    }
  };
}

// ä½¿ç”¨
window.addEventListener('scroll', throttle(function() {
  console.log('Scrolled');
}, 100));
```

### 7.2 äº‹ä»¶é˜²æŠ–ï¼ˆDebounceï¼‰

```javascript
// é˜²æŠ–ï¼šå»¶è¿Ÿæ‰§è¡Œï¼Œåœ¨è¿ç»­è§¦å‘æ—¶åªæ‰§è¡Œæœ€åä¸€æ¬¡
function debounce(func, delay) {
  let timeoutId;
  return function(...args) {
    clearTimeout(timeoutId);
    timeoutId = setTimeout(() => {
      func.apply(this, args);
    }, delay);
  };
}

// ä½¿ç”¨
input.addEventListener('input', debounce(function() {
  console.log('Input changed');
}, 300));
```

### 7.3 è¢«åŠ¨äº‹ä»¶ç›‘å¬å™¨

```javascript
// passive: true - æå‡æ»šåŠ¨æ€§èƒ½
// å‘Šè¯‰æµè§ˆå™¨äº‹ä»¶å¤„ç†å‡½æ•°ä¸ä¼šè°ƒç”¨ preventDefault()
element.addEventListener('touchstart', handler, {
  passive: true
});

// æ£€æŸ¥æ˜¯å¦æ”¯æŒ passive
let supportsPassive = false;
try {
  const opts = Object.defineProperty({}, 'passive', {
    get() {
      supportsPassive = true;
    }
  });
  window.addEventListener('test', null, opts);
} catch (e) {}
```

### 7.4 ä¸€æ¬¡æ€§äº‹ä»¶ç›‘å¬å™¨

```javascript
// once: true - åªæ‰§è¡Œä¸€æ¬¡
element.addEventListener('click', handler, {
  once: true
});

// æ‰‹åŠ¨ç§»é™¤
element.addEventListener('click', function handler(event) {
  console.log('Clicked');
  element.removeEventListener('click', handler);
});
```

---

## ğŸ“– å‚è€ƒèµ„æº

- [MDN - Event](https://developer.mozilla.org/zh-CN/docs/Web/API/Event)
- [MDN - EventTarget](https://developer.mozilla.org/zh-CN/docs/Web/API/EventTarget)
- [JavaScript.info - äº‹ä»¶](https://zh.javascript.info/events)

---

#javascript #äº‹ä»¶ #äº‹ä»¶æœºåˆ¶ #å‰ç«¯åŸºç¡€
