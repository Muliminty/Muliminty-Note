# è‡ªå®šä¹‰äº‹ä»¶ï¼ˆCustomEventï¼‰

> CustomEvent API å…è®¸å¼€å‘è€…åˆ›å»ºå’Œè§¦å‘è‡ªå®šä¹‰äº‹ä»¶ï¼Œå®ç°ç»„ä»¶é—´è§£è€¦é€šä¿¡ã€‚
> 
> **å‚è€ƒè§„èŒƒ**ï¼š[DOM Living Standard - CustomEvent](https://dom.spec.whatwg.org/#interface-customevent)

---

## ğŸ“š ç›®å½•

- [1. CustomEvent æ¦‚è¿°](#1-customevent-æ¦‚è¿°)
- [2. åˆ›å»ºè‡ªå®šä¹‰äº‹ä»¶](#2-åˆ›å»ºè‡ªå®šä¹‰äº‹ä»¶)
- [3. è§¦å‘è‡ªå®šä¹‰äº‹ä»¶](#3-è§¦å‘è‡ªå®šä¹‰äº‹ä»¶)
- [4. ç›‘å¬è‡ªå®šä¹‰äº‹ä»¶](#4-ç›‘å¬è‡ªå®šä¹‰äº‹ä»¶)
- [5. äº‹ä»¶æ•°æ®ä¼ é€’](#5-äº‹ä»¶æ•°æ®ä¼ é€’)
- [6. å®é™…åº”ç”¨åœºæ™¯](#6-å®é™…åº”ç”¨åœºæ™¯)
- [7. æœ€ä½³å®è·µ](#7-æœ€ä½³å®è·µ)

---

## 1. CustomEvent æ¦‚è¿°

### 1.1 ä»€ä¹ˆæ˜¯è‡ªå®šä¹‰äº‹ä»¶

**CustomEvent** æ˜¯æµè§ˆå™¨æä¾›çš„ç”¨äºåˆ›å»ºè‡ªå®šä¹‰äº‹ä»¶çš„æ¥å£ï¼Œå…è®¸å¼€å‘è€…å®šä¹‰è‡ªå·±çš„äº‹ä»¶ç±»å‹ï¼Œå®ç°ç»„ä»¶é—´è§£è€¦é€šä¿¡ã€‚

**ç‰¹ç‚¹**ï¼š
- è§£è€¦é€šä¿¡ï¼šç»„ä»¶é—´æ— éœ€ç›´æ¥å¼•ç”¨ï¼Œé€šè¿‡äº‹ä»¶é€šä¿¡
- çµæ´»æ‰©å±•ï¼šå¯ä»¥ä¼ é€’ä»»æ„æ•°æ®
- æ ‡å‡† APIï¼šåŸºäº DOM äº‹ä»¶ç³»ç»Ÿï¼Œå…¼å®¹æ€§å¥½

### 1.2 ä¸åŸç”Ÿäº‹ä»¶çš„åŒºåˆ«

| ç‰¹æ€§ | åŸç”Ÿäº‹ä»¶ | è‡ªå®šä¹‰äº‹ä»¶ |
|------|---------|-----------|
| è§¦å‘æ–¹å¼ | æµè§ˆå™¨è‡ªåŠ¨è§¦å‘ | å¼€å‘è€…æ‰‹åŠ¨è§¦å‘ |
| äº‹ä»¶ç±»å‹ | é¢„å®šä¹‰ï¼ˆclickã€load ç­‰ï¼‰ | è‡ªå®šä¹‰å‘½å |
| æ•°æ®ä¼ é€’ | é€šè¿‡ event å¯¹è±¡ | é€šè¿‡ detail å±æ€§ |
| ä½¿ç”¨åœºæ™¯ | ç”¨æˆ·äº¤äº’ã€é¡µé¢ç”Ÿå‘½å‘¨æœŸ | ç»„ä»¶é€šä¿¡ã€ä¸šåŠ¡é€»è¾‘ |

---

## 2. åˆ›å»ºè‡ªå®šä¹‰äº‹ä»¶

### 2.1 åŸºæœ¬è¯­æ³•

```javascript
// åˆ›å»ºè‡ªå®šä¹‰äº‹ä»¶
const event = new CustomEvent('eventName', {
  detail: {
    // è‡ªå®šä¹‰æ•°æ®
  },
  bubbles: true,    // æ˜¯å¦å†’æ³¡
  cancelable: true  // æ˜¯å¦å¯å–æ¶ˆ
});
```

### 2.2 æ„é€ å‡½æ•°å‚æ•°

**CustomEvent(type, options)**

- **type**ï¼ˆå¿…éœ€ï¼‰ï¼šäº‹ä»¶ç±»å‹åç§°ï¼ˆå­—ç¬¦ä¸²ï¼‰
- **options**ï¼ˆå¯é€‰ï¼‰ï¼šäº‹ä»¶é…ç½®å¯¹è±¡
  - `detail`ï¼šä¼ é€’ç»™äº‹ä»¶ç›‘å¬å™¨çš„æ•°æ®
  - `bubbles`ï¼šæ˜¯å¦å†’æ³¡ï¼ˆé»˜è®¤ `false`ï¼‰
  - `cancelable`ï¼šæ˜¯å¦å¯å–æ¶ˆï¼ˆé»˜è®¤ `false`ï¼‰

### 2.3 åˆ›å»ºç¤ºä¾‹

```javascript
// åˆ›å»ºç®€å•è‡ªå®šä¹‰äº‹ä»¶
const simpleEvent = new CustomEvent('myEvent');

// åˆ›å»ºå¸¦æ•°æ®çš„è‡ªå®šä¹‰äº‹ä»¶
const dataEvent = new CustomEvent('userAction', {
  detail: {
    action: 'click',
    timestamp: Date.now()
  }
});

// åˆ›å»ºå¯å†’æ³¡çš„è‡ªå®šä¹‰äº‹ä»¶
const bubbleEvent = new CustomEvent('customClick', {
  detail: { message: 'Hello' },
  bubbles: true,
  cancelable: true
});
```

---

## 3. è§¦å‘è‡ªå®šä¹‰äº‹ä»¶

### 3.1 åœ¨ window ä¸Šè§¦å‘

```javascript
// åˆ›å»ºè‡ªå®šä¹‰äº‹ä»¶
const event = new CustomEvent('miniServiceAgreed', {
  detail: {
    userId: '123',
    timestamp: Date.now()
  }
});

// åœ¨ window ä¸Šè§¦å‘
window.dispatchEvent(event);
```

### 3.2 åœ¨ DOM å…ƒç´ ä¸Šè§¦å‘

```javascript
// åœ¨ç‰¹å®šå…ƒç´ ä¸Šè§¦å‘
const button = document.querySelector('#myButton');
const event = new CustomEvent('buttonClicked', {
  detail: { buttonId: 'myButton' }
});

button.dispatchEvent(event);
```

### 3.3 åœ¨ document ä¸Šè§¦å‘

```javascript
// åœ¨ document ä¸Šè§¦å‘
const event = new CustomEvent('pageReady', {
  detail: { page: 'home' }
});

document.dispatchEvent(event);
```

---

## 4. ç›‘å¬è‡ªå®šä¹‰äº‹ä»¶

### 4.1 ä½¿ç”¨ addEventListener

```javascript
// ç›‘å¬ window ä¸Šçš„è‡ªå®šä¹‰äº‹ä»¶
window.addEventListener('miniServiceAgreed', (event) => {
  console.log('ç”¨æˆ·å·²åŒæ„æœåŠ¡åè®®');
  console.log('äº‹ä»¶æ•°æ®:', event.detail);
});

// ç›‘å¬ DOM å…ƒç´ ä¸Šçš„è‡ªå®šä¹‰äº‹ä»¶
const button = document.querySelector('#myButton');
button.addEventListener('buttonClicked', (event) => {
  console.log('æŒ‰é’®è¢«ç‚¹å‡»:', event.detail);
});
```

### 4.2 è·å–äº‹ä»¶æ•°æ®

```javascript
window.addEventListener('miniServiceAgreed', (event) => {
  // é€šè¿‡ detail å±æ€§è·å–æ•°æ®
  const { userId, timestamp } = event.detail;
  
  console.log('ç”¨æˆ·ID:', userId);
  console.log('æ—¶é—´æˆ³:', timestamp);
});
```

### 4.3 äº‹ä»¶å¯¹è±¡å±æ€§

```javascript
window.addEventListener('customEvent', (event) => {
  // äº‹ä»¶ç±»å‹
  console.log(event.type);        // 'customEvent'
  
  // è‡ªå®šä¹‰æ•°æ®
  console.log(event.detail);      // ä¼ é€’çš„æ•°æ®å¯¹è±¡
  
  // äº‹ä»¶ç›®æ ‡
  console.log(event.target);      // è§¦å‘äº‹ä»¶çš„å…ƒç´ 
  
  // å½“å‰ç›®æ ‡
  console.log(event.currentTarget); // ç»‘å®šç›‘å¬å™¨çš„å…ƒç´ 
  
  // æ˜¯å¦å†’æ³¡
  console.log(event.bubbles);     // true/false
  
  // æ˜¯å¦å¯å–æ¶ˆ
  console.log(event.cancelable);  // true/false
});
```

---

## 5. äº‹ä»¶æ•°æ®ä¼ é€’

### 5.1 ä¼ é€’ç®€å•æ•°æ®

```javascript
// è§¦å‘äº‹ä»¶æ—¶ä¼ é€’æ•°æ®
const event = new CustomEvent('dataEvent', {
  detail: {
    message: 'Hello World',
    count: 42
  }
});

window.dispatchEvent(event);

// æ¥æ”¶æ•°æ®
window.addEventListener('dataEvent', (event) => {
  console.log(event.detail.message); // 'Hello World'
  console.log(event.detail.count);   // 42
});
```

### 5.2 ä¼ é€’å¤æ‚å¯¹è±¡

```javascript
// ä¼ é€’å¤æ‚å¯¹è±¡
const event = new CustomEvent('userEvent', {
  detail: {
    user: {
      id: '123',
      name: 'John',
      email: 'john@example.com'
    },
    action: 'login',
    metadata: {
      ip: '192.168.1.1',
      userAgent: navigator.userAgent
    }
  }
});

window.dispatchEvent(event);

// æ¥æ”¶å¤æ‚å¯¹è±¡
window.addEventListener('userEvent', (event) => {
  const { user, action, metadata } = event.detail;
  console.log('ç”¨æˆ·:', user.name);
  console.log('æ“ä½œ:', action);
  console.log('å…ƒæ•°æ®:', metadata);
});
```

### 5.3 ä¼ é€’å‡½æ•°ï¼ˆä¸æ¨èï¼‰

```javascript
// æ³¨æ„ï¼šdetail ä¸­ä¼ é€’å‡½æ•°ä¼šä¸¢å¤±ä¸Šä¸‹æ–‡
const event = new CustomEvent('callbackEvent', {
  detail: {
    callback: function() {
      console.log('å›è°ƒæ‰§è¡Œ');
    }
  }
});

window.dispatchEvent(event);

// æ¥æ”¶å‡½æ•°
window.addEventListener('callbackEvent', (event) => {
  // å¯ä»¥è°ƒç”¨ï¼Œä½†éœ€è¦æ³¨æ„ this ç»‘å®š
  event.detail.callback();
});
```

---

## 6. å®é™…åº”ç”¨åœºæ™¯

### 6.1 ç»„ä»¶é—´é€šä¿¡

```javascript
// ç»„ä»¶ Aï¼šè§¦å‘äº‹ä»¶
class ComponentA {
  handleAgree() {
    const event = new CustomEvent('serviceAgreed', {
      detail: {
        userId: this.userId,
        timestamp: Date.now()
      }
    });
    window.dispatchEvent(event);
  }
}

// ç»„ä»¶ Bï¼šç›‘å¬äº‹ä»¶
class ComponentB {
  constructor() {
    window.addEventListener('serviceAgreed', this.onServiceAgreed.bind(this));
  }
  
  onServiceAgreed(event) {
    const { userId, timestamp } = event.detail;
    console.log('ç”¨æˆ·åŒæ„æœåŠ¡åè®®:', userId);
    // æ‰§è¡Œç›¸åº”é€»è¾‘
  }
}
```

### 6.2 çŠ¶æ€åŒæ­¥

```javascript
// çŠ¶æ€ç®¡ç†ï¼šè§¦å‘çŠ¶æ€å˜æ›´äº‹ä»¶
function updateUserStatus(status) {
  const event = new CustomEvent('userStatusChanged', {
    detail: {
      status: status,
      previousStatus: currentStatus,
      timestamp: Date.now()
    }
  });
  window.dispatchEvent(event);
}

// å¤šä¸ªç»„ä»¶ç›‘å¬çŠ¶æ€å˜æ›´
window.addEventListener('userStatusChanged', (event) => {
  const { status } = event.detail;
  updateUI(status);
  updateAnalytics(status);
  updateCache(status);
});
```

### 6.3 è·¨æ¡†æ¶é€šä¿¡

```javascript
// React ç»„ä»¶è§¦å‘äº‹ä»¶
function ReactComponent() {
  const handleClick = () => {
    const event = new CustomEvent('reactAction', {
      detail: { action: 'buttonClick' }
    });
    window.dispatchEvent(event);
  };
  
  return <button onClick={handleClick}>Click</button>;
}

// Vue ç»„ä»¶ç›‘å¬äº‹ä»¶
export default {
  mounted() {
    window.addEventListener('reactAction', this.handleReactAction);
  },
  methods: {
    handleReactAction(event) {
      console.log('React è§¦å‘çš„æ“ä½œ:', event.detail.action);
    }
  }
}
```

### 6.4 å¾®å‰ç«¯é€šä¿¡

```javascript
// ä¸»åº”ç”¨ï¼šè§¦å‘å…¨å±€äº‹ä»¶
function notifyMicroApp(data) {
  const event = new CustomEvent('microAppEvent', {
    detail: data,
    bubbles: true
  });
  window.dispatchEvent(event);
}

// å¾®åº”ç”¨ï¼šç›‘å¬å…¨å±€äº‹ä»¶
window.addEventListener('microAppEvent', (event) => {
  const data = event.detail;
  // å¤„ç†æ¥è‡ªä¸»åº”ç”¨çš„æ•°æ®
  handleMicroAppData(data);
});
```

---

## 7. æœ€ä½³å®è·µ

### 7.1 äº‹ä»¶å‘½åè§„èŒƒ

```javascript
// âœ… å¥½çš„å‘½åï¼šæ¸…æ™°ã€æœ‰æ„ä¹‰çš„åç§°
new CustomEvent('userLoginSuccess');
new CustomEvent('cartItemAdded');
new CustomEvent('paymentCompleted');

// âŒ ä¸å¥½çš„å‘½åï¼šæ¨¡ç³Šã€æ— æ„ä¹‰
new CustomEvent('event1');
new CustomEvent('action');
new CustomEvent('update');
```

### 7.2 ä½¿ç”¨å‘½åç©ºé—´

```javascript
// ä½¿ç”¨å‘½åç©ºé—´é¿å…å†²çª
new CustomEvent('app:user:login');
new CustomEvent('app:cart:add');
new CustomEvent('app:payment:complete');

// ç›‘å¬æ—¶ä½¿ç”¨å‘½åç©ºé—´
window.addEventListener('app:user:login', handler);
```

### 7.3 äº‹ä»¶æ¸…ç†

```javascript
// ç»„ä»¶é”€æ¯æ—¶ç§»é™¤äº‹ä»¶ç›‘å¬
class MyComponent {
  constructor() {
    this.handleEvent = this.handleEvent.bind(this);
    window.addEventListener('customEvent', this.handleEvent);
  }
  
  handleEvent(event) {
    // å¤„ç†äº‹ä»¶
  }
  
  destroy() {
    // æ¸…ç†äº‹ä»¶ç›‘å¬
    window.removeEventListener('customEvent', this.handleEvent);
  }
}
```

### 7.4 é”™è¯¯å¤„ç†

```javascript
window.addEventListener('customEvent', (event) => {
  try {
    // å¤„ç†äº‹ä»¶
    processEvent(event.detail);
  } catch (error) {
    console.error('å¤„ç†è‡ªå®šä¹‰äº‹ä»¶æ—¶å‡ºé”™:', error);
    // é”™è¯¯ä¸ŠæŠ¥
    reportError(error);
  }
});
```

### 7.5 ç±»å‹æ£€æŸ¥

```javascript
// è§¦å‘äº‹ä»¶å‰éªŒè¯æ•°æ®
function triggerEvent(eventName, data) {
  if (!eventName || typeof eventName !== 'string') {
    throw new Error('äº‹ä»¶åç§°å¿…é¡»æ˜¯å­—ç¬¦ä¸²');
  }
  
  const event = new CustomEvent(eventName, {
    detail: data,
    bubbles: true,
    cancelable: true
  });
  
  window.dispatchEvent(event);
}

// ç›‘å¬äº‹ä»¶æ—¶éªŒè¯æ•°æ®
window.addEventListener('customEvent', (event) => {
  if (!event.detail || typeof event.detail !== 'object') {
    console.warn('äº‹ä»¶æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
    return;
  }
  
  // å¤„ç†äº‹ä»¶
});
```

### 7.6 æ€§èƒ½ä¼˜åŒ–

```javascript
// ä½¿ç”¨é˜²æŠ–å¤„ç†é«˜é¢‘äº‹ä»¶
function debounce(func, wait) {
  let timeout;
  return function(...args) {
    clearTimeout(timeout);
    timeout = setTimeout(() => func.apply(this, args), wait);
  };
}

// é˜²æŠ–å¤„ç†è‡ªå®šä¹‰äº‹ä»¶
const debouncedHandler = debounce((event) => {
  console.log('å¤„ç†äº‹ä»¶:', event.detail);
}, 300);

window.addEventListener('highFrequencyEvent', debouncedHandler);
```

---

## 8. ä¸å…¶ä»–é€šä¿¡æ–¹å¼å¯¹æ¯”

### 8.1 CustomEvent vs å›è°ƒå‡½æ•°

| ç‰¹æ€§ | CustomEvent | å›è°ƒå‡½æ•° |
|------|------------|---------|
| è§£è€¦æ€§ | é«˜ï¼ˆå‘å¸ƒè®¢é˜…æ¨¡å¼ï¼‰ | ä½ï¼ˆç›´æ¥è°ƒç”¨ï¼‰ |
| ä¸€å¯¹å¤š | æ”¯æŒ | ä¸æ”¯æŒ |
| å¼‚æ­¥æ€§ | æ”¯æŒ | éœ€è¦æ‰‹åŠ¨å¤„ç† |
| é€‚ç”¨åœºæ™¯ | ç»„ä»¶é—´é€šä¿¡ | ç®€å•å‡½æ•°è°ƒç”¨ |

### 8.2 CustomEvent vs EventEmitter

```javascript
// CustomEventï¼šæµè§ˆå™¨åŸç”Ÿ API
const event = new CustomEvent('myEvent', { detail: data });
window.dispatchEvent(event);

// EventEmitterï¼šNode.js é£æ ¼ï¼ˆéœ€è¦åº“æ”¯æŒï¼‰
const emitter = new EventEmitter();
emitter.emit('myEvent', data);
```

### 8.3 CustomEvent vs å…¨å±€çŠ¶æ€ç®¡ç†

```javascript
// CustomEventï¼šäº‹ä»¶é©±åŠ¨
window.dispatchEvent(new CustomEvent('stateChange', { detail: newState }));

// å…¨å±€çŠ¶æ€ç®¡ç†ï¼šç›´æ¥è®¿é—®çŠ¶æ€
store.setState(newState);
const state = store.getState();
```

---

## 9. å…¼å®¹æ€§

### 9.1 æµè§ˆå™¨æ”¯æŒ

- **Chrome**ï¼š15+
- **Firefox**ï¼š11+
- **Safari**ï¼š6+
- **Edge**ï¼š12+
- **IE**ï¼šä¸æ”¯æŒï¼ˆéœ€è¦ä½¿ç”¨ polyfillï¼‰

### 9.2 Polyfill

```javascript
// ç®€å•çš„ CustomEvent polyfill
(function() {
  if (typeof window.CustomEvent === 'function') {
    return;
  }
  
  function CustomEvent(type, params) {
    params = params || { bubbles: false, cancelable: false, detail: null };
    const event = document.createEvent('CustomEvent');
    event.initCustomEvent(type, params.bubbles, params.cancelable, params.detail);
    return event;
  }
  
  window.CustomEvent = CustomEvent;
})();
```

---

## 10. ç›¸å…³é“¾æ¥

### 10.1 ç›¸å…³æ–‡æ¡£

- [äº‹ä»¶æœºåˆ¶](./äº‹ä»¶æœºåˆ¶.md) â€” äº‹ä»¶æ•è·ã€å†’æ³¡ã€å§”æ‰˜
- [DOM æ“ä½œ](./DOMæ“ä½œ.md) â€” DOM æ¥å£å’Œæ“ä½œ
- [BOM](./BOM.md) â€” windowã€document ç­‰æµè§ˆå™¨å¯¹è±¡

### 10.2 å‚è€ƒèµ„æº

- [MDN - CustomEvent](https://developer.mozilla.org/zh-CN/docs/Web/API/CustomEvent)
- [DOM Living Standard - CustomEvent](https://dom.spec.whatwg.org/#interface-customevent)
- [W3C Event Interface](https://www.w3.org/TR/DOM-Level-3-Events/)

---

**æœ€åæ›´æ–°**ï¼š2025  
**ç»´æŠ¤è§„èŒƒ**ï¼šæ¯æ¬¡æ–°å¢ç¬”è®°åï¼Œåœ¨å¯¹åº” MOC ä¸­åŠ å…¥é“¾æ¥

---

#javascript #äº‹ä»¶ #è‡ªå®šä¹‰äº‹ä»¶ #customevent #ç»„ä»¶é€šä¿¡ #æµè§ˆå™¨api #dom
