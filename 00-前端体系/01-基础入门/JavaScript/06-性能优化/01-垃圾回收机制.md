# åƒåœ¾å›æ”¶æœºåˆ¶ï¼ˆGarbage Collectionï¼‰

JavaScript è‡ªåŠ¨å†…å­˜ç®¡ç†æœºåˆ¶ã€‚

---

## ğŸ“š åŸºæœ¬æ¦‚å¿µ

### ä»€ä¹ˆæ˜¯åƒåœ¾å›æ”¶

åƒåœ¾å›æ”¶ï¼ˆGarbage Collectionï¼ŒGCï¼‰æ˜¯è‡ªåŠ¨ç®¡ç†å†…å­˜çš„æœºåˆ¶ï¼Œè‡ªåŠ¨é‡Šæ”¾ä¸å†ä½¿ç”¨çš„å¯¹è±¡å ç”¨çš„å†…å­˜ã€‚

```javascript
function createObject() {
  const obj = { data: 'some data' };
  return obj;
}

const myObj = createObject();
// å½“ myObj ä¸å†è¢«å¼•ç”¨æ—¶ï¼Œå¯¹è±¡ä¼šè¢«åƒåœ¾å›æ”¶
```

---

## ğŸ¯ åƒåœ¾å›æ”¶ç®—æ³•

### 1. æ ‡è®°æ¸…é™¤ï¼ˆMark and Sweepï¼‰

V8 å¼•æ“ä¸»è¦ä½¿ç”¨çš„ç®—æ³•ï¼š

1. **æ ‡è®°é˜¶æ®µ**ï¼šä»æ ¹å¯¹è±¡å¼€å§‹ï¼Œæ ‡è®°æ‰€æœ‰å¯è¾¾å¯¹è±¡
2. **æ¸…é™¤é˜¶æ®µ**ï¼šæ¸…é™¤æœªæ ‡è®°çš„å¯¹è±¡

```javascript
// ç¤ºä¾‹
let obj1 = { name: 'Alice' };
let obj2 = { name: 'Bob' };
obj1.friend = obj2;
obj2.friend = obj1;

obj1 = null;
obj2 = null;
// ä¸¤ä¸ªå¯¹è±¡å½¢æˆå¾ªç¯å¼•ç”¨ï¼Œä½†æ ‡è®°æ¸…é™¤ç®—æ³•å¯ä»¥å¤„ç†
```

### 2. å¼•ç”¨è®¡æ•°ï¼ˆReference Countingï¼‰

è®°å½•æ¯ä¸ªå¯¹è±¡çš„å¼•ç”¨æ¬¡æ•°ï¼Œå½“å¼•ç”¨æ•°ä¸º 0 æ—¶å›æ”¶ï¼š

```javascript
// é—®é¢˜ï¼šæ— æ³•å¤„ç†å¾ªç¯å¼•ç”¨
let obj1 = {};
let obj2 = {};
obj1.ref = obj2;
obj2.ref = obj1;
// å¼•ç”¨è®¡æ•°æ— æ³•å›æ”¶ï¼ˆç°ä»£æµè§ˆå™¨å·²ä¸ä½¿ç”¨ï¼‰
```

---

## ğŸ” å†…å­˜æ³„æ¼

### å¸¸è§åŸå› 

#### 1. å…¨å±€å˜é‡

```javascript
// âŒ é”™è¯¯ï¼šåˆ›å»ºå…¨å±€å˜é‡
function createData() {
  data = new Array(1000000).fill(0); // æœªä½¿ç”¨ var/let/const
}

// âœ… æ­£ç¡®
function createData() {
  const data = new Array(1000000).fill(0);
  return data;
}
```

#### 2. é—­åŒ…

```javascript
// âš ï¸ æ³¨æ„ï¼šé—­åŒ…å¯èƒ½æŒæœ‰å¤§å¯¹è±¡
function createHandler() {
  const largeData = new Array(1000000).fill(0);
  return function() {
    // largeData è¢«é—­åŒ…æŒæœ‰ï¼Œæ— æ³•é‡Šæ”¾
    console.log('Handler');
  };
}
```

#### 3. äº‹ä»¶ç›‘å¬å™¨

```javascript
// âŒ é”™è¯¯ï¼šæœªç§»é™¤äº‹ä»¶ç›‘å¬å™¨
element.addEventListener('click', handler);

// âœ… æ­£ç¡®ï¼šç§»é™¤äº‹ä»¶ç›‘å¬å™¨
element.addEventListener('click', handler);
element.removeEventListener('click', handler);
```

#### 4. å®šæ—¶å™¨

```javascript
// âŒ é”™è¯¯ï¼šæœªæ¸…é™¤å®šæ—¶å™¨
const timer = setInterval(() => {
  console.log('Running');
}, 1000);

// âœ… æ­£ç¡®ï¼šæ¸…é™¤å®šæ—¶å™¨
clearInterval(timer);
```

#### 5. DOM å¼•ç”¨

```javascript
// âš ï¸ æ³¨æ„ï¼šDOM å¼•ç”¨å¯èƒ½é˜»æ­¢åƒåœ¾å›æ”¶
const elements = [];
for (let i = 0; i < 1000; i++) {
  const element = document.createElement('div');
  elements.push(element); // æŒæœ‰ DOM å¼•ç”¨
  document.body.appendChild(element);
}

// éœ€è¦æ¸…ç†
elements.forEach(el => el.remove());
elements.length = 0;
```

---

## ğŸ’¡ ä¼˜åŒ–å»ºè®®

### 1. åŠæ—¶é‡Šæ”¾å¼•ç”¨

```javascript
function processData() {
  const data = fetchLargeData();
  // å¤„ç†æ•°æ®
  process(data);
  // åŠæ—¶é‡Šæ”¾
  data = null;
}
```

### 2. ä½¿ç”¨ WeakMap/WeakSet

```javascript
// WeakMap çš„é”®æ˜¯å¼±å¼•ç”¨ï¼Œä¸ä¼šé˜»æ­¢åƒåœ¾å›æ”¶
const weakMap = new WeakMap();
const obj = { data: 'large data' };
weakMap.set(obj, 'value');
// å½“ obj ä¸å†è¢«å¼•ç”¨æ—¶ï¼ŒWeakMap ä¸­çš„æ¡ç›®ä¼šè¢«è‡ªåŠ¨æ¸…é™¤
```

### 3. é¿å…å¾ªç¯å¼•ç”¨

```javascript
// å¦‚æœå¯èƒ½ï¼Œé¿å…å¾ªç¯å¼•ç”¨
// æˆ–ä½¿ç”¨ WeakMap/WeakSet
```

### 4. ä½¿ç”¨å¯¹è±¡æ± 

```javascript
// é‡ç”¨å¯¹è±¡ï¼Œå‡å°‘åˆ›å»ºå’Œé”€æ¯
class ObjectPool {
  constructor(createFn) {
    this.createFn = createFn;
    this.pool = [];
  }
  
  acquire() {
    return this.pool.pop() || this.createFn();
  }
  
  release(obj) {
    this.pool.push(obj);
  }
}
```

---

## ğŸ”§ è°ƒè¯•å·¥å…·

### Chrome DevTools

1. **Memory é¢æ¿**ï¼šæŸ¥çœ‹å†…å­˜ä½¿ç”¨
2. **Performance é¢æ¿**ï¼šè®°å½•å†…å­˜å¿«ç…§
3. **Heap Snapshot**ï¼šåˆ†æå †å†…å­˜

### å†…å­˜åˆ†æ

```javascript
// æ£€æŸ¥å†…å­˜ä½¿ç”¨
console.log(performance.memory);
// {
//   usedJSHeapSize: 1000000,
//   totalJSHeapSize: 2000000,
//   jsHeapSizeLimit: 4000000
// }
```

---

## ğŸ”— ç›¸å…³é“¾æ¥

- [å†…å­˜ç®¡ç†](../01-è¯­è¨€æ ¸å¿ƒ/åº•å±‚åŸç†/å†…å­˜ç®¡ç†.md) â€” å†…å­˜ç®¡ç†è¯¦è§£
- [ä»£ç æ€§èƒ½ä¼˜åŒ–](./03-ä»£ç æ€§èƒ½ä¼˜åŒ–.md) â€” ä»£ç å±‚é¢ä¼˜åŒ–
- [æ€§èƒ½ç›‘æ§ä¸åˆ†æ](./04-æ€§èƒ½ç›‘æ§ä¸åˆ†æ.md) â€” æ€§èƒ½åˆ†æå·¥å…·

---

**å‚è€ƒ**ï¼š
- [MDN: Memory Management](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Memory_Management)
- [V8 Garbage Collection](https://v8.dev/blog/trash-talk)

---

#javascript #æ€§èƒ½ä¼˜åŒ– #åƒåœ¾å›æ”¶ #å†…å­˜ç®¡ç† #gc
