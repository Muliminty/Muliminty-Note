# ä½œç”¨åŸŸå’Œé—­åŒ…ï¼ˆScope and Closuresï¼‰

> JavaScript çš„ä½œç”¨åŸŸæœºåˆ¶å’Œé—­åŒ…æ¦‚å¿µï¼šä»åŸºç¡€ä½¿ç”¨åˆ°åº•å±‚åŸç†

---

## ğŸ“– å…¥é—¨ï¼šåŸºç¡€ä½¿ç”¨

### 1. ä½œç”¨åŸŸï¼ˆScopeï¼‰

**ä½œç”¨åŸŸå®šä¹‰**ï¼šä½œç”¨åŸŸæ˜¯å˜é‡å’Œå‡½æ•°çš„å¯è®¿é—®èŒƒå›´ã€‚

#### 1.1 å…¨å±€ä½œç”¨åŸŸï¼ˆGlobal Scopeï¼‰

**ç‰¹ç‚¹**ï¼š
- åœ¨å‡½æ•°å¤–éƒ¨å£°æ˜çš„å˜é‡
- åœ¨æ•´ä¸ªç¨‹åºä¸­éƒ½å¯ä»¥è®¿é—®

**ç¤ºä¾‹**ï¼š
```javascript
let globalVar = "I'm global";  // å…¨å±€å˜é‡

function test() {
  console.log(globalVar);  // âœ… å¯ä»¥è®¿é—®
}

test();
console.log(globalVar);  // âœ… å¯ä»¥è®¿é—®
```

---

#### 1.2 å‡½æ•°ä½œç”¨åŸŸï¼ˆFunction Scopeï¼‰

**ç‰¹ç‚¹**ï¼š
- åœ¨å‡½æ•°å†…éƒ¨å£°æ˜çš„å˜é‡
- åªèƒ½åœ¨å‡½æ•°å†…éƒ¨è®¿é—®
- `var` å£°æ˜çš„å˜é‡å±äºå‡½æ•°ä½œç”¨åŸŸ

**ç¤ºä¾‹**ï¼š
```javascript
function test() {
  var functionVar = "I'm in function";  // å‡½æ•°ä½œç”¨åŸŸ
  console.log(functionVar);  // âœ… å¯ä»¥è®¿é—®
}

// console.log(functionVar);  // âŒ æŠ¥é”™ï¼šfunctionVar is not defined
test();
```

---

#### 1.3 å—çº§ä½œç”¨åŸŸï¼ˆBlock Scopeï¼‰

**ç‰¹ç‚¹**ï¼š
- åœ¨ `{}` ä»£ç å—å†…å£°æ˜çš„å˜é‡
- åªèƒ½åœ¨ä»£ç å—å†…è®¿é—®
- `let` å’Œ `const` å£°æ˜çš„å˜é‡å±äºå—çº§ä½œç”¨åŸŸ

**ç¤ºä¾‹**ï¼š
```javascript
if (true) {
  let blockVar = "I'm in block";  // å—çº§ä½œç”¨åŸŸ
  console.log(blockVar);  // âœ… å¯ä»¥è®¿é—®
}

// console.log(blockVar);  // âŒ æŠ¥é”™ï¼šblockVar is not defined
```

---

### 2. ä½œç”¨åŸŸé“¾ï¼ˆScope Chainï¼‰

**æ¦‚å¿µ**ï¼šå½“å‰ä½œç”¨åŸŸæ‰¾ä¸åˆ°å˜é‡æ—¶ï¼Œä¼šå‘ä¸Šçº§ä½œç”¨åŸŸæŸ¥æ‰¾ï¼Œå½¢æˆä½œç”¨åŸŸé“¾ã€‚

**ç¤ºä¾‹**ï¼š
```javascript
let global = "global";

function outer() {
  let outerVar = "outer";
  
  function inner() {
    let innerVar = "inner";
    console.log(innerVar);  // "inner"ï¼ˆå½“å‰ä½œç”¨åŸŸï¼‰
    console.log(outerVar);  // "outer"ï¼ˆä¸Šçº§ä½œç”¨åŸŸï¼‰
    console.log(global);    // "global"ï¼ˆå…¨å±€ä½œç”¨åŸŸï¼‰
  }
  
  inner();
}

outer();
```

---

### 3. é—­åŒ…ï¼ˆClosureï¼‰

**æ¦‚å¿µ**ï¼šé—­åŒ…æ˜¯å‡½æ•°èƒ½å¤Ÿè®¿é—®å…¶å¤–éƒ¨ä½œç”¨åŸŸå˜é‡çš„èƒ½åŠ›ã€‚

#### 3.1 é—­åŒ…çš„åŸºæœ¬ä½¿ç”¨

**ç¤ºä¾‹**ï¼š
```javascript
function outer() {
  let outerVar = "I'm outside";
  
  function inner() {
    console.log(outerVar);  // è®¿é—®å¤–éƒ¨å˜é‡
  }
  
  return inner;  // è¿”å›å†…éƒ¨å‡½æ•°
}

let closure = outer();
closure();  // "I'm outside"ï¼ˆä»ç„¶å¯ä»¥è®¿é—® outerVarï¼‰
```

---

#### 3.2 é—­åŒ…çš„å¸¸è§åº”ç”¨

**1. æ•°æ®ç§æœ‰åŒ–**ï¼š
```javascript
function createCounter() {
  let count = 0;  // ç§æœ‰å˜é‡
  
  return {
    increment() {
      count++;
      return count;
    },
    decrement() {
      count--;
      return count;
    },
    getCount() {
      return count;
    }
  };
}

let counter = createCounter();
console.log(counter.increment());  // 1
console.log(counter.increment());  // 2
console.log(counter.getCount());   // 2
```

**2. å‡½æ•°å·¥å‚**ï¼š
```javascript
function createMultiplier(multiplier) {
  return function(number) {
    return number * multiplier;
  };
}

let double = createMultiplier(2);
let triple = createMultiplier(3);

console.log(double(5));  // 10
console.log(triple(5));  // 15
```

---

## ğŸš€ æé«˜ï¼šåº•å±‚åŸç†

### 1. è¯æ³•ä½œç”¨åŸŸï¼ˆLexical Scopeï¼‰

#### 1.1 è¯æ³•ä½œç”¨åŸŸçš„å®šä¹‰

**æ¦‚å¿µ**ï¼šè¯æ³•ä½œç”¨åŸŸï¼ˆé™æ€ä½œç”¨åŸŸï¼‰æ˜¯åœ¨ä»£ç ç¼–å†™æ—¶ç¡®å®šçš„ä½œç”¨åŸŸï¼Œè€Œä¸æ˜¯è¿è¡Œæ—¶ã€‚

**åŸç†**ï¼š
- JavaScript ä½¿ç”¨è¯æ³•ä½œç”¨åŸŸ
- ä½œç”¨åŸŸç”±ä»£ç çš„ä¹¦å†™ä½ç½®å†³å®š
- å‡½æ•°çš„ä½œç”¨åŸŸåœ¨å®šä¹‰æ—¶å°±ç¡®å®šäº†

**ç¤ºä¾‹**ï¼š
```javascript
let x = "global";

function outer() {
  let x = "outer";
  
  function inner() {
    console.log(x);  // "outer"ï¼ˆè¯æ³•ä½œç”¨åŸŸï¼ŒæŸ¥æ‰¾å®šä¹‰æ—¶çš„å¤–å±‚ä½œç”¨åŸŸï¼‰
  }
  
  return inner;
}

let x = "new global";
let func = outer();
func();  // "outer"ï¼ˆä¸æ˜¯ "new global"ï¼‰
```

---

#### 1.2 ä½œç”¨åŸŸé“¾çš„æ„å»º

**åŸç†**ï¼š
- æ¯ä¸ªå‡½æ•°éƒ½æœ‰å†…éƒ¨å±æ€§ ``[[Scope]]``
- ``[[Scope]]`` ä¿å­˜äº†å‡½æ•°å®šä¹‰æ—¶çš„ä½œç”¨åŸŸé“¾
- å‡½æ•°æ‰§è¡Œæ—¶ï¼Œä¼šåˆ›å»ºæ–°çš„æ‰§è¡Œä¸Šä¸‹æ–‡
- æ–°çš„æ‰§è¡Œä¸Šä¸‹æ–‡çš„ä½œç”¨åŸŸé“¾ = å½“å‰å˜é‡å¯¹è±¡ + ``[[Scope]]``

**ç¤ºä¾‹åˆ†æ**ï¼š
```javascript
let global = "global";

function outer() {
  let outerVar = "outer";
  
  function inner() {
    let innerVar = "inner";
    console.log(innerVar, outerVar, global);
  }
  
  return inner;
}

let func = outer();
func();
```

**ä½œç”¨åŸŸé“¾ç»“æ„**ï¼š
```
inner æ‰§è¡Œä¸Šä¸‹æ–‡
â”œâ”€â”€ å˜é‡å¯¹è±¡ï¼ˆVOï¼‰
â”‚   â””â”€â”€ innerVar: "inner"
â””â”€â”€ ä½œç”¨åŸŸé“¾
    â”œâ”€â”€ outer å˜é‡å¯¹è±¡
    â”‚   â””â”€â”€ outerVar: "outer"
    â””â”€â”€ å…¨å±€å¯¹è±¡
        â””â”€â”€ global: "global"
```

---

### 2. æ‰§è¡Œä¸Šä¸‹æ–‡ï¼ˆExecution Contextï¼‰

#### 2.1 æ‰§è¡Œä¸Šä¸‹æ–‡çš„åˆ›å»º

**åˆ›å»ºé˜¶æ®µ**ï¼š
1. åˆ›å»ºå˜é‡å¯¹è±¡ï¼ˆVariable Objectï¼‰
2. å»ºç«‹ä½œç”¨åŸŸé“¾ï¼ˆScope Chainï¼‰
3. ç¡®å®š `this` ç»‘å®šï¼ˆThis Bindingï¼‰

**æ‰§è¡Œé˜¶æ®µ**ï¼š
1. å˜é‡èµ‹å€¼
2. å‡½æ•°å¼•ç”¨
3. æ‰§è¡Œä»£ç 

**ç¤ºä¾‹**ï¼š
```javascript
function test(a, b) {
  var c = 10;
  function inner() {}
  return a + b + c;
}

test(1, 2);
```

**æ‰§è¡Œä¸Šä¸‹æ–‡åˆ›å»ºè¿‡ç¨‹**ï¼š
```
åˆ›å»ºé˜¶æ®µï¼š
1. åˆ›å»ºå˜é‡å¯¹è±¡
   - arguments: { a: 1, b: 2 }
   - c: undefined
   - inner: function reference
2. å»ºç«‹ä½œç”¨åŸŸé“¾
   - [å½“å‰ VO, å…¨å±€å¯¹è±¡]
3. ç¡®å®š this ç»‘å®š

æ‰§è¡Œé˜¶æ®µï¼š
1. c = 10
2. æ‰§è¡Œ return a + b + c
```

---

### 3. é—­åŒ…çš„åŸç†

#### 3.1 é—­åŒ…çš„å½¢æˆæœºåˆ¶

**åŸç†**ï¼š
- å½“å‡½æ•°è¿”å›å†…éƒ¨å‡½æ•°æ—¶ï¼Œå†…éƒ¨å‡½æ•°ä¼šä¿ç•™å¯¹å¤–éƒ¨ä½œç”¨åŸŸçš„å¼•ç”¨
- å³ä½¿å¤–éƒ¨å‡½æ•°æ‰§è¡Œå®Œæ¯•ï¼Œå…¶å˜é‡å¯¹è±¡ä¹Ÿä¸ä¼šè¢«é”€æ¯
- å†…éƒ¨å‡½æ•°ä»ç„¶å¯ä»¥è®¿é—®å¤–éƒ¨å‡½æ•°çš„å˜é‡

**ç¤ºä¾‹**ï¼š
```javascript
function outer() {
  let outerVar = "outer";
  
  function inner() {
    console.log(outerVar);
  }
  
  return inner;  // è¿”å›å†…éƒ¨å‡½æ•°ï¼Œå½¢æˆé—­åŒ…
}

let closure = outer();
closure();  // ä»ç„¶å¯ä»¥è®¿é—® outerVar
```

**å†…å­˜æ¨¡å‹**ï¼š
```
outer æ‰§è¡Œä¸Šä¸‹æ–‡ï¼ˆå³ä½¿æ‰§è¡Œå®Œæ¯•ï¼Œä»ä¿ç•™åœ¨å†…å­˜ä¸­ï¼‰
â””â”€â”€ å˜é‡å¯¹è±¡
    â””â”€â”€ outerVar: "outer"

inner å‡½æ•°å¯¹è±¡
â””â”€â”€ ``[[Scope]]``: [outer çš„å˜é‡å¯¹è±¡, å…¨å±€å¯¹è±¡]

closure å˜é‡
â””â”€â”€ å¼•ç”¨ inner å‡½æ•°å¯¹è±¡
```

---

#### 3.2 é—­åŒ…çš„å†…å­˜ç®¡ç†

**å†…å­˜æ³„æ¼é£é™©**ï¼š
```javascript
function createHandler() {
  let largeData = new Array(1000000).fill(0);  // å¤§æ•°ç»„
  
  return function() {
    // å³ä½¿ä¸ä½¿ç”¨ largeDataï¼Œé—­åŒ…ä»ç„¶æŒæœ‰å¼•ç”¨
    console.log("Handler");
  };
}

let handler = createHandler();
// largeData ä¸ä¼šè¢«åƒåœ¾å›æ”¶ï¼Œå› ä¸ºé—­åŒ…æŒæœ‰å¼•ç”¨
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```javascript
function createHandler() {
  let largeData = new Array(1000000).fill(0);
  
  return function() {
    console.log("Handler");
  };
  
  // å¦‚æœä¸å†éœ€è¦ largeDataï¼Œå¯ä»¥æ˜¾å¼è®¾ç½®ä¸º null
  // largeData = null;  // ä½†è¿™æ ·ä¼šå¤±å»é—­åŒ…çš„ä½œç”¨
}

let handler = createHandler();
// å¦‚æœä¸å†éœ€è¦ handlerï¼Œåº”è¯¥è®¾ç½®ä¸º null
handler = null;  // é‡Šæ”¾é—­åŒ…
```

---

### 4. å˜é‡æå‡å’Œé—­åŒ…

#### 4.1 å˜é‡æå‡å¯¹é—­åŒ…çš„å½±å“

**ç¤ºä¾‹**ï¼š
```javascript
var functions = [];

for (var i = 0; i < 3; i++) {
  functions.push(function() {
    console.log(i);  // æ‰€æœ‰å‡½æ•°éƒ½å¼•ç”¨åŒä¸€ä¸ª i
  });
}

functions[0]();  // 3
functions[1]();  // 3
functions[2]();  // 3
```

**é—®é¢˜**ï¼šæ‰€æœ‰å‡½æ•°éƒ½å¼•ç”¨åŒä¸€ä¸ª `i`ï¼Œå› ä¸º `var` æ˜¯å‡½æ•°ä½œç”¨åŸŸã€‚

**è§£å†³æ–¹æ¡ˆ 1ï¼šä½¿ç”¨ `let`**ï¼š
```javascript
let functions = [];

for (let i = 0; i < 3; i++) {  // let åˆ›å»ºå—çº§ä½œç”¨åŸŸ
  functions.push(function() {
    console.log(i);  // æ¯ä¸ªå‡½æ•°å¼•ç”¨ä¸åŒçš„ i
  });
}

functions[0]();  // 0
functions[1]();  // 1
functions[2]();  // 2
```

**è§£å†³æ–¹æ¡ˆ 2ï¼šä½¿ç”¨ IIFE**ï¼š
```javascript
var functions = [];

for (var i = 0; i < 3; i++) {
  (function(j) {  // ç«‹å³æ‰§è¡Œå‡½æ•°ï¼Œåˆ›å»ºæ–°çš„ä½œç”¨åŸŸ
    functions.push(function() {
      console.log(j);
    });
  })(i);
}

functions[0]();  // 0
functions[1]();  // 1
functions[2]();  // 2
```

---

### 5. é—­åŒ…çš„æ€§èƒ½è€ƒè™‘

#### 5.1 å†…å­˜å ç”¨

**é—­åŒ…ä¼šå ç”¨æ›´å¤šå†…å­˜**ï¼š
- é—­åŒ…ä¼šä¿ç•™å¤–éƒ¨ä½œç”¨åŸŸçš„å˜é‡å¯¹è±¡
- å³ä½¿å¤–éƒ¨å‡½æ•°æ‰§è¡Œå®Œæ¯•ï¼Œå˜é‡å¯¹è±¡ä¹Ÿä¸ä¼šè¢«é”€æ¯
- éœ€è¦è°¨æ…ä½¿ç”¨ï¼Œé¿å…å†…å­˜æ³„æ¼

#### 5.2 æ€§èƒ½ä¼˜åŒ–

**é¿å…ä¸å¿…è¦çš„é—­åŒ…**ï¼š
```javascript
// ä¸å¥½çš„åšæ³•
function processData(data) {
  return data.map(function(item) {
    return item * 2;  // ä¸éœ€è¦é—­åŒ…
  });
}

// æ›´å¥½çš„åšæ³•
function processData(data) {
  return data.map(item => item * 2);  // ä½¿ç”¨ç®­å¤´å‡½æ•°
}
```

---

## ğŸ“ æœ€ä½³å®è·µ

1. **ç†è§£ä½œç”¨åŸŸ**ï¼šæ¸…æ¥šå˜é‡çš„ä½œç”¨åŸŸèŒƒå›´
2. **åˆç†ä½¿ç”¨é—­åŒ…**ï¼šåˆ©ç”¨é—­åŒ…å®ç°æ•°æ®ç§æœ‰åŒ–
3. **é¿å…å†…å­˜æ³„æ¼**ï¼šæ³¨æ„é—­åŒ…çš„å†…å­˜å ç”¨
4. **ä½¿ç”¨ `let` å’Œ `const`**ï¼šé¿å… `var` å¸¦æ¥çš„ä½œç”¨åŸŸé—®é¢˜

---

## ğŸ”— ç›¸å…³é“¾æ¥

- [å˜é‡å£°æ˜](./å˜é‡å£°æ˜.md) â€” å˜é‡å£°æ˜å’Œä½œç”¨åŸŸçš„å…³ç³»
- [å‡½æ•°](./å‡½æ•°.md) â€” å‡½æ•°çš„æ‰§è¡Œä¸Šä¸‹æ–‡å’Œé—­åŒ…
- [æ‰§è¡Œä¸Šä¸‹æ–‡](./æ‰§è¡Œä¸Šä¸‹æ–‡.md) â€” æ·±å…¥ç†è§£æ‰§è¡Œä¸Šä¸‹æ–‡ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
- [ECMAScript ä½œç”¨åŸŸè§„èŒƒ](https://tc39.es/ecma262/#sec-lexical-environments)

---

#javascript #ä½œç”¨åŸŸ #é—­åŒ… #è¯æ³•ä½œç”¨åŸŸ #ä½œç”¨åŸŸé“¾

