# 05. æ•°æ®åº“é›†æˆä¸ ORM æœ€ä½³å®è·µ

åœ¨ Next.js å…¨æ ˆå¼€å‘ä¸­ï¼Œæ•°æ®åº“è¿æ¥ä¸ä¼ ç»Ÿçš„ Node.js æœåŠ¡ï¼ˆå¦‚ Express å¸¸é©»å†…å­˜ï¼‰å®Œå…¨ä¸åŒã€‚

ç”±äº Next.js API Routes å’Œ Server Actions ç»å¸¸è¿è¡Œåœ¨ **Serverless (æ— æœåŠ¡å™¨)** ç¯å¢ƒä¸­ï¼Œå‡½æ•°æ‰§è¡Œå®Œå°±ä¼šé”€æ¯ã€‚å¦‚æœæ¯æ¬¡è¯·æ±‚éƒ½åˆ›å»ºä¸€ä¸ªæ–°çš„æ•°æ®åº“è¿æ¥ï¼Œé«˜å¹¶å‘ä¸‹ä¼šç¬é—´è€—å°½æ•°æ®åº“è¿æ¥æ•°ï¼Œå¯¼è‡´åº”ç”¨å´©æºƒã€‚

---

## 1. æ ¸å¿ƒé—®é¢˜ï¼šè¿æ¥æ± è€—å°½ (Connection Exhaustion)

**âŒ é”™è¯¯å†™æ³•ï¼š**

```ts
// lib/db.ts
import { PrismaClient } from '@prisma/client'

// ğŸ˜± æ¯æ¬¡ import è¿™ä¸ªæ–‡ä»¶ï¼Œéƒ½ä¼š new ä¸€ä¸ªæ–°çš„è¿æ¥å®ä¾‹
// åœ¨å¼€å‘ç¯å¢ƒ(çƒ­æ›´æ–°)æˆ– Serverless ç¯å¢ƒä¸‹ï¼Œè¿™ä¼šå¯¼è‡´è¿æ¥æ•°æ— é™å¢é•¿
export const db = new PrismaClient()
```

**âœ… æ­£ç¡®å†™æ³•ï¼šå…¨å±€å•ä¾‹æ¨¡å¼**

æˆ‘ä»¬éœ€è¦æŠŠå®¢æˆ·ç«¯å®ä¾‹æŒ‚è½½åˆ° `globalThis` å¯¹è±¡ä¸Šï¼Œç¡®ä¿æ•´ä¸ªè¿›ç¨‹åªå­˜åœ¨ä¸€ä¸ªå®ä¾‹ã€‚

```ts
// lib/db.ts
import { PrismaClient } from '@prisma/client'

// 1. å£°æ˜å…¨å±€ç±»å‹ï¼Œé˜²æ­¢ TS æŠ¥é”™
const globalForPrisma = globalThis as unknown as {
  prisma: PrismaClient | undefined
}

// 2. å¦‚æœå·²æœ‰å®ä¾‹åˆ™å¤ç”¨ï¼Œå¦åˆ™æ–°å»º
export const db = globalForPrisma.prisma ?? new PrismaClient()

// 3. åœ¨éç”Ÿäº§ç¯å¢ƒä¸‹ï¼Œå°†å®ä¾‹ä¿å­˜åˆ°å…¨å±€å˜é‡
if (process.env.NODE_ENV !== 'production') {
  globalForPrisma.prisma = db
}
```

è¿™æ ·ï¼Œæ— è®º Next.js åœ¨å¼€å‘ç¯å¢ƒæ€ä¹ˆçƒ­é‡è½½ (Hot Reload)ï¼Œæ•°æ®åº“è¿æ¥å§‹ç»ˆåªæœ‰ä¸€ä¸ªã€‚

---

## 2. ORM é€‰å‹å»ºè®®

åœ¨ 2024/2025 å¹´ï¼ŒNext.js ç”Ÿæ€ä¸»è¦æµè¡Œä¸¤ä¸ª ORMï¼š

| ç‰¹æ€§ | **Prisma** | **Drizzle ORM** |
| :--- | :--- | :--- |
| **é£æ ¼** | é¢å‘å¯¹è±¡ï¼ŒSchema ä¼˜å…ˆ (`schema.prisma`) | å‡½æ•°å¼ï¼ŒTS ä»£ç ä¼˜å…ˆ |
| **ç±»å‹å®‰å…¨** | â­ï¸â­ï¸â­ï¸â­ï¸â­ï¸ (è‡ªåŠ¨ç”Ÿæˆ) | â­ï¸â­ï¸â­ï¸â­ï¸â­ï¸ (åŸºäº TS æ¨æ–­) |
| **æ€§èƒ½** | âš ï¸ è¾ƒé‡ (åŸºäº Rust Binary) | ğŸš€ æè½» (SQL wrapper) |
| **å†·å¯åŠ¨** | è¾ƒæ…¢ | æå¿« (é€‚åˆ Serverless) |
| **é€‚ç”¨åœºæ™¯** | ä¼ ç»Ÿä¼ä¸šçº§é¡¹ç›®ï¼Œå¿«é€Ÿå¼€å‘ï¼Œä¸æè‡´è¿½æ±‚å†·å¯åŠ¨é€Ÿåº¦ | Serverless Edge ç¯å¢ƒï¼Œè¿½æ±‚æè‡´æ€§èƒ½ |

### Prisma å¿«é€Ÿä¸Šæ‰‹ç¤ºä¾‹

1. **å®‰è£…**
   ```bash
   npm install prisma --save-dev
   npm install @prisma/client
   npx prisma init
   ```

2. **å®šä¹‰æ¨¡å‹ (`prisma/schema.prisma`)**
   ```prisma
   model User {
     id    String @id @default(cuid())
     email String @unique
     posts Post[]
   }

   model Post {
     id        String  @id @default(cuid())
     title     String
     published Boolean @default(false)
     authorId  String
     author    User    @relation(fields: [authorId], references: [id])
   }
   ```

3. **åŒæ­¥æ•°æ®åº“**
   ```bash
   npx prisma db push
   ```

4. **åœ¨ Server Component ä¸­ä½¿ç”¨**
   ```tsx
   // app/page.tsx
   import { db } from '@/lib/db'

   export default async function Page() {
     const posts = await db.post.findMany({
       where: { published: true },
       include: { author: true }
     })

     return (
       <ul>
         {posts.map(post => (
           <li key={post.id}>{post.title} by {post.author.email}</li>
         ))}
       </ul>
     )
   }
   ```

---

## 3. Serverless ç¯å¢ƒä¸‹çš„ç‰¹æ®Šå¤„ç†

å¦‚æœä½ çš„æ•°æ®åº“ï¼ˆå¦‚ MySQL/PostgreSQLï¼‰æ‰˜ç®¡åœ¨ä¼ ç»Ÿäº‘æœåŠ¡å™¨ä¸Šï¼Œè€Œ Next.js éƒ¨ç½²åœ¨ Vercel Edge æˆ– AWS Lambda ä¸Šï¼Œä½ éœ€è¦ä½¿ç”¨ **è¿æ¥æ± ä»£ç† (Connection Pooling)**ã€‚

- **Vercel Postgres / Neon**: è‡ªå¸¦ Serverless Driverï¼Œæ— éœ€æ‹…å¿ƒã€‚
- **PlanetScale**: ä½¿ç”¨ HTTP åè®®ï¼Œæ— è¿æ¥æ•°é™åˆ¶ã€‚
- **AWS RDS / è‡ªå»ºæ•°æ®åº“**: å¿…é¡»é…åˆ **Prisma Data Proxy** æˆ– **PgBouncer** ä½¿ç”¨ï¼Œå¦åˆ™å¹¶å‘ä¸€é«˜å°±ä¼šæŒ‚ã€‚

## 4. æ€»ç»“

1.  **å¿…é¡»ä½¿ç”¨å•ä¾‹æ¨¡å¼**ï¼šé˜²æ­¢å¼€å‘ç¯å¢ƒå’Œ Serverless ç¯å¢ƒè¿æ¥æ³„éœ²ã€‚
2.  **Server Component ç›´è¿**ï¼šåœ¨ Server Component ä¸­ç›´æ¥æŸ¥æ•°æ®åº“æ˜¯æœ€é«˜æ•ˆçš„ï¼Œä¸éœ€è¦ç»è¿‡ fetch APIã€‚
3.  **æ³¨æ„ç¯å¢ƒé™åˆ¶**ï¼šå¦‚æœéƒ¨ç½²åœ¨ Edge Runtimeï¼ŒPrisma å¯èƒ½ä¸å…¼å®¹ï¼ˆå› ä¸ºå®ƒä¾èµ– Node.js APIï¼‰ï¼Œæ­¤æ—¶æ¨èç”¨ Drizzle æˆ– Prisma Accelerateã€‚
