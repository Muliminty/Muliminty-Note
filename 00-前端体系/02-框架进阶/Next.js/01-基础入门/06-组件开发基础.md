# 06. ç»„ä»¶å¼€å‘åŸºç¡€

Next.js 13+ å¼•å…¥äº† Server Components å’Œ Client Components çš„æ¦‚å¿µï¼Œè¿™æ˜¯ç†è§£ Next.js æ¶æ„çš„å…³é”®ã€‚æœ¬ç« å°†æ·±å…¥è®²è§£è¿™ä¸¤ç§ç»„ä»¶çš„åŒºåˆ«å’Œä½¿ç”¨åœºæ™¯ã€‚

---

## 1. Server Component vs Client Component

### æ ¸å¿ƒåŒºåˆ«

| ç‰¹æ€§ | Server Component | Client Component |
|------|-----------------|------------------|
| **è¿è¡Œä½ç½®** | æœåŠ¡å™¨ | æµè§ˆå™¨ |
| **JavaScript** | ä¸å‘é€åˆ°å®¢æˆ·ç«¯ | å‘é€åˆ°å®¢æˆ·ç«¯ |
| **äº¤äº’æ€§** | âŒ ä¸æ”¯æŒäº‹ä»¶å¤„ç†ã€useState ç­‰ | âœ… æ”¯æŒæ‰€æœ‰ React Hooks |
| **æ•°æ®è·å–** | âœ… å¯ä»¥ç›´æ¥è®¿é—®æ•°æ®åº“ã€API | âŒ éœ€è¦é€šè¿‡ API è·¯ç”± |
| **æ€§èƒ½** | ğŸš€ æ›´å¿«çš„é¦–å±åŠ è½½ | âš ï¸ éœ€è¦ä¸‹è½½ JS æ‰èƒ½äº¤äº’ |

### é»˜è®¤æ˜¯ Server Component

åœ¨ Next.js App Router ä¸­ï¼Œ**é»˜è®¤æ‰€æœ‰ç»„ä»¶éƒ½æ˜¯ Server Component**ã€‚

```tsx
// src/app/page.tsx
// è¿™æ˜¯ä¸€ä¸ª Server Componentï¼ˆé»˜è®¤ï¼‰
export default function Home() {
  // âœ… å¯ä»¥ç›´æ¥è®¿é—®æ•°æ®åº“
  // âœ… å¯ä»¥ç›´æ¥è¯»å–æ–‡ä»¶ç³»ç»Ÿ
  // âŒ ä¸èƒ½ä½¿ç”¨ useStateã€useEffect
  // âŒ ä¸èƒ½ä½¿ç”¨äº‹ä»¶å¤„ç†ï¼ˆonClick ç­‰ï¼‰
  
  return <div>Hello World</div>
}
```

### ä½¿ç”¨ Client Component

éœ€è¦äº¤äº’æ€§æ—¶ï¼Œä½¿ç”¨ `'use client'` æŒ‡ä»¤ï¼š

```tsx
// src/components/Counter.tsx
'use client' // æ ‡è®°ä¸º Client Component

import { useState } from 'react'

export default function Counter() {
  const [count, setCount] = useState(0)

  return (
    <div>
      <p>è®¡æ•°ï¼š{count}</p>
      <button onClick={() => setCount(count + 1)}>å¢åŠ </button>
    </div>
  )
}
```

---

## 2. ä½•æ—¶ä½¿ç”¨ Server Componentï¼Ÿ

### âœ… é€‚åˆ Server Component çš„åœºæ™¯

1. **æ•°æ®è·å–**ï¼ˆä»æ•°æ®åº“ã€API è·å–æ•°æ®ï¼‰
2. **è®¿é—®åç«¯èµ„æº**ï¼ˆæ–‡ä»¶ç³»ç»Ÿã€ç¯å¢ƒå˜é‡ï¼‰
3. **å‡å°‘å®¢æˆ·ç«¯ JS ä½“ç§¯**ï¼ˆæå‡æ€§èƒ½ï¼‰
4. **SEO ä¼˜åŒ–**ï¼ˆå†…å®¹åœ¨æœåŠ¡ç«¯æ¸²æŸ“ï¼‰

### å®æˆ˜æ¡ˆä¾‹ï¼šåšå®¢æ–‡ç« åˆ—è¡¨ï¼ˆServer Componentï¼‰

```tsx
// src/app/blog/page.tsx
// Server Component - é€‚åˆæ•°æ®è·å–

// æ¨¡æ‹Ÿä»æ•°æ®åº“è·å–æ•°æ®
async function getPosts() {
  // å®é™…é¡¹ç›®ä¸­è¿™é‡Œå¯èƒ½æ˜¯ï¼š
  // const posts = await db.post.findMany()
  return [
    { id: '1', title: 'Next.js å…¥é—¨', content: '...' },
    { id: '2', title: 'TypeScript å®è·µ', content: '...' },
  ]
}

export default async function BlogPage() {
  const posts = await getPosts()

  return (
    <div className="max-w-4xl mx-auto px-4 py-20">
      <h1 className="text-4xl font-bold mb-8">åšå®¢</h1>
      <div className="space-y-6">
        {posts.map((post) => (
          <article key={post.id} className="bg-white p-6 rounded-lg shadow">
            <h2 className="text-2xl font-semibold mb-2">{post.title}</h2>
            <p className="text-gray-600">{post.content}</p>
          </article>
        ))}
      </div>
    </div>
  )
}
```

---

## 3. ä½•æ—¶ä½¿ç”¨ Client Componentï¼Ÿ

### âœ… é€‚åˆ Client Component çš„åœºæ™¯

1. **ç”¨æˆ·äº¤äº’**ï¼ˆç‚¹å‡»ã€è¾“å…¥ã€æ‹–æ‹½ï¼‰
2. **çŠ¶æ€ç®¡ç†**ï¼ˆuseStateã€useReducerï¼‰
3. **ç”Ÿå‘½å‘¨æœŸ**ï¼ˆuseEffectã€useLayoutEffectï¼‰
4. **æµè§ˆå™¨ API**ï¼ˆlocalStorageã€windowã€documentï¼‰
5. **ç¬¬ä¸‰æ–¹åº“**ï¼ˆéœ€è¦å®¢æˆ·ç«¯è¿è¡Œçš„åº“ï¼‰

### å®æˆ˜æ¡ˆä¾‹ï¼šæœç´¢æ¡†ï¼ˆClient Componentï¼‰

```tsx
// src/components/SearchBox.tsx
'use client'

import { useState } from 'react'
import { useRouter } from 'next/navigation'

export default function SearchBox() {
  const [query, setQuery] = useState('')
  const router = useRouter()

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault()
    router.push(`/search?q=${encodeURIComponent(query)}`)
  }

  return (
    <form onSubmit={handleSubmit} className="flex gap-2">
      <input
        type="text"
        value={query}
        onChange={(e) => setQuery(e.target.value)}
        placeholder="æœç´¢..."
        className="px-4 py-2 border rounded-lg flex-1"
      />
      <button
        type="submit"
        className="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700"
      >
        æœç´¢
      </button>
    </form>
  )
}
```

---

## 4. æ··åˆä½¿ç”¨ï¼šServer + Client Component

æœ€ä½³å®è·µæ˜¯ï¼š**åœ¨ Server Component ä¸­è·å–æ•°æ®ï¼Œä¼ é€’ç»™ Client Component è¿›è¡Œäº¤äº’**ã€‚

### å®æˆ˜æ¡ˆä¾‹ï¼šäº§å“åˆ—è¡¨ + è´­ç‰©è½¦

```tsx
// src/app/products/page.tsx
// Server Component - è·å–æ•°æ®
async function getProducts() {
  // ä»æ•°æ®åº“è·å–
  return [
    { id: '1', name: 'å•†å“A', price: 100 },
    { id: '2', name: 'å•†å“B', price: 200 },
  ]
}

export default async function ProductsPage() {
  const products = await getProducts()

  return (
    <div>
      <h1>å•†å“åˆ—è¡¨</h1>
      {/* å°†æ•°æ®ä¼ é€’ç»™ Client Component */}
      <ProductList products={products} />
    </div>
  )
}
```

```tsx
// src/components/ProductList.tsx
'use client'

import { useState } from 'react'

interface Product {
  id: string
  name: string
  price: number
}

interface ProductListProps {
  products: Product[] // ä» Server Component æ¥æ”¶æ•°æ®
}

export default function ProductList({ products }: ProductListProps) {
  const [cart, setCart] = useState<Product[]>([])

  const addToCart = (product: Product) => {
    setCart([...cart, product])
  }

  return (
    <div>
      <div className="grid gap-4">
        {products.map((product) => (
          <div key={product.id} className="border p-4 rounded">
            <h3>{product.name}</h3>
            <p>Â¥{product.price}</p>
            <button
              onClick={() => addToCart(product)}
              className="mt-2 bg-blue-600 text-white px-4 py-2 rounded"
            >
              åŠ å…¥è´­ç‰©è½¦
            </button>
          </div>
        ))}
      </div>
      
      <div className="mt-8">
        <h2>è´­ç‰©è½¦ ({cart.length})</h2>
        {cart.map((item) => (
          <div key={item.id}>{item.name}</div>
        ))}
      </div>
    </div>
  )
}
```

---

## 5. ç»„ä»¶ç»„ç»‡æœ€ä½³å®è·µ

### ç›®å½•ç»“æ„

```
src/
â”œâ”€â”€ app/                    # é¡µé¢ï¼ˆServer Componentï¼‰
â”‚   â”œâ”€â”€ page.tsx
â”‚   â””â”€â”€ blog/
â”‚       â””â”€â”€ page.tsx
â”œâ”€â”€ components/             # å¯å¤ç”¨ç»„ä»¶
â”‚   â”œâ”€â”€ ui/                 # UI ç»„ä»¶ï¼ˆClient Componentï¼‰
â”‚   â”‚   â”œâ”€â”€ Button.tsx
â”‚   â”‚   â””â”€â”€ Input.tsx
â”‚   â”œâ”€â”€ features/           # åŠŸèƒ½ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ SearchBox.tsx   # Client Component
â”‚   â”‚   â””â”€â”€ ProductList.tsx  # Client Component
â”‚   â””â”€â”€ server/              # Server Componentï¼ˆå¯é€‰ï¼‰
â”‚       â””â”€â”€ DataFetcher.tsx
â””â”€â”€ lib/                    # å·¥å…·å‡½æ•°
    â””â”€â”€ utils.ts
```

### ç»„ä»¶å‘½åè§„èŒƒ

- **PascalCase**ï¼šç»„ä»¶æ–‡ä»¶åå’Œç»„ä»¶å
- **æè¿°æ€§å‘½å**ï¼š`UserProfile` è€Œä¸æ˜¯ `Profile`
- **åŠŸèƒ½åˆ†ç»„**ï¼šç›¸å…³ç»„ä»¶æ”¾åœ¨åŒä¸€æ–‡ä»¶å¤¹

---

## 6. Props ç±»å‹å®šä¹‰

### ä½¿ç”¨ TypeScript å®šä¹‰ Props

```tsx
// src/components/Button.tsx
'use client'

interface ButtonProps {
  children: React.ReactNode
  onClick?: () => void
  variant?: 'primary' | 'secondary'
  disabled?: boolean
}

export default function Button({
  children,
  onClick,
  variant = 'primary',
  disabled = false,
}: ButtonProps) {
  return (
    <button
      onClick={onClick}
      disabled={disabled}
      className={`
        px-4 py-2 rounded-lg
        ${variant === 'primary' ? 'bg-blue-600 text-white' : 'bg-gray-200'}
        ${disabled ? 'opacity-50 cursor-not-allowed' : 'hover:opacity-90'}
      `}
    >
      {children}
    </button>
  )
}
```

### ä½¿ç”¨ç¤ºä¾‹

```tsx
// src/app/page.tsx
import Button from '@/components/Button'

export default function Home() {
  return (
    <div>
      <Button variant="primary" onClick={() => alert('ç‚¹å‡»äº†')}>
        ä¸»è¦æŒ‰é’®
      </Button>
      <Button variant="secondary">æ¬¡è¦æŒ‰é’®</Button>
      <Button disabled>ç¦ç”¨æŒ‰é’®</Button>
    </div>
  )
}
```

---

## 7. å®æˆ˜æ¡ˆä¾‹ï¼šå¾…åŠäº‹é¡¹åº”ç”¨

### éœ€æ±‚
åˆ›å»ºä¸€ä¸ªå¾…åŠäº‹é¡¹åº”ç”¨ï¼š
- æ˜¾ç¤ºå¾…åŠåˆ—è¡¨ï¼ˆServer Component è·å–æ•°æ®ï¼‰
- æ·»åŠ æ–°å¾…åŠï¼ˆClient Component å¤„ç†äº¤äº’ï¼‰
- åˆ‡æ¢å®ŒæˆçŠ¶æ€ï¼ˆClient Componentï¼‰

### å®ç°

```tsx
// src/app/todos/page.tsx
// Server Component - è·å–åˆå§‹æ•°æ®
async function getTodos() {
  // å®é™…é¡¹ç›®ä¸­ä»æ•°æ®åº“è·å–
  return [
    { id: '1', text: 'å­¦ä¹  Next.js', completed: false },
    { id: '2', text: 'å®Œæˆé¡¹ç›®', completed: true },
  ]
}

export default async function TodosPage() {
  const initialTodos = await getTodos()

  return (
    <div className="max-w-2xl mx-auto px-4 py-20">
      <h1 className="text-4xl font-bold mb-8">å¾…åŠäº‹é¡¹</h1>
      <TodoApp initialTodos={initialTodos} />
    </div>
  )
}
```

```tsx
// src/components/TodoApp.tsx
'use client'

import { useState } from 'react'

interface Todo {
  id: string
  text: string
  completed: boolean
}

interface TodoAppProps {
  initialTodos: Todo[]
}

export default function TodoApp({ initialTodos }: TodoAppProps) {
  const [todos, setTodos] = useState<Todo[]>(initialTodos)
  const [input, setInput] = useState('')

  const addTodo = () => {
    if (input.trim()) {
      const newTodo: Todo = {
        id: Date.now().toString(),
        text: input,
        completed: false,
      }
      setTodos([...todos, newTodo])
      setInput('')
    }
  }

  const toggleTodo = (id: string) => {
    setTodos(
      todos.map((todo) =>
        todo.id === id ? { ...todo, completed: !todo.completed } : todo
      )
    )
  }

  const deleteTodo = (id: string) => {
    setTodos(todos.filter((todo) => todo.id !== id))
  }

  return (
    <div>
      {/* æ·»åŠ å¾…åŠ */}
      <div className="flex gap-2 mb-6">
        <input
          type="text"
          value={input}
          onChange={(e) => setInput(e.target.value)}
          onKeyPress={(e) => e.key === 'Enter' && addTodo()}
          placeholder="è¾“å…¥å¾…åŠäº‹é¡¹..."
          className="flex-1 px-4 py-2 border rounded-lg"
        />
        <button
          onClick={addTodo}
          className="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700"
        >
          æ·»åŠ 
        </button>
      </div>

      {/* å¾…åŠåˆ—è¡¨ */}
      <div className="space-y-2">
        {todos.map((todo) => (
          <div
            key={todo.id}
            className={`flex items-center gap-3 p-4 bg-white rounded-lg shadow ${
              todo.completed ? 'opacity-60' : ''
            }`}
          >
            <input
              type="checkbox"
              checked={todo.completed}
              onChange={() => toggleTodo(todo.id)}
              className="w-5 h-5"
            />
            <span
              className={`flex-1 ${
                todo.completed ? 'line-through text-gray-500' : ''
              }`}
            >
              {todo.text}
            </span>
            <button
              onClick={() => deleteTodo(todo.id)}
              className="text-red-600 hover:text-red-800"
            >
              åˆ é™¤
            </button>
          </div>
        ))}
      </div>

      {/* ç»Ÿè®¡ */}
      <div className="mt-6 text-gray-600">
        æ€»è®¡ï¼š{todos.length} | å·²å®Œæˆï¼š{todos.filter((t) => t.completed).length} | æœªå®Œæˆï¼š{todos.filter((t) => !t.completed).length}
      </div>
    </div>
  )
}
```

---

## 8. å¸¸è§é”™è¯¯å’Œè§£å†³æ–¹æ¡ˆ

### é”™è¯¯ 1ï¼šåœ¨ Server Component ä¸­ä½¿ç”¨ Hooks

```tsx
// âŒ é”™è¯¯
export default function Page() {
  const [count, setCount] = useState(0) // é”™è¯¯ï¼
  return <div>{count}</div>
}

// âœ… æ­£ç¡®ï¼šæ·»åŠ  'use client'
'use client'
export default function Page() {
  const [count, setCount] = useState(0)
  return <div>{count}</div>
}
```

### é”™è¯¯ 2ï¼šåœ¨ Client Component ä¸­ç›´æ¥è®¿é—®æ•°æ®åº“

```tsx
// âŒ é”™è¯¯
'use client'
import { db } from '@/lib/db'

export default function Component() {
  const data = db.query() // é”™è¯¯ï¼æ•°æ®åº“åªèƒ½åœ¨æœåŠ¡ç«¯è®¿é—®
  return <div>{data}</div>
}

// âœ… æ­£ç¡®ï¼šé€šè¿‡ API è·¯ç”±
'use client'
export default function Component() {
  const [data, setData] = useState(null)
  
  useEffect(() => {
    fetch('/api/data')
      .then(res => res.json())
      .then(setData)
  }, [])
  
  return <div>{data}</div>
}
```

### é”™è¯¯ 3ï¼šå°† Server Component ä½œä¸º Client Component çš„å­ç»„ä»¶

```tsx
// âŒ é”™è¯¯
'use client'
export default function ClientComponent() {
  return (
    <div>
      <ServerComponent /> {/* é”™è¯¯ï¼ä¸èƒ½è¿™æ ·åš */}
    </div>
  )
}

// âœ… æ­£ç¡®ï¼šå°† Server Component ä½œä¸º props ä¼ é€’
'use client'
export default function ClientComponent({ children }: { children: React.ReactNode }) {
  return <div>{children}</div>
}

// ä½¿ç”¨
export default function Page() {
  return (
    <ClientComponent>
      <ServerComponent /> {/* âœ… æ­£ç¡® */}
    </ClientComponent>
  )
}
```

---

## 9. æ€»ç»“

æœ¬ç« æˆ‘ä»¬å­¦ä¹ äº†ï¼š
1. âœ… Server Component å’Œ Client Component çš„åŒºåˆ«
2. âœ… ä½•æ—¶ä½¿ç”¨ Server Componentï¼ˆæ•°æ®è·å–ã€æ€§èƒ½ä¼˜åŒ–ï¼‰
3. âœ… ä½•æ—¶ä½¿ç”¨ Client Componentï¼ˆç”¨æˆ·äº¤äº’ã€çŠ¶æ€ç®¡ç†ï¼‰
4. âœ… æ··åˆä½¿ç”¨çš„æœ€ä½³å®è·µ
5. âœ… æ„å»ºäº†å®Œæ•´çš„å¾…åŠäº‹é¡¹åº”ç”¨

**å…³é”®åŸåˆ™**ï¼š
- ğŸ¯ **é»˜è®¤ä½¿ç”¨ Server Component**ï¼ˆæ€§èƒ½æ›´å¥½ï¼‰
- ğŸ¯ **åªåœ¨éœ€è¦äº¤äº’æ—¶ä½¿ç”¨ Client Component**ï¼ˆå‡å°‘ JS ä½“ç§¯ï¼‰
- ğŸ¯ **Server Component è·å–æ•°æ®ï¼ŒClient Component å¤„ç†äº¤äº’**

**ä¸‹ä¸€æ­¥**ï¼šåœ¨ä¸‹ä¸€ç« ï¼Œæˆ‘ä»¬å°†å­¦ä¹ æ ·å¼æ–¹æ¡ˆï¼ŒåŒ…æ‹¬ Tailwind CSS å’Œ CSS Modules çš„ä½¿ç”¨ã€‚

