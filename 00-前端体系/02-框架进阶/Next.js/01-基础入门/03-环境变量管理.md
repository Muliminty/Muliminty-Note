# 03. ç¯å¢ƒå˜é‡ç®¡ç†

ç¯å¢ƒå˜é‡æ˜¯åŒºåˆ†å¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒçš„å…³é”®ã€‚Next.js æä¾›äº†å¼ºå¤§çš„ç¯å¢ƒå˜é‡ç®¡ç†æœºåˆ¶ï¼Œä½†ä¹Ÿæœ‰ä¸€äº›å®‰å…¨é™·é˜±éœ€è¦æ³¨æ„ã€‚

---

## 1. ç¯å¢ƒå˜é‡æ–‡ä»¶

Next.js æ”¯æŒå¤šç§ç¯å¢ƒå˜é‡æ–‡ä»¶ï¼ŒæŒ‰ä¼˜å…ˆçº§ä»é«˜åˆ°ä½ï¼š

| æ–‡ä»¶å | ä½¿ç”¨åœºæ™¯ | ä¼˜å…ˆçº§ |
|--------|----------|--------|
| `.env.local` | æœ¬åœ°å¼€å‘ï¼Œ**ä¸åº”è¯¥æäº¤åˆ° Git** | æœ€é«˜ |
| `.env.development` | å¼€å‘ç¯å¢ƒ | ä¸­ |
| `.env.production` | ç”Ÿäº§ç¯å¢ƒ | ä¸­ |
| `.env` | æ‰€æœ‰ç¯å¢ƒé€šç”¨ | æœ€ä½ |

### æ–‡ä»¶åŠ è½½é¡ºåº

Next.js ä¼šæŒ‰ä»¥ä¸‹é¡ºåºåŠ è½½ç¯å¢ƒå˜é‡ï¼š
1. `.env`ï¼ˆæ‰€æœ‰ç¯å¢ƒï¼‰
2. `.env.development` æˆ– `.env.production`ï¼ˆæ ¹æ® `NODE_ENV`ï¼‰
3. `.env.local`ï¼ˆæ‰€æœ‰ç¯å¢ƒï¼Œä½†ä¼˜å…ˆçº§æœ€é«˜ï¼‰

**é‡è¦**ï¼šååŠ è½½çš„å˜é‡ä¼šè¦†ç›–å…ˆåŠ è½½çš„å˜é‡ã€‚

---

## 2. å®¢æˆ·ç«¯ vs æœåŠ¡ç«¯å˜é‡

è¿™æ˜¯ Next.js ç¯å¢ƒå˜é‡ç®¡ç†çš„æ ¸å¿ƒæ¦‚å¿µã€‚

### æœåŠ¡ç«¯å˜é‡ï¼ˆé»˜è®¤ï¼‰

æ‰€æœ‰ç¯å¢ƒå˜é‡é»˜è®¤åªåœ¨**æœåŠ¡ç«¯**å¯ç”¨ï¼Œä¸ä¼šæš´éœ²åˆ°å®¢æˆ·ç«¯ã€‚

```bash
# .env.local
DATABASE_URL=postgresql://localhost:5432/mydb
API_SECRET_KEY=super-secret-key-123
```

```tsx
// âœ… æœåŠ¡ç«¯ç»„ä»¶å¯ä»¥ä½¿ç”¨
export default async function Page() {
  const dbUrl = process.env.DATABASE_URL // âœ… å¯ä»¥è®¿é—®
  return <div>...</div>
}

// âŒ å®¢æˆ·ç«¯ç»„ä»¶ä¸èƒ½ä½¿ç”¨
'use client'
export default function ClientComponent() {
  const dbUrl = process.env.DATABASE_URL // âŒ undefined
  return <div>...</div>
}
```

### å®¢æˆ·ç«¯å˜é‡ï¼ˆéœ€è¦å‰ç¼€ï¼‰

å¦‚æœå˜é‡éœ€è¦åœ¨**å®¢æˆ·ç«¯**ä½¿ç”¨ï¼Œå¿…é¡»åŠ ä¸Š `NEXT_PUBLIC_` å‰ç¼€ã€‚

```bash
# .env.local
NEXT_PUBLIC_API_URL=https://api.example.com
NEXT_PUBLIC_APP_NAME=My App
```

```tsx
// âœ… å®¢æˆ·ç«¯ç»„ä»¶å¯ä»¥ä½¿ç”¨
'use client'
export default function ClientComponent() {
  const apiUrl = process.env.NEXT_PUBLIC_API_URL // âœ… å¯ä»¥è®¿é—®
  return <div>{apiUrl}</div>
}
```

> âš ï¸ **å®‰å…¨è­¦å‘Š**ï¼š`NEXT_PUBLIC_` å‰ç¼€çš„å˜é‡ä¼šè¢«æ‰“åŒ…åˆ°å®¢æˆ·ç«¯ JS ä¸­ï¼Œä»»ä½•äººéƒ½å¯ä»¥åœ¨æµè§ˆå™¨ä¸­çœ‹åˆ°ã€‚**æ°¸è¿œä¸è¦**æŠŠæ•æ„Ÿä¿¡æ¯ï¼ˆå¦‚ API å¯†é’¥ã€æ•°æ®åº“å¯†ç ï¼‰æ”¾åœ¨ `NEXT_PUBLIC_` å˜é‡ä¸­ã€‚

---

## 3. å®æˆ˜æ¡ˆä¾‹

### æ¡ˆä¾‹ 1ï¼šAPI é…ç½®

**åœºæ™¯**ï¼šå¼€å‘ç¯å¢ƒä½¿ç”¨æœ¬åœ° APIï¼Œç”Ÿäº§ç¯å¢ƒä½¿ç”¨è¿œç¨‹ APIã€‚

```bash
# .env.development
NEXT_PUBLIC_API_URL=http://localhost:3001/api
API_SECRET_KEY=dev-secret-key

# .env.production
NEXT_PUBLIC_API_URL=https://api.production.com
API_SECRET_KEY=prod-secret-key-xxx
```

**ä½¿ç”¨**ï¼š
```tsx
// å®¢æˆ·ç«¯ç»„ä»¶
'use client'
export default function ApiComponent() {
  const apiUrl = process.env.NEXT_PUBLIC_API_URL
  
  const fetchData = async () => {
    const res = await fetch(`${apiUrl}/users`)
    return res.json()
  }
  
  return <button onClick={fetchData}>è·å–æ•°æ®</button>
}

// æœåŠ¡ç«¯ç»„ä»¶
export default async function ServerPage() {
  const apiUrl = process.env.NEXT_PUBLIC_API_URL
  const secretKey = process.env.API_SECRET_KEY // âœ… æœåŠ¡ç«¯å¯ç”¨
  
  const res = await fetch(`${apiUrl}/users`, {
    headers: {
      'Authorization': `Bearer ${secretKey}` // å®‰å…¨ï¼šå¯†é’¥ä¸ä¼šæš´éœ²åˆ°å®¢æˆ·ç«¯
    }
  })
  
  const data = await res.json()
  return <div>{/* æ¸²æŸ“æ•°æ® */}</div>
}
```

### æ¡ˆä¾‹ 2ï¼šæ•°æ®åº“è¿æ¥

**åœºæ™¯**ï¼šæ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ä¸åº”è¯¥æš´éœ²åˆ°å®¢æˆ·ç«¯ã€‚

```bash
# .env.localï¼ˆä¸æäº¤åˆ° Gitï¼‰
DATABASE_URL=postgresql://user:password@localhost:5432/mydb
```

```tsx
// âœ… åªèƒ½åœ¨æœåŠ¡ç«¯ä½¿ç”¨
// app/api/users/route.ts
import { PrismaClient } from '@prisma/client'

const prisma = new PrismaClient({
  datasources: {
    db: {
      url: process.env.DATABASE_URL, // âœ… æœåŠ¡ç«¯å®‰å…¨
    },
  },
})

export async function GET() {
  const users = await prisma.user.findMany()
  return Response.json(users)
}
```

### æ¡ˆä¾‹ 3ï¼šç¬¬ä¸‰æ–¹æœåŠ¡é…ç½®

**åœºæ™¯**ï¼šé›†æˆ Stripe æ”¯ä»˜ï¼ˆéœ€è¦å…¬é’¥å’Œç§é’¥ï¼‰ã€‚

```bash
# .env.local
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_test_xxx
STRIPE_SECRET_KEY=sk_test_xxx
```

```tsx
// å®¢æˆ·ç«¯ï¼šä½¿ç”¨å…¬é’¥
'use client'
import { loadStripe } from '@stripe/stripe-js'

const stripePromise = loadStripe(
  process.env.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY!
)

export default function CheckoutButton() {
  const handleCheckout = async () => {
    const stripe = await stripePromise
    // ä½¿ç”¨å…¬é’¥åˆå§‹åŒ– Stripe
  }
  
  return <button onClick={handleCheckout}>æ”¯ä»˜</button>
}

// æœåŠ¡ç«¯ï¼šä½¿ç”¨ç§é’¥
// app/api/checkout/route.ts
import Stripe from 'stripe'

const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!, {
  apiVersion: '2023-10-16',
})

export async function POST(request: Request) {
  // ä½¿ç”¨ç§é’¥åˆ›å»ºæ”¯ä»˜æ„å›¾
  const paymentIntent = await stripe.paymentIntents.create({
    amount: 1000,
    currency: 'usd',
  })
  
  return Response.json({ clientSecret: paymentIntent.client_secret })
}
```

---

## 4. ç±»å‹å®‰å…¨çš„ç¯å¢ƒå˜é‡

### åˆ›å»ºç±»å‹å®šä¹‰

```typescript
// src/types/env.d.ts
namespace NodeJS {
  interface ProcessEnv {
    // å®¢æˆ·ç«¯å˜é‡
    NEXT_PUBLIC_API_URL: string
    NEXT_PUBLIC_APP_NAME: string
    
    // æœåŠ¡ç«¯å˜é‡
    DATABASE_URL: string
    API_SECRET_KEY: string
  }
}
```

### ä½¿ç”¨éªŒè¯åº“ï¼ˆæ¨èï¼‰

ä½¿ç”¨ `zod` éªŒè¯ç¯å¢ƒå˜é‡ï¼Œç¡®ä¿ç±»å‹å®‰å…¨ï¼š

```bash
npm install zod
```

```typescript
// src/lib/env.ts
import { z } from 'zod'

const envSchema = z.object({
  // å®¢æˆ·ç«¯å˜é‡
  NEXT_PUBLIC_API_URL: z.string().url(),
  NEXT_PUBLIC_APP_NAME: z.string(),
  
  // æœåŠ¡ç«¯å˜é‡
  DATABASE_URL: z.string().url(),
  API_SECRET_KEY: z.string().min(1),
})

// éªŒè¯å¹¶å¯¼å‡º
export const env = envSchema.parse({
  NEXT_PUBLIC_API_URL: process.env.NEXT_PUBLIC_API_URL,
  NEXT_PUBLIC_APP_NAME: process.env.NEXT_PUBLIC_APP_NAME,
  DATABASE_URL: process.env.DATABASE_URL,
  API_SECRET_KEY: process.env.API_SECRET_KEY,
})

// ä½¿ç”¨
// import { env } from '@/lib/env'
// const apiUrl = env.NEXT_PUBLIC_API_URL // ç±»å‹å®‰å…¨
```

---

## 5. .gitignore é…ç½®

ç¡®ä¿æ•æ„Ÿä¿¡æ¯ä¸ä¼šè¢«æäº¤åˆ° Gitï¼š

```gitignore
# .gitignore

# ç¯å¢ƒå˜é‡æ–‡ä»¶
.env*.local
.env.local
.env.development.local
.env.test.local
.env.production.local

# ä½†ä¿ç•™ç¤ºä¾‹æ–‡ä»¶
!.env.example
```

**åˆ›å»º `.env.example` ä½œä¸ºæ¨¡æ¿**ï¼š

```bash
# .env.example
NEXT_PUBLIC_API_URL=https://api.example.com
DATABASE_URL=postgresql://localhost:5432/mydb
API_SECRET_KEY=your-secret-key
```

å›¢é˜Ÿæˆå‘˜å¯ä»¥å¤åˆ¶ `.env.example` ä¸º `.env.local` å¹¶å¡«å…¥å®é™…å€¼ã€‚

---

## 6. è¿è¡Œæ—¶ç¯å¢ƒå˜é‡

### åœ¨ Vercel ä¸­é…ç½®

1. è¿›å…¥é¡¹ç›®è®¾ç½®
2. æ‰¾åˆ° "Environment Variables"
3. æ·»åŠ å˜é‡ï¼ˆä¼šè‡ªåŠ¨åŒºåˆ†å¼€å‘/é¢„è§ˆ/ç”Ÿäº§ç¯å¢ƒï¼‰

### åœ¨ Docker ä¸­é…ç½®

```dockerfile
# Dockerfile
FROM node:18-alpine

WORKDIR /app

COPY package*.json ./
RUN npm install

COPY . .

# æ„å»ºæ—¶ä¼ å…¥ç¯å¢ƒå˜é‡
ARG NEXT_PUBLIC_API_URL
ENV NEXT_PUBLIC_API_URL=$NEXT_PUBLIC_API_URL

RUN npm run build

CMD ["npm", "start"]
```

```bash
# è¿è¡Œå®¹å™¨æ—¶ä¼ å…¥
docker build --build-arg NEXT_PUBLIC_API_URL=https://api.example.com .
```

---

## 7. å¸¸è§é”™è¯¯å’Œè§£å†³æ–¹æ¡ˆ

### é”™è¯¯ 1ï¼šå®¢æˆ·ç«¯è®¿é—®æœåŠ¡ç«¯å˜é‡

```tsx
// âŒ é”™è¯¯
'use client'
export default function Component() {
  const secret = process.env.API_SECRET_KEY // undefined
  return <div>{secret}</div>
}

// âœ… æ­£ç¡®ï¼šé€šè¿‡ API è·¯ç”±è·å–
'use client'
export default function Component() {
  const [data, setData] = useState(null)
  
  useEffect(() => {
    fetch('/api/secret-data')
      .then(res => res.json())
      .then(setData)
  }, [])
  
  return <div>{data}</div>
}
```

### é”™è¯¯ 2ï¼šå¿˜è®° NEXT_PUBLIC_ å‰ç¼€

```tsx
// âŒ é”™è¯¯
'use client'
const apiUrl = process.env.API_URL // undefined

// âœ… æ­£ç¡®
const apiUrl = process.env.NEXT_PUBLIC_API_URL
```

### é”™è¯¯ 3ï¼šåœ¨æ„å»ºæ—¶ä½¿ç”¨è¿è¡Œæ—¶å˜é‡

```tsx
// âŒ é”™è¯¯ï¼šæ„å»ºæ—¶ NEXT_PUBLIC_API_URL å¯èƒ½ä¸å­˜åœ¨
const apiUrl = process.env.NEXT_PUBLIC_API_URL || 'default'

// âœ… æ­£ç¡®ï¼šä½¿ç”¨éªŒè¯
import { env } from '@/lib/env'
const apiUrl = env.NEXT_PUBLIC_API_URL
```

---

## 8. å®æˆ˜ç»ƒä¹ ï¼šé…ç½®å¤šç¯å¢ƒé¡¹ç›®

### éœ€æ±‚
åˆ›å»ºä¸€ä¸ªæ”¯æŒå¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ä¸‰ç¯å¢ƒçš„é¡¹ç›®é…ç½®ã€‚

### å®ç°æ­¥éª¤

**æ­¥éª¤ 1ï¼šåˆ›å»ºç¯å¢ƒå˜é‡æ–‡ä»¶**

```bash
# .env.development
NEXT_PUBLIC_API_URL=http://localhost:3001
NEXT_PUBLIC_ENV=development

# .env.production
NEXT_PUBLIC_API_URL=https://api.production.com
NEXT_PUBLIC_ENV=production

# .env.localï¼ˆä¸æäº¤ï¼‰
DATABASE_URL=postgresql://localhost:5432/devdb
```

**æ­¥éª¤ 2ï¼šåˆ›å»ºç±»å‹å®šä¹‰**

```typescript
// src/types/env.d.ts
namespace NodeJS {
  interface ProcessEnv {
    NEXT_PUBLIC_API_URL: string
    NEXT_PUBLIC_ENV: 'development' | 'production' | 'test'
    DATABASE_URL: string
  }
}
```

**æ­¥éª¤ 3ï¼šä½¿ç”¨ç¯å¢ƒå˜é‡**

```tsx
// src/app/page.tsx
export default function Home() {
  const apiUrl = process.env.NEXT_PUBLIC_API_URL
  const env = process.env.NEXT_PUBLIC_ENV
  
  return (
    <div>
      <h1>å½“å‰ç¯å¢ƒï¼š{env}</h1>
      <p>API åœ°å€ï¼š{apiUrl}</p>
    </div>
  )
}
```

---

## 9. æ€»ç»“

æœ¬ç« æˆ‘ä»¬å­¦ä¹ äº†ï¼š
1. âœ… ç¯å¢ƒå˜é‡æ–‡ä»¶çš„ä¼˜å…ˆçº§å’ŒåŠ è½½é¡ºåº
2. âœ… å®¢æˆ·ç«¯å˜é‡ï¼ˆ`NEXT_PUBLIC_`ï¼‰å’ŒæœåŠ¡ç«¯å˜é‡çš„åŒºåˆ«
3. âœ… å¦‚ä½•å®‰å…¨åœ°ç®¡ç†æ•æ„Ÿä¿¡æ¯
4. âœ… ç±»å‹å®‰å…¨çš„ç¯å¢ƒå˜é‡éªŒè¯
5. âœ… å¤šç¯å¢ƒé…ç½®æœ€ä½³å®è·µ

**å®‰å…¨è¦ç‚¹**ï¼š
- ğŸ”’ æ°¸è¿œä¸è¦æŠŠæ•æ„Ÿä¿¡æ¯æ”¾åœ¨ `NEXT_PUBLIC_` å˜é‡ä¸­
- ğŸ”’ `.env.local` ä¸è¦æäº¤åˆ° Git
- ğŸ”’ ä½¿ç”¨ `zod` éªŒè¯ç¯å¢ƒå˜é‡ï¼Œç¡®ä¿ç±»å‹å®‰å…¨

**ä¸‹ä¸€æ­¥**ï¼šåœ¨ä¸‹ä¸€ç« ï¼Œæˆ‘ä»¬å°†é€šè¿‡å®æˆ˜åˆ›å»ºå¤šä¸ªé¡µé¢ï¼Œæ·±å…¥å­¦ä¹  Next.js çš„è·¯ç”±ç³»ç»Ÿã€‚

