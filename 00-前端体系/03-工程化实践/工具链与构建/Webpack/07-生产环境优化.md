# ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–

> ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–æ˜¯ Webpack é…ç½®çš„é‡è¦éƒ¨åˆ†ã€‚æœ¬ç« ä»‹ç»ä»£ç å‹ç¼©ã€Tree Shakingã€ä½œç”¨åŸŸæå‡ç­‰ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–æŠ€å·§ã€‚

---

## ğŸ“‹ å­¦ä¹ ç›®æ ‡

- âœ… æŒæ¡ä»£ç å‹ç¼©é…ç½®
- âœ… ç†è§£ Tree Shaking åŸç†
- âœ… å­¦ä¼šä½œç”¨åŸŸæå‡
- âœ… æŒæ¡èµ„æºä¼˜åŒ–æŠ€å·§
- âœ… äº†è§£ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ

---

## ä»£ç å‹ç¼©

### JavaScript å‹ç¼©

**å®‰è£… TerserPlugin**ï¼š
```bash
npm install --save-dev terser-webpack-plugin
```

**é…ç½®**ï¼š
```javascript
const TerserPlugin = require('terser-webpack-plugin')

module.exports = {
  mode: 'production',
  optimization: {
    minimize: true,
    minimizer: [
      new TerserPlugin({
        terserOptions: {
          compress: {
            drop_console: true,  // ç§»é™¤ console
            drop_debugger: true,  // ç§»é™¤ debugger
            pure_funcs: ['console.log']  // ç§»é™¤æŒ‡å®šå‡½æ•°
          },
          format: {
            comments: false  // ç§»é™¤æ³¨é‡Š
          }
        },
        extractComments: false
      })
    ]
  }
}
```

### CSS å‹ç¼©

**å®‰è£… CssMinimizerPlugin**ï¼š
```bash
npm install --save-dev css-minimizer-webpack-plugin
```

**é…ç½®**ï¼š
```javascript
const CssMinimizerPlugin = require('css-minimizer-webpack-plugin')

module.exports = {
  optimization: {
    minimizer: [
      new CssMinimizerPlugin({
        minimizerOptions: {
          preset: [
            'default',
            {
              discardComments: { removeAll: true }
            }
          ]
        }
      })
    ]
  }
}
```

### HTML å‹ç¼©

```javascript
const HtmlWebpackPlugin = require('html-webpack-plugin')

module.exports = {
  plugins: [
    new HtmlWebpackPlugin({
      template: './src/index.html',
      minify: {
        removeComments: true,
        collapseWhitespace: true,
        removeRedundantAttributes: true,
        useShortDoctype: true,
        removeEmptyAttributes: true,
        removeStyleLinkTypeAttributes: true,
        minifyJS: true,
        minifyCSS: true
      }
    })
  ]
}
```

---

## Tree Shaking

Tree Shaking ç”¨äºç§»é™¤æœªä½¿ç”¨çš„ä»£ç ã€‚

### å¯ç”¨ Tree Shaking

```javascript
module.exports = {
  mode: 'production',  // è‡ªåŠ¨å¯ç”¨ Tree Shaking
  optimization: {
    usedExports: true,
    sideEffects: false
  }
}
```

### æ ‡è®°å‰¯ä½œç”¨

åœ¨ `package.json` ä¸­æ ‡è®°å‰¯ä½œç”¨ï¼š

```json
{
  "sideEffects": false  // æ— å‰¯ä½œç”¨ï¼Œå¯ä»¥å®‰å…¨åœ°è¿›è¡Œ Tree Shaking
}
```

æˆ–è€…æŒ‡å®šæœ‰å‰¯ä½œç”¨çš„æ–‡ä»¶ï¼š

```json
{
  "sideEffects": [
    "*.css",
    "*.scss",
    "./src/polyfills.js"
  ]
}
```

### ES Module è¦æ±‚

Tree Shaking è¦æ±‚ä½¿ç”¨ ES Moduleï¼š

```javascript
// âœ… æ”¯æŒ Tree Shaking
import { func1, func2 } from './utils'
export { func1 }

// âŒ ä¸æ”¯æŒ Tree Shaking
const utils = require('./utils')
module.exports = utils
```

### ç¤ºä¾‹

**utils.js**ï¼š
```javascript
export function used() {
  return 'used'
}

export function unused() {
  return 'unused'
}
```

**index.js**ï¼š
```javascript
import { used } from './utils'
console.log(used())
```

**ç»“æœ**ï¼š`unused` å‡½æ•°ä¼šè¢«ç§»é™¤ã€‚

---

## ä½œç”¨åŸŸæå‡ï¼ˆScope Hoistingï¼‰

ä½œç”¨åŸŸæå‡å¯ä»¥å‡å°‘å‡½æ•°å£°æ˜å’Œé—­åŒ…ï¼Œæå‡ä»£ç æ‰§è¡Œæ•ˆç‡ã€‚

### å¯ç”¨ä½œç”¨åŸŸæå‡

```javascript
module.exports = {
  optimization: {
    concatenateModules: true  // å¯ç”¨ä½œç”¨åŸŸæå‡
  }
}
```

### æ•ˆæœå¯¹æ¯”

**æœªå¯ç”¨**ï¼š
```javascript
// æ¯ä¸ªæ¨¡å—éƒ½è¢«åŒ…è£…åœ¨å‡½æ•°ä¸­
(function(module, exports, __webpack_require__) {
  // æ¨¡å—ä»£ç 
})
```

**å¯ç”¨å**ï¼š
```javascript
// æ¨¡å—ä»£ç ç›´æ¥åˆå¹¶ï¼Œå‡å°‘å‡½æ•°åŒ…è£…
// æ›´å°‘çš„é—­åŒ…ï¼Œæ›´å¿«çš„æ‰§è¡Œé€Ÿåº¦
```

---

## èµ„æºä¼˜åŒ–

### å›¾ç‰‡ä¼˜åŒ–

```javascript
module.exports = {
  module: {
    rules: [
      {
        test: /\.(png|jpg|jpeg|gif|svg)$/,
        type: 'asset',
        parser: {
          dataUrlCondition: {
            maxSize: 8 * 1024  // 8KB ä»¥ä¸‹è½¬ base64
          }
        },
        generator: {
          filename: 'images/[hash][ext]'
        }
      }
    ]
  }
}
```

### å­—ä½“ä¼˜åŒ–

```javascript
module.exports = {
  module: {
    rules: [
      {
        test: /\.(woff|woff2|eot|ttf|otf)$/,
        type: 'asset/resource',
        generator: {
          filename: 'fonts/[hash][ext]'
        }
      }
    ]
  }
}
```

### ä½¿ç”¨ CDN

```javascript
module.exports = {
  externals: {
    'react': 'React',
    'react-dom': 'ReactDOM',
    'lodash': '_'
  },
  output: {
    publicPath: 'https://cdn.example.com/'
  }
}
```

---

## ç”Ÿäº§ç¯å¢ƒé…ç½®ç¤ºä¾‹

### å®Œæ•´é…ç½®

```javascript
const path = require('path')
const TerserPlugin = require('terser-webpack-plugin')
const CssMinimizerPlugin = require('css-minimizer-webpack-plugin')
const MiniCssExtractPlugin = require('mini-css-extract-plugin')
const HtmlWebpackPlugin = require('html-webpack-plugin')
const { CleanWebpackPlugin } = require('clean-webpack-plugin')

module.exports = {
  mode: 'production',
  
  entry: './src/index.js',
  
  output: {
    path: path.resolve(__dirname, 'dist'),
    filename: 'js/[name].[contenthash:8].js',
    chunkFilename: 'js/[name].[contenthash:8].chunk.js',
    clean: true
  },
  
  devtool: 'source-map',
  
  optimization: {
    minimize: true,
    minimizer: [
      new TerserPlugin({
        terserOptions: {
          compress: {
            drop_console: true,
            drop_debugger: true
          }
        }
      }),
      new CssMinimizerPlugin()
    ],
    usedExports: true,
    sideEffects: false,
    concatenateModules: true
  },
  
  module: {
    rules: [
      {
        test: /\.css$/,
        use: [
          MiniCssExtractPlugin.loader,
          'css-loader'
        ]
      }
    ]
  },
  
  plugins: [
    new CleanWebpackPlugin(),
    new HtmlWebpackPlugin({
      template: './src/index.html',
      minify: {
        removeComments: true,
        collapseWhitespace: true
      }
    }),
    new MiniCssExtractPlugin({
      filename: 'css/[name].[contenthash:8].css'
    })
  ]
}
```

---

## æœ€ä½³å®è·µ

### 1. ä½¿ç”¨ contenthash å®ç°é•¿æœŸç¼“å­˜

```javascript
module.exports = {
  output: {
    filename: '[name].[contenthash:8].js'
  }
}
```

### 2. åˆ†ç¦»ç¬¬ä¸‰æ–¹åº“

```javascript
module.exports = {
  optimization: {
    splitChunks: {
      cacheGroups: {
        vendor: {
          test: /[\\/]node_modules[\\/]/,
          name: 'vendors',
          chunks: 'all'
        }
      }
    }
  }
}
```

### 3. ä½¿ç”¨ Source Mapï¼ˆå¯é€‰ï¼‰

```javascript
module.exports = {
  devtool: 'source-map'  // æˆ– 'hidden-source-map'
}
```

### 4. å¯ç”¨ Gzip å‹ç¼©

```javascript
const CompressionPlugin = require('compression-webpack-plugin')

module.exports = {
  plugins: [
    new CompressionPlugin({
      algorithm: 'gzip'
    })
  ]
}
```

---

## æ€»ç»“

- **ä»£ç å‹ç¼©**ï¼šä½¿ç”¨ TerserPlugin å’Œ CssMinimizerPlugin
- **Tree Shaking**ï¼šç§»é™¤æœªä½¿ç”¨çš„ä»£ç 
- **ä½œç”¨åŸŸæå‡**ï¼šå‡å°‘å‡½æ•°åŒ…è£…ï¼Œæå‡æ€§èƒ½
- **èµ„æºä¼˜åŒ–**ï¼šå›¾ç‰‡ã€å­—ä½“ç­‰èµ„æºä¼˜åŒ–
- **é•¿æœŸç¼“å­˜**ï¼šä½¿ç”¨ contenthash å®ç°ç¼“å­˜ä¼˜åŒ–

---

## ä¸‹ä¸€æ­¥

- [ä»£ç åˆ†å‰²](./08-ä»£ç åˆ†å‰².md) - å­¦ä¹ ä»£ç åˆ†å‰²ç­–ç•¥
- [æ€§èƒ½ä¼˜åŒ–](./09-æ€§èƒ½ä¼˜åŒ–.md) - å­¦ä¹ æ€§èƒ½ä¼˜åŒ–æŠ€å·§
- [æœ€ä½³å®è·µ](./14-æœ€ä½³å®è·µ.md) - å­¦ä¹ æœ€ä½³å®è·µ

---

#Webpack #ç”Ÿäº§ç¯å¢ƒ #ä¼˜åŒ– #TreeShaking #ä»£ç å‹ç¼©

