# Gulp æ ¸å¿ƒæ¦‚å¿µ

> Gulp çš„æ ¸å¿ƒæ¦‚å¿µå’Œå·¥ä½œåŸç†è¯¦è§£

---

## ğŸ“‹ ç›®å½•

- [Streamï¼ˆæµï¼‰](#streamæµ)
- [Taskï¼ˆä»»åŠ¡ï¼‰](#taskä»»åŠ¡)
- [Srcï¼ˆæºæ–‡ä»¶ï¼‰](#srcæºæ–‡ä»¶)
- [Destï¼ˆç›®æ ‡æ–‡ä»¶ï¼‰](#destç›®æ ‡æ–‡ä»¶)
- [Watchï¼ˆç›‘å¬ï¼‰](#watchç›‘å¬)
- [Seriesï¼ˆä¸²è¡Œï¼‰](#seriesä¸²è¡Œ)
- [Parallelï¼ˆå¹¶è¡Œï¼‰](#parallelå¹¶è¡Œ)
- [Pipeï¼ˆç®¡é“ï¼‰](#pipeç®¡é“)

---

## Streamï¼ˆæµï¼‰

### ä»€ä¹ˆæ˜¯ Stream

Stream æ˜¯ Gulp çš„æ ¸å¿ƒæ¦‚å¿µï¼Œæ‰€æœ‰æ–‡ä»¶æ“ä½œéƒ½é€šè¿‡æµå®Œæˆã€‚æµæ˜¯æ•°æ®çš„ç®¡é“ï¼Œå¯ä»¥åœ¨ä¸ä¿å­˜ä¸­é—´æ–‡ä»¶çš„æƒ…å†µä¸‹å¤„ç†æ•°æ®ã€‚

```javascript
// ä¼ ç»Ÿæ–¹å¼ï¼šè¯»å–æ–‡ä»¶ â†’ å†™å…¥ä¸´æ—¶æ–‡ä»¶ â†’ å¤„ç† â†’ å†™å…¥ç»“æœ
const fs = require('fs');
const data = fs.readFileSync('src/app.js');
fs.writeFileSync('temp/app.js', data);
// ... å¤„ç† temp/app.js
fs.writeFileSync('dist/app.js', processedData);

// Gulp Stream æ–¹å¼ï¼šå†…å­˜ä¸­å¤„ç†
const { src, dest } = require('gulp');

src('src/app.js')        // è¯»å–æ–‡ä»¶ï¼ˆè¾“å…¥æµï¼‰
  .pipe(uglify())        // å‹ç¼©å¤„ç†ï¼ˆè½¬æ¢æµï¼‰
  .pipe(dest('dist/'));   // å†™å…¥æ–‡ä»¶ï¼ˆè¾“å‡ºæµï¼‰
```

### Stream ç±»å‹

```javascript
// 1. å¯è¯»æµï¼ˆReadable Streamï¼‰
const readable = fs.createReadStream('src/app.js');

// 2. å¯å†™æµï¼ˆWritable Streamï¼‰
const writable = fs.createWriteStream('dist/app.js');

// 3. è½¬æ¢æµï¼ˆTransform Streamï¼‰
const { Transform } = require('stream');
const transform = new Transform({
  transform(chunk, encoding, callback) {
    // å¤„ç†æ•°æ®
    this.push(processedChunk);
    callback();
  }
});
```

### Gulp Stream å·¥ä½œæµç¨‹

```
æ–‡ä»¶ç³»ç»Ÿ
    â†“
gulp.src()     â† è¯»å–æ–‡ä»¶ï¼Œåˆ›å»ºå¯è¯»æµ
    â†“
.pipe()        â† åº”ç”¨æ’ä»¶ï¼Œè½¬æ¢æµ
    â†“
.pipe()        â† åº”ç”¨æ’ä»¶ï¼Œè½¬æ¢æµ
    â†“
gulp.dest()    â† å†™å…¥æ–‡ä»¶ï¼Œåˆ›å»ºå¯å†™æµ
    â†“
æ–‡ä»¶ç³»ç»Ÿ
```

---

## Taskï¼ˆä»»åŠ¡ï¼‰

### ä»€ä¹ˆæ˜¯ Task

Task æ˜¯ Gulp çš„åŸºæœ¬æ‰§è¡Œå•å…ƒï¼Œä¸€ä¸ª Task æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œæ‰§è¡Œç‰¹å®šçš„æ„å»ºæ“ä½œã€‚

```javascript
// Gulp 3.x æ–¹å¼ï¼ˆå·²åºŸå¼ƒï¼‰
gulp.task('scripts', function() {
  return gulp.src('src/js/*.js')
    .pipe(uglify())
    .pipe(gulp.dest('dist/js'));
});

// Gulp 4.x æ–¹å¼ï¼ˆæ¨èï¼‰
function scripts() {
  return src('src/js/*.js')
    .pipe(uglify())
    .pipe(dest('dist/js'));
}

// å¯¼å‡ºä»»åŠ¡
exports.scripts = scripts;
```

### Task ç±»å‹

```javascript
// 1. å¼‚æ­¥ä»»åŠ¡ï¼ˆè¿”å› Streamï¼‰
function scripts() {
  return src('src/js/*.js')
    .pipe(uglify())
    .pipe(dest('dist/js'));
}

// 2. Promise ä»»åŠ¡
function clean() {
  return del(['dist/*']);
}

// 3. async/await ä»»åŠ¡
async function build() {
  await scripts();
  await styles();
  console.log('Build complete');
}

// 4. Callback ä»»åŠ¡
function callbackTask(cb) {
  console.log('Task running');
  cb(); // å¿…é¡»è°ƒç”¨ callback
}
```

### Task æ‰§è¡Œ

```bash
# æ‰§è¡Œå•ä¸ªä»»åŠ¡
gulp scripts
gulp styles
gulp build

# æ‰§è¡Œé»˜è®¤ä»»åŠ¡
gulp
```

---

## Srcï¼ˆæºæ–‡ä»¶ï¼‰

### åŸºæœ¬ç”¨æ³•

```javascript
const { src } = require('gulp');

// è¯»å–å•ä¸ªæ–‡ä»¶
src('src/app.js')

// è¯»å–å¤šä¸ªæ–‡ä»¶
src(['src/app.js', 'src/utils.js'])

// ä½¿ç”¨é€šé…ç¬¦
src('src/**/*.js')        // æ‰€æœ‰ JS æ–‡ä»¶
src('src/*.{js,css}')     // æ‰€æœ‰ JS å’Œ CSS æ–‡ä»¶
```

### é€šé…ç¬¦æ¨¡å¼

```javascript
// * åŒ¹é…ä»»æ„å­—ç¬¦ï¼ˆé™¤äº† /ï¼‰
src('src/*.js')           // src/app.js âœ“, src/utils.js âœ“
                          // src/sub/main.js âœ—

// ** åŒ¹é…ä»»æ„å±‚çº§ç›®å½•
src('src/**/*.js')        // src/app.js âœ“
                          // src/sub/main.js âœ“
                          // src/sub/deep/nested.js âœ“

// ! æ’é™¤æ–‡ä»¶
src(['src/**/*.js', '!src/test/**/*.js'])  // æ’é™¤ test ç›®å½•

// {} åŒ¹é…å¤šä¸ªé€‰é¡¹
src('src/*.{js,css,html}')
```

### Src é€‰é¡¹

```javascript
src('src/**/*.js', {
  allowEmpty: true,          // å…è®¸æºæ–‡ä»¶ä¸ºç©º
  base: 'src',               // è®¾ç½®åŸºç¡€ç›®å½•
  since: lastRunTime,        // åªå¤„ç†ä¿®æ”¹è¿‡çš„æ–‡ä»¶
  dot: false,                // æ˜¯å¦åŒ…å«éšè—æ–‡ä»¶
  followSymlinks: true,      // æ˜¯å¦è·Ÿéšç¬¦å·é“¾æ¥
  sourcemaps: false          // æ˜¯å¦ç”Ÿæˆ sourcemap
})
```

### å®é™…ç¤ºä¾‹

```javascript
// åªå¤„ç†ä¿®æ”¹è¿‡çš„æ–‡ä»¶ï¼ˆå¢é‡æ„å»ºï¼‰
const { src, lastRun } = require('gulp');

function scripts() {
  return src('src/js/**/*.js', { 
    since: lastRun(scripts)  // åªè¿”å›è‡ªä¸Šæ¬¡è¿è¡Œåä¿®æ”¹çš„æ–‡ä»¶
  })
    .pipe(uglify())
    .pipe(dest('dist/js'));
}
```

---

## Destï¼ˆç›®æ ‡æ–‡ä»¶ï¼‰

### åŸºæœ¬ç”¨æ³•

```javascript
const { src, dest } = require('gulp');

// å†™å…¥åˆ°æŒ‡å®šç›®å½•
function scripts() {
  return src('src/js/*.js')
    .pipe(uglify())
    .pipe(dest('dist/js'));  // å†™å…¥ dist/js ç›®å½•
}
```

### ä¿æŒç›®å½•ç»“æ„

```javascript
// æºæ–‡ä»¶: src/js/app.js, src/js/utils.js
src('src/js/**/*.js')
  .pipe(dest('dist'))  
// ç»“æœ: dist/js/app.js, dist/js/utils.js

// ä½¿ç”¨ base é€‰é¡¹
src('src/js/**/*.js', { base: 'src' })
  .pipe(dest('dist'))
// ç»“æœ: dist/js/app.js, dist/js/utils.js
```

### Dest é€‰é¡¹

```javascript
dest('dist', {
  cwd: process.cwd(),        // å½“å‰å·¥ä½œç›®å½•
  mode: 0o777,              // æ–‡ä»¶æƒé™
  dirMode: 0o777,           // ç›®å½•æƒé™
  overwrite: true,          // æ˜¯å¦è¦†ç›–å·²å­˜åœ¨æ–‡ä»¶
  sourcemaps: './maps'      // sourcemap è¾“å‡ºç›®å½•
})
```

---

## Watchï¼ˆç›‘å¬ï¼‰

### åŸºæœ¬ç”¨æ³•

```javascript
const { watch } = require('gulp');

// ç›‘å¬æ–‡ä»¶å˜åŒ–
watch('src/js/**/*.js', scripts);

// ç›‘å¬å¤šä¸ªæ–‡ä»¶
watch(['src/js/**/*.js', 'src/css/**/*.css'], build);
```

### Watch é€‰é¡¹

```javascript
watch('src/js/**/*.js', {
  delay: 200,                // é˜²æŠ–å»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰
  ignoreInitial: false,      // æ˜¯å¦å¿½ç•¥åˆå§‹æ–‡ä»¶
  queue: true,              // æ˜¯å¦æ’é˜Ÿæ‰§è¡Œ
  events: 'all',            // ç›‘å¬äº‹ä»¶ç±»å‹
  followSymlinks: true      // æ˜¯å¦è·Ÿéšç¬¦å·é“¾æ¥
}, scripts);
```

### ç›‘å¬äº‹ä»¶

```javascript
// ç›‘å¬ä¸åŒäº‹ä»¶
const watcher = watch('src/js/**/*.js');

watcher.on('change', (path, stats) => {
  console.log(`File ${path} was changed`);
});

watcher.on('add', (path) => {
  console.log(`File ${path} was added`);
});

watcher.on('unlink', (path) => {
  console.log(`File ${path} was removed`);
});

watcher.on('error', (error) => {
  console.error('Watcher error:', error);
});
```

### å®é™…ç¤ºä¾‹

```javascript
// å¼€å‘æ¨¡å¼ç›‘å¬
function dev() {
  // ç›‘å¬ JS æ–‡ä»¶
  watch('src/js/**/*.js', scripts);
  
  // ç›‘å¬ CSS æ–‡ä»¶
  watch('src/css/**/*.css', styles);
  
  // ç›‘å¬ HTML æ–‡ä»¶
  watch('src/**/*.html', html);
  
  // ç›‘å¬å›¾ç‰‡æ–‡ä»¶
  watch('src/images/**/*', images);
}

exports.dev = dev;
```

---

## Seriesï¼ˆä¸²è¡Œï¼‰

### åŸºæœ¬ç”¨æ³•

```javascript
const { series } = require('gulp');

// ä¸²è¡Œæ‰§è¡Œä»»åŠ¡ï¼ˆæŒ‰é¡ºåºï¼‰
exports.build = series(clean, scripts, styles, html);

// ç­‰ä»·äº:
// 1. æ‰§è¡Œ clean
// 2. clean å®Œæˆåæ‰§è¡Œ scripts
// 3. scripts å®Œæˆåæ‰§è¡Œ styles
// 4. styles å®Œæˆåæ‰§è¡Œ html
```

### é”™è¯¯å¤„ç†

```javascript
// å¦‚æœæŸä¸ªä»»åŠ¡å‡ºé”™ï¼Œåç»­ä»»åŠ¡ä¸ä¼šæ‰§è¡Œ
function clean(cb) {
  // æ¨¡æ‹Ÿé”™è¯¯
  cb(new Error('Clean failed'));
}

function scripts() {
  // ä¸ä¼šæ‰§è¡Œ
  return src('src/js/*.js')
    .pipe(dest('dist/js'));
}

exports.build = series(clean, scripts);  // scripts ä¸ä¼šæ‰§è¡Œ
```

### å®é™…ç¤ºä¾‹

```javascript
// æ¸…ç† â†’ æ„å»º â†’ å‹ç¼©
gulp.task('build', series(
  clean,        // 1. æ¸…ç† dist ç›®å½•
  parallel(     // 2. å¹¶è¡Œæ„å»º
    scripts,
    styles,
    html
  ),
  zip           // 3. æ‰“åŒ…å‹ç¼©
));
```

---

## Parallelï¼ˆå¹¶è¡Œï¼‰

### åŸºæœ¬ç”¨æ³•

```javascript
const { parallel } = require('gulp');

// å¹¶è¡Œæ‰§è¡Œä»»åŠ¡ï¼ˆåŒæ—¶ï¼‰
exports.build = parallel(scripts, styles, html);

// ç­‰ä»·äº:
// scriptsã€stylesã€html åŒæ—¶æ‰§è¡Œ
```

### Series + Parallel ç»„åˆ

```javascript
// æ¸…ç† â†’ (JS/CSS/HTML å¹¶è¡Œ) â†’ å‹ç¼©
exports.build = series(
  clean,
  parallel(scripts, styles, html),
  zip
);
```

### å®é™…ç¤ºä¾‹

```javascript
// æ„å»ºä»»åŠ¡
function build() {
  return parallel(
    series(cleanJS, scripts),    // æ¸…ç† JS â†’ æ„å»º JS
    series(cleanCSS, styles),    // æ¸…ç† CSS â†’ æ„å»º CSS
    series(cleanImages, images)  // æ¸…ç†å›¾ç‰‡ â†’ æ„å»ºå›¾ç‰‡
  );
}

exports.build = build;
```

---

## Pipeï¼ˆç®¡é“ï¼‰

### åŸºæœ¬ç”¨æ³•

```javascript
// ç®¡é“å¼å¤„ç†
src('src/js/*.js')
  .pipe(uglify())           // å‹ç¼©
  .pipe(rename({ suffix: '.min' }))  // é‡å‘½å
  .pipe(dest('dist/js'));   // è¾“å‡º
```

### ç®¡é“å·¥ä½œåŸç†

```javascript
// Gulp æ’ä»¶é€šå¸¸æ˜¯è½¬æ¢æµ
function uglify() {
  return through2.obj(function(file, encoding, callback) {
    // 1. æ¥æ”¶æ–‡ä»¶
    const content = file.contents.toString();
    
    // 2. å¤„ç†æ–‡ä»¶
    const minified = UglifyJS.minify(content).code;
    
    // 3. è¿”å›æ–‡ä»¶
    file.contents = Buffer.from(minified);
    
    // 4. ä¼ é€’ç»™ä¸‹ä¸€ä¸ªæ’ä»¶
    callback(null, file);
  });
}
```

### ç®¡é“é”™è¯¯å¤„ç†

```javascript
// é”™è¯¯å¤„ç†
src('src/js/*.js')
  .pipe(uglify().on('error', function(err) {
    console.error('Uglify error:', err);
    this.emit('end');  // ç»§ç»­æ‰§è¡Œ
  }))
  .pipe(dest('dist/js'));

// ä½¿ç”¨ plumber æ’ä»¶
const plumber = require('gulp-plumber');

src('src/js/*.js')
  .pipe(plumber())  // é˜²æ­¢ç®¡é“å› é”™è¯¯ä¸­æ–­
  .pipe(uglify())
  .pipe(dest('dist/js'));
```

### æ¡ä»¶ç®¡é“

```javascript
const gulpif = require('gulp-if');
const { argv } = require('yargs');

// åªåœ¨ç”Ÿäº§ç¯å¢ƒå‹ç¼©
function scripts() {
  return src('src/js/*.js')
    .pipe(gulpif(argv.production, uglify()))  // æ¡ä»¶åˆ¤æ–­
    .pipe(dest('dist/js'));
}
```

---

## æ ¸å¿ƒæ¦‚å¿µæ€»ç»“

### æ•°æ®æµç”Ÿå‘½å‘¨æœŸ

```
gulp.src()      // 1. åˆ›å»ºå¯è¯»æµ
  â†“
.pipe()         // 2. åº”ç”¨è½¬æ¢æµ
  â†“
.pipe()         // 3. åº”ç”¨è½¬æ¢æµ
  â†“
gulp.dest()    // 4. åˆ›å»ºå¯å†™æµ
```

### ä»»åŠ¡æ‰§è¡Œæ¨¡å¼

```javascript
// ä¸²è¡Œæ‰§è¡Œ
series(task1, task2, task3)
// task1 â†’ task2 â†’ task3

// å¹¶è¡Œæ‰§è¡Œ
parallel(task1, task2, task3)
// task1ã€task2ã€task3 åŒæ—¶æ‰§è¡Œ

// æ··åˆæ‰§è¡Œ
series(clean, parallel(scripts, styles), zip)
// clean â†’ (scripts + styles) â†’ zip
```

### æ–‡ä»¶å¤„ç†æµç¨‹

```javascript
// å®Œæ•´çš„å·¥ä½œæµ
function build() {
  return src('src/**/*', { since: lastRun(build) })  // 1. è¯»å–æºæ–‡ä»¶
    .pipe(sourcemaps.init())         // 2. åˆå§‹åŒ– sourcemap
    .pipe(uglify())                  // 3. å‹ç¼©
    .pipe(rename({ suffix: '.min' })) // 4. é‡å‘½å
    .pipe(sourcemaps.write('.'))     // 5. å†™å…¥ sourcemap
    .pipe(dest('dist'));             // 6. è¾“å‡ºåˆ°ç›®æ ‡
}
```

---

## ğŸ“š ç›¸å…³é“¾æ¥

- [Gulp ç®€ä»‹ä¸å®‰è£…](../01-åŸºç¡€å…¥é—¨/Gulp-ç®€ä»‹ä¸å®‰è£….md)
- [Gulp åŸºæœ¬ä½¿ç”¨](./åŸºæœ¬ä½¿ç”¨.md)
- [å¸¸ç”¨æ’ä»¶](../03-å¸¸ç”¨æ’ä»¶/å¸¸ç”¨æ’ä»¶.md)
- [å®˜æ–¹æ–‡æ¡£](https://gulpjs.com/docs/en/api/concepts)

---

**æ ‡ç­¾**: #gulp #æ ¸å¿ƒæ¦‚å¿µ #stream #task #pipeline
