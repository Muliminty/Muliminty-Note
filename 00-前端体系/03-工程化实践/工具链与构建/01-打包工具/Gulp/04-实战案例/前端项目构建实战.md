# å‰ç«¯é¡¹ç›®æ„å»ºå®æˆ˜

> ä½¿ç”¨ Gulp æ„å»ºå®Œæ•´çš„å‰ç«¯é¡¹ç›®

---

## ğŸ“‹ ç›®å½•

- [é¡¹ç›®ç»“æ„](#é¡¹ç›®ç»“æ„)
- [åˆå§‹åŒ–é¡¹ç›®](#åˆå§‹åŒ–é¡¹ç›®)
- [é…ç½®å¼€å‘ç¯å¢ƒ](#é…ç½®å¼€å‘ç¯å¢ƒ)
- [é…ç½®ç”Ÿäº§ç¯å¢ƒ](#é…ç½®ç”Ÿäº§ç¯å¢ƒ)
- [ä¼˜åŒ–æ„å»ºæ€§èƒ½](#ä¼˜åŒ–æ„å»ºæ€§èƒ½)
- [å®Œæ•´é…ç½®ç¤ºä¾‹](#å®Œæ•´é…ç½®ç¤ºä¾‹)

---

## é¡¹ç›®ç»“æ„

### æ¨èçš„é¡¹ç›®ç»“æ„

```
project/
â”œâ”€â”€ src/                          # æºæ–‡ä»¶
â”‚   â”œâ”€â”€ assets/                   # é™æ€èµ„æº
â”‚   â”‚   â”œâ”€â”€ fonts/               # å­—ä½“æ–‡ä»¶
â”‚   â”‚   â””â”€â”€ icons/               # å›¾æ ‡
â”‚   â”œâ”€â”€ images/                  # å›¾ç‰‡
â”‚   â”‚   â””â”€â”€ sprites/             # é›ªç¢§å›¾
â”‚   â”œâ”€â”€ js/                      # JavaScript
â”‚   â”‚   â”œâ”€â”€ components/          # ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ utils/               # å·¥å…·å‡½æ•°
â”‚   â”‚   â”œâ”€â”€ app.js               # å…¥å£æ–‡ä»¶
â”‚   â”‚   â””â”€â”€ main.js              # ä¸»é€»è¾‘
â”‚   â”œâ”€â”€ scss/                    # Sass æ ·å¼
â”‚   â”‚   â”œâ”€â”€ base/                # åŸºç¡€æ ·å¼
â”‚   â”‚   â”œâ”€â”€ components/          # ç»„ä»¶æ ·å¼
â”‚   â”‚   â”œâ”€â”€ layout/              # å¸ƒå±€æ ·å¼
â”‚   â”‚   â”œâ”€â”€ pages/               # é¡µé¢æ ·å¼
â”‚   â”‚   â”œâ”€â”€ utils/               # å·¥å…·æ ·å¼
â”‚   â”‚   â”œâ”€â”€ vendors/             # ç¬¬ä¸‰æ–¹æ ·å¼
â”‚   â”‚   â””â”€â”€ app.scss             # ä¸»æ ·å¼æ–‡ä»¶
â”‚   â””â”€â”€ templates/               # æ¨¡æ¿æ–‡ä»¶
â”‚       â”œâ”€â”€ layouts/             # å¸ƒå±€æ¨¡æ¿
â”‚       â”œâ”€â”€ partials/            # å±€éƒ¨æ¨¡æ¿
â”‚       â””â”€â”€ pages/               # é¡µé¢æ¨¡æ¿
â”œâ”€â”€ dist/                         # æ„å»ºè¾“å‡ºï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
â”œâ”€â”€ public/                       # é™æ€æ–‡ä»¶ï¼ˆç›´æ¥å¤åˆ¶ï¼‰
â”œâ”€â”€ gulpfile.js                  # Gulp é…ç½®
â”œâ”€â”€ gulpfile.config.js           # Gulp é…ç½®æ–‡ä»¶
â”œâ”€â”€ package.json                 # é¡¹ç›®é…ç½®
â””â”€â”€ README.md                    # é¡¹ç›®è¯´æ˜
```

---

## åˆå§‹åŒ–é¡¹ç›®

### 1. åˆ›å»ºé¡¹ç›®ç›®å½•

```bash
mkdir my-project
cd my-project
```

### 2. åˆå§‹åŒ– npm

```bash
npm init -y
```

### 3. å®‰è£… Gulp å’Œæ’ä»¶

```bash
# å®‰è£… Gulp
npm install --save-dev gulp gulp-cli

# å®‰è£…æ ¸å¿ƒæ’ä»¶
npm install --save-dev \
  gulp-uglify \
  gulp-babel @babel/core @babel/preset-env \
  gulp-sass sass \
  gulp-postcss autoprefixer cssnano \
  gulp-clean-css \
  gulp-htmlmin \
  gulp-imagemin \
  gulp-concat \
  gulp-rename \
  gulp-sourcemaps \
  browser-sync \
  del \
  gulp-plumber \
  gulp-notify \
  gulp-size \
  gulp-changed
```

### 4. åˆ›å»ºé…ç½®æ–‡ä»¶

```javascript
// gulpfile.config.js
module.exports = {
  paths: {
    src: {
      js: 'src/js/**/*.js',
      scss: 'src/scss/**/*.scss',
      html: 'src/*.html',
      images: 'src/images/**/*',
      fonts: 'src/assets/fonts/**/*'
    },
    dest: {
      js: 'dist/js',
      css: 'dist/css',
      html: 'dist',
      images: 'dist/images',
      fonts: 'dist/fonts'
    }
  },
  options: {
    uglify: {
      compress: {
        drop_console: true
      }
    },
    babel: {
      presets: ['@babel/preset-env']
    },
    sass: {
      outputStyle: 'expanded'
    },
    postcss: [
      require('autoprefixer')(),
      require('cssnano')()
    ],
    htmlmin: {
      collapseWhitespace: true,
      removeComments: true,
      minifyCSS: true,
      minifyJS: true
    },
    imagemin: {
      quality: 85
    }
  }
};
```

---

## é…ç½®å¼€å‘ç¯å¢ƒ

### å¼€å‘ç¯å¢ƒç‰¹ç‚¹

- å¿«é€Ÿæ„å»º
- ç”Ÿæˆ Source Map
- ä¿ç•™æœªå‹ç¼©ä»£ç 
- çƒ­é‡è½½
- é”™è¯¯æç¤º

### å¼€å‘ç¯å¢ƒé…ç½®

```javascript
// gulpfile.js
const { src, dest, watch, series, parallel } = require('gulp');
const browserSync = require('browser-sync').create();
const config = require('./gulpfile.config.js');

// JavaScript å¤„ç†ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
function scriptsDev() {
  const babel = require('gulp-babel');
  const sourcemaps = require('gulp-sourcemaps');
  const plumber = require('gulp-plumber');
  const notify = require('gulp-notify');

  return src(config.paths.src.js, { sourcemaps: true })
    .pipe(plumber({
      errorHandler: notify.onError('Error: <%= error.message %>')
    }))
    .pipe(sourcemaps.init())
    .pipe(babel(config.options.babel))
    .pipe(sourcemaps.write('.'))
    .pipe(dest(config.paths.dest.js))
    .pipe(browserSync.stream());
}

// CSS å¤„ç†ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
function stylesDev() {
  const sass = require('gulp-sass')(require('sass'));
  const sourcemaps = require('gulp-sourcemaps');
  const postcss = require('gulp-postcss');
  const plumber = require('gulp-plumber');
  const notify = require('gulp-notify');

  return src(config.paths.src.scss, { sourcemaps: true })
    .pipe(plumber({
      errorHandler: notify.onError('Error: <%= error.message %>')
    }))
    .pipe(sourcemaps.init())
    .pipe(sass(config.options.sass))
    .pipe(postcss([require('autoprefixer')()]))
    .pipe(sourcemaps.write('.'))
    .pipe(dest(config.paths.dest.css))
    .pipe(browserSync.stream());
}

// HTML å¤„ç†ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
function htmlDev() {
  const fileInclude = require('gulp-file-include');
  const plumber = require('gulp-plumber');

  return src(config.paths.src.html)
    .pipe(plumber())
    .pipe(fileInclude({
      prefix: '@@',
      basepath: '@file'
    }))
    .pipe(dest(config.paths.dest.html))
    .pipe(browserSync.stream());
}

// å›¾ç‰‡å¤„ç†ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
function imagesDev() {
  return src(config.paths.src.images)
    .pipe(dest(config.paths.dest.images));
}

// å¯åŠ¨å¼€å‘æœåŠ¡å™¨
function server() {
  browserSync.init({
    server: {
      baseDir: './dist'
    },
    port: 3000,
    open: true,
    notify: false
  });
}

// æ–‡ä»¶ç›‘å¬
function watchFiles() {
  watch(config.paths.src.js, scriptsDev);
  watch(config.paths.src.scss, stylesDev);
  watch(config.paths.src.html, htmlDev);
  watch(config.paths.src.images, imagesDev);
}

// å¼€å‘ä»»åŠ¡
exports.dev = series(
  parallel(scriptsDev, stylesDev, htmlDev, imagesDev),
  parallel(server, watchFiles)
);
```

---

## é…ç½®ç”Ÿäº§ç¯å¢ƒ

### ç”Ÿäº§ç¯å¢ƒç‰¹ç‚¹

- ä»£ç å‹ç¼©
- å›¾ç‰‡ä¼˜åŒ–
- æ–‡ä»¶å“ˆå¸Œ
- èµ„æºä¼˜åŒ–
- æ€§èƒ½ä¼˜åŒ–

### ç”Ÿäº§ç¯å¢ƒé…ç½®

```javascript
// JavaScript å¤„ç†ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
function scriptsProd() {
  const babel = require('gulp-babel');
  const uglify = require('gulp-uglify');
  const concat = require('gulp-concat');
  const rename = require('gulp-rename');
  const sourcemaps = require('gulp-sourcemaps');
  const size = require('gulp-size');

  return src(config.paths.src.js)
    .pipe(sourcemaps.init())
    .pipe(babel(config.options.babel))
    .pipe(concat('app.js'))
    .pipe(dest(config.paths.dest.js))
    .pipe(uglify(config.options.uglify))
    .pipe(rename({ suffix: '.min' }))
    .pipe(sourcemaps.write('.'))
    .pipe(size({ showFiles: true, gzip: true }))
    .pipe(dest(config.paths.dest.js));
}

// CSS å¤„ç†ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
function stylesProd() {
  const sass = require('gulp-sass')(require('sass'));
  const postcss = require('gulp-postcss');
  const cleanCSS = require('gulp-clean-css');
  const concat = require('gulp-concat');
  const rename = require('gulp-rename');
  const sourcemaps = require('gulp-sourcemaps');
  const size = require('gulp-size');

  return src(config.paths.src.scss)
    .pipe(sourcemaps.init())
    .pipe(sass(config.options.sass))
    .pipe(postcss(config.options.postcss))
    .pipe(concat('app.css'))
    .pipe(dest(config.paths.dest.css))
    .pipe(cleanCSS())
    .pipe(rename({ suffix: '.min' }))
    .pipe(sourcemaps.write('.'))
    .pipe(size({ showFiles: true, gzip: true }))
    .pipe(dest(config.paths.dest.css));
}

// HTML å¤„ç†ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
function htmlProd() {
  const htmlmin = require('gulp-htmlmin');
  const fileInclude = require('gulp-file-include');

  return src(config.paths.src.html)
    .pipe(fileInclude({
      prefix: '@@',
      basepath: '@file'
    }))
    .pipe(htmlmin(config.options.htmlmin))
    .pipe(dest(config.paths.dest.html));
}

// å›¾ç‰‡å¤„ç†ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
function imagesProd() {
  const imagemin = require('gulp-imagemin');

  return src(config.paths.src.images)
    .pipe(imagemin([
      imagemin.gifsicle({ interlaced: true }),
      imagemin.mozjpeg({ quality: 85, progressive: true }),
      imagemin.optipng({ optimizationLevel: 5 }),
      imagemin.svgo({
        plugins: [
          { removeViewBox: true },
          { cleanupIDs: false }
        ]
      })
    ]))
    .pipe(dest(config.paths.dest.images));
}

// å­—ä½“å¤„ç†
function fonts() {
  return src(config.paths.src.fonts)
    .pipe(dest(config.paths.dest.fonts));
}

// æ¸…ç†æ„å»ºç›®å½•
function clean() {
  const del = require('del');
  return del(['dist/**/*']);
}

// æ„å»ºä»»åŠ¡
exports.build = series(
  clean,
  parallel(scriptsProd, stylesProd, htmlProd, imagesProd, fonts)
);
```

---

## ä¼˜åŒ–æ„å»ºæ€§èƒ½

### 1. å¢é‡æ„å»º

```javascript
const changed = require('gulp-changed');

function images() {
  return src('src/images/**/*')
    .pipe(changed('dist/images'))  // åªå¤„ç†ä¿®æ”¹è¿‡çš„å›¾ç‰‡
    .pipe(imagemin())
    .pipe(dest('dist/images'));
}
```

### 2. ç¼“å­˜å¤„ç†ç»“æœ

```javascript
const cache = require('gulp-cache');

function images() {
  return src('src/images/**/*')
    .pipe(cache(imagemin([
      imagemin.jpegtran({ progressive: true }),
      imagemin.optipng({ optimizationLevel: 5 })
    ])))
    .pipe(dest('dist/images'));
}
```

### 3. å¹¶è¡Œæ‰§è¡Œä»»åŠ¡

```javascript
// ä¸²è¡Œï¼ˆæ…¢ï¼‰
exports.build = series(scripts, styles, html, images);

// å¹¶è¡Œï¼ˆå¿«ï¼‰
exports.build = parallel(scripts, styles, html, images);

// æ··åˆï¼ˆæ¨èï¼‰
exports.build = series(
  clean,
  parallel(scripts, styles, html, images)
);
```

### 4. ä½¿ç”¨ gulp.lastRun

```javascript
const { lastRun } = require('gulp');

function scripts() {
  return src('src/js/**/*.js', {
    since: lastRun(scripts)  // åªè¿”å›è‡ªä¸Šæ¬¡è¿è¡Œåä¿®æ”¹çš„æ–‡ä»¶
  })
    .pipe(babel())
    .pipe(dest('dist/js'));
}
```

### 5. å¤šæ ¸æ„å»º

```javascript
const os = require('os');
const cluster = require('cluster');

function parallelBuild() {
  const cpuCount = os.cpus().length;
  
  if (cluster.isMaster) {
    // åˆ›å»ºå·¥ä½œè¿›ç¨‹
    for (let i = 0; i < cpuCount; i++) {
      cluster.fork();
    }
  } else {
    // å·¥ä½œè¿›ç¨‹æ‰§è¡Œä»»åŠ¡
    return parallel(scripts, styles, images);
  }
}
```

---

## å®Œæ•´é…ç½®ç¤ºä¾‹

### package.json

```json
{
  "name": "gulp-project",
  "version": "1.0.0",
  "description": "Gulp å‰ç«¯é¡¹ç›®æ„å»º",
  "scripts": {
    "dev": "gulp dev",
    "build": "gulp build",
    "clean": "gulp clean",
    "serve": "gulp serve"
  },
  "devDependencies": {
    "@babel/core": "^7.15.0",
    "@babel/preset-env": "^7.15.0",
    "autoprefixer": "^10.3.0",
    "browser-sync": "^2.27.0",
    "cssnano": "^5.0.0",
    "del": "^6.0.0",
    "gulp": "^4.0.2",
    "gulp-babel": "^8.0.0",
    "gulp-clean-css": "^4.3.0",
    "gulp-concat": "^2.6.1",
    "gulp-file-include": "^2.3.0",
    "gulp-htmlmin": "^5.0.1",
    "gulp-if": "^3.0.0",
    "gulp-imagemin": "^8.0.0",
    "gulp-notify": "^4.0.0",
    "gulp-plumber": "^1.2.1",
    "gulp-postcss": "^9.0.0",
    "gulp-rename": "^2.0.0",
    "gulp-sass": "^5.0.0",
    "gulp-size": "^4.0.1",
    "gulp-sourcemaps": "^3.0.0",
    "gulp-uglify": "^3.0.2",
    "sass": "^1.38.0"
  }
}
```

### å®Œæ•´ gulpfile.js

```javascript
const { src, dest, watch, series, parallel, lastRun } = require('gulp');
const browserSync = require('browser-sync').create();
const config = require('./gulpfile.config.js');

// åˆ¤æ–­æ˜¯å¦ä¸ºç”Ÿäº§ç¯å¢ƒ
const isProduction = process.env.NODE_ENV === 'production';

// æ¸…ç†æ„å»ºç›®å½•
function clean() {
  const del = require('del');
  return del(['dist/**/*']);
}

// JavaScript å¤„ç†
function scripts() {
  const babel = require('gulp-babel');
  const uglify = require('gulp-uglify');
  const concat = require('gulp-concat');
  const rename = require('gulp-rename');
  const sourcemaps = require('gulp-sourcemaps');
  const plumber = require('gulp-plumber');
  const size = require('gulp-size');

  return src(config.paths.src.js, { 
    sourcemaps: !isProduction,
    since: lastRun(scripts)
  })
    .pipe(plumber({
      errorHandler: require('gulp-notify').onError('Error: <%= error.message %>')
    }))
    .pipe(sourcemaps.init())
    .pipe(babel(config.options.babel))
    .pipe(concat('app.js'))
    .pipe(dest(config.paths.dest.js))
    .pipe(gulpif(isProduction, uglify(config.options.uglify)))
    .pipe(gulpif(isProduction, rename({ suffix: '.min' })))
    .pipe(sourcemaps.write('.'))
    .pipe(gulpif(isProduction, size({ showFiles: true, gzip: true })))
    .pipe(dest(config.paths.dest.js))
    .pipe(gulpif(!isProduction, browserSync.stream()));
}

// CSS å¤„ç†
function styles() {
  const sass = require('gulp-sass')(require('sass'));
  const postcss = require('gulp-postcss');
  const cleanCSS = require('gulp-clean-css');
  const concat = require('gulp-concat');
  const rename = require('gulp-rename');
  const sourcemaps = require('gulp-sourcemaps');
  const plumber = require('gulp-plumber');
  const size = require('gulp-size');

  return src(config.paths.src.scss, { 
    sourcemaps: !isProduction,
    since: lastRun(styles)
  })
    .pipe(plumber({
      errorHandler: require('gulp-notify').onError('Error: <%= error.message %>')
    }))
    .pipe(sourcemaps.init())
    .pipe(sass(config.options.sass))
    .pipe(postcss(gulpif(isProduction, config.options.postcss : [require('autoprefixer')()])))
    .pipe(concat('app.css'))
    .pipe(dest(config.paths.dest.css))
    .pipe(gulpif(isProduction, cleanCSS()))
    .pipe(gulpif(isProduction, rename({ suffix: '.min' })))
    .pipe(sourcemaps.write('.'))
    .pipe(gulpif(isProduction, size({ showFiles: true, gzip: true })))
    .pipe(dest(config.paths.dest.css))
    .pipe(gulpif(!isProduction, browserSync.stream()));
}

// HTML å¤„ç†
function html() {
  const htmlmin = require('gulp-htmlmin');
  const fileInclude = require('gulp-file-include');

  return src(config.paths.src.html)
    .pipe(fileInclude({
      prefix: '@@',
      basepath: '@file'
    }))
    .pipe(gulpif(isProduction, htmlmin(config.options.htmlmin)))
    .pipe(dest(config.paths.dest.html))
    .pipe(gulpif(!isProduction, browserSync.stream()));
}

// å›¾ç‰‡å¤„ç†
function images() {
  const imagemin = require('gulp-imagemin');
  const changed = require('gulp-changed');

  return src(config.paths.src.images, {
    since: lastRun(images)
  })
    .pipe(changed(config.paths.dest.images))
    .pipe(gulpif(isProduction, imagemin([
      imagemin.gifsicle({ interlaced: true }),
      imagemin.mozjpeg({ quality: 85, progressive: true }),
      imagemin.optipng({ optimizationLevel: 5 }),
      imagemin.svgo({
        plugins: [
          { removeViewBox: true },
          { cleanupIDs: false }
        ]
      })
    ])))
    .pipe(dest(config.paths.dest.images));
}

// å­—ä½“å¤„ç†
function fonts() {
  return src(config.paths.src.fonts)
    .pipe(dest(config.paths.dest.fonts));
}

// å¼€å‘æœåŠ¡å™¨
function server() {
  browserSync.init({
    server: {
      baseDir: './dist'
    },
    port: 3000,
    open: true,
    notify: false
  });
}

// æ–‡ä»¶ç›‘å¬
function watchFiles() {
  watch(config.paths.src.js, scripts);
  watch(config.paths.src.scss, styles);
  watch(config.paths.src.html, html);
  watch(config.paths.src.images, images);
  watch(config.paths.src.fonts, fonts);
}

// ä»»åŠ¡
exports.clean = clean;
exports.scripts = scripts;
exports.styles = styles;
exports.html = html;
exports.images = images;
exports.fonts = fonts;
exports.watch = watchFiles;

// å¼€å‘ä»»åŠ¡
exports.dev = series(
  clean,
  parallel(scripts, styles, html, images, fonts),
  parallel(server, watchFiles)
);

// ç”Ÿäº§æ„å»º
exports.build = series(
  clean,
  parallel(scripts, styles, html, images, fonts)
);

// é»˜è®¤ä»»åŠ¡
exports.default = isProduction ? exports.build : exports.dev;
```

---

## ğŸ“š ç›¸å…³é“¾æ¥

- [Gulp ç®€ä»‹ä¸å®‰è£…](../../01-åŸºç¡€å…¥é—¨/Gulp-ç®€ä»‹ä¸å®‰è£….md)
- [Gulp åŸºæœ¬ä½¿ç”¨](../../01-åŸºç¡€å…¥é—¨/åŸºæœ¬ä½¿ç”¨.md)
- [å¸¸ç”¨æ’ä»¶](../../03-å¸¸ç”¨æ’ä»¶/å¸¸ç”¨æ’ä»¶.md)
- [æœ€ä½³å®è·µ](../../05-æœ€ä½³å®è·µ/æœ€ä½³å®è·µ.md)

---

**æ ‡ç­¾**: #gulp #å®æˆ˜ #å‰ç«¯æ„å»º #å·¥ç¨‹åŒ–
