# ä»é›¶å¼€å§‹æ„å»ºè„šæ‰‹æ¶ï¼ˆBuild Scaffold from Scratchï¼‰

> ä»åˆ›å»ºä¸€ä¸ªç©ºç›®å½•å¼€å§‹ï¼Œé€æ­¥æ­å»ºå‡ºå®Œæ•´çš„å‰ç«¯è„šæ‰‹æ¶ç³»ç»Ÿï¼ŒåŒ…æ‹¬ CLI å‘½ä»¤å¤„ç†ã€ç”¨æˆ·äº¤äº’ã€æ–‡ä»¶ç”Ÿæˆç­‰æ ¸å¿ƒåŠŸèƒ½ã€‚

---

## ğŸ“‹ ç›®å½•

- [1. é¡¹ç›®åˆå§‹åŒ–](#1-é¡¹ç›®åˆå§‹åŒ–)
- [2. CLI å‘½ä»¤å¤„ç†](#2-cli-å‘½ä»¤å¤„ç†)
- [3. ç”¨æˆ·äº¤äº’å®ç°](#3-ç”¨æˆ·äº¤äº’å®ç°)
- [4. æ–‡ä»¶ç”Ÿæˆä¸ç›®å½•åˆ›å»º](#4-æ–‡ä»¶ç”Ÿæˆä¸ç›®å½•åˆ›å»º)
- [5. åŒ…ç®¡ç†å™¨å…¼å®¹](#5-åŒ…ç®¡ç†å™¨å…¼å®¹)
- [6. é”™è¯¯å¤„ç†å’Œæ—¥å¿—ç³»ç»Ÿ](#6-é”™è¯¯å¤„ç†å’Œæ—¥å¿—ç³»ç»Ÿ)
- [7. å®Œæ•´ä»£ç ç¤ºä¾‹](#7-å®Œæ•´ä»£ç ç¤ºä¾‹)

---

## 1. é¡¹ç›®åˆå§‹åŒ–

### 1.1 åˆ›å»ºé¡¹ç›®ç›®å½•

```bash
mkdir my-cli
cd my-cli
npm init -y
```

### 1.2 å®‰è£…ä¾èµ–

```bash
# æ ¸å¿ƒä¾èµ–
npm install commander inquirer chalk fs-extra ejs

# å¼€å‘ä¾èµ–
npm install -D typescript @types/node @types/inquirer ts-node nodemon
```

### 1.3 ç›®å½•ç»“æ„

```
my-cli/
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â”œâ”€â”€ bin/
â”‚   â””â”€â”€ cli.js          # CLI å…¥å£æ–‡ä»¶
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.ts        # ä¸»å…¥å£
â”‚   â”œâ”€â”€ commands/       # å‘½ä»¤å¤„ç†
â”‚   â”‚   â””â”€â”€ create.ts
â”‚   â”œâ”€â”€ utils/          # å·¥å…·å‡½æ•°
â”‚   â”‚   â”œâ”€â”€ logger.ts
â”‚   â”‚   â””â”€â”€ file.ts
â”‚   â””â”€â”€ templates/      # æ¨¡æ¿æ–‡ä»¶
â”‚       â””â”€â”€ basic/
â””â”€â”€ dist/               # ç¼–è¯‘è¾“å‡º
```

### 1.4 package.json é…ç½®

```json
{
  "name": "my-cli",
  "version": "1.0.0",
  "description": "å‰ç«¯è„šæ‰‹æ¶å·¥å…·",
  "main": "dist/index.js",
  "bin": {
    "my-cli": "./bin/cli.js"
  },
  "scripts": {
    "build": "tsc",
    "dev": "ts-node src/index.ts",
    "start": "node dist/index.js"
  },
  "keywords": ["cli", "scaffold", "frontend"],
  "author": "",
  "license": "MIT"
}
```

### 1.5 TypeScript é…ç½®

```json
// tsconfig.json
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "commonjs",
    "lib": ["ES2020"],
    "outDir": "./dist",
    "rootDir": "./src",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "resolveJsonModule": true,
    "declaration": true,
    "declarationMap": true,
    "sourceMap": true
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist"]
}
```

---

## 2. CLI å‘½ä»¤å¤„ç†

### 2.1 åˆ›å»º CLI å…¥å£æ–‡ä»¶

```javascript
#!/usr/bin/env node

// bin/cli.js
require('../dist/index.js');
```

### 2.2 ä¸»å…¥å£æ–‡ä»¶

```typescript
// src/index.ts
import { Command } from 'commander';
import { createCommand } from './commands/create';

const program = new Command();

program
  .name('my-cli')
  .description('å‰ç«¯è„šæ‰‹æ¶å·¥å…·')
  .version('1.0.0');

// æ³¨å†Œ create å‘½ä»¤
program
  .command('create')
  .description('åˆ›å»ºæ–°é¡¹ç›®')
  .argument('<project-name>', 'é¡¹ç›®åç§°')
  .option('-t, --template <template>', 'é€‰æ‹©æ¨¡æ¿', 'basic-js')
  .option('--no-install', 'ä¸å®‰è£…ä¾èµ–')
  .option('--package-manager <manager>', 'åŒ…ç®¡ç†å™¨', 'npm')
  .action(async (projectName, options) => {
    await createCommand(projectName, options);
  });

program.parse();
```

### 2.3 Create å‘½ä»¤å®ç°

```typescript
// src/commands/create.ts
import inquirer from 'inquirer';
import { createProject } from '../utils/file';
import { installDependencies } from '../utils/package';
import { logger } from '../utils/logger';

export async function createCommand(
  projectName: string,
  options: {
    template?: string;
    install?: boolean;
    packageManager?: string;
  }
) {
  try {
    // 1. æ”¶é›†ç”¨æˆ·è¾“å…¥
    const answers = await collectUserInput(projectName, options);

    // 2. åˆ›å»ºé¡¹ç›®
    logger.info(`æ­£åœ¨åˆ›å»ºé¡¹ç›®: ${projectName}`);
    await createProject(projectName, answers);

    // 3. å®‰è£…ä¾èµ–
    if (answers.installDeps) {
      logger.info('æ­£åœ¨å®‰è£…ä¾èµ–...');
      await installDependencies(projectName, answers.packageManager);
    }

    logger.success(`é¡¹ç›® ${projectName} åˆ›å»ºæˆåŠŸï¼`);
  } catch (error) {
    logger.error(`åˆ›å»ºé¡¹ç›®å¤±è´¥: ${error.message}`);
    process.exit(1);
  }
}

async function collectUserInput(
  projectName: string,
  options: any
): Promise<any> {
  // å¦‚æœå·²ç»é€šè¿‡å‘½ä»¤è¡Œå‚æ•°æŒ‡å®šï¼Œç›´æ¥ä½¿ç”¨
  if (options.template && options.packageManager) {
    return {
      projectName,
      template: options.template,
      installDeps: options.install !== false,
      packageManager: options.packageManager,
      initGit: false
    };
  }

  // å¦åˆ™è¿›è¡Œäº¤äº’å¼è¯¢é—®
  const answers = await inquirer.prompt([
    {
      type: 'list',
      name: 'template',
      message: 'é€‰æ‹©é¡¹ç›®æ¨¡æ¿:',
      choices: [
        { name: 'Basic JavaScript', value: 'basic-js' },
        { name: 'Basic TypeScript', value: 'basic-ts' },
        { name: 'React', value: 'react' },
        { name: 'React + TypeScript', value: 'react-ts' },
        { name: 'Vue', value: 'vue' },
        { name: 'Vue + TypeScript', value: 'vue-ts' }
      ],
      default: options.template || 'basic-js'
    },
    {
      type: 'list',
      name: 'packageManager',
      message: 'é€‰æ‹©åŒ…ç®¡ç†å™¨:',
      choices: ['npm', 'yarn', 'pnpm'],
      default: options.packageManager || 'npm'
    },
    {
      type: 'confirm',
      name: 'installDeps',
      message: 'æ˜¯å¦ç«‹å³å®‰è£…ä¾èµ–?',
      default: options.install !== false
    },
    {
      type: 'confirm',
      name: 'initGit',
      message: 'æ˜¯å¦åˆå§‹åŒ– Git ä»“åº“?',
      default: true
    }
  ]);

  return {
    projectName,
    ...answers
  };
}
```

---

## 3. ç”¨æˆ·äº¤äº’å®ç°

### 3.1 ä½¿ç”¨ Inquirer

```typescript
import inquirer from 'inquirer';

// æ–‡æœ¬è¾“å…¥
const { name } = await inquirer.prompt([
  {
    type: 'input',
    name: 'name',
    message: 'è¯·è¾“å…¥é¡¹ç›®åç§°:',
    validate: (input) => {
      if (!input.trim()) {
        return 'é¡¹ç›®åç§°ä¸èƒ½ä¸ºç©º';
      }
      return true;
    }
  }
]);

// é€‰æ‹©åˆ—è¡¨
const { template } = await inquirer.prompt([
  {
    type: 'list',
    name: 'template',
    message: 'é€‰æ‹©æ¨¡æ¿:',
    choices: ['react', 'vue', 'angular']
  }
]);

// ç¡®è®¤
const { confirm } = await inquirer.prompt([
  {
    type: 'confirm',
    name: 'confirm',
    message: 'æ˜¯å¦ç»§ç»­?',
    default: true
  }
]);

// å¤šé€‰
const { features } = await inquirer.prompt([
  {
    type: 'checkbox',
    name: 'features',
    message: 'é€‰æ‹©åŠŸèƒ½:',
    choices: [
      { name: 'ESLint', value: 'eslint' },
      { name: 'Prettier', value: 'prettier' },
      { name: 'Husky', value: 'husky' }
    ]
  }
]);
```

### 3.2 è‡ªå®šä¹‰æç¤ºæ ·å¼

```typescript
import chalk from 'chalk';

// ä½¿ç”¨ chalk ç¾åŒ–è¾“å‡º
console.log(chalk.blue('æ­£åœ¨åˆ›å»ºé¡¹ç›®...'));
console.log(chalk.green('âœ“ é¡¹ç›®åˆ›å»ºæˆåŠŸ'));
console.log(chalk.red('âœ— åˆ›å»ºå¤±è´¥'));
console.log(chalk.yellow('âš  è­¦å‘Šä¿¡æ¯'));
```

---

## 4. æ–‡ä»¶ç”Ÿæˆä¸ç›®å½•åˆ›å»º

### 4.1 æ–‡ä»¶å·¥å…·å‡½æ•°

```typescript
// src/utils/file.ts
import fs from 'fs-extra';
import path from 'path';
import ejs from 'ejs';

export async function createProject(
  projectName: string,
  options: {
    template: string;
    [key: string]: any;
  }
) {
  const targetDir = path.resolve(process.cwd(), projectName);
  const templateDir = path.resolve(__dirname, '../templates', options.template);

  // æ£€æŸ¥ç›®å½•æ˜¯å¦å­˜åœ¨
  if (await fs.pathExists(targetDir)) {
    throw new Error(`ç›®å½• ${projectName} å·²å­˜åœ¨`);
  }

  // æ£€æŸ¥æ¨¡æ¿æ˜¯å¦å­˜åœ¨
  if (!(await fs.pathExists(templateDir))) {
    throw new Error(`æ¨¡æ¿ ${options.template} ä¸å­˜åœ¨`);
  }

  // åˆ›å»ºç›®æ ‡ç›®å½•
  await fs.ensureDir(targetDir);

  // å¤åˆ¶å¹¶å¤„ç†æ¨¡æ¿æ–‡ä»¶
  await copyTemplate(templateDir, targetDir, {
    projectName,
    ...options
  });
}

async function copyTemplate(
  srcDir: string,
  targetDir: string,
  data: any
) {
  const files = await fs.readdir(srcDir);

  for (const file of files) {
    const srcPath = path.join(srcDir, file);
    const targetPath = path.join(targetDir, file);
    const stat = await fs.stat(srcPath);

    if (stat.isDirectory()) {
      await fs.ensureDir(targetPath);
      await copyTemplate(srcPath, targetPath, data);
    } else {
      // å¤„ç†æ¨¡æ¿æ–‡ä»¶
      if (file.endsWith('.ejs')) {
        const template = await fs.readFile(srcPath, 'utf-8');
        const content = ejs.render(template, data);
        const targetFile = targetPath.replace(/\.ejs$/, '');
        await fs.writeFile(targetFile, content);
      } else {
        await fs.copy(srcPath, targetPath);
      }
    }
  }
}
```

### 4.2 æ¨¡æ¿æ–‡ä»¶ç¤ºä¾‹

```ejs
// templates/basic-js/package.json.ejs
{
  "name": "<%= projectName %>",
  "version": "1.0.0",
  "description": "",
  "main": "index.js",
  "scripts": {
    "start": "node index.js"
  },
  "keywords": [],
  "author": "<%= author || '' %>",
  "license": "MIT"
}
```

```ejs
// templates/basic-js/index.js
console.log('Hello, <%= projectName %>!');
```

---

## 5. åŒ…ç®¡ç†å™¨å…¼å®¹

### 5.1 åŒ…ç®¡ç†å™¨å·¥å…·å‡½æ•°

```typescript
// src/utils/package.ts
import { execSync } from 'child_process';
import path from 'path';
import { logger } from './logger';

export async function installDependencies(
  projectName: string,
  packageManager: 'npm' | 'yarn' | 'pnpm'
) {
  const projectPath = path.resolve(process.cwd(), projectName);

  try {
    logger.info(`ä½¿ç”¨ ${packageManager} å®‰è£…ä¾èµ–...`);

    const commands = {
      npm: 'npm install',
      yarn: 'yarn install',
      pnpm: 'pnpm install'
    };

    execSync(commands[packageManager], {
      cwd: projectPath,
      stdio: 'inherit'
    });

    logger.success('ä¾èµ–å®‰è£…å®Œæˆ');
  } catch (error) {
    logger.error(`ä¾èµ–å®‰è£…å¤±è´¥: ${error.message}`);
    throw error;
  }
}

export async function initGit(projectPath: string) {
  try {
    logger.info('åˆå§‹åŒ– Git ä»“åº“...');
    execSync('git init', { cwd: projectPath, stdio: 'inherit' });
    logger.success('Git ä»“åº“åˆå§‹åŒ–å®Œæˆ');
  } catch (error) {
    logger.warn(`Git åˆå§‹åŒ–å¤±è´¥: ${error.message}`);
  }
}
```

---

## 6. é”™è¯¯å¤„ç†å’Œæ—¥å¿—ç³»ç»Ÿ

### 6.1 æ—¥å¿—å·¥å…·

```typescript
// src/utils/logger.ts
import chalk from 'chalk';

export const logger = {
  info: (message: string) => {
    console.log(chalk.blue('â„¹'), message);
  },
  success: (message: string) => {
    console.log(chalk.green('âœ“'), message);
  },
  error: (message: string) => {
    console.log(chalk.red('âœ—'), message);
  },
  warn: (message: string) => {
    console.log(chalk.yellow('âš '), message);
  },
  step: (message: string) => {
    console.log(chalk.cyan('â†’'), message);
  }
};
```

### 6.2 é”™è¯¯å¤„ç†

```typescript
// src/utils/error.ts
import { logger } from './logger';

export class ScaffoldError extends Error {
  constructor(message: string, public code?: string) {
    super(message);
    this.name = 'ScaffoldError';
  }
}

export function handleError(error: unknown) {
  if (error instanceof ScaffoldError) {
    logger.error(error.message);
    process.exit(1);
  } else if (error instanceof Error) {
    logger.error(error.message);
    process.exit(1);
  } else {
    logger.error('æœªçŸ¥é”™è¯¯');
    process.exit(1);
  }
}
```

---

## 7. å®Œæ•´ä»£ç ç¤ºä¾‹

### 7.1 é¡¹ç›®ç»“æ„

```
my-cli/
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â”œâ”€â”€ bin/
â”‚   â””â”€â”€ cli.js
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.ts
â”‚   â”œâ”€â”€ commands/
â”‚   â”‚   â””â”€â”€ create.ts
â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â”œâ”€â”€ logger.ts
â”‚   â”‚   â”œâ”€â”€ file.ts
â”‚   â”‚   â””â”€â”€ package.ts
â”‚   â””â”€â”€ templates/
â”‚       â””â”€â”€ basic-js/
â”‚           â”œâ”€â”€ package.json.ejs
â”‚           â””â”€â”€ index.js
â””â”€â”€ dist/
```

### 7.2 ä½¿ç”¨ç¤ºä¾‹

```bash
# å¼€å‘æ¨¡å¼è¿è¡Œ
npm run dev create my-app

# æ„å»º
npm run build

# é“¾æ¥åˆ°å…¨å±€ï¼ˆå¼€å‘æµ‹è¯•ï¼‰
npm link

# ä½¿ç”¨
my-cli create my-app
my-cli create my-app --template react-ts
my-cli create my-app --template vue --package-manager pnpm
```

### 7.3 è¿è¡Œæ•ˆæœ

```bash
$ my-cli create my-app

? é€‰æ‹©é¡¹ç›®æ¨¡æ¿: (Use arrow keys)
  â¯ Basic JavaScript
    Basic TypeScript
    React
    React + TypeScript
    Vue
    Vue + TypeScript

? é€‰æ‹©åŒ…ç®¡ç†å™¨: (Use arrow keys)
  â¯ npm
    yarn
    pnpm

? æ˜¯å¦ç«‹å³å®‰è£…ä¾èµ–? (Y/n) Y
? æ˜¯å¦åˆå§‹åŒ– Git ä»“åº“? (Y/n) Y

â„¹ æ­£åœ¨åˆ›å»ºé¡¹ç›®: my-app
âœ“ é¡¹ç›®åˆ›å»ºæˆåŠŸ
â„¹ æ­£åœ¨å®‰è£…ä¾èµ–...
âœ“ ä¾èµ–å®‰è£…å®Œæˆ
âœ“ Git ä»“åº“åˆå§‹åŒ–å®Œæˆ
âœ“ é¡¹ç›® my-app åˆ›å»ºæˆåŠŸï¼
```

---

## ğŸ“ æ€»ç»“

### æ ¸å¿ƒåŠŸèƒ½

1. âœ… CLI å‘½ä»¤å¤„ç†ï¼ˆCommanderï¼‰
2. âœ… ç”¨æˆ·äº¤äº’ï¼ˆInquirerï¼‰
3. âœ… æ–‡ä»¶ç”Ÿæˆï¼ˆfs-extra + EJSï¼‰
4. âœ… åŒ…ç®¡ç†å™¨å…¼å®¹ï¼ˆnpm/yarn/pnpmï¼‰
5. âœ… é”™è¯¯å¤„ç†å’Œæ—¥å¿—ï¼ˆChalkï¼‰

### ä¸‹ä¸€æ­¥

- [æ¨¡æ¿ç³»ç»Ÿå®ç°](./03-æ¨¡æ¿ç³»ç»Ÿå®ç°.md) - å®ç°å®Œæ•´çš„æ¨¡æ¿ç³»ç»Ÿï¼Œæ”¯æŒå¤šç§æ¡†æ¶æ¨¡æ¿

---

#è„šæ‰‹æ¶ #å‰ç«¯å·¥ç¨‹åŒ– #CLIå·¥å…· #Node.js #TypeScript

