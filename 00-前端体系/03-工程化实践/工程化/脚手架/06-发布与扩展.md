# å‘å¸ƒä¸æ‰©å±•ï¼ˆPublish & Extendï¼‰

> å‘å¸ƒè„šæ‰‹æ¶åˆ° npmï¼Œå®ç°ç‰ˆæœ¬ç®¡ç†ã€ç”¨æˆ·è‡ªå®šä¹‰æ¨¡æ¿ã€é…ç½®æ–‡ä»¶ç³»ç»Ÿã€Mock æœåŠ¡å™¨ç­‰æ‰©å±•åŠŸèƒ½ï¼Œä»¥åŠæµ‹è¯•å’Œ CI/CD æµç¨‹ã€‚

---

## ğŸ“‹ ç›®å½•

- [1. å‘å¸ƒåˆ° npm](#1-å‘å¸ƒåˆ°-npm)
- [2. ç‰ˆæœ¬ç®¡ç†ç­–ç•¥](#2-ç‰ˆæœ¬ç®¡ç†ç­–ç•¥)
- [3. ç”¨æˆ·è‡ªå®šä¹‰æ¨¡æ¿æ”¯æŒ](#3-ç”¨æˆ·è‡ªå®šä¹‰æ¨¡æ¿æ”¯æŒ)
- [4. é…ç½®æ–‡ä»¶ç³»ç»Ÿ](#4-é…ç½®æ–‡ä»¶ç³»ç»Ÿ)
- [5. Mock æœåŠ¡å™¨é›†æˆ](#5-mock-æœåŠ¡å™¨é›†æˆ)
- [6. è¿è¡Œæ—¶èƒ½åŠ›](#6-è¿è¡Œæ—¶èƒ½åŠ›)
- [7. æµ‹è¯•å’Œ CI/CD](#7-æµ‹è¯•å’Œ-cicd)

---

## 1. å‘å¸ƒåˆ° npm

### 1.1 å‘å¸ƒå‰å‡†å¤‡

#### package.json é…ç½®

```json
{
  "name": "my-cli",
  "version": "1.0.0",
  "description": "å‰ç«¯è„šæ‰‹æ¶å·¥å…·",
  "main": "dist/index.js",
  "bin": {
    "my-cli": "./bin/cli.js"
  },
  "files": [
    "bin",
    "dist",
    "templates",
    "README.md"
  ],
  "keywords": [
    "cli",
    "scaffold",
    "frontend",
    "react",
    "vue",
    "template"
  ],
  "author": "Your Name",
  "license": "MIT",
  "repository": {
    "type": "git",
    "url": "https://github.com/your-username/my-cli.git"
  },
  "bugs": {
    "url": "https://github.com/your-username/my-cli/issues"
  },
  "homepage": "https://github.com/your-username/my-cli#readme",
  "engines": {
    "node": ">=14.0.0"
  }
}
```

#### .npmignore æ–‡ä»¶

```
# å¼€å‘æ–‡ä»¶
src/
tsconfig.json
*.ts
!*.d.ts

# æµ‹è¯•æ–‡ä»¶
test/
*.test.ts
*.spec.ts

# é…ç½®æ–‡ä»¶
.eslintrc.json
.prettierrc.json
.gitignore

# ä¸´æ—¶æ–‡ä»¶
.temp/
node_modules/
dist/*.map
```

### 1.2 æ„å»ºå’Œå‘å¸ƒæµç¨‹

```bash
# 1. æ„å»ºé¡¹ç›®
npm run build

# 2. è¿è¡Œæµ‹è¯•
npm test

# 3. æ£€æŸ¥æ–‡ä»¶
npm pack --dry-run

# 4. ç™»å½• npm
npm login

# 5. å‘å¸ƒ
npm publish

# 6. å‘å¸ƒåˆ°ç‰¹å®š tagï¼ˆå¦‚ betaï¼‰
npm publish --tag beta
```

### 1.3 å‘å¸ƒè„šæœ¬

```json
{
  "scripts": {
    "prepublishOnly": "npm run build && npm test",
    "version": "npm run build && git add -A dist",
    "postversion": "git push && git push --tags"
  }
}
```

### 1.4 ä½¿ç”¨ç¤ºä¾‹

```bash
# å…¨å±€å®‰è£…
npm install -g my-cli

# ä½¿ç”¨
my-cli create my-app

# æ›´æ–°
npm update -g my-cli
```

---

## 2. ç‰ˆæœ¬ç®¡ç†ç­–ç•¥

### 2.1 è¯­ä¹‰åŒ–ç‰ˆæœ¬

éµå¾ª [Semantic Versioning](https://semver.org/) è§„èŒƒï¼š

- **ä¸»ç‰ˆæœ¬å·ï¼ˆMAJORï¼‰**ï¼šä¸å…¼å®¹çš„ API ä¿®æ”¹
- **æ¬¡ç‰ˆæœ¬å·ï¼ˆMINORï¼‰**ï¼šå‘ä¸‹å…¼å®¹çš„åŠŸèƒ½æ€§æ–°å¢
- **ä¿®è®¢å·ï¼ˆPATCHï¼‰**ï¼šå‘ä¸‹å…¼å®¹çš„é—®é¢˜ä¿®æ­£

### 2.2 ç‰ˆæœ¬æ›´æ–°å‘½ä»¤

```bash
# æ›´æ–°ä¿®è®¢å·ï¼ˆ1.0.0 -> 1.0.1ï¼‰
npm version patch

# æ›´æ–°æ¬¡ç‰ˆæœ¬å·ï¼ˆ1.0.0 -> 1.1.0ï¼‰
npm version minor

# æ›´æ–°ä¸»ç‰ˆæœ¬å·ï¼ˆ1.0.0 -> 2.0.0ï¼‰
npm version major

# é¢„å‘å¸ƒç‰ˆæœ¬
npm version prerelease --preid=beta
```

### 2.3 ç‰ˆæœ¬ç®¡ç†è„šæœ¬

```typescript
// scripts/version.ts
import { execSync } from 'child_process';
import fs from 'fs-extra';
import path from 'path';

async function updateVersion(type: 'patch' | 'minor' | 'major') {
  // è¯»å–å½“å‰ç‰ˆæœ¬
  const packageJsonPath = path.join(process.cwd(), 'package.json');
  const packageJson = await fs.readJson(packageJsonPath);
  const [major, minor, patch] = packageJson.version.split('.').map(Number);

  // è®¡ç®—æ–°ç‰ˆæœ¬
  let newVersion: string;
  switch (type) {
    case 'major':
      newVersion = `${major + 1}.0.0`;
      break;
    case 'minor':
      newVersion = `${major}.${minor + 1}.0`;
      break;
    case 'patch':
      newVersion = `${major}.${minor}.${patch + 1}`;
      break;
  }

  // æ›´æ–°ç‰ˆæœ¬
  packageJson.version = newVersion;
  await fs.writeJson(packageJsonPath, packageJson, { spaces: 2 });

  // æ„å»º
  execSync('npm run build', { stdio: 'inherit' });

  // æäº¤
  execSync(`git add -A`, { stdio: 'inherit' });
  execSync(`git commit -m "chore: bump version to ${newVersion}"`, {
    stdio: 'inherit'
  });
  execSync(`git tag v${newVersion}`, { stdio: 'inherit' });

  console.log(`Version updated to ${newVersion}`);
}

const type = process.argv[2] as 'patch' | 'minor' | 'major';
updateVersion(type);
```

---

## 3. ç”¨æˆ·è‡ªå®šä¹‰æ¨¡æ¿æ”¯æŒ

### 3.1 æ¨¡æ¿æ³¨å†Œå‘½ä»¤

```typescript
// src/commands/template.ts
import { Command } from 'commander';
import path from 'path';
import fs from 'fs-extra';

export function registerTemplateCommand(program: Command) {
  const templateCommand = program
    .command('template')
    .description('ç®¡ç†è‡ªå®šä¹‰æ¨¡æ¿');

  // æ·»åŠ æ¨¡æ¿
  templateCommand
    .command('add')
    .description('æ·»åŠ è‡ªå®šä¹‰æ¨¡æ¿')
    .argument('<name>', 'æ¨¡æ¿åç§°')
    .argument('<path>', 'æ¨¡æ¿è·¯å¾„')
    .action(async (name, templatePath) => {
      await addTemplate(name, templatePath);
    });

  // åˆ—å‡ºæ¨¡æ¿
  templateCommand
    .command('list')
    .description('åˆ—å‡ºæ‰€æœ‰è‡ªå®šä¹‰æ¨¡æ¿')
    .action(async () => {
      await listTemplates();
    });

  // åˆ é™¤æ¨¡æ¿
  templateCommand
    .command('remove')
    .description('åˆ é™¤è‡ªå®šä¹‰æ¨¡æ¿')
    .argument('<name>', 'æ¨¡æ¿åç§°')
    .action(async (name) => {
      await removeTemplate(name);
    });
}

async function addTemplate(name: string, templatePath: string) {
  const configDir = path.join(require('os').homedir(), '.my-cli', 'templates');
  await fs.ensureDir(configDir);

  const targetPath = path.join(configDir, name);
  const sourcePath = path.resolve(templatePath);

  if (!(await fs.pathExists(sourcePath))) {
    throw new Error(`Template path not found: ${templatePath}`);
  }

  // å¤åˆ¶æ¨¡æ¿
  await fs.copy(sourcePath, targetPath);

  // ä¿å­˜é…ç½®
  const configPath = path.join(configDir, 'config.json');
  let config: Record<string, string> = {};

  if (await fs.pathExists(configPath)) {
    config = await fs.readJson(configPath);
  }

  config[name] = targetPath;
  await fs.writeJson(configPath, config, { spaces: 2 });

  console.log(`Template "${name}" added successfully`);
}

async function listTemplates() {
  const configDir = path.join(require('os').homedir(), '.my-cli', 'templates');
  const configPath = path.join(configDir, 'config.json');

  if (!(await fs.pathExists(configPath))) {
    console.log('No custom templates found');
    return;
  }

  const config = await fs.readJson(configPath);
  console.log('\nCustom Templates:');
  Object.keys(config).forEach((name) => {
    console.log(`  - ${name}: ${config[name]}`);
  });
}

async function removeTemplate(name: string) {
  const configDir = path.join(require('os').homedir(), '.my-cli', 'templates');
  const configPath = path.join(configDir, 'config.json');

  if (!(await fs.pathExists(configPath))) {
    throw new Error('No templates found');
  }

  const config = await fs.readJson(configPath);

  if (!config[name]) {
    throw new Error(`Template "${name}" not found`);
  }

  // åˆ é™¤æ¨¡æ¿ç›®å½•
  const templatePath = config[name];
  if (await fs.pathExists(templatePath)) {
    await fs.remove(templatePath);
  }

  // æ›´æ–°é…ç½®
  delete config[name];
  await fs.writeJson(configPath, config, { spaces: 2 });

  console.log(`Template "${name}" removed successfully`);
}
```

### 3.2 ä½¿ç”¨è‡ªå®šä¹‰æ¨¡æ¿

```typescript
// åœ¨åˆ›å»ºå‘½ä»¤ä¸­æ”¯æŒè‡ªå®šä¹‰æ¨¡æ¿
const customTemplates = await loadCustomTemplates();
const allTemplates = [...builtinTemplates, ...customTemplates];

// ç”¨æˆ·å¯ä»¥é€‰æ‹©è‡ªå®šä¹‰æ¨¡æ¿
const { template } = await inquirer.prompt([
  {
    type: 'list',
    name: 'template',
    message: 'é€‰æ‹©æ¨¡æ¿:',
    choices: allTemplates
  }
]);
```

---

## 4. é…ç½®æ–‡ä»¶ç³»ç»Ÿ

### 4.1 é…ç½®æ–‡ä»¶æ ¼å¼

```json
// .scaffoldrc.json æˆ– .my-clirc.json
{
  "templates": {
    "custom-react": "~/.my-cli/templates/custom-react",
    "company-template": "github:company/templates/react"
  },
  "defaults": {
    "packageManager": "pnpm",
    "installDeps": true,
    "initGit": true,
    "features": ["eslint", "prettier"]
  },
  "plugins": [
    "my-cli-eslint-plugin",
    "my-cli-prettier-plugin"
  ]
}
```

### 4.2 é…ç½®ç®¡ç†å™¨

```typescript
// src/utils/config.ts
import path from 'path';
import fs from 'fs-extra';

export interface ScaffoldConfig {
  templates?: Record<string, string>;
  defaults?: {
    packageManager?: 'npm' | 'yarn' | 'pnpm';
    installDeps?: boolean;
    initGit?: boolean;
    features?: string[];
  };
  plugins?: string[];
}

export class ConfigManager {
  private configPath: string;

  constructor() {
    // æ”¯æŒå¤šä¸ªé…ç½®æ–‡ä»¶ä½ç½®
    const homeDir = require('os').homedir();
    this.configPath = path.join(homeDir, '.my-cli', 'config.json');
  }

  // åŠ è½½é…ç½®
  async loadConfig(): Promise<ScaffoldConfig> {
    if (await fs.pathExists(this.configPath)) {
      return await fs.readJson(this.configPath);
    }

    // è¿”å›é»˜è®¤é…ç½®
    return {
      defaults: {
        packageManager: 'npm',
        installDeps: true,
        initGit: true,
        features: []
      }
    };
  }

  // ä¿å­˜é…ç½®
  async saveConfig(config: ScaffoldConfig): Promise<void> {
    await fs.ensureDir(path.dirname(this.configPath));
    await fs.writeJson(this.configPath, config, { spaces: 2 });
  }

  // åˆå¹¶é…ç½®
  mergeConfig(
    base: ScaffoldConfig,
    override: ScaffoldConfig
  ): ScaffoldConfig {
    return {
      templates: { ...base.templates, ...override.templates },
      defaults: { ...base.defaults, ...override.defaults },
      plugins: [...(base.plugins || []), ...(override.plugins || [])]
    };
  }
}
```

### 4.3 ä½¿ç”¨é…ç½®

```typescript
// åœ¨åˆ›å»ºå‘½ä»¤ä¸­ä½¿ç”¨é…ç½®
const configManager = new ConfigManager();
const config = await configManager.loadConfig();

// åˆå¹¶å‘½ä»¤è¡Œå‚æ•°å’Œé…ç½®
const finalOptions = configManager.mergeConfig(
  {
    defaults: config.defaults || {}
  },
  options
);
```

---

## 5. Mock æœåŠ¡å™¨é›†æˆ

### 5.1 Mock æœåŠ¡å™¨æ’ä»¶

```typescript
// plugins/mock-server-plugin/index.ts
import { Plugin } from '../../src/core/plugin';
import { HookRegistry } from '../../src/core/hooks';
import { LifecycleHooks } from '../../src/core/lifecycle';
import express from 'express';
import { createServer } from 'http';

const mockServerPlugin: Plugin = {
  name: 'mock-server-plugin',
  version: '1.0.0',
  description: 'æ·»åŠ  Mock æœåŠ¡å™¨',

  install(registry: HookRegistry, options?: any) {
    registry.register(
      LifecycleHooks.AFTER_CREATE,
      async (targetDir: string, createOptions: any) => {
        if (createOptions.features?.includes('mock-server')) {
          await addMockServer(targetDir, createOptions);
        }
      },
      50
    );
  }
};

async function addMockServer(targetDir: string, options: any) {
  // åˆ›å»º mock ç›®å½•
  const mockDir = path.join(targetDir, 'mock');
  await fs.ensureDir(mockDir);

  // åˆ›å»º mock æœåŠ¡å™¨æ–‡ä»¶
  const mockServerCode = `
import express from 'express';

const app = express();
app.use(express.json());

// Mock API
app.get('/api/users', (req, res) => {
  res.json([
    { id: 1, name: 'User 1' },
    { id: 2, name: 'User 2' }
  ]);
});

app.listen(3001, () => {
  console.log('Mock server running on http://localhost:3001');
});
`;

  await fs.writeFile(
    path.join(mockDir, 'server.js'),
    mockServerCode
  );

  // æ›´æ–° package.json
  const packageJsonPath = path.join(targetDir, 'package.json');
  const packageJson = await fs.readJson(packageJsonPath);

  packageJson.devDependencies = {
    ...packageJson.devDependencies,
    express: '^4.18.0'
  };

  packageJson.scripts = {
    ...packageJson.scripts,
    'mock:server': 'node mock/server.js'
  };

  await fs.writeJson(packageJsonPath, packageJson, { spaces: 2 });
}

export default mockServerPlugin;
```

---

## 6. è¿è¡Œæ—¶èƒ½åŠ›

### 6.1 å¼€å‘æœåŠ¡å™¨é›†æˆ

```typescript
// src/commands/dev.ts
import { Command } from 'commander';
import { execSync } from 'child_process';

export function registerDevCommand(program: Command) {
  program
    .command('dev')
    .description('å¯åŠ¨å¼€å‘æœåŠ¡å™¨')
    .option('-p, --port <port>', 'ç«¯å£å·', '3000')
    .option('--mock', 'å¯åŠ¨ Mock æœåŠ¡å™¨')
    .action(async (options) => {
      if (options.mock) {
        // å¯åŠ¨ Mock æœåŠ¡å™¨
        execSync('npm run mock:server', {
          stdio: 'inherit',
          cwd: process.cwd()
        });
      }

      // å¯åŠ¨å¼€å‘æœåŠ¡å™¨
      execSync('npm run dev', {
        stdio: 'inherit',
        cwd: process.cwd(),
        env: {
          ...process.env,
          PORT: options.port
        }
      });
    });
}
```

### 6.2 ä¸­é—´ä»¶ç³»ç»Ÿ

```typescript
// src/core/middleware.ts
export type Middleware = (
  req: any,
  res: any,
  next: () => void
) => void | Promise<void>;

export class MiddlewareManager {
  private middlewares: Middleware[] = [];

  use(middleware: Middleware): void {
    this.middlewares.push(middleware);
  }

  async execute(req: any, res: any): Promise<void> {
    let index = 0;

    const next = async () => {
      if (index < this.middlewares.length) {
        const middleware = this.middlewares[index++];
        await middleware(req, res, next);
      }
    };

    await next();
  }
}
```

---

## 7. æµ‹è¯•å’Œ CI/CD

### 7.1 å•å…ƒæµ‹è¯•

```typescript
// test/utils/file.test.ts
import { describe, it, expect } from '@jest/globals';
import { createProject } from '../../src/utils/file';
import fs from 'fs-extra';
import path from 'path';

describe('createProject', () => {
  it('should create project directory', async () => {
    const projectName = 'test-project';
    const targetDir = path.join(process.cwd(), projectName);

    // æ¸…ç†
    if (await fs.pathExists(targetDir)) {
      await fs.remove(targetDir);
    }

    await createProject(projectName, {
      template: 'basic-js'
    });

    expect(await fs.pathExists(targetDir)).toBe(true);
    expect(await fs.pathExists(path.join(targetDir, 'package.json'))).toBe(
      true
    );

    // æ¸…ç†
    await fs.remove(targetDir);
  });
});
```

### 7.2 CI/CD é…ç½®

```yaml
# .github/workflows/ci.yml
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
      - run: npm ci
      - run: npm run build
      - run: npm test

  publish:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
          registry-url: 'https://registry.npmjs.org'
      - run: npm ci
      - run: npm run build
      - run: npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
```

---

## ğŸ“ æ€»ç»“

### æ ¸å¿ƒåŠŸèƒ½

1. âœ… å‘å¸ƒåˆ° npm çš„å®Œæ•´æµç¨‹
2. âœ… ç‰ˆæœ¬ç®¡ç†ç­–ç•¥
3. âœ… ç”¨æˆ·è‡ªå®šä¹‰æ¨¡æ¿æ”¯æŒ
4. âœ… é…ç½®æ–‡ä»¶ç³»ç»Ÿ
5. âœ… Mock æœåŠ¡å™¨é›†æˆ
6. âœ… è¿è¡Œæ—¶èƒ½åŠ›
7. âœ… æµ‹è¯•å’Œ CI/CD

### å®Œæ•´æµç¨‹

1. **å¼€å‘** â†’ ç¼–å†™ä»£ç å’Œæµ‹è¯•
2. **æ„å»º** â†’ ç¼–è¯‘ TypeScript
3. **æµ‹è¯•** â†’ è¿è¡Œå•å…ƒæµ‹è¯•
4. **å‘å¸ƒ** â†’ å‘å¸ƒåˆ° npm
5. **ä½¿ç”¨** â†’ ç”¨æˆ·å®‰è£…å’Œä½¿ç”¨

---

#è„šæ‰‹æ¶ #å‰ç«¯å·¥ç¨‹åŒ– #npmå‘å¸ƒ #CI/CD #æ‰©å±•èƒ½åŠ›

