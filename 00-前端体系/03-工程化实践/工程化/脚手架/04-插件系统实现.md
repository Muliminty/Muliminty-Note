# æ’ä»¶ç³»ç»Ÿå®ç°

> å®ç°æ’ä»¶æœºåˆ¶ï¼Œå…è®¸è„šæ‰‹æ¶é€šè¿‡æ’ä»¶æ‰©å±•åŠŸèƒ½ï¼Œç±»ä¼¼ Vite å’Œ Webpack çš„æ’ä»¶ä½“ç³»ï¼ŒåŒ…æ‹¬ Hook æœºåˆ¶ã€æ’ä»¶æ³¨å†Œã€ç”Ÿå‘½å‘¨æœŸç®¡ç†ç­‰ã€‚

---

## ğŸ“‹ ç›®å½•

- [1. æ’ä»¶æ¶æ„è®¾è®¡](#1-æ’ä»¶æ¶æ„è®¾è®¡)
- [2. Hook æœºåˆ¶å®ç°](#2-hook-æœºåˆ¶å®ç°)
- [3. æ’ä»¶æ³¨å†Œå’ŒåŠ è½½](#3-æ’ä»¶æ³¨å†Œå’ŒåŠ è½½)
- [4. æ’ä»¶ç”Ÿå‘½å‘¨æœŸ](#4-æ’ä»¶ç”Ÿå‘½å‘¨æœŸ)
- [5. æ’ä»¶å¼€å‘ç¤ºä¾‹](#5-æ’ä»¶å¼€å‘ç¤ºä¾‹)

---

## 1. æ’ä»¶æ¶æ„è®¾è®¡

### 1.1 æ’ä»¶ç³»ç»Ÿæ¶æ„

```
Scaffold Core
    â†“
Plugin System
    â”œâ”€â”€ Hook Registry
    â”œâ”€â”€ Plugin Loader
    â””â”€â”€ Lifecycle Manager
    â†“
Plugins
    â”œâ”€â”€ ESLint Plugin
    â”œâ”€â”€ Prettier Plugin
    â”œâ”€â”€ Husky Plugin
    â””â”€â”€ Custom Plugin
```

### 1.2 æ ¸å¿ƒæ¦‚å¿µ

- **Hookï¼ˆé’©å­ï¼‰**ï¼šåœ¨ç‰¹å®šæ—¶æœºæ‰§è¡Œçš„å‡½æ•°
- **Pluginï¼ˆæ’ä»¶ï¼‰**ï¼šåŒ…å«å¤šä¸ª Hook çš„æ¨¡å—
- **Lifecycleï¼ˆç”Ÿå‘½å‘¨æœŸï¼‰**ï¼šæ’ä»¶æ‰§è¡Œçš„å„ä¸ªé˜¶æ®µ

---

## 2. Hook æœºåˆ¶å®ç°

### 2.1 Hook ç±»å‹å®šä¹‰

```typescript
// src/core/hooks.ts
export type HookFunction = (...args: any[]) => Promise<void> | void;

export interface Hook {
  name: string;
  fn: HookFunction;
  priority?: number; // ä¼˜å…ˆçº§ï¼Œæ•°å­—è¶Šå°è¶Šå…ˆæ‰§è¡Œ
}

export class HookRegistry {
  private hooks: Map<string, Hook[]> = new Map();

  // æ³¨å†Œ Hook
  register(hookName: string, fn: HookFunction, priority: number = 100) {
    if (!this.hooks.has(hookName)) {
      this.hooks.set(hookName, []);
    }

    const hooks = this.hooks.get(hookName)!;
    hooks.push({ name: hookName, fn, priority });
    
    // æŒ‰ä¼˜å…ˆçº§æ’åº
    hooks.sort((a, b) => (a.priority || 100) - (b.priority || 100));
  }

  // æ‰§è¡Œ Hook
  async execute(hookName: string, ...args: any[]): Promise<void> {
    const hooks = this.hooks.get(hookName) || [];
    
    for (const hook of hooks) {
      await hook.fn(...args);
    }
  }

  // è·å–æ‰€æœ‰ Hook åç§°
  getHookNames(): string[] {
    return Array.from(this.hooks.keys());
  }
}
```

### 2.2 é¢„å®šä¹‰ Hook

```typescript
// src/core/lifecycle.ts
export enum LifecycleHooks {
  // åˆ›å»ºå‰
  BEFORE_CREATE = 'beforeCreate',
  
  // åˆ›å»ºå
  AFTER_CREATE = 'afterCreate',
  
  // æ¨¡æ¿å¤„ç†å‰
  BEFORE_RENDER_TEMPLATE = 'beforeRenderTemplate',
  
  // æ¨¡æ¿å¤„ç†å
  AFTER_RENDER_TEMPLATE = 'afterRenderTemplate',
  
  // å®‰è£…ä¾èµ–å‰
  BEFORE_INSTALL = 'beforeInstall',
  
  // å®‰è£…ä¾èµ–å
  AFTER_INSTALL = 'afterInstall',
  
  // Git åˆå§‹åŒ–å‰
  BEFORE_INIT_GIT = 'beforeInitGit',
  
  // Git åˆå§‹åŒ–å
  AFTER_INIT_GIT = 'afterInitGit',
  
  // å®Œæˆå‰
  BEFORE_COMPLETE = 'beforeComplete',
  
  // å®Œæˆå
  AFTER_COMPLETE = 'afterComplete'
}
```

---

## 3. æ’ä»¶æ³¨å†Œå’ŒåŠ è½½

### 3.1 æ’ä»¶æ¥å£å®šä¹‰

```typescript
// src/core/plugin.ts
import { HookRegistry } from './hooks';
import { LifecycleHooks } from './lifecycle';

export interface Plugin {
  name: string;
  version?: string;
  description?: string;
  
  // æ’ä»¶å®‰è£…å‡½æ•°
  install(registry: HookRegistry, options?: any): void;
  
  // æ’ä»¶å¸è½½å‡½æ•°ï¼ˆå¯é€‰ï¼‰
  uninstall?(): void;
}

export class PluginManager {
  private registry: HookRegistry;
  private plugins: Map<string, Plugin> = new Map();

  constructor() {
    this.registry = new HookRegistry();
  }

  // æ³¨å†Œæ’ä»¶
  register(plugin: Plugin, options?: any): void {
    if (this.plugins.has(plugin.name)) {
      throw new Error(`Plugin ${plugin.name} is already registered`);
    }

    plugin.install(this.registry, options);
    this.plugins.set(plugin.name, plugin);
  }

  // å¸è½½æ’ä»¶
  unregister(pluginName: string): void {
    const plugin = this.plugins.get(pluginName);
    if (plugin && plugin.uninstall) {
      plugin.uninstall();
    }
    this.plugins.delete(pluginName);
  }

  // è·å– Hook Registry
  getRegistry(): HookRegistry {
    return this.registry;
  }

  // è·å–æ‰€æœ‰æ’ä»¶
  getPlugins(): Plugin[] {
    return Array.from(this.plugins.values());
  }
}
```

### 3.2 æ’ä»¶åŠ è½½å™¨

```typescript
// src/core/loader.ts
import path from 'path';
import fs from 'fs-extra';
import { Plugin, PluginManager } from './plugin';

export class PluginLoader {
  // ä»æœ¬åœ°è·¯å¾„åŠ è½½æ’ä»¶
  async loadFromPath(pluginPath: string): Promise<Plugin> {
    const fullPath = path.resolve(pluginPath);
    
    if (!(await fs.pathExists(fullPath))) {
      throw new Error(`Plugin not found: ${pluginPath}`);
    }

    // å°è¯•åŠ è½½æ’ä»¶
    const pluginModule = require(fullPath);
    
    // æ”¯æŒé»˜è®¤å¯¼å‡ºæˆ–å‘½åå¯¼å‡º
    const plugin = pluginModule.default || pluginModule;
    
    if (!plugin || typeof plugin.install !== 'function') {
      throw new Error(`Invalid plugin: ${pluginPath}`);
    }

    return plugin;
  }

  // ä» npm åŒ…åŠ è½½æ’ä»¶
  async loadFromNpm(packageName: string): Promise<Plugin> {
    // è¿™é‡Œéœ€è¦å…ˆå®‰è£… npm åŒ…
    // ç„¶ååŠ è½½æ’ä»¶
    const pluginPath = path.join(
      process.cwd(),
      'node_modules',
      packageName
    );
    
    return this.loadFromPath(pluginPath);
  }
}
```

---

## 4. æ’ä»¶ç”Ÿå‘½å‘¨æœŸ

### 4.1 é›†æˆåˆ°åˆ›å»ºæµç¨‹

```typescript
// src/commands/create.ts
import { PluginManager } from '../core/plugin';
import { LifecycleHooks } from '../core/lifecycle';

export async function createCommand(
  projectName: string,
  options: any
) {
  const pluginManager = new PluginManager();
  const registry = pluginManager.getRegistry();

  try {
    // 1. åŠ è½½æ’ä»¶
    await loadPlugins(pluginManager, options);

    // 2. beforeCreate Hook
    await registry.execute(LifecycleHooks.BEFORE_CREATE, projectName, options);

    // 3. åˆ›å»ºé¡¹ç›®
    const targetDir = path.resolve(process.cwd(), projectName);
    await createProject(targetDir, options);

    // 4. afterCreate Hook
    await registry.execute(LifecycleHooks.AFTER_CREATE, targetDir, options);

    // 5. beforeRenderTemplate Hook
    await registry.execute(
      LifecycleHooks.BEFORE_RENDER_TEMPLATE,
      targetDir,
      options
    );

    // 6. æ¸²æŸ“æ¨¡æ¿
    await renderTemplate(targetDir, options);

    // 7. afterRenderTemplate Hook
    await registry.execute(
      LifecycleHooks.AFTER_RENDER_TEMPLATE,
      targetDir,
      options
    );

    // 8. å®‰è£…ä¾èµ–
    if (options.installDeps) {
      await registry.execute(
        LifecycleHooks.BEFORE_INSTALL,
        targetDir,
        options
      );

      await installDependencies(targetDir, options.packageManager);

      await registry.execute(
        LifecycleHooks.AFTER_INSTALL,
        targetDir,
        options
      );
    }

    // 9. åˆå§‹åŒ– Git
    if (options.initGit) {
      await registry.execute(
        LifecycleHooks.BEFORE_INIT_GIT,
        targetDir,
        options
      );

      await initGit(targetDir);

      await registry.execute(
        LifecycleHooks.AFTER_INIT_GIT,
        targetDir,
        options
      );
    }

    // 10. beforeComplete Hook
    await registry.execute(
      LifecycleHooks.BEFORE_COMPLETE,
      targetDir,
      options
    );

    // 11. afterComplete Hook
    await registry.execute(
      LifecycleHooks.AFTER_COMPLETE,
      targetDir,
      options
    );

    logger.success(`é¡¹ç›® ${projectName} åˆ›å»ºæˆåŠŸï¼`);
  } catch (error) {
    logger.error(`åˆ›å»ºé¡¹ç›®å¤±è´¥: ${error.message}`);
    throw error;
  }
}

async function loadPlugins(
  pluginManager: PluginManager,
  options: any
): Promise<void> {
  // ä»é…ç½®æˆ–é€‰é¡¹åŠ è½½æ’ä»¶
  const plugins = options.plugins || [];

  for (const pluginConfig of plugins) {
    if (typeof pluginConfig === 'string') {
      // æ’ä»¶åç§°
      const loader = new PluginLoader();
      const plugin = await loader.loadFromNpm(pluginConfig);
      pluginManager.register(plugin);
    } else if (typeof pluginConfig === 'object') {
      // æ’ä»¶é…ç½®å¯¹è±¡
      const loader = new PluginLoader();
      const plugin = await loader.loadFromPath(pluginConfig.path);
      pluginManager.register(plugin, pluginConfig.options);
    }
  }
}
```

---

## 5. æ’ä»¶å¼€å‘ç¤ºä¾‹

### 5.1 ESLint æ’ä»¶

```typescript
// plugins/eslint-plugin/index.ts
import { Plugin } from '../../src/core/plugin';
import { HookRegistry } from '../../src/core/hooks';
import { LifecycleHooks } from '../../src/core/lifecycle';
import fs from 'fs-extra';
import path from 'path';

const eslintPlugin: Plugin = {
  name: 'eslint-plugin',
  version: '1.0.0',
  description: 'è‡ªåŠ¨æ·»åŠ  ESLint é…ç½®',

  install(registry: HookRegistry, options?: any) {
    // åœ¨ afterCreate æ—¶æ·»åŠ  ESLint é…ç½®
    registry.register(
      LifecycleHooks.AFTER_CREATE,
      async (targetDir: string, createOptions: any) => {
        if (createOptions.features?.includes('eslint')) {
          await addESLintConfig(targetDir, createOptions);
        }
      },
      50 // ä¼˜å…ˆçº§
    );
  }
};

async function addESLintConfig(targetDir: string, options: any) {
  const eslintConfig = {
    extends: options.useTypeScript
      ? ['eslint:recommended', '@typescript-eslint/recommended']
      : ['eslint:recommended'],
    parser: options.useTypeScript ? '@typescript-eslint/parser' : undefined,
    parserOptions: {
      ecmaVersion: 2020,
      sourceType: 'module',
      ...(options.useTypeScript && {
        project: './tsconfig.json'
      })
    },
    env: {
      browser: true,
      es2020: true
    }
  };

  const configPath = path.join(targetDir, '.eslintrc.json');
  await fs.writeJson(configPath, eslintConfig, { spaces: 2 });

  // æ›´æ–° package.json
  const packageJsonPath = path.join(targetDir, 'package.json');
  const packageJson = await fs.readJson(packageJsonPath);

  packageJson.devDependencies = {
    ...packageJson.devDependencies,
    eslint: '^8.0.0',
    ...(options.useTypeScript && {
      '@typescript-eslint/eslint-plugin': '^5.0.0',
      '@typescript-eslint/parser': '^5.0.0'
    })
  };

  packageJson.scripts = {
    ...packageJson.scripts,
    lint: 'eslint src --ext .js,.jsx,.ts,.tsx',
    'lint:fix': 'eslint src --ext .js,.jsx,.ts,.tsx --fix'
  };

  await fs.writeJson(packageJsonPath, packageJson, { spaces: 2 });
}

export default eslintPlugin;
```

### 5.2 Prettier æ’ä»¶

```typescript
// plugins/prettier-plugin/index.ts
import { Plugin } from '../../src/core/plugin';
import { HookRegistry } from '../../src/core/hooks';
import { LifecycleHooks } from '../../src/core/lifecycle';
import fs from 'fs-extra';
import path from 'path';

const prettierPlugin: Plugin = {
  name: 'prettier-plugin',
  version: '1.0.0',
  description: 'è‡ªåŠ¨æ·»åŠ  Prettier é…ç½®',

  install(registry: HookRegistry, options?: any) {
    registry.register(
      LifecycleHooks.AFTER_CREATE,
      async (targetDir: string, createOptions: any) => {
        if (createOptions.features?.includes('prettier')) {
          await addPrettierConfig(targetDir);
        }
      },
      50
    );
  }
};

async function addPrettierConfig(targetDir: string) {
  const prettierConfig = {
    semi: true,
    singleQuote: true,
    tabWidth: 2,
    trailingComma: 'es5',
    printWidth: 80
  };

  const configPath = path.join(targetDir, '.prettierrc.json');
  await fs.writeJson(configPath, prettierConfig, { spaces: 2 });

  // æ·»åŠ  .prettierignore
  const ignorePath = path.join(targetDir, '.prettierignore');
  await fs.writeFile(
    ignorePath,
    'node_modules\ndist\nbuild\ncoverage\n'
  );

  // æ›´æ–° package.json
  const packageJsonPath = path.join(targetDir, 'package.json');
  const packageJson = await fs.readJson(packageJsonPath);

  packageJson.devDependencies = {
    ...packageJson.devDependencies,
    prettier: '^2.8.0'
  };

  packageJson.scripts = {
    ...packageJson.scripts,
    format: 'prettier --write "src/**/*.{js,jsx,ts,tsx,json,css,md}"'
  };

  await fs.writeJson(packageJsonPath, packageJson, { spaces: 2 });
}

export default prettierPlugin;
```

### 5.3 Husky æ’ä»¶

```typescript
// plugins/husky-plugin/index.ts
import { Plugin } from '../../src/core/plugin';
import { HookRegistry } from '../../src/core/hooks';
import { LifecycleHooks } from '../../src/core/lifecycle';
import { execSync } from 'child_process';
import fs from 'fs-extra';
import path from 'path';

const huskyPlugin: Plugin = {
  name: 'husky-plugin',
  version: '1.0.0',
  description: 'è‡ªåŠ¨æ·»åŠ  Husky Git Hooks',

  install(registry: HookRegistry, options?: any) {
    registry.register(
      LifecycleHooks.AFTER_INSTALL,
      async (targetDir: string, createOptions: any) => {
        if (createOptions.features?.includes('husky')) {
          await setupHusky(targetDir, createOptions);
        }
      },
      50
    );
  }
};

async function setupHusky(targetDir: string, options: any) {
  // æ›´æ–° package.json
  const packageJsonPath = path.join(targetDir, 'package.json');
  const packageJson = await fs.readJson(packageJsonPath);

  packageJson.devDependencies = {
    ...packageJson.devDependencies,
    husky: '^8.0.0',
    'lint-staged': '^13.0.0'
  };

  packageJson.scripts = {
    ...packageJson.scripts,
    prepare: 'husky install'
  };

  await fs.writeJson(packageJsonPath, packageJson, { spaces: 2 });

  // å®‰è£…ä¾èµ–ååˆå§‹åŒ– Husky
  execSync('npm run prepare', { cwd: targetDir, stdio: 'inherit' });

  // åˆ›å»º pre-commit hook
  const huskyDir = path.join(targetDir, '.husky');
  await fs.ensureDir(huskyDir);

  const preCommitHook = `#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

npx lint-staged
`;

  await fs.writeFile(
    path.join(huskyDir, 'pre-commit'),
    preCommitHook
  );
  await fs.chmod(path.join(huskyDir, 'pre-commit'), '755');

  // æ·»åŠ  lint-staged é…ç½®
  packageJson['lint-staged'] = {
    '*.{js,jsx,ts,tsx}': ['eslint --fix', 'prettier --write'],
    '*.{json,css,md}': ['prettier --write']
  };

  await fs.writeJson(packageJsonPath, packageJson, { spaces: 2 });
}

export default huskyPlugin;
```

### 5.4 ä½¿ç”¨æ’ä»¶

```typescript
// åœ¨åˆ›å»ºå‘½ä»¤ä¸­ä½¿ç”¨æ’ä»¶
const options = {
  template: 'react-ts',
  features: ['eslint', 'prettier', 'husky'],
  plugins: [
    'my-cli-eslint-plugin',
    'my-cli-prettier-plugin',
    'my-cli-husky-plugin'
  ]
};

await createCommand('my-app', options);
```

---

## ğŸ“ æ€»ç»“

### æ ¸å¿ƒåŠŸèƒ½

1. âœ… Hook æœºåˆ¶å®ç°
2. âœ… æ’ä»¶æ³¨å†Œå’ŒåŠ è½½
3. âœ… ç”Ÿå‘½å‘¨æœŸç®¡ç†
4. âœ… æ’ä»¶å¼€å‘ç¤ºä¾‹ï¼ˆESLintã€Prettierã€Huskyï¼‰

### ä¸‹ä¸€æ­¥

- [è¿œç¨‹æ¨¡æ¿æ”¯æŒ](./05-è¿œç¨‹æ¨¡æ¿æ”¯æŒ.md) - æ”¯æŒä» GitHubã€npm ç­‰è¿œç¨‹æºä¸‹è½½æ¨¡æ¿

---

#è„šæ‰‹æ¶ #å‰ç«¯å·¥ç¨‹åŒ– #æ’ä»¶ç³»ç»Ÿ #Hookæœºåˆ¶ #Node.js

