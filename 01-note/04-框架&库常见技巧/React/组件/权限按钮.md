## **React 权限按钮组件 - PermissionButton**

### **功能概述**

`PermissionButton` 是一个基于用户权限控制的按钮组件，适用于需要根据用户角色判断是否显示或禁用按钮的场景。该组件支持加载指示器、按钮禁用和隐藏等功能，方便与权限系统集成。该组件可以在按钮点击时显示加载状态，并根据权限数组来判断按钮的显示和启用状态。

### **核心特性**
- **权限控制**：根据用户角色权限决定按钮是否显示或禁用。
- **加载状态**：在执行点击事件时支持显示加载指示器。
- **按钮类型**：支持 `disabled` 和 `hidden` 两种按钮显示方式，允许隐藏或禁用按钮。
- **权限处理**：支持根据 `permissions` 数组控制按钮的权限。

---

### **代码解析**

#### **1. 组件结构和输入参数**

`PermissionButton` 组件接收以下属性：

```js
const PermissionButton = ({
  roles = [],             // 用户角色权限数组
  children,               // 按钮的子元素
  onClick,                // 点击事件处理函数
  btnType = 'disabled',   // 按钮类型（'disabled' 或 'hidden'）
  permissions,            // 权限数组
  ...restProps           // 其他按钮属性
}) => { ... }
```

- `roles`：用户的角色权限数组，组件会根据角色权限来决定按钮是否显示或启用。
- `children`：按钮的内容，可以是任何 React 组件或文本。
- `onClick`：按钮的点击事件处理函数。
- `btnType`：控制按钮类型，`'disabled'` 表示按钮禁用，`'hidden'` 表示按钮隐藏。默认值为 `'disabled'`。
- `permissions`：来自 Redux 状态管理的权限数组，用于控制用户的访问权限。
- `restProps`：所有其他传递给 `<Button />` 的属性，如 `className`, `style` 等。

#### **2. 组件状态管理**

```js
const [permission, setPermission] = useState(null);  // 权限状态
const [loading, setLoading] = useState(false);       // 加载状态
```

- `permission`：用于存储用户的权限数据。初始状态为 `null`，表示权限尚未加载。
- `loading`：表示按钮是否处于加载状态。当点击按钮时，`loading` 被设置为 `true`，执行 `onClick` 后重置为 `false`。

#### **3. 权限加载逻辑**

`useEffect` 钩子用于加载和处理权限数据：

```js
useEffect(() => {
  try {
    const storedPermission = permissions || [];
    if (Array.isArray(storedPermission)) {
      setPermission([...storedPermission, 'unrestricted']);
    } else {
      setPermission([]);  // 权限为空时默认设置为空数组
    }
  } catch (error) {
    setPermission(null);  // 出现异常时将权限设置为空数组
  }
}, [permissions]);
```

- 如果 `permissions` 数组有效，则将其与 `'unrestricted'` 权限合并，表示用户拥有不受限制的权限。
- 如果没有权限或加载出错，则权限设置为 `null`。

#### **4. 按钮点击事件**

`handleOnClick` 函数负责处理按钮的点击事件，并管理加载状态：

```js
const handleOnClick = async (e) => {
  if (onClick) {
    setLoading(true);
    try {
      await onClick(e);  // 执行点击事件处理函数
    } catch (error) {
      // 错误处理（目前为空）
    } finally {
      setLoading(false);  // 无论成功与否，都停止加载状态
    }
  }
};
```

- 在按钮点击时，先设置 `loading` 为 `true`，然后调用 `onClick` 事件处理函数。
- 执行完毕后，恢复 `loading` 为 `false`。

#### **5. 权限判断和按钮渲染**

- 判断是否有足够权限来启用按钮：

```js
const isEnabled = Array.isArray(permission) && permission.length > 0 && roles?.some(role => permission.includes(role));
```

- 如果权限尚未加载，则返回空（`null` 或自定义加载组件）：

```js
if (permission === null) {
  return <></>;  // 或者返回其他自定义的加载组件
}
```

- 根据 `btnType` 判断按钮显示方式：
  - **禁用按钮**：当 `btnType` 为 `'disabled'` 时，按钮可以被禁用，但仍然显示。
  - **隐藏按钮**：当 `btnType` 为 `'hidden'` 时，按钮会根据权限判断是否渲染。

```js
if (btnType === 'disabled') {
  return (
    <Button
      title={permission ? '' : '没有权限'}
      {...restProps}
      loading={loading && hasLoadingRole}
      onClick={handleOnClick}
      disabled={!isEnabled || restProps.disabled}
    >
      {children}
    </Button>
  );
}

if (btnType === 'hidden') {
  return isEnabled ? (
    <Button
      {...restProps}
      loading={loading && hasLoadingRole}
      onClick={handleOnClick}
    >
      {children}
    </Button>
  ) : null;  // 如果没有权限则不渲染按钮
}
```

- `hasLoadingRole` 用于检查用户角色是否包含 `'loading'`，若包含，则在加载时显示加载指示器。
- `isEnabled` 判断当前权限是否足够，如果没有权限则禁用或隐藏按钮。

#### **6. Redux 数据连接**

`mapStateToProps` 用于从 Redux 中获取用户权限：

```js
const mapStateToProps = ({ account }) => ({
  permissions: account.permissions,  // 获取当前用户的权限
});
```

通过 `connect` 将组件与 Redux 状态连接：

```js
export default connect(mapStateToProps)(PermissionButton);
```

这样，组件可以自动获取到最新的 `permissions` 数据。

---

### **组件使用场景**

- **权限控制按钮**：根据不同角色权限显示或禁用按钮。
- **加载状态指示**：在执行一些异步操作（如 API 请求）时，通过按钮显示加载状态。
- **动态按钮显示**：根据角色权限动态决定是否显示或禁用按钮。

---

```
import React, { useEffect, useState } from 'react';
import { Button } from 'antd';  // 引入 Spin 用于显示加载指示器
import { connect } from 'react-redux';

/**
 * PermissionButton 组件用于根据用户权限显示按钮，并在特定条件下启用加载效果。
 * 
 * @component
 * @param {Object} props - 组件的属性。
 * @param {Array<string>} props.roles - 用户角色权限数组，其中包含 'loading' 时启用加载效果。
 * @param {React.ReactNode} props.children - 按钮的子元素。
 * @param {Function} [props.onClick] - 按钮的点击事件处理函数。
 * @param {Object} [props.restProps] - 其他传递给按钮的属性。
 * @param {Object} [props.btnType] - 按钮的类型，默认为 'disabled','hidden' 时隐藏按钮，'disabled' 时禁用按钮。
 * @returns {React.ReactElement} 权限按钮组件。
 */
const PermissionButton = ({ roles = [], children, onClick, btnType = 'disabled', permissions, ...restProps }) => {
  const [permission, setPermission] = useState(null);
  const [loading, setLoading] = useState(false);

  // 权限加载逻辑
  useEffect(() => {
    try {
      const storedPermission = permissions || [];
      if (Array.isArray(storedPermission)) {
        setPermission([...storedPermission, 'unrestricted']);
      } else {
        setPermission([]);  // 如果没有权限，则默认设置为空数组
      }
    } catch (error) {
      setPermission(null);  // 出现异常时也设置为空数组
    }
  }, [permissions]);

  const handleOnClick = async (e) => {
    if (onClick) {
      setLoading(true);
      try {
        await onClick(e);
      } catch (error) {

      } finally {
        setLoading(false);
      }
    }
  };



  const hasLoadingRole = roles.includes('loading');

  // 检查 permission 是否是数组，并且确保 roles 中有权限角色
  const isEnabled = Array.isArray(permission) && permission.length > 0 && roles?.some(role => permission.includes(role));

  // 如果权限数据尚未加载，显示加载指示器
  if (permission === null) {
    return <></>;  // 或者返回其他自定义的加载组件
  }

  if (btnType === 'disabled') {
    return (
      <Button
        title={permission ? '' : '没有权限'}
        {...restProps}
        loading={loading && hasLoadingRole}
        onClick={handleOnClick}
        disabled={!isEnabled || restProps.disabled}
      >
        {children}
      </Button>
    );
  }

  if (btnType === 'hidden') {
    return isEnabled ? (
      <Button
        {...restProps}
        loading={loading && hasLoadingRole}
        onClick={handleOnClick}
      >
        {children}
      </Button>
    ) : null;  // 如果没有权限则不渲染按钮
  }

  return <></>;  // 需要保证返回 null 的情况是预期的
};

const mapStateToProps = ({ account }) => ({
  permissions: account.permissions,
});

export default connect(mapStateToProps)(PermissionButton);


```