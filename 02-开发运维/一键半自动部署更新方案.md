
### 🧩 1. 总体架构
```
本地开发 → git push → 服务器 Hook → 自动 build → Docker 重启 → Nginx 零中断
```

---

### 🛠️ 2. 环境准备（一次性）
| 组件 | 命令 |
|---|---|
| **Ubuntu 22.04+** | 已有 |
| **Docker** | `sudo apt install docker.io` |
| **Docker Compose** | `sudo apt install docker-compose-plugin` |
| **Git** | `sudo apt install git` |
| **Nginx** | `sudo apt install nginx` |

---

### 📁 3. 项目目录（示例）
```
/home/muliminty/app
├── docker-compose.yml
├── Dockerfile
├── .git/hooks/post-receive   ← 自动部署触发器
└── dist/                     ← 构建产物（前端）或 jar（后端）
```

---

### 🐳 4. Dockerfile（以静态前端为例）
```dockerfile
FROM nginx:alpine
COPY dist /usr/share/nginx/html
```
```yaml
# docker-compose.yml
version: "3.9"
services:
  web:
    build: .
    ports:
      - "127.0.0.1:3000:80"
    restart: unless-stopped
```

---

### 🔁 5. 一键更新脚本（本地也可手动跑）
```bash
#!/bin/bash
# /home/muliminty/app/update.sh
set -e
cd /home/muliminty/app
git pull origin main
docker compose build --no-cache
docker compose up -d --remove-orphans
echo "✅ 更新完成，容器已重启"
```
赋权：  
```bash
chmod +x /home/muliminty/app/update.sh
```

---

### 🪝 6. Git 服务器 Hook（自动触发）
```bash
# /home/muliminty/app/.git/hooks/post-receive
#!/bin/bash
exec >>/tmp/deploy.log 2>&1
echo "$(date) 收到 push，开始部署..."
cd /home/muliminty/app || exit 1
./update.sh
```
赋权：  
```bash
chmod +x /home/muliminty/app/.git/hooks/post-receive
```

---

### 🌐 7. Nginx 反向代理（零中断）
```nginx
# /etc/nginx/sites-available/app
server {
    listen 80;
    server_name  your-domain.com;

    location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```
启用：
```bash
sudo ln -s /etc/nginx/sites-available/app /etc/nginx/sites-enabled/
sudo nginx -t && sudo systemctl reload nginx
```

---

### 🚀 8. 使用流程（日常开发）
1. 本地写代码 → `git commit -m "xxx"`  
2. `git push origin main`  
3. 服务器 Hook 自动执行 `./update.sh`  
4. Docker 重新构建 → 平滑重启 → Nginx 无中断  
5. 浏览器刷新即可看到最新效果