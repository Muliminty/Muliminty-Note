# Nginx å˜é‡ä½¿ç”¨

> Nginx å˜é‡çš„å®šä¹‰ã€ä½¿ç”¨å’Œä½œç”¨åŸŸ

---

## ğŸ“‹ ç›®å½•

- [å†…ç½®å˜é‡](#å†…ç½®å˜é‡)
- [è‡ªå®šä¹‰å˜é‡](#è‡ªå®šä¹‰å˜é‡)
- [å˜é‡ä½œç”¨åŸŸ](#å˜é‡ä½œç”¨åŸŸ)
- [Map æ¨¡å—](#map-æ¨¡å—)
- [å˜é‡ä½¿ç”¨ç¤ºä¾‹](#å˜é‡ä½¿ç”¨ç¤ºä¾‹)

---

## å†…ç½®å˜é‡

### HTTP è¯·æ±‚ç›¸å…³å˜é‡

```nginx
# å®¢æˆ·ç«¯ä¿¡æ¯
$remote_addr        # å®¢æˆ·ç«¯ IP åœ°å€
$remote_port        # å®¢æˆ·ç«¯ç«¯å£
$remote_user        # å®¢æˆ·ç«¯ç”¨æˆ·åï¼ˆåŸºæœ¬è®¤è¯ï¼‰
$http_user_agent    # ç”¨æˆ·ä»£ç†å­—ç¬¦ä¸²
$http_referer       # æ¥æºé¡µé¢

# è¯·æ±‚ä¿¡æ¯
$request            # å®Œæ•´è¯·æ±‚è¡Œï¼ˆGET / HTTP/1.1ï¼‰
$request_method     # è¯·æ±‚æ–¹æ³•ï¼ˆGETã€POST ç­‰ï¼‰
$request_uri        # å®Œæ•´ URIï¼ˆå¸¦å‚æ•°ï¼‰
$uri                # è¯·æ±‚ URIï¼ˆä¸å¸¦å‚æ•°ï¼Œå¯èƒ½æ”¹å˜ï¼‰
$document_uri       # åŒ $uri
$args               # æŸ¥è¯¢å­—ç¬¦ä¸²
$query_string       # åŒ $args
$server_protocol    # åè®®ç‰ˆæœ¬ï¼ˆHTTP/1.1ã€HTTP/2.0ï¼‰

# æœåŠ¡å™¨ä¿¡æ¯
$server_name        # æœåŠ¡å™¨åç§°
$server_addr        # æœåŠ¡å™¨ IP
$server_port        # æœåŠ¡å™¨ç«¯å£
$hostname           # ä¸»æœºå
$https              # æ˜¯å¦ HTTPSï¼ˆon æˆ–ç©ºï¼‰
$scheme             # åè®®ï¼ˆhttp æˆ– httpsï¼‰
```

### HTTP å“åº”ç›¸å…³å˜é‡

```nginx
$status             # å“åº”çŠ¶æ€ç 
$body_bytes_sent    # å“åº”ä½“å¤§å°ï¼ˆå­—èŠ‚ï¼‰
$bytes_sent         # å“åº”æ€»å¤§å°ï¼ˆå­—èŠ‚ï¼‰
$content_length     # å“åº”å¤´ä¸­çš„ Content-Length
$content_type       # å“åº”å¤´ä¸­çš„ Content-Type
$sent_http_NAME     # å‘é€çš„å“åº”å¤´ï¼ˆå¦‚ $sent_http_content_typeï¼‰
```

### æ—¶é—´ç›¸å…³å˜é‡

```nginx
$time_local         # æœ¬åœ°æ—¶é—´æ ¼å¼ï¼ˆ02/Jan/2024:12:34:56 +0800ï¼‰
$time_iso8601       # ISO 8601 æ—¶é—´æ ¼å¼ï¼ˆ2024-01-02T12:34:56+08:00ï¼‰
$msec               # æ¯«ç§’çº§æ—¶é—´æˆ³
$request_time       # è¯·æ±‚å¤„ç†æ—¶é—´ï¼ˆç§’ï¼Œæ¯«ç§’ç²¾åº¦ï¼‰
$upstream_response_time  # ä¸Šæ¸¸å“åº”æ—¶é—´
```

### ä»£ç†ç›¸å…³å˜é‡

```nginx
$proxy_host         # ä»£ç†ä¸»æœºå
$proxy_port         # ä»£ç†ç«¯å£
$proxy_add_x_forwarded_for  # X-Forwarded-For å€¼

# åå‘ä»£ç†ç›¸å…³
$upstream_addr      # ä¸Šæ¸¸æœåŠ¡å™¨åœ°å€
$upstream_status    # ä¸Šæ¸¸å“åº”çŠ¶æ€ç 
$upstream_response_time  # ä¸Šæ¸¸å“åº”æ—¶é—´
```

### Location ç›¸å…³å˜é‡

```nginx
$document_root      # å½“å‰è¯·æ±‚çš„æ ¹ç›®å½•
$realpath_root      # æ ¹ç›®å½•çš„è§„èŒƒè·¯å¾„
$request_filename   # è¯·æ±‚çš„æ–‡ä»¶è·¯å¾„ï¼ˆroot + uriï¼‰
```

### Cookie ç›¸å…³å˜é‡

```nginx
$cookie_NAME        # è·å–æŒ‡å®šåç§°çš„ cookie å€¼
$http_cookie        # æ‰€æœ‰ cookie å­—ç¬¦ä¸²
```

### ç‰¹æ®Šå˜é‡

```nginx
$is_args            # æ˜¯å¦æœ‰æŸ¥è¯¢å­—ç¬¦ä¸²ï¼ˆ? æˆ–ç©ºï¼‰
$args_value         # æŸ¥è¯¢å­—ç¬¦ä¸²çš„å€¼
$limit_rate         # é™é€Ÿå€¼

# åœ°ç†ä½ç½®å˜é‡ï¼ˆéœ€è¦ GeoIP æ¨¡å—ï¼‰
$geoip_country_code
$geoip_country_name
$geoip_city
$geoip_latitude
$geoip_longitude
```

---

## è‡ªå®šä¹‰å˜é‡

### Set æŒ‡ä»¤

```nginx
# åŸºæœ¬è¯­æ³•
set $variable value;

# ç¤ºä¾‹
server {
    listen 80;
    server_name example.com;

    location / {
        set $my_var "hello world";
        return 200 $my_var;
    }
}
```

### å˜é‡èµ‹å€¼

```nginx
# å­—ç¬¦ä¸²èµ‹å€¼
set $name "John";

# å˜é‡å¼•ç”¨
set $greeting "Hello, $name";

# ç»„åˆå˜é‡
set $full_path "/data$uri";

# æ¡ä»¶èµ‹å€¼ï¼ˆé…åˆ ifï¼‰
set $cache_control "";
if ($request_uri ~* "\.(jpg|jpeg|png|gif|css|js)$") {
    set $cache_control "public, max-age=31536000, immutable";
}

# åœ¨å“åº”å¤´ä¸­ä½¿ç”¨
add_header Cache-Control $cache_control;
```

### å˜é‡ä½œç”¨åŸŸè§„åˆ™

```nginx
# å˜é‡åœ¨å®šä¹‰åå¯ç”¨
server {
    listen 80;
    server_name example.com;

    # åœ¨è¿™é‡Œä¸èƒ½ä½¿ç”¨ $my_var

    location / {
        set $my_var "value";
        # åœ¨è¿™é‡Œå¯ä»¥ä½¿ç”¨ $my_var

        location /sub/ {
            # å­ location ä¸­ä¹Ÿå¯ä»¥ä½¿ç”¨ $my_var
        }
    }

    location /other/ {
        # åœ¨è¿™é‡Œä¸èƒ½ä½¿ç”¨ $my_varï¼ˆåœ¨ä¸åŒ location ä¸­å®šä¹‰ï¼‰
    }
}
```

---

## å˜é‡ä½œç”¨åŸŸ

### è¯·æ±‚çº§å˜é‡

```nginx
# æ¯ä¸ªè¯·æ±‚ç‹¬ç«‹
server {
    location / {
        set $request_id $request_id;  # æ¯ä¸ªè¯·æ±‚éƒ½ä¸åŒ
        return 200 $request_id;
    }
}
```

### é…ç½®çº§å˜é‡

```nginx
# åœ¨é…ç½®åŠ è½½æ—¶ç¡®å®š
http {
    # è¿™äº›å˜é‡åœ¨æ‰€æœ‰è¯·æ±‚ä¸­ç›¸åŒ
    set $server_name "my-server";

    server {
        # å¯ä»¥ä½¿ç”¨ $server_name
        add_header X-Server $server_name;
    }
}
```

### Location çº§å˜é‡

```nginx
server {
    location /api/ {
        set $api_version "v1";
        proxy_set_header X-API-Version $api_version;
        proxy_pass http://backend;
    }

    location /api/v2/ {
        set $api_version "v2";
        proxy_set_header X-API-Version $api_version;
        proxy_pass http://backend;
    }
}
```

---

## Map æ¨¡å—

### Map åŸºæœ¬ç”¨æ³•

```nginx
# è¯­æ³•
map $source_variable $target_variable {
    default value;                    # é»˜è®¤å€¼
    pattern1 value1;                  # åŒ¹é…æ¨¡å¼
    pattern2 value2;
    ...
}

# ç¤ºä¾‹: æ ¹æ®ç”¨æˆ·ä»£ç†åˆ¤æ–­è®¾å¤‡ç±»å‹
http {
    map $http_user_agent $device_type {
        default "desktop";
        ~*mobile|android|iphone|ipad  "mobile";
        ~*bot|spider|crawl           "bot";
    }

    server {
        listen 80;
        server_name example.com;

        location / {
            add_header X-Device-Type $device_type;
            root /var/www/$device_type;
        }
    }
}
```

### Map åŒ¹é…è§„åˆ™

```nginx
# å­—ç¬¦ä¸²åŒ¹é…
map $uri $page_type {
    default "other";
    /        "home";
    /about   "about";
    /contact "contact";
}

# æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…
map $uri $cache_control {
    default "private, no-cache";
    ~^/static/ "public, max-age=31536000, immutable";
    ~*\.(jpg|jpeg|png|gif|css|js)$ "public, max-age=86400";
}

# Hostname åŒ¹é…
map $host $backend {
    default backend_default;
    hostnames;
    example.com backend_1;
    *.example.com backend_2;
    ~^www\.(.+)$ backend_www;
}

upstream backend_default { server 127.0.0.1:8000; }
upstream backend_1 { server 127.0.0.1:8001; }
upstream backend_2 { server 127.0.0.1:8002; }
upstream backend_www { server 127.0.0.1:8003; }
```

### å¤æ‚ Map ç¤ºä¾‹

```nginx
# æ ¹æ® IP åœ°å€è®¾ç½®é™åˆ¶
geo $limit {
    default 1;
    192.168.1.0/24 0;          # å†…ç½‘ä¸é™
    10.0.0.0/8 0;              # å†…ç½‘ä¸é™
}

map $limit $limit_key {
    0 "";
    1 $binary_remote_addr;
}

limit_req_zone $limit_key zone=api:10m rate=10r/s;

server {
    location /api/ {
        limit_req zone=api burst=20 nodelay;
        proxy_pass http://backend;
    }
}

# æ ¹æ®è¯·æ±‚æ–¹æ³•è®¾ç½®ç¼“å­˜æ—¶é—´
map $request_method $cache_time {
    default 0;                 # ä¸ç¼“å­˜
    GET 1h;                    # GET è¯·æ±‚ç¼“å­˜ 1 å°æ—¶
    HEAD 1h;                   # HEAD è¯·æ±‚ç¼“å­˜ 1 å°æ—¶
}

server {
    location / {
        proxy_cache_valid $cache_time;
        proxy_pass http://backend;
    }
}
```

---

## å˜é‡ä½¿ç”¨ç¤ºä¾‹

### æ—¥å¿—ä¸­ä½¿ç”¨å˜é‡

```nginx
# è‡ªå®šä¹‰æ—¥å¿—æ ¼å¼
log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                '$status $body_bytes_sent "$http_referer" '
                '"$http_user_agent" "$http_x_forwarded_for"';

log_format detailed '$remote_addr|$time_iso8601|$request_method|$uri|$status|'
                    '$body_bytes_sent|$request_time|$upstream_response_time|' 
                    '$http_user_agent|$http_referer';

log_format json escape=json '{'
    '"timestamp":"$time_iso8601",'
    '"remote_addr":"$remote_addr",'
    '"request_method":"$request_method",'
    '"uri":"$uri",'
    '"status":$status,'
    '"body_bytes_sent":$body_bytes_sent,'
    '"request_time":$request_time,'
    '"user_agent":"$http_user_agent",'
    '"referer":"$http_referer"'
'}';

access_log /var/log/nginx/access.log main;
```

### åå‘ä»£ç†ä¸­ä½¿ç”¨å˜é‡

```nginx
# åŠ¨æ€è®¾ç½®åç«¯
upstream backend {
    server backend1.example.com:8080;
    server backend2.example.com:8080;
}

server {
    listen 80;
    server_name example.com;

    location / {
        # è®¾ç½®è¯·æ±‚å¤´
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Request-ID $request_id;

        # è¶…æ—¶è®¾ç½®
        proxy_connect_timeout 5s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # é”™è¯¯é¡µé¢
        proxy_intercept_errors on;

        # ä¼ é€’åç«¯
        proxy_pass http://backend;
    }
}
```

### é‡å®šå‘ä¸­ä½¿ç”¨å˜é‡

```nginx
# å¼ºåˆ¶ HTTPS
server {
    listen 80;
    server_name example.com;

    return 301 https://$server_name$request_uri;
}

# æ ¹æ®æ¡ä»¶é‡å®šå‘
server {
    listen 80;
    server_name example.com;

    if ($http_user_agent ~* "mobile") {
        return 302 http://m.example.com$request_uri;
    }

    location / {
        root /var/www/html;
    }
}

# åŠ¨æ€é‡å®šå‘
map $uri $redirect_url {
    default "";
    /old-page /new-page;
    /old-blog/ /new-blog/;
}

server {
    if ($redirect_url != "") {
        return 301 $redirect_url;
    }
}
```

### ç¼“å­˜æ§åˆ¶ä¸­ä½¿ç”¨å˜é‡

```nginx
# æ ¹æ®æ–‡ä»¶ç±»å‹è®¾ç½®ç¼“å­˜
map $request_uri $cache_control {
    default "private, no-cache";
    ~^/static/ "public, max-age=31536000, immutable";
    ~*\.(jpg|jpeg|png|gif|css|js|woff|woff2|ttf|eot)$ "public, max-age=86400";
    ~*\.html$ "public, max-age=3600";
}

server {
    location / {
        add_header Cache-Control $cache_control;
        try_files $uri $uri/ =404;
    }

    location ~* \.(jpg|jpeg|png|gif|css|js)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}

# æ ¹æ®çŠ¶æ€ç è®¾ç½®ç¼“å­˜
map $status $cache_time {
    200 1h;           # æˆåŠŸå“åº”ç¼“å­˜ 1 å°æ—¶
    404 1m;           # 404 ç¼“å­˜ 1 åˆ†é’Ÿ
    500 0;            # 500 ä¸ç¼“å­˜
    default 0;        # å…¶ä»–ä¸ç¼“å­˜
}

server {
    location / {
        proxy_cache_valid $cache_time;
        proxy_pass http://backend;
    }
}
```

### A/B æµ‹è¯•ä¸­ä½¿ç”¨å˜é‡

```nginx
# åŸºäº IP çš„ A/B æµ‹è¯•
split_clients "${remote_addr}" $variant {
    50%     "a";
    50%     "b";
}

server {
    listen 80;
    server_name example.com;

    location / {
        root /var/www/$variant;
        add_header X-Variant $variant;
    }
}

# åŸºäº Cookie çš„ A/B æµ‹è¯•
map $cookie_variant $variant {
    default "a";
    ~*^b$   "b";
}

server {
    listen 80;
    server_name example.com;

    location / {
        if ($variant = "b") {
            add_header Set-Cookie "variant=b; Path=/; Max-Age=86400";
        }

        root /var/www/$variant;
    }
}
```

---

## ğŸ”§ æ³¨æ„äº‹é¡¹

### å˜é‡å®šä¹‰é™åˆ¶

```nginx
# é”™è¯¯: åœ¨ if ä¸­å®šä¹‰å˜é‡
server {
    location / {
        if ($uri = "/test") {
            set $test "value";  # ä¸æ¨è
        }
        # $test å¯èƒ½åœ¨å…¶ä»–æƒ…å†µä¸‹æœªå®šä¹‰
    }
}

# æ­£ç¡®: å…ˆå®šä¹‰å˜é‡
server {
    location / {
        set $test "";
        if ($uri = "/test") {
            set $test "value";
        }
        # $test æ€»æ˜¯æœ‰å€¼
    }
}
```

### å˜é‡æ€§èƒ½è€ƒè™‘

```nginx
# å˜é‡è§£ææœ‰å¼€é”€ï¼Œä¸è¦æ»¥ç”¨
# é”™è¯¯ï¼šè¿‡å¤šå˜é‡è®¡ç®—
server {
    set $a "value1";
    set $b "${a}_suffix";
    set $c "${b}_final";
    return 200 $c;
}

# æ­£ç¡®ï¼šç›´æ¥ä½¿ç”¨
server {
    return 200 "value1_suffix_final";
}
```

### å˜é‡å®‰å…¨æ€§

```nginx
# ä¸è¦åœ¨æ—¥å¿—ä¸­è®°å½•æ•æ„Ÿä¿¡æ¯
# é”™è¯¯ï¼š
log_format sensitive '$remote_addr|$http_authorization|$cookie_sessionid';

# æ­£ç¡®ï¼š
log_format safe '$remote_addr|$request_method|$uri|$status';
```

---

## ğŸ“š ç›¸å…³é“¾æ¥

- [Nginx æ ¸å¿ƒæ¦‚å¿µ](../01-åŸºç¡€å…¥é—¨/æ ¸å¿ƒæ¦‚å¿µ.md)
- [é…ç½®æ–‡ä»¶ç»“æ„](./é…ç½®æ–‡ä»¶ç»“æ„.md)
- [Location åŒ¹é…è§„åˆ™](../03-æ ¸å¿ƒåŠŸèƒ½/Location-åŒ¹é…è§„åˆ™.md)
- [Map æ¨¡å—](../03-æ ¸å¿ƒåŠŸèƒ½/Map-æ¨¡å—.md)

---

**æ ‡ç­¾**: #nginx #å˜é‡ #é…ç½® #map #åŠ¨æ€
