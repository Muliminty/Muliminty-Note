# Nginx é…ç½®æ–‡ä»¶ç»“æ„

> Nginx é…ç½®æ–‡ä»¶çš„ç»„ç»‡ç»“æ„å’Œè¯­æ³•è§„åˆ™

---

## ğŸ“‹ ç›®å½•

- [é…ç½®æ–‡ä»¶ä½ç½®](#é…ç½®æ–‡ä»¶ä½ç½®)
- [é…ç½®æ–‡ä»¶è¯­æ³•](#é…ç½®æ–‡ä»¶è¯­æ³•)
- [é…ç½®ä¸Šä¸‹æ–‡](#é…ç½®ä¸Šä¸‹æ–‡)
- [æŒ‡ä»¤ç±»å‹](#æŒ‡ä»¤ç±»å‹)
- [Include æœºåˆ¶](#include-æœºåˆ¶)
- [é…ç½®ç¤ºä¾‹](#é…ç½®ç¤ºä¾‹)

---

## é…ç½®æ–‡ä»¶ä½ç½®

### é»˜è®¤é…ç½®æ–‡ä»¶è·¯å¾„

```
Linux:
â”œâ”€â”€ /etc/nginx/nginx.conf              # ä¸»é…ç½®æ–‡ä»¶
â”œâ”€â”€ /etc/nginx/mime.types              # MIME ç±»å‹å®šä¹‰
â”œâ”€â”€ /etc/nginx/fastcgi_params          # FastCGI å‚æ•°
â”œâ”€â”€ /etc/nginx/uwsgi_params            # uWSGI å‚æ•°
â”œâ”€â”€ /etc/nginx/scgi_params             # SCGI å‚æ•°
â”œâ”€â”€ /etc/nginx/conf.d/                 # é€šç”¨é…ç½®ç‰‡æ®µ
â”œâ”€â”€ /etc/nginx/sites-available/        # å¯ç”¨ç«™ç‚¹ï¼ˆUbuntu/Debianï¼‰
â””â”€â”€ /etc/nginx/sites-enabled/          # å¯ç”¨ç«™ç‚¹ï¼ˆUbuntu/Debianï¼‰

Windows:
â””â”€â”€ C:\nginx\conf\nginx.conf           # ä¸»é…ç½®æ–‡ä»¶
```

### æŸ¥æ‰¾é…ç½®æ–‡ä»¶

```bash
# æŸ¥çœ‹ Nginx ä½¿ç”¨çš„é…ç½®æ–‡ä»¶
nginx -t

# è¾“å‡ºç¤ºä¾‹:
# nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
# nginx: configuration file /etc/nginx/nginx.conf test is successful

# æŸ¥çœ‹æ‰€æœ‰é…ç½®ï¼ˆåŒ…æ‹¬ includeï¼‰
nginx -T
```

---

## é…ç½®æ–‡ä»¶è¯­æ³•

### åŸºæœ¬è¯­æ³•è§„åˆ™

```nginx
# 1. æŒ‡ä»¤ä»¥åˆ†å·ç»“å°¾
directive value1 value2 ...;

# 2. å—æŒ‡ä»¤ä½¿ç”¨å¤§æ‹¬å·
directive {
    sub_directive value;
}

# 3. æ³¨é‡Šä½¿ç”¨ #
# è¿™æ˜¯æ³¨é‡Š

# 4. æ”¯æŒç»­è¡Œç¬¦
access_log /var/log/nginx/access.log  \
           main;

# 5. è·¯å¾„å¯ä»¥ä½¿ç”¨ç»å¯¹è·¯å¾„æˆ–ç›¸å¯¹è·¯å¾„
include /etc/nginx/conf.d/*.conf;      # ç»å¯¹è·¯å¾„
include conf.d/*.conf;                 # ç›¸å¯¹è·¯å¾„ï¼ˆç›¸å¯¹äº nginx.conf æ‰€åœ¨ç›®å½•ï¼‰
```

### æŒ‡ä»¤æ ¼å¼

```nginx
# ç®€å•æŒ‡ä»¤
directive value;

# å¸¦å‚æ•°çš„æŒ‡ä»¤
directive param1=value1 param2=value2;

# å—æŒ‡ä»¤
directive {
    sub_directive1 value1;
    sub_directive2 value2;
}

# å¤šä¸ªå€¼
directive value1 value2 value3;

# æ•°ç»„å½¢å¼
directive value1,
        value2,
        value3;
```

### å˜é‡ä½¿ç”¨

```nginx
# å†…ç½®å˜é‡
$remote_addr      # å®¢æˆ·ç«¯ IP
$remote_user      # å®¢æˆ·ç«¯ç”¨æˆ·
$time_local       # æœ¬åœ°æ—¶é—´
$request          # å®Œæ•´è¯·æ±‚
$status           # å“åº”çŠ¶æ€ç 
$body_bytes_sent  # å“åº”ä½“å¤§å°
$http_referer     # æ¥æºé¡µé¢
$http_user_agent  # ç”¨æˆ·ä»£ç†

# è‡ªå®šä¹‰å˜é‡
set $my_var "hello";
set $full_path "/data$uri";

# å˜é‡ä½¿ç”¨
return 200 "IP: $remote_addr\n";
```

---

## é…ç½®ä¸Šä¸‹æ–‡

### é…ç½®å±‚çº§ç»“æ„

```nginx
# å…¨å±€ä¸Šä¸‹æ–‡ï¼ˆMain Contextï¼‰
user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log;
pid /var/run/nginx.pid;

# Events ä¸Šä¸‹æ–‡
events {
    worker_connections 1024;
    use epoll;
}

# HTTP ä¸Šä¸‹æ–‡
http {
    include mime.types;
    default_type application/octet-stream;

    # Upstream ä¸Šä¸‹æ–‡ï¼ˆåœ¨ http ä¸­ï¼‰
    upstream backend {
        server 127.0.0.1:8080;
        server 127.0.0.1:8081;
    }

    # Server ä¸Šä¸‹æ–‡ï¼ˆåœ¨ http ä¸­ï¼‰
    server {
        listen 80;
        server_name example.com;

        # Location ä¸Šä¸‹æ–‡ï¼ˆåœ¨ server ä¸­ï¼‰
        location / {
            root /var/www/html;
            index index.html;
        }

        # Location ä¸Šä¸‹æ–‡
        location /api/ {
            proxy_pass http://backend;
        }
    }

    # å¦ä¸€ä¸ª Server ä¸Šä¸‹æ–‡
    server {
        listen 443 ssl;
        server_name secure.example.com;

        location / {
            root /var/www/secure;
        }
    }
}

# Mail ä¸Šä¸‹æ–‡ï¼ˆå¯é€‰ï¼‰
mail {
    # ...
}

# Stream ä¸Šä¸‹æ–‡ï¼ˆå¯é€‰ï¼‰
stream {
    # ...
}
```

### Main ä¸Šä¸‹æ–‡

```nginx
# å…¨å±€é…ç½®,å½±å“æ•´ä¸ª Nginx
user nginx;                    # è¿è¡Œç”¨æˆ·
group nginx;                   # è¿è¡Œç»„
worker_processes auto;         # worker è¿›ç¨‹æ•°
error_log /var/log/nginx/error.log warn;  # é”™è¯¯æ—¥å¿—
pid /var/run/nginx.pid;        # PID æ–‡ä»¶
daemon on;                     # æ˜¯å¦ä»¥å®ˆæŠ¤è¿›ç¨‹è¿è¡Œ
worker_rlimit_nofile 65535;    # worker æ‰“å¼€æ–‡ä»¶æ•°é™åˆ¶
include /etc/nginx/modules-enabled/*.conf;  # åŠ è½½æ¨¡å—
```

### Events ä¸Šä¸‹æ–‡

```nginx
events {
    worker_connections 1024;           # æ¯ä¸ª worker çš„è¿æ¥æ•°
    use epoll;                         # ä½¿ç”¨ epollï¼ˆLinuxï¼‰
    multi_accept on;                   # æ‰¹é‡æ¥å—è¿æ¥
    accept_mutex on;                   # ä¸²è¡Œæ¥å—è¿æ¥
    accept_mutex_delay 500ms;          # ä¸²è¡Œå»¶è¿Ÿ
}
```

### Http ä¸Šä¸‹æ–‡

```nginx
http {
    include mime.types;                # MIME ç±»å‹
    default_type application/octet-stream;  # é»˜è®¤ç±»å‹

    # æ—¥å¿—æ ¼å¼
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;  # è®¿é—®æ—¥å¿—

    # æ–‡ä»¶ä¼ è¾“
    sendfile on;                       # å¼€å¯ sendfile
    tcp_nopush on;                     # ä¼˜åŒ–åŒ…å‘é€
    tcp_nodelay on;                    # ç¦ç”¨ Nagle

    # è¿æ¥ä¿æŒ
    keepalive_timeout 65;              # é•¿è¿æ¥è¶…æ—¶
    keepalive_requests 100;            # é•¿è¿æ¥æœ€å¤§è¯·æ±‚æ•°

    # å‹ç¼©
    gzip on;                           # å¼€å¯ Gzip
    gzip_types text/plain text/css;    # å‹ç¼©ç±»å‹

    # å®¢æˆ·ç«¯é™åˆ¶
    client_max_body_size 1m;           # è¯·æ±‚ä½“å¤§å°é™åˆ¶
    client_header_buffer_size 1k;      # è¯·æ±‚å¤´ç¼“å†²åŒº

    # Include å…¶ä»–é…ç½®
    include /etc/nginx/conf.d/*.conf;
    include /etc/nginx/sites-enabled/*;
}
```

### Server ä¸Šä¸‹æ–‡

```nginx
server {
    listen 80;                         # ç›‘å¬ç«¯å£
    listen [::]:80 ipv6only=on;        # IPv6

    server_name example.com www.example.com;  # åŸŸå

    # è®¿é—®æ—¥å¿—
    access_log /var/log/nginx/example.access.log main;

    # é”™è¯¯æ—¥å¿—
    error_log /var/log/nginx/example.error.log warn;

    # é”™è¯¯é¡µé¢
    error_page 404 /404.html;
    error_page 500 502 503 504 /50x.html;

    # æ ¹ç›®å½•
    root /var/www/example;

    # é»˜è®¤é¦–é¡µ
    index index.html index.htm;

    # Location é…ç½®
    location / {
        try_files $uri $uri/ =404;
    }

    # å…¶ä»– location
    location /api/ {
        proxy_pass http://backend;
    }
}
```

### Location ä¸Šä¸‹æ–‡

```nginx
location [modifier] pattern {
    # é…ç½®æŒ‡ä»¤
}

# åŒ¹é…æ–¹å¼
location = / {                      # ç²¾ç¡®åŒ¹é…
    # ...
}

location / {                        # å‰ç¼€åŒ¹é…ï¼ˆæœ€ä½ä¼˜å…ˆçº§ï¼‰
    # ...
}

location /api/ {                    # å‰ç¼€åŒ¹é…
    # ...
}

location ~ \.php$ {                 # æ­£åˆ™åŒ¹é…ï¼ˆåŒºåˆ†å¤§å°å†™ï¼‰
    # ...
}

location ~* \.(jpg|jpeg|png)$ {    # æ­£åˆ™åŒ¹é…ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰
    # ...
}

location ^~ /static/ {              # ä¼˜å…ˆå‰ç¼€åŒ¹é…
    # ...
}
```

### Upstream ä¸Šä¸‹æ–‡

```nginx
upstream backend {
    server backend1.example.com:8080 weight=5;
    server backend2.example.com:8080 weight=3;
    server backend3.example.com:8080 backup;

    keepalive 32;                    # é•¿è¿æ¥æ•°
    keepalive_timeout 60s;           # é•¿è¿æ¥è¶…æ—¶
    keepalive_requests 100;          # é•¿è¿æ¥æœ€å¤§è¯·æ±‚æ•°

    ip_hash;                         # IP å“ˆå¸Œ
    least_conn;                      # æœ€å°‘è¿æ¥
}

# ä½¿ç”¨ upstream
server {
    location / {
        proxy_pass http://backend;
    }
}
```

---

## æŒ‡ä»¤ç±»å‹

### æ ¸å¿ƒæŒ‡ä»¤

```nginx
# å…¨å±€æŒ‡ä»¤ï¼ˆåªèƒ½åœ¨ main ä¸Šä¸‹æ–‡ï¼‰
user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log;
pid /var/run/nginx.pid;

# Events æŒ‡ä»¤ï¼ˆåªèƒ½åœ¨ events ä¸Šä¸‹æ–‡ï¼‰
events {
    worker_connections 1024;
    use epoll;
}

# HTTP æŒ‡ä»¤ï¼ˆåªèƒ½åœ¨ http ä¸Šä¸‹æ–‡ï¼‰
http {
    include mime.types;
    default_type application/octet-stream;
}
```

### æ ‡å‡†æ¨¡å—æŒ‡ä»¤

```nginx
# HTTP æ ¸å¿ƒæ¨¡å—
server {
    listen 80;
    server_name example.com;
    root /var/www/html;
    index index.html;
}

location / {
    try_files $uri $uri/ =404;
}

# è®¿é—®æ§åˆ¶æ¨¡å—
location /admin/ {
    allow 192.168.1.0/24;
    deny all;
}

# Gzip æ¨¡å—
gzip on;
gzip_types text/plain text/css;

# SSL æ¨¡å—
ssl_certificate /path/to/cert.pem;
ssl_certificate_key /path/to/key.pem;
```

### ç¬¬ä¸‰æ–¹æ¨¡å—æŒ‡ä»¤

```nginx
# å¦‚æœç¼–è¯‘äº†ç¬¬ä¸‰æ–¹æ¨¡å—
load_module modules/ngx_http_geoip_module.so;

http {
    geoip_country /usr/share/GeoIP/GeoIP.dat;

    map $geoip_country_code $allowed_country {
        default no;
        CN yes;
        US yes;
    }

    server {
        if ($allowed_country = no) {
            return 403;
        }
    }
}
```

---

## Include æœºåˆ¶

### Include è¯­æ³•

```nginx
# åŒ…å«å•ä¸ªæ–‡ä»¶
include /etc/nginx/mime.types;

# åŒ…å«ç›®å½•ä¸‹æ‰€æœ‰ .conf æ–‡ä»¶
include /etc/nginx/conf.d/*.conf;

# åŒ…å«å¤šä¸ªç›®å½•
include /etc/nginx/conf.d/*.conf;
include /etc/nginx/sites-enabled/*;

# ç›¸å¯¹è·¯å¾„ï¼ˆç›¸å¯¹äº nginx.conf æ‰€åœ¨ç›®å½•ï¼‰
include conf.d/*.conf;
```

### ä½¿ç”¨åœºæ™¯

```nginx
# 1. åˆ†ç¦» MIME ç±»å‹
include mime.types;

# 2. åˆ†ç¦»è™šæ‹Ÿä¸»æœºé…ç½®
include /etc/nginx/sites-enabled/*;

# 3. åˆ†ç¦»å…¬å…±é…ç½®ç‰‡æ®µ
http {
    include /etc/nginx/conf.d/logging.conf;
    include /etc/nginx/conf.d/gzip.conf;
    include /etc/nginx/conf.d/proxy.conf;
}

# 4. æ¡ä»¶åŒ…å«
# æ³¨æ„: Nginx ä¸æ”¯æŒæ¡ä»¶ include,ä½†å¯ä»¥é€šè¿‡å˜é‡å®ç°
map $hostname $config {
    default "default.conf";
    hostnames;
    example.com "example.conf";
}

include /etc/nginx/custom/$config;
```

### æœ€ä½³å®è·µ

```nginx
# /etc/nginx/nginx.conf
user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include mime.types;
    default_type application/octet-stream;

    # åŸºç¡€é…ç½®
    include /etc/nginx/conf.d/basic.conf;

    # æ—¥å¿—é…ç½®
    include /etc/nginx/conf.d/logging.conf;

    # æ€§èƒ½ä¼˜åŒ–
    include /etc/nginx/conf.d/performance.conf;

    # å®‰å…¨é…ç½®
    include /etc/nginx/conf.d/security.conf;

    # è™šæ‹Ÿä¸»æœº
    include /etc/nginx/sites-enabled/*;
}
```

---

## é…ç½®ç¤ºä¾‹

### å®Œæ•´é…ç½®ç¤ºä¾‹

```nginx
# /etc/nginx/nginx.conf

# Main ä¸Šä¸‹æ–‡
user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

# Events ä¸Šä¸‹æ–‡
events {
    worker_connections 1024;
    use epoll;
    multi_accept on;
}

# HTTP ä¸Šä¸‹æ–‡
http {
    # MIME ç±»å‹
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # æ—¥å¿—æ ¼å¼
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    log_format json '{"time":"$time_iso8601","remote_addr":"$remote_addr",'
                    '"request":"$request","status":$status,"bytes_sent":$bytes_sent}';

    # è®¿é—®æ—¥å¿—
    access_log /var/log/nginx/access.log main;

    # é”™è¯¯æ—¥å¿—ï¼ˆå·²åœ¨ main ä¸­å®šä¹‰ï¼‰
    # error_log /var/log/nginx/error.log warn;

    # æ–‡ä»¶ä¼ è¾“ä¼˜åŒ–
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;

    # è¿æ¥ä¿æŒ
    keepalive_timeout 65;
    keepalive_requests 100;

    # å®¢æˆ·ç«¯é™åˆ¶
    client_max_body_size 1m;
    client_header_buffer_size 1k;
    large_client_header_buffers 4 8k;

    # Gzip å‹ç¼©
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml+rss
        application/atom+xml
        image/svg+xml;

    # è™šæ‹Ÿä¸»æœº
    server {
        listen 80;
        server_name localhost;

        access_log /var/log/nginx/localhost.access.log main;
        error_log /var/log/nginx/localhost.error.log warn;

        root /usr/share/nginx/html;
        index index.html index.htm;

        location / {
            try_files $uri $uri/ =404;
        }

        error_page 404 /404.html;
        error_page 500 502 503 504 /50x.html;

        location = /50x.html {
            root /usr/share/nginx/html;
        }
    }

    # åŒ…å«å…¶ä»–é…ç½®
    include /etc/nginx/conf.d/*.conf;
    include /etc/nginx/sites-enabled/*;
}
```

### è™šæ‹Ÿä¸»æœºé…ç½®ç¤ºä¾‹

```nginx
# /etc/nginx/sites-available/example.com
server {
    listen 80;
    listen [::]:80 ipv6only=on;

    server_name example.com www.example.com;

    root /var/www/example.com;
    index index.html index.htm index.php;

    # è®¿é—®æ—¥å¿—
    access_log /var/log/nginx/example.com.access.log main;
    error_log /var/log/nginx/example.com.error.log warn;

    # é”™è¯¯é¡µé¢
    error_page 404 /404.html;
    error_page 500 502 503 504 /50x.html;

    # é™æ€æ–‡ä»¶ç¼“å­˜
    location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # API ä»£ç†
    location /api/ {
        proxy_pass http://backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # PHP å¤„ç†
    location ~ \.php$ {
        fastcgi_pass unix:/var/run/php/php7.4-fpm.sock;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
    }

    # é™åˆ¶è®¿é—®
    location /admin/ {
        allow 192.168.1.0/24;
        deny all;
        auth_basic "Admin Area";
        auth_basic_user_file /etc/nginx/.htpasswd;
    }

    # ç¦æ­¢è®¿é—®éšè—æ–‡ä»¶
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
}

# å¯ç”¨ç«™ç‚¹ï¼ˆUbuntu/Debianï¼‰
# sudo ln -s /etc/nginx/sites-available/example.com /etc/nginx/sites-enabled/
```

---

## ğŸ”§ é…ç½®æ£€æŸ¥

### éªŒè¯é…ç½®

```bash
# æ£€æŸ¥è¯­æ³•
sudo nginx -t

# æ£€æŸ¥å¹¶æ˜¾ç¤ºæ‰€æœ‰é…ç½®
sudo nginx -T

# æ£€æŸ¥æŒ‡å®šé…ç½®æ–‡ä»¶
sudo nginx -t -c /path/to/custom/nginx.conf
```

### å¸¸è§é”™è¯¯

```nginx
# é”™è¯¯: ç¼ºå°‘åˆ†å·
# location / {
#     root /var/www/html    # é”™è¯¯: ç¼ºå°‘åˆ†å·
# }

# æ­£ç¡®:
location / {
    root /var/www/html;
}

# é”™è¯¯: æ‹¬å·ä¸åŒ¹é…
# server {
#     listen 80;
#     location / {
#         root /var/www/html;
#     }
# # é”™è¯¯: ç¼ºå°‘ server çš„å…³é—­æ‹¬å·

# æ­£ç¡®:
server {
    listen 80;
    location / {
        root /var/www/html;
    }
}

# é”™è¯¯: æŒ‡ä»¤ä½ç½®é”™è¯¯
# http {
#     worker_connections 1024;  # é”™è¯¯: ä¸èƒ½åœ¨ http ä¸Šä¸‹æ–‡ä¸­
# }

# æ­£ç¡®:
events {
    worker_connections 1024;
}
```

---

## ğŸ“š ç›¸å…³é“¾æ¥

- [Nginx æ ¸å¿ƒæ¦‚å¿µ](../01-åŸºç¡€å…¥é—¨/æ ¸å¿ƒæ¦‚å¿µ.md)
- [è™šæ‹Ÿä¸»æœºé…ç½®](../03-æ ¸å¿ƒåŠŸèƒ½/è™šæ‹Ÿä¸»æœºé…ç½®.md)
- [Location åŒ¹é…è§„åˆ™](../03-æ ¸å¿ƒåŠŸèƒ½/Location-åŒ¹é…è§„åˆ™.md)
- [å˜é‡ä½¿ç”¨](../02-é…ç½®ç®¡ç†/å˜é‡ä½¿ç”¨.md)

---

**æ ‡ç­¾**: #nginx #é…ç½® #ç»“æ„ #è¯­æ³• #ç®¡ç†
