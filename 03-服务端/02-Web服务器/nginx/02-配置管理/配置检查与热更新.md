# Nginx é…ç½®æ£€æŸ¥ä¸çƒ­æ›´æ–°

> Nginx é…ç½®æ–‡ä»¶æ£€æŸ¥ã€æµ‹è¯•å’Œçƒ­æ›´æ–°æ–¹æ³•

---

## ğŸ“‹ ç›®å½•

- [é…ç½®æ£€æŸ¥](#é…ç½®æ£€æŸ¥)
- [çƒ­æ›´æ–°åŸç†](#çƒ­æ›´æ–°åŸç†)
- [çƒ­æ›´æ–°æ–¹æ³•](#çƒ­æ›´æ–°æ–¹æ³•)
- [é…ç½®å›æ»š](#é…ç½®å›æ»š)
- [è‡ªåŠ¨åŒ–éƒ¨ç½²](#è‡ªåŠ¨åŒ–éƒ¨ç½²)

---

## é…ç½®æ£€æŸ¥

### åŸºæœ¬è¯­æ³•æ£€æŸ¥

```bash
# æ£€æŸ¥é…ç½®æ–‡ä»¶è¯­æ³•
sudo nginx -t

# è¾“å‡ºç¤ºä¾‹:
# nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
# nginx: configuration file /etc/nginx/nginx.conf test is successful

# æ£€æŸ¥å¹¶æ˜¾ç¤ºæ‰€æœ‰é…ç½®
sudo nginx -T

# æ£€æŸ¥æŒ‡å®šé…ç½®æ–‡ä»¶
sudo nginx -t -c /path/to/custom/nginx.conf
```

### è¯¦ç»†æ£€æŸ¥

```bash
# æŸ¥çœ‹é…ç½®æ–‡ä»¶è·¯å¾„
sudo nginx -t 2>&1 | grep "configuration file"

# æŸ¥çœ‹ include çš„æ–‡ä»¶åˆ—è¡¨
sudo nginx -T | grep -E "^# configuration file"

# ç»Ÿè®¡é…ç½®æŒ‡ä»¤æ•°é‡
sudo nginx -T | grep -v "^#" | wc -l
```

### å¸¸è§é—®é¢˜æ£€æŸ¥

```bash
# 1. æ£€æŸ¥æ‹¬å·åŒ¹é…
cat /etc/nginx/nginx.conf | grep -o "[{}]" | sort | uniq -c
# åº”è¯¥æˆå¯¹å‡ºç°

# 2. æ£€æŸ¥åˆ†å·ç¼ºå¤±
grep -n "[^;]$" /etc/nginx/nginx.conf | grep -v "#" | grep -v "{$"

# 3. æ£€æŸ¥é‡å¤ç›‘å¬ç«¯å£
grep -r "listen.*80" /etc/nginx/

# 4. æ£€æŸ¥ server_name é‡å¤
grep -r "server_name" /etc/nginx/sites-enabled/
```

---

## çƒ­æ›´æ–°åŸç†

### Master-Worker æ¨¡å‹

```
çƒ­æ›´æ–°è¿‡ç¨‹:

é˜¶æ®µ 1: æ£€æŸ¥é…ç½®
Master è¿›ç¨‹è¯»å–æ–°é…ç½® â†’ éªŒè¯è¯­æ³• â†’ åŠ è½½é…ç½®

é˜¶æ®µ 2: å¯åŠ¨æ–° Worker
Master è¿›ç¨‹å¯åŠ¨æ–°çš„ Worker è¿›ç¨‹ï¼ˆä½¿ç”¨æ–°é…ç½®ï¼‰

é˜¶æ®µ 3: åˆ‡æ¢æµé‡
æ–° Worker è¿›ç¨‹å¼€å§‹æ¥å—æ–°è¿æ¥
æ—§ Worker è¿›ç¨‹åœæ­¢æ¥å—æ–°è¿æ¥

é˜¶æ®µ 4: ä¼˜é›…åœæ­¢æ—§ Worker
æ—§ Worker è¿›ç¨‹å¤„ç†å®Œå½“å‰è¯·æ±‚åé€€å‡º

é˜¶æ®µ 5: å®Œæˆæ›´æ–°
æ‰€æœ‰æ—§ Worker è¿›ç¨‹é€€å‡º,æ›´æ–°å®Œæˆ
```

### ä¿¡å·å¤„ç†

```bash
# Master è¿›ç¨‹æ¥æ”¶ä¿¡å·

HUP (Hang Up):
- é‡è½½é…ç½®æ–‡ä»¶
- å¯åŠ¨æ–°çš„ Worker è¿›ç¨‹
- ä¼˜é›…åœæ­¢æ—§çš„ Worker è¿›ç¨‹
- ä¸ä¸­æ–­æœåŠ¡

USR2:
- å¹³æ»‘å‡çº§ Nginx äºŒè¿›åˆ¶æ–‡ä»¶
- å¯åŠ¨æ–°çš„ Master è¿›ç¨‹
- é€æ­¥åˆ‡æ¢æµé‡

WINCH:
- ä¼˜é›…åœæ­¢ Worker è¿›ç¨‹
- ç”¨äºé…åˆ USR2 å®Œæˆå¹³æ»‘å‡çº§

QUIT:
- ä¼˜é›…åœæ­¢æ•´ä¸ª Nginx
- å¤„ç†å®Œå½“å‰è¯·æ±‚åé€€å‡º
```

---

## çƒ­æ›´æ–°æ–¹æ³•

### æ–¹æ³•ä¸€: Reload å‘½ä»¤ï¼ˆæ¨èï¼‰

```bash
# 1. æ£€æŸ¥é…ç½®
sudo nginx -t

# 2. å¦‚æœæ£€æŸ¥é€šè¿‡,é‡è½½é…ç½®
sudo systemctl reload nginx
# æˆ–
sudo nginx -s reload

# 3. éªŒè¯æ˜¯å¦æˆåŠŸ
sudo systemctl status nginx

# 4. æŸ¥çœ‹ Worker è¿›ç¨‹
ps aux | grep nginx
```

### æ–¹æ³•äºŒ: ç›´æ¥å‘ Master è¿›ç¨‹å‘é€ä¿¡å·

```bash
# 1. è·å– Master è¿›ç¨‹ PID
MASTER_PID=$(cat /var/run/nginx.pid)

# 2. æ£€æŸ¥é…ç½®
sudo nginx -t

# 3. å‘é€ HUP ä¿¡å·
sudo kill -HUP $MASTER_PID

# 4. éªŒè¯
ps aux | grep nginx
```

### æ–¹æ³•ä¸‰: ä½¿ç”¨è„šæœ¬è‡ªåŠ¨åŒ–

```bash
#!/bin/bash
# nginx-reload.sh

echo "æ£€æŸ¥ Nginx é…ç½®..."
nginx -t
if [ $? -ne 0 ]; then
    echo "é…ç½®æ£€æŸ¥å¤±è´¥,è¯·æ£€æŸ¥é…ç½®æ–‡ä»¶"
    exit 1
fi

echo "é…ç½®æ£€æŸ¥é€šè¿‡,æ­£åœ¨é‡è½½..."
systemctl reload nginx
if [ $? -eq 0 ]; then
    echo "Nginx é‡è½½æˆåŠŸ"
else
    echo "Nginx é‡è½½å¤±è´¥"
    exit 1
fi

echo "å½“å‰ Nginx è¿›ç¨‹:"
ps aux | grep nginx
```

### æ–¹æ³•å››: é…ç½®è‡ªåŠ¨ç”Ÿæˆå’Œçƒ­æ›´æ–°

```bash
#!/bin/bash
# auto-deploy.sh

CONFIG_DIR="/etc/nginx"
BACKUP_DIR="/backup/nginx/$(date +%Y%m%d_%H%M%S)"

# åˆ›å»ºå¤‡ä»½
echo "åˆ›å»ºé…ç½®å¤‡ä»½..."
mkdir -p $BACKUP_DIR
cp -r $CONFIG_DIR/* $BACKUP_DIR/

# ç”Ÿæˆé…ç½®
echo "ç”Ÿæˆ Nginx é…ç½®..."
generate_nginx_config() {
    # è¿™é‡Œè°ƒç”¨ä½ çš„é…ç½®ç”Ÿæˆè„šæœ¬
    python3 /path/to/generate_config.py
}

generate_nginx_config
if [ $? -ne 0 ]; then
    echo "é…ç½®ç”Ÿæˆå¤±è´¥"
    exit 1
fi

# æ£€æŸ¥é…ç½®
echo "æ£€æŸ¥ Nginx é…ç½®..."
nginx -t
if [ $? -ne 0 ]; then
    echo "é…ç½®æ£€æŸ¥å¤±è´¥,å›æ»šé…ç½®..."
    cp -r $BACKUP_DIR/* $CONFIG_DIR/
    exit 1
fi

# çƒ­æ›´æ–°
echo "æ‰§è¡Œçƒ­æ›´æ–°..."
systemctl reload nginx
if [ $? -eq 0 ]; then
    echo "çƒ­æ›´æ–°æˆåŠŸ"
else
    echo "çƒ­æ›´æ–°å¤±è´¥,å›æ»šé…ç½®..."
    cp -r $BACKUP_DIR/* $CONFIG_DIR/
    systemctl reload nginx
    exit 1
fi

echo "éƒ¨ç½²å®Œæˆ"
```

---

## é…ç½®å›æ»š

### æ‰‹åŠ¨å›æ»š

```bash
# 1. å¤‡ä»½å½“å‰é…ç½®ï¼ˆå¦‚æœæ›´æ–°å¤±è´¥ï¼‰
sudo cp /etc/nginx/nginx.conf /etc/nginx/nginx.conf.bak

# 2. æ¢å¤ä¹‹å‰çš„é…ç½®
sudo cp /etc/nginx/nginx.conf.backup /etc/nginx/nginx.conf

# 3. æ£€æŸ¥é…ç½®
sudo nginx -t

# 4. é‡è½½é…ç½®
sudo systemctl reload nginx
```

### è‡ªåŠ¨å¤‡ä»½å’Œå›æ»šè„šæœ¬

```bash
#!/bin/bash
# backup-and-rollback.sh

BACKUP_DIR="/backup/nginx"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)

# åˆ›å»ºå¤‡ä»½
backup_config() {
    echo "åˆ›å»ºé…ç½®å¤‡ä»½..."
    mkdir -p $BACKUP_DIR
    tar -czf $BACKUP_DIR/nginx_config_$TIMESTAMP.tar.gz \
        -C /etc/nginx .
    echo "å¤‡ä»½å®Œæˆ: $BACKUP_DIR/nginx_config_$TIMESTAMP.tar.gz"
}

# åˆ—å‡ºå¤‡ä»½
list_backups() {
    echo "å¯ç”¨å¤‡ä»½:"
    ls -la $BACKUP_DIR/*.tar.gz
}

# å›æ»šé…ç½®
rollback_config() {
    local backup_file=$1
    if [ -z "$backup_file" ]; then
        echo "è¯·æŒ‡å®šå¤‡ä»½æ–‡ä»¶"
        list_backups
        exit 1
    fi

    echo "æ­£åœ¨å›æ»šé…ç½®: $backup_file"

    # åˆ›å»ºå½“å‰é…ç½®å¤‡ä»½
    backup_config

    # æ¢å¤é…ç½®
    cd /etc/nginx
    tar -xzf $backup_file

    # æ£€æŸ¥é…ç½®
    nginx -t
    if [ $? -ne 0 ]; then
        echo "é…ç½®æ£€æŸ¥å¤±è´¥,è‡ªåŠ¨æ¢å¤ä¸Šæ¬¡å¤‡ä»½"
        # æ¢å¤ä¸Šæ¬¡çš„å¤‡ä»½
        # ...
        exit 1
    fi

    # é‡è½½é…ç½®
    systemctl reload nginx
    echo "å›æ»šå®Œæˆ"
}

# ä¸»é€»è¾‘
case $1 in
    backup)
        backup_config
        ;;
    list)
        list_backups
        ;;
    rollback)
        rollback_config $2
        ;;
    *)
        echo "ç”¨æ³•: $0 {backup|list|rollback <backup_file>}"
        exit 1
        ;;
esac
```

### ä½¿ç”¨ Git è¿›è¡Œç‰ˆæœ¬æ§åˆ¶

```bash
# 1. åˆå§‹åŒ– Git ä»“åº“
cd /etc/nginx
sudo git init

# 2. æ·»åŠ æ‰€æœ‰é…ç½®
sudo git add .

# 3. æäº¤åˆå§‹ç‰ˆæœ¬
sudo git commit -m "Initial configuration"

# 4. é…ç½® git
sudo git config user.email "admin@example.com"
sudo git config user.name "Nginx Admin"

# 5. ä¿®æ”¹é…ç½®åæäº¤
sudo git add .
sudo git commit -m "Update virtual host configuration"

# 6. æŸ¥çœ‹å†å²
sudo git log

# 7. å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬
sudo git reset --hard <commit_id>
sudo nginx -t && sudo systemctl reload nginx
```

---

## è‡ªåŠ¨åŒ–éƒ¨ç½²

### ä½¿ç”¨ CI/CD è‡ªåŠ¨éƒ¨ç½²

```yaml
# .github/workflows/deploy-nginx.yml
name: Deploy Nginx Configuration

on:
  push:
    branches:
      - main
    paths:
      - 'nginx-configs/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "nginx-configs/*"
          target: "/tmp/nginx-configs"

      - name: Reload Nginx
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # å¤‡ä»½å½“å‰é…ç½®
            sudo cp -r /etc/nginx /etc/nginx.backup.$(date +%Y%m%d_%H%M%S)

            # å¤åˆ¶æ–°é…ç½®
            sudo cp -r /tmp/nginx-configs/* /etc/nginx/

            # æ£€æŸ¥é…ç½®
            sudo nginx -t

            # å¦‚æœæ£€æŸ¥é€šè¿‡,é‡è½½é…ç½®
            if [ $? -eq 0 ]; then
              sudo systemctl reload nginx
              echo "Nginx é…ç½®éƒ¨ç½²æˆåŠŸ"
            else
              echo "Nginx é…ç½®æ£€æŸ¥å¤±è´¥"
              exit 1
            fi
```

### Ansible è‡ªåŠ¨åŒ–éƒ¨ç½²

```yaml
# ansible/deploy-nginx.yml
---
- name: Deploy Nginx Configuration
  hosts: webservers
  become: yes

  tasks:
    - name: Backup current configuration
      shell: |
        cp -r /etc/nginx /backup/nginx.$(date +%Y%m%d_%H%M%S)
      args:
        executable: /bin/bash

    - name: Copy nginx configuration
      copy:
        src: "{{ item }}"
        dest: "/etc/nginx/"
        owner: root
        group: root
        mode: '0644'
      with_fileglob:
        - "../nginx-configs/*"

    - name: Check nginx configuration
      command: nginx -t
      register: nginx_test
      failed_when: nginx_test.rc != 0

    - name: Reload nginx if configuration is valid
      service:
        name: nginx
        state: reloaded
      when: nginx_test.rc == 0
```

### Docker + Nginx çƒ­æ›´æ–°

```bash
#!/bin/bash
# docker-nginx-reload.sh

CONTAINER_NAME="nginx-web"
CONFIG_DIR="/path/to/nginx/config"

# 1. æ£€æŸ¥é…ç½®ï¼ˆä½¿ç”¨ä¸´æ—¶å®¹å™¨ï¼‰
docker run --rm \
  -v $CONFIG_DIR:/etc/nginx:ro \
  nginx:latest nginx -t

if [ $? -ne 0 ]; then
  echo "é…ç½®æ£€æŸ¥å¤±è´¥"
  exit 1
fi

# 2. å¤åˆ¶æ–°é…ç½®åˆ°è¿è¡Œä¸­çš„å®¹å™¨
echo "å¤åˆ¶é…ç½®åˆ°å®¹å™¨..."
docker cp $CONFIG_DIR/nginx.conf $CONTAINER_NAME:/etc/nginx/nginx.conf
docker cp $CONFIG_DIR/conf.d $CONTAINER_NAME:/etc/nginx/conf.d

# 3. é‡è½½é…ç½®
echo "é‡è½½ Nginx é…ç½®..."
docker exec $CONTAINER_NAME nginx -s reload

echo "çƒ­æ›´æ–°å®Œæˆ"
```

---

## ğŸ”§ é«˜çº§æŠ€å·§

### é›¶åœæœºéƒ¨ç½²ç­–ç•¥

```bash
#!/bin/bash
# zero-downtime-deploy.sh

BACKUP_DIR="/backup/nginx"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)

# 1. åˆ›å»ºå¤‡ä»½
echo "åˆ›å»ºå¤‡ä»½..."
mkdir -p $BACKUP_DIR
tar -czf $BACKUP_DIR/nginx_before_$TIMESTAMP.tar.gz -C /etc/nginx .

# 2. éªŒè¯é…ç½®
echo "éªŒè¯é…ç½®..."
sudo nginx -t
if [ $? -ne 0 ]; then
  echo "é…ç½®éªŒè¯å¤±è´¥"
  exit 1
fi

# 3. é€æ­¥æ›´æ–°ï¼ˆæ»šåŠ¨æ›´æ–°ï¼‰
echo "å¼€å§‹æ»šåŠ¨æ›´æ–°..."

# è·å–å½“å‰ worker è¿›ç¨‹æ•°
OLD_WORKERS=$(pgrep -f "nginx: worker process" | wc -l)

# å‘é€ USR2 ä¿¡å·ï¼ˆå¯åŠ¨æ–° masterï¼‰
sudo kill -USR2 $(cat /var/run/nginx.pid)

# ç­‰å¾…æ–° worker å¯åŠ¨
sleep 5

NEW_WORKERS=$(pgrep -f "nginx: worker process" | wc -l)
echo "Worker è¿›ç¨‹æ•°: $OLD_WORKERS -> $NEW_WORKERS"

# 4. éªŒè¯æ–°ç‰ˆæœ¬
if [ $NEW_WORKERS -gt $OLD_WORKERS ]; then
  echo "æ–°ç‰ˆæœ¬å¯åŠ¨æˆåŠŸï¼Œæ­£åœ¨æµ‹è¯•..."

  # æµ‹è¯•è¯·æ±‚
  for i in {1..10}; do
    curl -f http://localhost/health || {
      echo "å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œå¼€å§‹å›æ»š"
      sudo kill -QUIT $(cat /var/run/nginx.pid.oldbin)
      exit 1
    }
  done

  echo "å¥åº·æ£€æŸ¥é€šè¿‡"

  # ä¼˜é›…åœæ­¢æ—§ worker
  sudo kill -WINCH $(cat /var/run/nginx.pid.oldbin)

  # ç­‰å¾…æ—§ worker é€€å‡º
  sleep 10

  # åœæ­¢æ—§ master
  sudo kill -QUIT $(cat /var/run/nginx.pid.oldbin)

  echo "é›¶åœæœºéƒ¨ç½²å®Œæˆ"
else
  echo "æ–°ç‰ˆæœ¬å¯åŠ¨å¤±è´¥"
  exit 1
fi
```

### é…ç½®å˜æ›´é€šçŸ¥

```bash
#!/bin/bash
# config-change-notify.sh

# Slack é€šçŸ¥
notify_slack() {
  local message=$1
  local webhook="https://hooks.slack.com/services/YOUR/WEBHOOK/URL"

  curl -X POST -H 'Content-type: application/json' \
    --data "{\"text\":\"$message\"}" \
    $webhook
}

# æ£€æŸ¥é…ç½®å˜æ›´
LAST_CHECK=$(date +%s)
while true; do
  find /etc/nginx -name "*.conf" -newermt "@${LAST_CHECK}" | while read file; do
    echo "æ£€æµ‹åˆ°é…ç½®å˜æ›´: $file"

    # æ£€æŸ¥é…ç½®
    if nginx -t 2>/dev/null; then
      # è‡ªåŠ¨é‡è½½
      systemctl reload nginx

      # å‘é€é€šçŸ¥
      notify_slack "âœ… Nginx é…ç½®å·²è‡ªåŠ¨æ›´æ–°: $(basename $file)"
    else
      notify_slack "âŒ Nginx é…ç½®æ£€æŸ¥å¤±è´¥: $(basename $file)"
    fi
  done

  LAST_CHECK=$(date +%s)
  sleep 60  # æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
done
```

---

## ğŸ“š ç›¸å…³é“¾æ¥

- [Nginx åŸºæœ¬å‘½ä»¤](../01-åŸºç¡€å…¥é—¨/åŸºæœ¬å‘½ä»¤.md)
- [é…ç½®æ–‡ä»¶ç»“æ„](./é…ç½®æ–‡ä»¶ç»“æ„.md)
- [ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²](../08-éƒ¨ç½²å®è·µ/ç”Ÿäº§ç¯å¢ƒéƒ¨ç½².md)
- [ç›‘æ§ä¸æ—¥å¿—](../07-æ—¥å¿—ä¸ç›‘æ§/ç›‘æ§ä¸æ—¥å¿—.md)

---

**æ ‡ç­¾**: #nginx #çƒ­æ›´æ–° #é…ç½®ç®¡ç† #éƒ¨ç½² #è¿ç»´
