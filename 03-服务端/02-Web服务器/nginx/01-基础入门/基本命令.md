# Nginx åŸºæœ¬å‘½ä»¤

> Nginx å¸¸ç”¨å‘½ä»¤è¯¦è§£

---

## ğŸ“‹ ç›®å½•

- [æœåŠ¡ç®¡ç†](#æœåŠ¡ç®¡ç†)
- [é…ç½®æ£€æŸ¥](#é…ç½®æ£€æŸ¥)
- [ä¿¡å·æ§åˆ¶](#ä¿¡å·æ§åˆ¶)
- [æ—¥å¿—ç®¡ç†](#æ—¥å¿—ç®¡ç†)
- [æ€§èƒ½æŸ¥çœ‹](#æ€§èƒ½æŸ¥çœ‹)
- [å¸¸ç”¨è„šæœ¬](#å¸¸ç”¨è„šæœ¬)

---

## æœåŠ¡ç®¡ç†

### Systemd å‘½ä»¤ï¼ˆæ¨èï¼‰

```bash
# å¯åŠ¨ Nginx
sudo systemctl start nginx

# åœæ­¢ Nginx
sudo systemctl stop nginx

# é‡å¯ Nginx
sudo systemctl restart nginx

# é‡è½½é…ç½®ï¼ˆä¸ä¸­æ–­æœåŠ¡ï¼‰
sudo systemctl reload nginx

# æŸ¥çœ‹çŠ¶æ€
sudo systemctl status nginx

# è®¾ç½®å¼€æœºè‡ªå¯
sudo systemctl enable nginx

# ç¦ç”¨å¼€æœºè‡ªå¯
sudo systemctl disable nginx

# æŸ¥çœ‹æ˜¯å¦å¯ç”¨
sudo systemctl is-enabled nginx

# æŸ¥çœ‹æœåŠ¡è¯¦æƒ…
sudo systemctl show nginx
```

### Init.d å‘½ä»¤ï¼ˆæ—§ç³»ç»Ÿï¼‰

```bash
# å¯åŠ¨
sudo service nginx start

# åœæ­¢
sudo service nginx stop

# é‡å¯
sudo service nginx restart

# é‡è½½é…ç½®
sudo service nginx reload

# æŸ¥çœ‹çŠ¶æ€
sudo service nginx status
```

### Nginx å‘½ä»¤ç›´æ¥æ§åˆ¶

```bash
# å¯åŠ¨ Nginxï¼ˆéœ€è¦æŒ‡å®šé…ç½®æ–‡ä»¶ï¼‰
sudo nginx -c /etc/nginx/nginx.conf

# å¿«é€Ÿåœæ­¢ï¼ˆå¼ºåˆ¶ï¼‰
sudo nginx -s stop

# ä¼˜é›…åœæ­¢ï¼ˆå¤„ç†å®Œå½“å‰è¯·æ±‚ï¼‰
sudo nginx -s quit

# é‡è½½é…ç½®
sudo nginx -s reload

# é‡æ–°æ‰“å¼€æ—¥å¿—æ–‡ä»¶
sudo nginx -s reopen

# æµ‹è¯•é…ç½®
sudo nginx -t

# æµ‹è¯•é…ç½®å¹¶æ˜¾ç¤ºé…ç½®æ–‡ä»¶è·¯å¾„
sudo nginx -T
```

---

## é…ç½®æ£€æŸ¥

### æ£€æŸ¥é…ç½®æ–‡ä»¶è¯­æ³•

```bash
# åŸºæœ¬è¯­æ³•æ£€æŸ¥
sudo nginx -t

# ç¤ºä¾‹è¾“å‡º
nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
nginx: configuration file /etc/nginx/nginx.conf test is successful
```

### æ˜¾ç¤ºé…ç½®ä¿¡æ¯

```bash
# æ˜¾ç¤ºé…ç½®æ–‡ä»¶è·¯å¾„å’Œå†…å®¹
sudo nginx -T

# ç¤ºä¾‹è¾“å‡º
# configuration file /etc/nginx/nginx.conf:

user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log;
pid /var/run/nginx.pid;

# ... æ‰€æœ‰é…ç½®å†…å®¹

# ä»…æ˜¾ç¤ºé…ç½®æ–‡ä»¶è·¯å¾„
sudo nginx -t 2>&1 | grep configuration

# æŸ¥æ‰¾ç‰¹å®šé…ç½®
sudo nginx -T | grep server_name
```

### æ£€æŸ¥æŒ‡å®šé…ç½®æ–‡ä»¶

```bash
# æ£€æŸ¥è‡ªå®šä¹‰é…ç½®æ–‡ä»¶
sudo nginx -t -c /path/to/custom/nginx.conf

# æ£€æŸ¥å¹¶æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
sudo nginx -T -c /path/to/custom/nginx.conf
```

---

## ä¿¡å·æ§åˆ¶

### å‘ Nginx è¿›ç¨‹å‘é€ä¿¡å·

```bash
# æŸ¥æ‰¾ Nginx master è¿›ç¨‹ PID
cat /var/run/nginx.pid
# æˆ–
ps aux | grep nginx | grep master

# ä¼˜é›…åœæ­¢ï¼ˆQUITï¼‰
sudo kill -QUIT <master_pid>
sudo kill -QUIT $(cat /var/run/nginx.pid)

# å¿«é€Ÿåœæ­¢ï¼ˆTERMï¼‰
sudo kill -TERM <master_pid>

# é‡è½½é…ç½®ï¼ˆHUPï¼‰
sudo kill -HUP <master_pid>

# é‡æ–°æ‰“å¼€æ—¥å¿—æ–‡ä»¶ï¼ˆUSR1ï¼‰
sudo kill -USR1 <master_pid>

# å¹³æ»‘å‡çº§ï¼ˆUSR2 + WINCHï¼‰
sudo kill -USR2 <master_pid>  # å¯åŠ¨æ–° worker
sudo kill -WINCH <master_pid>  # ä¼˜é›…åœæ­¢æ—§ worker
```

### ä¿¡å·è¯´æ˜

| ä¿¡å· | åç§° | ä½œç”¨ |
|------|------|------|
| `TERM` | å¿«é€Ÿåœæ­¢ | ç«‹å³ç»ˆæ­¢è¿›ç¨‹ |
| `QUIT` | ä¼˜é›…åœæ­¢ | å¤„ç†å®Œå½“å‰è¯·æ±‚ååœæ­¢ |
| `HUP` | é‡è½½é…ç½® | é‡è½½é…ç½®æ–‡ä»¶,å¹³æ»‘é‡å¯ |
| `USR1` | é‡æ–°æ‰“å¼€æ—¥å¿— | ç”¨äºæ—¥å¿—åˆ‡å‰² |
| `USR2` | å¹³æ»‘å‡çº§ | å¯åŠ¨æ–°çš„ master è¿›ç¨‹ |
| `WINCH` | ä¼˜é›…åœæ­¢ worker | é…åˆ USR2 ä½¿ç”¨ |

---

## æ—¥å¿—ç®¡ç†

### æŸ¥çœ‹æ—¥å¿—

```bash
# æŸ¥çœ‹è®¿é—®æ—¥å¿—
sudo tail -f /var/log/nginx/access.log

# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
sudo tail -f /var/log/nginx/error.log

# æŸ¥çœ‹æœ€å 100 è¡Œ
sudo tail -n 100 /var/log/nginx/access.log

# æŸ¥çœ‹æŒ‡å®šæ—¶é—´æ®µçš„æ—¥å¿—
sudo grep "2024-01-01" /var/log/nginx/access.log

# ç»Ÿè®¡è®¿é—®æ¬¡æ•°
sudo wc -l /var/log/nginx/access.log

# æŒ‰ IP ç»Ÿè®¡
sudo awk '{print $1}' /var/log/nginx/access.log | sort | uniq -c | sort -nr | head -20
```

### æ—¥å¿—åˆ‡å‰²

```bash
# åˆ›å»ºæ—¥å¿—åˆ‡å‰²è„šæœ¬
sudo cat > /usr/local/bin/nginx-logrotate.sh << 'EOF'
#!/bin/bash
LOG_DIR="/var/log/nginx"
DATE=$(date +%Y%m%d)

# é‡å‘½åæ—¥å¿—æ–‡ä»¶
mv ${LOG_DIR}/access.log ${LOG_DIR}/access.log.${DATE}
mv ${LOG_DIR}/error.log ${LOG_DIR}/error.log.${DATE}

# é‡æ–°æ‰“å¼€æ—¥å¿—æ–‡ä»¶
kill -USR1 $(cat /var/run/nginx.pid)

# å‹ç¼©æ—§æ—¥å¿—ï¼ˆå¯é€‰ï¼‰
gzip ${LOG_DIR}/access.log.${DATE}
gzip ${LOG_DIR}/error.log.${DATE}

# åˆ é™¤ 30 å¤©å‰çš„æ—¥å¿—
find ${LOG_DIR} -name "*.log.*" -mtime +30 -delete
EOF

# æ·»åŠ æ‰§è¡Œæƒé™
sudo chmod +x /usr/local/bin/nginx-logrotate.sh

# æ·»åŠ åˆ° crontab
crontab -e
# æ·»åŠ ä»¥ä¸‹å†…å®¹,æ¯å¤©å‡Œæ™¨åˆ‡å‰²æ—¥å¿—
0 0 * * * /usr/local/bin/nginx-logrotate.sh
```

### ä½¿ç”¨ logrotateï¼ˆæ¨èï¼‰

```bash
# Ubuntu/Debian å·²é»˜è®¤é…ç½®
ls /etc/logrotate.d/nginx

# æ‰‹åŠ¨è¿è¡Œ logrotate
sudo logrotate -f /etc/logrotate.d/nginx

# æµ‹è¯•é…ç½®
sudo logrotate -d /etc/logrotate.d/nginx
```

---

## æ€§èƒ½æŸ¥çœ‹

### æŸ¥çœ‹ Nginx è¿›ç¨‹

```bash
# æŸ¥çœ‹æ‰€æœ‰ Nginx è¿›ç¨‹
ps aux | grep nginx

# æŸ¥çœ‹ master è¿›ç¨‹
ps aux | grep nginx | grep master

# æŸ¥çœ‹ worker è¿›ç¨‹
ps aux | grep nginx | grep worker

# ç»Ÿè®¡ worker æ•°é‡
ps aux | grep nginx | grep worker | wc -l
```

### æŸ¥çœ‹è¿æ¥æ•°

```bash
# æŸ¥çœ‹ Nginx è¿æ¥æ•°
netstat -anp | grep nginx | grep ESTABLISHED | wc -l

# æŸ¥çœ‹æ‰€æœ‰è¿æ¥çŠ¶æ€
netstat -anp | grep nginx | awk '{print $6}' | sort | uniq -c | sort -nr

# ä½¿ç”¨ ss å‘½ä»¤ï¼ˆæ¨èï¼‰
ss -antp | grep nginx

# æŸ¥çœ‹æ¯ä¸ª worker çš„è¿æ¥æ•°
for pid in $(pgrep -f "nginx: worker"); do
    echo "Worker PID: $pid"
    ss -antp | grep $pid | wc -l
done
```

### æŸ¥çœ‹å†…å­˜ä½¿ç”¨

```bash
# æŸ¥çœ‹ Nginx å†…å­˜ä½¿ç”¨
ps aux | grep nginx | awk '{sum+=$6} END {print "Total Memory:", sum/1024, "MB"}'

# æŸ¥çœ‹å•ä¸ªè¿›ç¨‹å†…å­˜
pmap -x $(cat /var/run/nginx.pid)

# å®æ—¶ç›‘æ§
top -p $(pgrep -f "nginx: master" | tr '\n' ',')
```

### æ€§èƒ½ç»Ÿè®¡

```bash
# å¯ç”¨ stub_status æ¨¡å—åè®¿é—®
# åœ¨ nginx.conf ä¸­æ·»åŠ :
# location /nginx_status {
#     stub_status on;
#     access_log off;
#     allow 127.0.0.1;
#     deny all;
# }

curl http://localhost/nginx_status

# è¾“å‡ºç¤ºä¾‹:
# Active connections: 2
# server accepts handled requests
#  100 100 200
# Reading: 0 Writing: 1 Waiting: 1
```

---

## å¸¸ç”¨è„šæœ¬

### å¿«é€Ÿé‡å¯è„šæœ¬

```bash
# åˆ›å»ºå¿«é€Ÿé‡å¯è„šæœ¬
sudo cat > /usr/local/bin/nginx-restart << 'EOF'
#!/bin/bash
echo "æ­£åœ¨æ£€æŸ¥ Nginx é…ç½®..."
sudo nginx -t
if [ $? -eq 0 ]; then
    echo "é…ç½®æ£€æŸ¥é€šè¿‡,æ­£åœ¨é‡è½½..."
    sudo systemctl reload nginx
    echo "Nginx é‡è½½å®Œæˆ"
else
    echo "é…ç½®æ£€æŸ¥å¤±è´¥,è¯·æ£€æŸ¥é…ç½®æ–‡ä»¶"
    exit 1
fi
EOF

# æ·»åŠ æ‰§è¡Œæƒé™
sudo chmod +x /usr/local/bin/nginx-restart
```

### æ€§èƒ½ç›‘æ§è„šæœ¬

```bash
# åˆ›å»ºæ€§èƒ½ç›‘æ§è„šæœ¬
sudo cat > /usr/local/bin/nginx-monitor << 'EOF'
#!/bin/bash
echo "=== Nginx æ€§èƒ½ç›‘æ§ ==="
echo "æ—¶é—´: $(date)"
echo ""

echo "è¿›ç¨‹çŠ¶æ€:"
ps aux | grep nginx | grep -v grep
echo ""

echo "è¿æ¥ç»Ÿè®¡:"
ss -antp | grep nginx | wc -l
echo ""

echo "å†…å­˜ä½¿ç”¨:"
ps aux | grep nginx | grep -v grep | awk '{sum+=$6} END {print "Total Memory:", sum/1024, "MB"}'
echo ""

echo "å·¥ä½œè¿›ç¨‹æ•°:"
ps aux | grep nginx | grep worker | wc -l
EOF

# æ·»åŠ æ‰§è¡Œæƒé™
sudo chmod +x /usr/local/bin/nginx-monitor
```

### é…ç½®å¤‡ä»½è„šæœ¬

```bash
# åˆ›å»ºé…ç½®å¤‡ä»½è„šæœ¬
sudo cat > /usr/local/bin/nginx-backup << 'EOF'
#!/bin/bash
BACKUP_DIR="/backup/nginx/$(date +%Y%m%d_%H%M%S)"
mkdir -p $BACKUP_DIR

# å¤‡ä»½é…ç½®æ–‡ä»¶
cp -r /etc/nginx/* $BACKUP_DIR/

# æ‰“åŒ…å‹ç¼©
tar -czf ${BACKUP_DIR}.tar.gz -C /backup/nginx $(basename $BACKUP_DIR)
rm -rf $BACKUP_DIR

echo "å¤‡ä»½å®Œæˆ: ${BACKUP_DIR}.tar.gz"
EOF

# æ·»åŠ æ‰§è¡Œæƒé™
sudo chmod +x /usr/local/bin/nginx-backup
```

---

## ğŸ”§ æ•…éšœæ’æŸ¥å‘½ä»¤

### æ£€æŸ¥ç«¯å£å ç”¨

```bash
# æ£€æŸ¥ 80 ç«¯å£
sudo netstat -tulpn | grep :80
sudo lsof -i :80

# æ£€æŸ¥ 443 ç«¯å£
sudo netstat -tulpn | grep :443
sudo lsof -i :443
```

### æ£€æŸ¥é…ç½®æ–‡ä»¶

```bash
# æ£€æŸ¥è¯­æ³•
sudo nginx -t

# æŸ¥æ‰¾é…ç½®æ–‡ä»¶
sudo nginx -t 2>&1 | grep configuration

# æŸ¥æ‰¾ include çš„æ–‡ä»¶
sudo grep -r "include" /etc/nginx/
```

### æ£€æŸ¥æƒé™

```bash
# æ£€æŸ¥ Nginx è¿è¡Œç”¨æˆ·
ps aux | grep nginx | grep master

# æ£€æŸ¥ç½‘ç«™ç›®å½•æƒé™
ls -la /var/www/html/

# æ£€æŸ¥æ—¥å¿—æ–‡ä»¶æƒé™
ls -la /var/log/nginx/
```

### æµ‹è¯•ç½‘ç»œè¿æ¥

```bash
# æµ‹è¯•æœ¬åœ°è¿æ¥
curl -I http://localhost

# æµ‹è¯•ç‰¹å®šåŸŸå
curl -I http://example.com

# æµ‹è¯• HTTPS
curl -I https://example.com

# è¯¦ç»†è°ƒè¯•
curl -v http://localhost
```

---

## ğŸ“š ç›¸å…³é“¾æ¥

- [Nginx å®‰è£…ä¸ç¯å¢ƒé…ç½®](./å®‰è£…ä¸ç¯å¢ƒé…ç½®.md)
- [Nginx æ ¸å¿ƒæ¦‚å¿µ](./æ ¸å¿ƒæ¦‚å¿µ.md)
- [é…ç½®æ–‡ä»¶ç»“æ„](../02-é…ç½®ç®¡ç†/é…ç½®æ–‡ä»¶ç»“æ„.md)
- [æ•…éšœæ’æŸ¥](../09-æ•…éšœæ’æŸ¥/å¸¸è§é—®é¢˜æ’æŸ¥.md)

---

**æ ‡ç­¾**: #nginx #å‘½ä»¤ #è¿ç»´ #ç®¡ç†
