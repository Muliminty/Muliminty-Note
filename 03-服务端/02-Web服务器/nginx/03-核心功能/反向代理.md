# Nginx åå‘ä»£ç†

> Nginx åå‘ä»£ç†é…ç½®å’Œä½¿ç”¨è¯¦è§£

---

## ğŸ“‹ ç›®å½•

- [åå‘ä»£ç†åŸºç¡€](#åå‘ä»£ç†åŸºç¡€)
- [åŸºæœ¬é…ç½®](#åŸºæœ¬é…ç½®)
- [è¯·æ±‚å¤´è®¾ç½®](#è¯·æ±‚å¤´è®¾ç½®)
- [è¶…æ—¶é…ç½®](#è¶…æ—¶é…ç½®)
- [ç¼“å†²é…ç½®](#ç¼“å†²é…ç½®)
- [é”™è¯¯å¤„ç†](#é”™è¯¯å¤„ç†)
- [è´Ÿè½½å‡è¡¡](#è´Ÿè½½å‡è¡¡)
- [WebSocket ä»£ç†](#websocket-ä»£ç†)

---

## åå‘ä»£ç†åŸºç¡€

### ä»€ä¹ˆæ˜¯åå‘ä»£ç†

```
æ­£å‘ä»£ç†ï¼ˆForward Proxyï¼‰:
å®¢æˆ·ç«¯ â†’ ä»£ç†æœåŠ¡å™¨ â†’ äº’è”ç½‘ â†’ ç›®æ ‡æœåŠ¡å™¨
ï¼ˆå®¢æˆ·ç«¯çŸ¥é“ç›®æ ‡æœåŠ¡å™¨ï¼Œç›®æ ‡æœåŠ¡å™¨ä¸çŸ¥é“çœŸå®å®¢æˆ·ç«¯ï¼‰

åå‘ä»£ç†ï¼ˆReverse Proxyï¼‰:
å®¢æˆ·ç«¯ â†’ åå‘ä»£ç† â†’ åç«¯æœåŠ¡å™¨
ï¼ˆå®¢æˆ·ç«¯ä¸çŸ¥é“åç«¯æœåŠ¡å™¨ï¼Œåç«¯æœåŠ¡å™¨ä¸çŸ¥é“çœŸå®å®¢æˆ·ç«¯ï¼‰
```

**åå‘ä»£ç†çš„ä½œç”¨**:
- éšè—åç«¯æœåŠ¡å™¨
- è´Ÿè½½å‡è¡¡
- SSL/TLS ç»ˆç«¯
- ç¼“å­˜åŠ é€Ÿ
- å®‰å…¨é˜²æŠ¤
- ç»Ÿä¸€å…¥å£

### Nginx åå‘ä»£ç†æ¶æ„

```
å®¢æˆ·ç«¯è¯·æ±‚
    â†“
Nginx åå‘ä»£ç†
    â†“
åç«¯æœåŠ¡å™¨ï¼ˆWeb åº”ç”¨ã€API æœåŠ¡ç­‰ï¼‰
    â†“
å“åº”è¿”å› Nginx
    â†“
è¿”å›ç»™å®¢æˆ·ç«¯
```

---

## åŸºæœ¬é…ç½®

### æœ€ç®€å•çš„åå‘ä»£ç†

```nginx
server {
    listen 80;
    server_name example.com;

    location / {
        proxy_pass http://backend_server:8080;
    }
}
```

### å¸¦è·¯å¾„çš„åå‘ä»£ç†

```nginx
# åç«¯æœåŠ¡å™¨: http://backend:8080/

# æ–¹å¼ 1: ä¸å¸¦ URIï¼ˆä¿ç•™åŸå§‹è·¯å¾„ï¼‰
location /api/ {
    proxy_pass http://backend:8080;  # è¯·æ±‚ /api/users â†’ http://backend:8080/api/users
}

# æ–¹å¼ 2: å¸¦ URIï¼ˆæ›¿æ¢è·¯å¾„ï¼‰
location /api/ {
    proxy_pass http://backend:8080/;  # è¯·æ±‚ /api/users â†’ http://backend:8080/users
}

# æ–¹å¼ 3: è‡ªå®šä¹‰è·¯å¾„
location /old-api/ {
    proxy_pass http://backend:8080/new-api/;  # è¯·æ±‚ /old-api/users â†’ http://backend:8080/new-api/users
}
```

### å¤šåç«¯ä»£ç†

```nginx
# å®šä¹‰ upstream
upstream backend {
    server app1.example.com:8080;
    server app2.example.com:8080;
    server app3.example.com:8080;
}

server {
    listen 80;
    server_name api.example.com;

    location / {
        proxy_pass http://backend;
    }
}
```

---

## è¯·æ±‚å¤´è®¾ç½®

### åŸºæœ¬è¯·æ±‚å¤´

```nginx
server {
    listen 80;
    server_name example.com;

    location / {
        # è®¾ç½® Host å¤´ï¼ˆé‡è¦ï¼ï¼‰
        proxy_set_header Host $host;

        # è®¾ç½®çœŸå® IP
        proxy_set_header X-Real-IP $remote_addr;

        # è®¾ç½® X-Forwarded-For
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        # è®¾ç½®åè®®
        proxy_set_header X-Forwarded-Proto $scheme;

        # è®¾ç½®ç«¯å£
        proxy_set_header X-Forwarded-Port $server_port;

        # è®¾ç½®åŸå§‹ Host
        proxy_set_header X-Forwarded-Host $server_name;

        # ä¼ é€’åç«¯
        proxy_pass http://backend;
    }
}
```

### å®Œæ•´è¯·æ±‚å¤´ç¤ºä¾‹

```nginx
location / {
    # åŸºæœ¬ä¿¡æ¯
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Port $server_port;
    proxy_set_header X-Forwarded-Host $server_name;

    # é™„åŠ ä¿¡æ¯
    proxy_set_header X-Request-ID $request_id;
    proxy_set_header X-Request-Start "t=${msec}";
    proxy_set_header X-Original-URI $request_uri;
    proxy_set_header X-Original-Method $request_method;

    # å®¢æˆ·ç«¯ä¿¡æ¯
    proxy_set_header User-Agent $http_user_agent;
    proxy_set_header Accept-Language $http_accept_language;
    proxy_set_header Accept-Encoding $http_accept_encoding;

    proxy_pass http://backend;
}
```

### æ¡ä»¶è®¾ç½®è¯·æ±‚å¤´

```nginx
location / {
    # ä»…å¯¹ç‰¹å®šè¯·æ±‚è®¾ç½®è¯·æ±‚å¤´
    if ($request_method = POST) {
        proxy_set_header X-Request-Type "form-submit";
    }

    if ($http_user_agent ~* "mobile") {
        proxy_set_header X-Device-Type "mobile";
    }

    proxy_pass http://backend;
}

# ä½¿ç”¨ map æ›´ä¼˜é›…çš„å®ç°
map $http_user_agent $device_type {
    default "desktop";
    ~*mobile|android|iphone|ipad "mobile";
    ~*tablet|ipad "tablet";
}

server {
    location / {
        proxy_set_header X-Device-Type $device_type;
        proxy_pass http://backend;
    }
}
```

---

## è¶…æ—¶é…ç½®

### è¿æ¥è¶…æ—¶

```nginx
server {
    listen 80;
    server_name example.com;

    location / {
        # è¿æ¥è¶…æ—¶ï¼ˆè¿æ¥åˆ°åç«¯ï¼‰
        proxy_connect_timeout 5s;

        # å‘é€è¶…æ—¶ï¼ˆå‘é€è¯·æ±‚åˆ°åç«¯ï¼‰
        proxy_send_timeout 60s;

        # è¯»å–è¶…æ—¶ï¼ˆç­‰å¾…åç«¯å“åº”ï¼‰
        proxy_read_timeout 60s;

        proxy_pass http://backend;
    }
}
```

### è¶…æ—¶è¯´æ˜

| æŒ‡ä»¤ | è¯´æ˜ | æ¨èå€¼ |
|------|------|--------|
| `proxy_connect_timeout` | ä¸åç«¯å»ºç«‹è¿æ¥çš„è¶…æ—¶ | 3-5sï¼ˆçŸ­ï¼‰<br>10-30sï¼ˆé•¿ï¼‰ |
| `proxy_send_timeout` | å‘é€è¯·æ±‚åˆ°åç«¯çš„è¶…æ—¶ | 60s |
| `proxy_read_timeout` | ç­‰å¾…åç«¯å“åº”çš„è¶…æ—¶ | 60sï¼ˆæ™®é€šï¼‰<br>300sï¼ˆé•¿è½®è¯¢ï¼‰ |

### ä¸åŒåœºæ™¯çš„è¶…æ—¶é…ç½®

```nginx
# 1. API æ¥å£ï¼ˆçŸ­è¶…æ—¶ï¼‰
location /api/ {
    proxy_connect_timeout 3s;
    proxy_send_timeout 10s;
    proxy_read_timeout 10s;
    proxy_pass http://api_backend;
}

# 2. æ–‡ä»¶ä¸Šä¼ ï¼ˆé•¿è¶…æ—¶ï¼‰
location /upload/ {
    proxy_connect_timeout 5s;
    proxy_send_timeout 300s;      # ä¸Šä¼ å¯èƒ½éœ€è¦å¾ˆé•¿æ—¶é—´
    proxy_read_timeout 60s;
    proxy_pass http://upload_backend;
}

# 3. é•¿è½®è¯¢/Websocketï¼ˆéå¸¸é•¿ï¼‰
location /ws/ {
    proxy_connect_timeout 5s;
    proxy_send_timeout 3600s;     # 1 å°æ—¶
    proxy_read_timeout 3600s;     # 1 å°æ—¶
    proxy_pass http://ws_backend;
}

# 4. æ™®é€šç½‘é¡µï¼ˆä¸­ç­‰è¶…æ—¶ï¼‰
location / {
    proxy_connect_timeout 5s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
    proxy_pass http://web_backend;
}
```

---

## ç¼“å†²é…ç½®

### è¯·æ±‚ç¼“å†²

```nginx
server {
    location / {
        # æ˜¯å¦ç¼“å†²å®¢æˆ·ç«¯è¯·æ±‚ä½“
        proxy_request_buffering on;    # é»˜è®¤ on

        # å®¢æˆ·ç«¯è¯·æ±‚ä½“å¤§å°é™åˆ¶
        client_max_body_size 10m;

        # è¯·æ±‚ä½“ç¼“å†²åŒºå¤§å°
        client_body_buffer_size 128k;

        proxy_pass http://backend;
    }
}
```

### å“åº”ç¼“å†²

```nginx
server {
    location / {
        # æ˜¯å¦ç¼“å†²åç«¯å“åº”
        proxy_buffering on;            # é»˜è®¤ on

        # å“åº”ç¼“å†²åŒºæ•°é‡å’Œå¤§å°
        proxy_buffers 8 4k;            # 8 ä¸ª 4k ç¼“å†²åŒº

        # å“åº”å¤´ç¼“å†²åŒºå¤§å°
        proxy_buffer_size 4k;          # é»˜è®¤å¤§å°

        # ç¬¬ä¸€ä¸ªå“åº”åŒ…çš„è¶…æ—¶
        proxy_buffering on;

        # æ˜¯å¦ç¼“å­˜åˆ°ç£ç›˜
        proxy_max_temp_file_size 1024m;  # æœ€å¤§ä¸´æ—¶æ–‡ä»¶å¤§å°
        proxy_temp_file_write_size 8k;   # æ¯æ¬¡å†™å…¥å¤§å°
        proxy_temp_path /var/tmp/nginx;  # ä¸´æ—¶æ–‡ä»¶è·¯å¾„

        proxy_pass http://backend;
    }
}
```

### ç¼“å†²é…ç½®è¯´æ˜

| æŒ‡ä»¤ | è¯´æ˜ | æ¨èå€¼ |
|------|------|--------|
| `proxy_buffering` | æ˜¯å¦å¯ç”¨å“åº”ç¼“å†² | onï¼ˆé»˜è®¤ï¼‰ |
| `proxy_buffers` | å“åº”ç¼“å†²åŒºæ•°é‡å’Œå¤§å° | 8 4k æˆ– 8 8k |
| `proxy_buffer_size` | å“åº”å¤´ç¼“å†²åŒºå¤§å° | 4k æˆ– 8k |
| `proxy_busy_buffers_size` | å¿™ç¼“å†²åŒºå¤§å° | 8k æˆ– 16k |
| `proxy_max_temp_file_size` | ä¸´æ—¶æ–‡ä»¶æœ€å¤§å¤§å° | 1024m |
| `proxy_temp_file_write_size` | ä¸´æ—¶æ–‡ä»¶å†™å…¥å¤§å° | 8k |

### ä¸åŒåœºæ™¯çš„ç¼“å†²é…ç½®

```nginx
# 1. å¤§æ–‡ä»¶ä¸‹è½½ï¼ˆå…³é—­ç¼“å†²ï¼‰
location /download/ {
    proxy_buffering off;           # å…³é—­ç¼“å†²,ç›´æ¥è½¬å‘
    proxy_pass http://file_backend;
}

# 2. SSE (Server-Sent Events)
location /events/ {
    proxy_buffering off;           # å…³é—­ç¼“å†²,å®æ—¶è½¬å‘
    proxy_cache off;
    proxy_pass http://sse_backend;
}

# 3. æ™®é€šç½‘é¡µï¼ˆå¼€å¯ç¼“å†²ï¼‰
location / {
    proxy_buffering on;            # å¼€å¯ç¼“å†²
    proxy_buffers 16 4k;
    proxy_buffer_size 8k;
    proxy_pass http://web_backend;
}

# 4. API æ¥å£ï¼ˆé€‚åº¦ç¼“å†²ï¼‰
location /api/ {
    proxy_buffering on;
    proxy_buffers 4 4k;
    proxy_buffer_size 4k;
    proxy_pass http://api_backend;
}
```

---

## é”™è¯¯å¤„ç†

### é”™è¯¯é¡µé¢é…ç½®

```nginx
server {
    listen 80;
    server_name example.com;

    location / {
        proxy_pass http://backend;

        # æ‹¦æˆªåç«¯é”™è¯¯
        proxy_intercept_errors on;

        # è‡ªå®šä¹‰é”™è¯¯é¡µé¢
        error_page 404 /404.html;
        error_page 500 502 503 504 /50x.html;

        # é”™è¯¯é¡µé¢ä½ç½®
        location = /50x.html {
            root /usr/share/nginx/html;
        }

        location = /404.html {
            root /usr/share/nginx/html;
        }
    }
}
```

### åç«¯é”™è¯¯é‡è¯•

```nginx
server {
    location / {
        proxy_pass http://backend;

        # é‡è¯•è®¾ç½®
        proxy_next_upstream error timeout;  # åœ¨å“ªäº›æƒ…å†µä¸‹é‡è¯•
        proxy_next_upstream_tries 3;        # æœ€å¤§é‡è¯•æ¬¡æ•°
        proxy_next_upstream_timeout 10s;    # é‡è¯•è¶…æ—¶

        # æˆ–è€…æ˜¾ç¤ºé”™è¯¯é¡µé¢
        proxy_intercept_errors on;
        error_page 502 503 504 /error.html;
    }
}
```

### å¥åº·æ£€æŸ¥ï¼ˆéœ€è¦ nginx-plus æˆ–ç¬¬ä¸‰æ–¹æ¨¡å—ï¼‰

```nginx
upstream backend {
    server backend1.example.com:8080 max_fails=3 fail_timeout=30s;
    server backend2.example.com:8080 max_fails=3 fail_timeout=30s;
    server backend3.example.com:8080 max_fails=3 fail_timeout=30s backup;
}

server {
    location / {
        proxy_pass http://backend;

        # å¥åº·æ£€æŸ¥å‚æ•°
        proxy_connect_timeout 3s;
        proxy_next_upstream error timeout http_500 http_502 http_503 http_504;
    }
}
```

---

## è´Ÿè½½å‡è¡¡

### åŸºæœ¬è´Ÿè½½å‡è¡¡

```nginx
upstream backend {
    # è½®è¯¢ï¼ˆé»˜è®¤ï¼‰
    server backend1.example.com:8080;
    server backend2.example.com:8080;
    server backend3.example.com:8080;
}

server {
    location / {
        proxy_pass http://backend;
    }
}
```

### åŠ æƒè½®è¯¢

```nginx
upstream backend {
    server backend1.example.com:8080 weight=3;  # 3/6 çš„è¯·æ±‚
    server backend2.example.com:8080 weight=2;  # 2/6 çš„è¯·æ±‚
    server backend3.example.com:8080 weight=1;  # 1/6 çš„è¯·æ±‚
}
```

### IP å“ˆå¸Œ

```nginx
upstream backend {
    ip_hash;  # æ ¹æ®å®¢æˆ·ç«¯ IP å“ˆå¸Œ

    server backend1.example.com:8080;
    server backend2.example.com:8080;
    server backend3.example.com:8080;
}
```

### æœ€å°‘è¿æ¥

```nginx
upstream backend {
    least_conn;  # é€‰æ‹©è¿æ¥æ•°æœ€å°‘çš„åç«¯

    server backend1.example.com:8080;
    server backend2.example.com:8080;
    server backend3.example.com:8080;
}
```

### åç«¯å‚æ•°é…ç½®

```nginx
upstream backend {
    server backend1.example.com:8080 max_fails=3 fail_timeout=30s weight=3;
    server backend2.example.com:8080 max_fails=3 fail_timeout=30s weight=2;
    server backend3.example.com:8080 max_fails=3 fail_timeout=30s backup;  # å¤‡ç”¨

    keepalive 32;              # é•¿è¿æ¥æ•°
    keepalive_timeout 60s;     # é•¿è¿æ¥è¶…æ—¶
    keepalive_requests 100;    # é•¿è¿æ¥æœ€å¤§è¯·æ±‚æ•°
}

server {
    location / {
        proxy_pass http://backend;
        proxy_http_version 1.1;  # HTTP 1.1
        proxy_set_header Connection "";
    }
}
```

---

## WebSocket ä»£ç†

### WebSocket åŸºç¡€é…ç½®

```nginx
server {
    listen 80;
    server_name ws.example.com;

    location /ws/ {
        proxy_pass http://ws_backend;

        # WebSocket æ”¯æŒ
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # è¶…æ—¶è®¾ç½®ï¼ˆWebSocket éœ€è¦é•¿è¿æ¥ï¼‰
        proxy_connect_timeout 7d;
        proxy_send_timeout 7d;
        proxy_read_timeout 7d;

        # å…³é—­ç¼“å†²
        proxy_buffering off;
    }
}
```

### WebSocket è´Ÿè½½å‡è¡¡

```nginx
upstream ws_backend {
    # IP å“ˆå¸Œï¼ˆWebSocket éœ€è¦ä¼šè¯ä¿æŒï¼‰
    ip_hash;

    server ws1.example.com:8080;
    server ws2.example.com:8080;
}

server {
    listen 80;
    server_name ws.example.com;

    location /ws/ {
        proxy_pass http://ws_backend;

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # WebSocket è¶…æ—¶
        proxy_connect_timeout 7d;
        proxy_send_timeout 7d;
        proxy_read_timeout 7d;
        proxy_buffering off;
    }
}
```

---

## ğŸ”§ é«˜çº§æŠ€å·§

### åŠ¨æ€åç«¯é€‰æ‹©

```nginx
# ä½¿ç”¨å˜é‡é€‰æ‹©åç«¯
upstream backend_a {
    server backend-a.example.com:8080;
}

upstream backend_b {
    server backend-b.example.com:8080;
}

server {
    listen 80;
    server_name example.com;

    location / {
        set $backend "backend_a";

        if ($http_user_agent ~* "mobile") {
            set $backend "backend_b";
        }

        proxy_pass http://$backend;
    }
}

# ä½¿ç”¨ map æ›´ä¼˜é›…çš„å®ç°
map $http_user_agent $backend {
    default "backend_a";
    ~*mobile "backend_b";
}

server {
    location / {
        proxy_pass http://$backend;
    }
}
```

### åŸºäº Cookie çš„ä¼šè¯ä¿æŒ

```nginx
upstream backend {
    server backend1.example.com:8080;
    server backend2.example.com:8080;

    # æ ¹æ® Cookie é€‰æ‹©åç«¯ï¼ˆéœ€è¦ç¬¬ä¸‰æ–¹æ¨¡å—ï¼‰
    # hash $cookie_sessionid consistent;
}

server {
    location / {
        proxy_pass http://backend;

        # è®¾ç½®ä¼šè¯ Cookie
        add_header Set-Cookie "backend=$upstream_addr; Path=/; HttpOnly";
    }
}
```

### API ç½‘å…³æ¨¡å¼

```nginx
# å¤šä¸ªåç«¯æœåŠ¡
upstream user_service {
    server user1.example.com:8080;
    server user2.example.com:8080;
}

upstream order_service {
    server order1.example.com:8080;
    server order2.example.com:8080;
}

upstream product_service {
    server product1.example.com:8080;
    server product2.example.com:8080;
}

server {
    listen 80;
    server_name api.example.com;

    # API ç½‘å…³è·¯ç”±
    location /api/users/ {
        proxy_pass http://user_service;
        proxy_set_header X-Service-Name "user-service";
    }

    location /api/orders/ {
        proxy_pass http://order_service;
        proxy_set_header X-Service-Name "order-service";
    }

    location /api/products/ {
        proxy_pass http://product_service;
        proxy_set_header X-Service-Name "product-service";
    }

    # å¥åº·æ£€æŸ¥æ¥å£
    location /health {
        access_log off;
        return 200 "OK\n";
        add_header Content-Type text/plain;
    }
}
```

---

## ğŸ“š ç›¸å…³é“¾æ¥

- [è´Ÿè½½å‡è¡¡](../03-æ ¸å¿ƒåŠŸèƒ½/è´Ÿè½½å‡è¡¡.md)
- [è™šæ‹Ÿä¸»æœºé…ç½®](../03-æ ¸å¿ƒåŠŸèƒ½/è™šæ‹Ÿä¸»æœºé…ç½®.md)
- [ä¸Šæ¸¸æœåŠ¡å™¨ç®¡ç†](../03-æ ¸å¿ƒåŠŸèƒ½/ä¸Šæ¸¸æœåŠ¡å™¨ç®¡ç†.md)
- [ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²](../08-éƒ¨ç½²å®è·µ/ç”Ÿäº§ç¯å¢ƒéƒ¨ç½².md)

---

**æ ‡ç­¾**: #nginx #åå‘ä»£ç† #è´Ÿè½½å‡è¡¡ #websocket #proxy
