# Nginx è´Ÿè½½å‡è¡¡

> Nginx è´Ÿè½½å‡è¡¡é…ç½®ç­–ç•¥å’Œæœ€ä½³å®è·µ

---

## ğŸ“‹ ç›®å½•

- [è´Ÿè½½å‡è¡¡åŸºç¡€](#è´Ÿè½½å‡è¡¡åŸºç¡€)
- [Upstream é…ç½®](#upstream-é…ç½®)
- [è´Ÿè½½å‡è¡¡ç®—æ³•](#è´Ÿè½½å‡è¡¡ç®—æ³•)
- [å¥åº·æ£€æŸ¥](#å¥åº·æ£€æŸ¥)
- [ä¼šè¯ä¿æŒ](#ä¼šè¯ä¿æŒ)
- [é«˜çº§é…ç½®](#é«˜çº§é…ç½®)
- [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)

---

## è´Ÿè½½å‡è¡¡åŸºç¡€

### ä»€ä¹ˆæ˜¯è´Ÿè½½å‡è¡¡

è´Ÿè½½å‡è¡¡æ˜¯å°†å®¢æˆ·ç«¯è¯·æ±‚åˆ†å‘åˆ°å¤šä¸ªåç«¯æœåŠ¡å™¨,ä»¥æé«˜æ€§èƒ½ã€å¯é æ€§å’Œå¯æ‰©å±•æ€§ã€‚

```
å®¢æˆ·ç«¯è¯·æ±‚
    â†“
è´Ÿè½½å‡è¡¡å™¨ï¼ˆNginxï¼‰
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åç«¯æœåŠ¡å™¨ â”‚ åç«¯æœåŠ¡å™¨ â”‚ åç«¯æœåŠ¡å™¨ â”‚
â”‚ Server 1  â”‚ Server 2  â”‚ Server 3  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è´Ÿè½½å‡è¡¡çš„å¥½å¤„**:
- æé«˜å¹¶å‘å¤„ç†èƒ½åŠ›
- å¢å¼ºç³»ç»Ÿå¯é æ€§ï¼ˆæ•…éšœè½¬ç§»ï¼‰
- å®ç°æ°´å¹³æ‰©å±•
- ä¼˜åŒ–èµ„æºåˆ©ç”¨ç‡

### Nginx è´Ÿè½½å‡è¡¡æ¶æ„

```nginx
# 1. å®šä¹‰åç«¯æœåŠ¡å™¨ç»„
upstream backend {
    server backend1.example.com:8080;
    server backend2.example.com:8080;
    server backend3.example.com:8080;
}

# 2. ä½¿ç”¨ upstream
server {
    listen 80;
    server_name example.com;

    location / {
        proxy_pass http://backend;
    }
}
```

---

## Upstream é…ç½®

### åŸºæœ¬ Upstream

```nginx
upstream backend {
    server backend1.example.com:8080;
    server backend2.example.com:8080;
    server backend3.example.com:8080;
}
```

### å¸¦æƒé‡çš„ Upstream

```nginx
upstream backend {
    # weight è¶Šå¤§,åˆ†é…çš„è¯·æ±‚è¶Šå¤š
    server backend1.example.com:8080 weight=3;  # 3/6 = 50%
    server backend2.example.com:8080 weight=2;  # 2/6 = 33%
    server backend3.example.com:8080 weight=1;  # 1/6 = 17%
}
```

### å¸¦å‚æ•°çš„ Upstream

```nginx
upstream backend {
    # max_fails: æœ€å¤§å¤±è´¥æ¬¡æ•°
    # fail_timeout: å¤±è´¥è¶…æ—¶æ—¶é—´
    # backup: å¤‡ç”¨æœåŠ¡å™¨
    # down: æ ‡è®°ä¸ºä¸å¯ç”¨
    # max_conns: æœ€å¤§è¿æ¥æ•°

    server backend1.example.com:8080 max_fails=3 fail_timeout=30s weight=3 max_conns=100;
    server backend2.example.com:8080 max_fails=3 fail_timeout=30s weight=2 max_conns=100;
    server backend3.example.com:8080 max_fails=3 fail_timeout=30s weight=1 backup;
    server backend4.example.com:8080 down;  # æ‰‹åŠ¨ä¸‹çº¿
}
```

### é•¿è¿æ¥é…ç½®

```nginx
upstream backend {
    server backend1.example.com:8080;
    server backend2.example.com:8080;

    keepalive 32;              # æ¯ä¸ª worker çš„é•¿è¿æ¥æ•°
    keepalive_timeout 60s;     # é•¿è¿æ¥è¶…æ—¶æ—¶é—´
    keepalive_requests 100;    # æ¯ä¸ªé•¿è¿æ¥æœ€å¤§è¯·æ±‚æ•°
}

server {
    location / {
        proxy_pass http://backend;

        # HTTP 1.1 å’Œé•¿è¿æ¥
        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }
}
```

### DNS è§£æ

```nginx
upstream backend {
    # åŸŸåä¼šè‡ªåŠ¨è§£æ
    server api.example.com:8080;

    # è®¾ç½® DNS è§£æé¢‘ç‡
    resolver 8.8.8.8 8.8.4.4 valid=300s;  # æ¯ 5 åˆ†é’Ÿè§£æä¸€æ¬¡
    resolver_timeout 5s;                   # DNS è§£æè¶…æ—¶
}
```

---

## è´Ÿè½½å‡è¡¡ç®—æ³•

### 1. è½®è¯¢ (Round Robin) - é»˜è®¤

```nginx
upstream backend {
    # é»˜è®¤å°±æ˜¯è½®è¯¢
    server backend1.example.com:8080;
    server backend2.example.com:8080;
    server backend3.example.com:8080;
}

# è¯·æ±‚åˆ†é…é¡ºåº:
# Request 1 â†’ backend1
# Request 2 â†’ backend2
# Request 3 â†’ backend3
# Request 4 â†’ backend1
# Request 5 â†’ backend2
# ...
```

### 2. åŠ æƒè½®è¯¢ (Weighted Round Robin)

```nginx
upstream backend {
    server backend1.example.com:8080 weight=3;  # æ€§èƒ½å¥½çš„æœåŠ¡å™¨
    server backend2.example.com:8080 weight=2;
    server backend3.example.com:8080 weight=1;  # æ€§èƒ½å·®çš„æœåŠ¡å™¨
}

# è¯·æ±‚åˆ†é…é¡ºåº:
# Request 1 â†’ backend1
# Request 2 â†’ backend1
# Request 3 â†’ backend1
# Request 4 â†’ backend2
# Request 5 â†’ backend2
# Request 6 â†’ backend3
# Request 7 â†’ backend1
# ...
```

### 3. IP å“ˆå¸Œ (IP Hash)

```nginx
upstream backend {
    ip_hash;  # æ ¹æ®å®¢æˆ·ç«¯ IP å“ˆå¸Œ

    server backend1.example.com:8080;
    server backend2.example.com:8080;
    server backend3.example.com:8080;
}

# åŒä¸€ä¸ªå®¢æˆ·ç«¯ IP æ€»æ˜¯åˆ†é…åˆ°åŒä¸€ä¸ªåç«¯
# ç”¨äºéœ€è¦ä¼šè¯ä¿æŒçš„åœºæ™¯
```

### 4. æœ€å°‘è¿æ¥ (Least Connections)

```nginx
upstream backend {
    least_conn;  # é€‰æ‹©è¿æ¥æ•°æœ€å°‘çš„åç«¯

    server backend1.example.com:8080;
    server backend2.example.com:8080;
    server backend3.example.com:8080;
}

# é€‚åˆè¯·æ±‚å¤„ç†æ—¶é—´å·®å¼‚è¾ƒå¤§çš„åœºæ™¯
```

### 5. é€šç”¨å“ˆå¸Œ (Generic Hash)

```nginx
upstream backend {
    hash $request_uri consistent;  # æ ¹æ®è¯·æ±‚ URI å“ˆå¸Œ

    server backend1.example.com:8080;
    server backend2.example.com:8080;
    server backend3.example.com:8080;
}

# åŒä¸€ä¸ª URI æ€»æ˜¯åˆ†é…åˆ°åŒä¸€ä¸ªåç«¯
# consistent å‚æ•°ä½¿ç”¨ä¸€è‡´æ€§å“ˆå¸Œ,æ·»åŠ /åˆ é™¤æœåŠ¡å™¨æ—¶å½±å“è¾ƒå°

# ä¹Ÿå¯ä»¥æ ¹æ®å…¶ä»–å˜é‡å“ˆå¸Œ
hash $remote_addr;          # æ ¹æ®å®¢æˆ·ç«¯ IP
hash $cookie_sessionid;     # æ ¹æ® Cookie
hash $arg_user;             # æ ¹æ® URL å‚æ•°
```

### 6. éšæœº (Random)

```nginx
upstream backend {
    random;  # éšæœºé€‰æ‹©

    server backend1.example.com:8080;
    server backend2.example.com:8080;
    server backend3.example.com:8080;
}

# éšæœºé€‰æ‹©,é…åˆæƒé‡ä½¿ç”¨
upstream backend {
    random two=on;  # é€‰æ‹©è´Ÿè½½æœ€ä½çš„ä¸¤ä¸ª,å†éšæœºé€‰æ‹©ä¸€ä¸ª

    server backend1.example.com:8080 weight=3;
    server backend2.example.com:8080 weight=2;
    server backend3.example.com:8080 weight=1;
}
```

---

## å¥åº·æ£€æŸ¥

### è¢«åŠ¨å¥åº·æ£€æŸ¥

```nginx
upstream backend {
    # max_fails: æœ€å¤§å¤±è´¥æ¬¡æ•°
    # fail_timeout: å¤±è´¥è¶…æ—¶æ—¶é—´
    server backend1.example.com:8080 max_fails=3 fail_timeout=30s;
    server backend2.example.com:8080 max_fails=3 fail_timeout=30s;
    server backend3.example.com:8080 max_fails=3 fail_timeout=30s;
}

server {
    location / {
        proxy_pass http://backend;

        # åœ¨å“ªäº›æƒ…å†µä¸‹è®¤ä¸ºå¤±è´¥
        proxy_next_upstream error timeout http_500 http_502 http_503 http_504;

        # é‡è¯•æ¬¡æ•°
        proxy_next_upstream_tries 3;

        # é‡è¯•è¶…æ—¶
        proxy_next_upstream_timeout 10s;
    }
}
```

### ä¸»åŠ¨å¥åº·æ£€æŸ¥ï¼ˆéœ€è¦ nginx-plusï¼‰

```nginx
upstream backend {
    zone backend 64k;

    server backend1.example.com:8080;
    server backend2.example.com:8080;
    server backend3.example.com:8080;

    # ä¸»åŠ¨å¥åº·æ£€æŸ¥
    health_check;
}
```

### ä½¿ç”¨ç¬¬ä¸‰æ–¹æ¨¡å—ï¼ˆnginx_upstream_check_moduleï¼‰

```nginx
upstream backend {
    server backend1.example.com:8080;
    server backend2.example.com:8080;
    server backend3.example.com:8080;

    # ä¸»åŠ¨å¥åº·æ£€æŸ¥
    check interval=3000 rise=2 fall=3 timeout=1000 type=http;
    check_http_send "GET /health HTTP/1.0\r\n\r\n";
    check_http_expect_alive http_2xx http_3xx;
}
```

### å¥åº·æ£€æŸ¥é…ç½®è¯´æ˜

| å‚æ•° | è¯´æ˜ | æ¨èå€¼ |
|------|------|--------|
| `max_fails` | æœ€å¤§å¤±è´¥æ¬¡æ•° | 3 |
| `fail_timeout` | å¤±è´¥è¶…æ—¶æ—¶é—´ | 30s |
| `backup` | æ ‡è®°ä¸ºå¤‡ç”¨æœåŠ¡å™¨ | - |
| `down` | æ ‡è®°ä¸ºä¸å¯ç”¨ | - |
| `max_conns` | æœ€å¤§è¿æ¥æ•° | æ ¹æ®åç«¯èƒ½åŠ› |
| `slow_start` | æ…¢å¯åŠ¨æ—¶é—´ | 30s |

---

## ä¼šè¯ä¿æŒ

### IP å“ˆå¸Œä¼šè¯ä¿æŒ

```nginx
upstream backend {
    ip_hash;  # æ ¹æ® IP å“ˆå¸Œ,åŒä¸€ IP è®¿é—®åŒä¸€åç«¯

    server backend1.example.com:8080;
    server backend2.example.com:8080;
    server backend3.example.com:8080;
}
```

### Cookie ä¼šè¯ä¿æŒï¼ˆéœ€è¦ç¬¬ä¸‰æ–¹æ¨¡å—ï¼‰

```nginx
upstream backend {
    server backend1.example.com:8080;
    server backend2.example.com:8080;
    server backend3.example.com:8080;

    # æ ¹æ® Cookie ç²˜æ€§
    sticky cookie srv_id expires=1h domain=.example.com path=/;
}
```

### é€šç”¨å“ˆå¸Œä¼šè¯ä¿æŒ

```nginx
upstream backend {
    hash $cookie_sessionid consistent;  # æ ¹æ® sessionid Cookie

    server backend1.example.com:8080;
    server backend2.example.com:8080;
    server backend3.example.com:8080;
}

# å…¶ä»–å“ˆå¸Œæ–¹å¼
hash $remote_addr;          # æ ¹æ® IP
hash $arg_userid;           # æ ¹æ® URL å‚æ•°
hash $http_authorization;   # æ ¹æ®è®¤è¯ä¿¡æ¯
```

### åº”ç”¨å±‚ä¼šè¯ä¿æŒ

```nginx
upstream backend {
    server backend1.example.com:8080;
    server backend2.example.com:8080;
    server backend3.example.com:8080;
}

map $cookie_backend $backend_name {
    default backend;
    backend1.example.com:8080 backend1;
    backend2.example.com:8080 backend2;
    backend3.example.com:8080 backend3;
}

server {
    location / {
        # å¦‚æœæœ‰åç«¯ cookie,ä½¿ç”¨æŒ‡å®šçš„åç«¯
        if ($cookie_backend) {
            proxy_pass http://$cookie_backend;
            break;
        }

        # å¦åˆ™è´Ÿè½½å‡è¡¡
        proxy_pass http://backend;

        # è®¾ç½®åç«¯ cookie
        add_header Set-Cookie "backend=$upstream_addr; Path=/; Max-Age=3600";
    }
}
```

---

## é«˜çº§é…ç½®

### åŠ¨æ€é…ç½®åç«¯

```nginx
# ä½¿ç”¨å˜é‡ä½œä¸ºåç«¯
upstream backend {
    server backend1.example.com:8080;
    server backend2.example.com:8080;
    server backend3.example.com:8080;
}

upstream backend_backup {
    server backup1.example.com:8080;
    server backup2.example.com:8080;
}

map $http_authorization $backend_pool {
    default "backend";
    ~*premium "backend_premium";
    ~*free    "backend_free";
}

server {
    location / {
        proxy_pass http://$backend_pool;
    }
}
```

### æ ¹æ®åœ°ç†ä½ç½®è´Ÿè½½å‡è¡¡

```nginx
# éœ€è¦ GeoIP æ¨¡å—
geo $backend_pool {
    default "backend_us";
    192.168.1.0/24 "backend_local";
    10.0.0.0/8     "backend_internal";
    CN             "backend_cn";
    JP             "backend_jp";
    EU             "backend_eu";
}

upstream backend_us { server us1.example.com:8080; }
upstream backend_local { server local1.example.com:8080; }
upstream backend_internal { server internal1.example.com:8080; }
upstream backend_cn { server cn1.example.com:8080; }
upstream backend_jp { server jp1.example.com:8080; }
upstream backend_eu { server eu1.example.com:8080; }

server {
    location / {
        proxy_pass http://$backend_pool;
    }
}
```

### åŸºäºå“åº”æ—¶é—´çš„åŠ¨æ€è´Ÿè½½å‡è¡¡

```nginx
upstream backend {
    server backend1.example.com:8080 max_fails=3 fail_timeout=30s;
    server backend2.example.com:8080 max_fails=3 fail_timeout=30s;
    server backend3.example.com:8080 max_fails=3 fail_timeout=30s;

    # ä½¿ç”¨æœ€å°‘æ—¶é—´ç®—æ³•ï¼ˆnginx-plusï¼‰
    least_time header;
    # least_time last_byte;  # æˆ–è€…æ ¹æ®æœ€åå­—èŠ‚æ—¶é—´
}
```

### ç†”æ–­æœºåˆ¶

```nginx
upstream backend {
    server backend1.example.com:8080 max_fails=3 fail_timeout=30s;
    server backend2.example.com:8080 max_fails=3 fail_timeout=30s;
    server backend3.example.com:8080 max_fails=3 fail_timeout=30s;
}

server {
    location / {
        proxy_pass http://backend;

        # ç†”æ–­é…ç½®
        proxy_next_upstream error timeout http_500 http_502 http_503 http_504;
        proxy_next_upstream_tries 3;
        proxy_next_upstream_timeout 5s;

        # å¦‚æœæ‰€æœ‰åç«¯éƒ½å¤±è´¥,è¿”å›é”™è¯¯
        error_page 500 502 503 504 /error.html;
    }
}
```

### ç°åº¦å‘å¸ƒ

```nginx
upstream backend_old {
    server backend-old1.example.com:8080;
    server backend-old2.example.com:8080;
}

upstream backend_new {
    server backend-new1.example.com:8080;
    server backend-new2.example.com:8080;
}

# ç°åº¦è§„åˆ™
map $cookie_gray $backend_pool {
    default "backend_old";
    "new"   "backend_new";
    "old"   "backend_old";
}

map $remote_addr $backend_ip {
    default "backend_old";
    ~^192\.168\.1\.[0-5]$ "backend_new";  # ç‰¹å®š IP æ®µä½¿ç”¨æ–°ç‰ˆæœ¬
}

server {
    location / {
        # ä¼˜å…ˆä½¿ç”¨ Cookie è§„åˆ™,å…¶æ¬¡ä½¿ç”¨ IP è§„åˆ™
        set $final_backend $backend_pool;
        if ($final_backend = "backend_old") {
            set $final_backend $backend_ip;
        }

        proxy_pass http://$final_backend;

        # è®¾ç½®ç°åº¦ Cookie
        add_header Set-Cookie "gray=$cookie_gray; Path=/; Max-Age=86400";
    }
}
```

---

## æ€§èƒ½ä¼˜åŒ–

### é•¿è¿æ¥ä¼˜åŒ–

```nginx
upstream backend {
    server backend1.example.com:8080 max_fails=3 fail_timeout=30s;
    server backend2.example.com:8080 max_fails=3 fail_timeout=30s;

    keepalive 32;              # æ¯ä¸ª worker çš„é•¿è¿æ¥æ•°
    keepalive_timeout 60s;     # é•¿è¿æ¥è¶…æ—¶
    keepalive_requests 100;    # æ¯ä¸ªé•¿è¿æ¥æœ€å¤§è¯·æ±‚æ•°
}

server {
    location / {
        proxy_pass http://backend;

        # HTTP 1.1 å’Œé•¿è¿æ¥
        proxy_http_version 1.1;
        proxy_set_header Connection "";

        # é•¿è¿æ¥è¶…æ—¶
        proxy_connect_timeout 5s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
}
```

### ç¼“å†²åŒºä¼˜åŒ–

```nginx
server {
    location / {
        proxy_pass http://backend;

        # å“åº”ç¼“å†²
        proxy_buffering on;
        proxy_buffers 16 4k;      # å¢åŠ ç¼“å†²åŒºæ•°é‡
        proxy_buffer_size 8k;     # å¢åŠ ç¼“å†²åŒºå¤§å°
        proxy_busy_buffers_size 16k;

        # è¯·æ±‚ç¼“å†²
        client_body_buffer_size 128k;
        proxy_request_buffering on;
    }
}
```

### è¶…æ—¶ä¼˜åŒ–

```nginx
server {
    location / {
        proxy_pass http://backend;

        # è¿æ¥è¶…æ—¶
        proxy_connect_timeout 3s;   # çŸ­è¿æ¥è¶…æ—¶
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # åç«¯å¤±è´¥é‡è¯•
        proxy_next_upstream error timeout http_500 http_502 http_503 http_504;
        proxy_next_upstream_tries 3;
        proxy_next_upstream_timeout 10s;
    }
}
```

### ä¸Šæ¸¸æœåŠ¡å™¨é…ç½®ä¼˜åŒ–

```nginx
upstream backend {
    server backend1.example.com:8080
        max_fails=3              # æœ€å¤§å¤±è´¥æ¬¡æ•°
        fail_timeout=30s         # å¤±è´¥è¶…æ—¶æ—¶é—´
        max_conns=100            # æœ€å¤§è¿æ¥æ•°
        slow_start=30s;          # æ…¢å¯åŠ¨æ—¶é—´ï¼ˆé€æ¸æ¢å¤æµé‡ï¼‰

    server backend2.example.com:8080
        max_fails=3
        fail_timeout=30s
        max_conns=100
        slow_start=30s;

    keepalive 32;
    keepalive_timeout 60s;
    keepalive_requests 100;
}
```

---

## ğŸ”§ ç›‘æ§å’Œè°ƒè¯•

### ç›‘æ§è´Ÿè½½å‡è¡¡çŠ¶æ€

```nginx
server {
    listen 80;
    server_name example.com;

    location / {
        proxy_pass http://backend;

        # æ·»åŠ åç«¯ä¿¡æ¯åˆ°å“åº”å¤´ï¼ˆè°ƒè¯•ç”¨ï¼‰
        add_header X-Upstream $upstream_addr always;
        add_header X-Upstream-Status $upstream_status always;
        add_header X-Upstream-Response-Time $upstream_response_time always;
    }

    # çŠ¶æ€ç›‘æ§
    location /upstream_status {
        # éœ€è¦ nginx-plus æˆ–ç¬¬ä¸‰æ–¹æ¨¡å—
        upstream_status;
        access_log off;
    }
}
```

### æ—¥å¿—è®°å½•

```nginx
# è‡ªå®šä¹‰æ—¥å¿—æ ¼å¼ï¼ŒåŒ…å«è´Ÿè½½å‡è¡¡ä¿¡æ¯
log_format upstream_log '$remote_addr - $remote_user [$time_local] '
                       '"$request" $status $body_bytes_sent '
                       '"$http_referer" "$http_user_agent" '
                       'rt=$request_time uct="$upstream_connect_time" '
                       'uht="$upstream_header_time" urt="$upstream_response_time" '
                       'addr="$upstream_addr" status="$upstream_status"';

access_log /var/log/nginx/upstream.log upstream_log;
```

---

## ğŸ“š ç›¸å…³é“¾æ¥

- [åå‘ä»£ç†](../03-æ ¸å¿ƒåŠŸèƒ½/åå‘ä»£ç†.md)
- [ä¸Šæ¸¸æœåŠ¡å™¨ç®¡ç†](../03-æ ¸å¿ƒåŠŸèƒ½/ä¸Šæ¸¸æœåŠ¡å™¨ç®¡ç†.md)
- [å¥åº·æ£€æŸ¥ä¸ç›‘æ§](../07-æ—¥å¿—ä¸ç›‘æ§/å¥åº·æ£€æŸ¥ä¸ç›‘æ§.md)
- [ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²](../08-éƒ¨ç½²å®è·µ/ç”Ÿäº§ç¯å¢ƒéƒ¨ç½².md)

---

**æ ‡ç­¾**: #nginx #è´Ÿè½½å‡è¡¡ #upstream #æ€§èƒ½ #é«˜å¯ç”¨
