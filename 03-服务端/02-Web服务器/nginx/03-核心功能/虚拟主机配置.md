# Nginx è™šæ‹Ÿä¸»æœºé…ç½®

> Nginx è™šæ‹Ÿä¸»æœºï¼ˆServer Blockï¼‰é…ç½®è¯¦è§£

---

## ğŸ“‹ ç›®å½•

- [è™šæ‹Ÿä¸»æœºåŸºç¡€](#è™šæ‹Ÿä¸»æœºåŸºç¡€)
- [åŸºäºåŸŸåçš„è™šæ‹Ÿä¸»æœº](#åŸºäºåŸŸåçš„è™šæ‹Ÿä¸»æœº)
- [åŸºäºç«¯å£çš„è™šæ‹Ÿä¸»æœº](#åŸºäºç«¯å£çš„è™šæ‹Ÿä¸»æœº)
- [åŸºäº IP çš„è™šæ‹Ÿä¸»æœº](#åŸºäº-ip-çš„è™šæ‹Ÿä¸»æœº)
- [é»˜è®¤è™šæ‹Ÿä¸»æœº](#é»˜è®¤è™šæ‹Ÿä¸»æœº)
- [è™šæ‹Ÿä¸»æœºæœ€ä½³å®è·µ](#è™šæ‹Ÿä¸»æœºæœ€ä½³å®è·µ)

---

## è™šæ‹Ÿä¸»æœºåŸºç¡€

### ä»€ä¹ˆæ˜¯è™šæ‹Ÿä¸»æœº

è™šæ‹Ÿä¸»æœºå…è®¸åœ¨åŒä¸€å°æœåŠ¡å™¨ä¸Šè¿è¡Œå¤šä¸ªç½‘ç«™,å…±äº«æœåŠ¡å™¨èµ„æºã€‚

```
æœåŠ¡å™¨ IP: 192.168.1.100
    â”œâ”€ ç½‘ç«™ 1: www.example1.com
    â”œâ”€ ç½‘ç«™ 2: www.example2.com
    â””â”€ ç½‘ç«™ 3: www.example3.com
```

### Nginx è™šæ‹Ÿä¸»æœºç±»å‹

1. **åŸºäºåŸŸåçš„è™šæ‹Ÿä¸»æœº** - æœ€å¸¸ç”¨çš„æ–¹å¼
2. **åŸºäºç«¯å£çš„è™šæ‹Ÿä¸»æœº** - ä¸åŒç«¯å£
3. **åŸºäº IP çš„è™šæ‹Ÿä¸»æœº** - ä¸åŒ IP åœ°å€

---

## åŸºäºåŸŸåçš„è™šæ‹Ÿä¸»æœº

### åŸºæœ¬é…ç½®

```nginx
# è™šæ‹Ÿä¸»æœº 1
server {
    listen 80;
    server_name www.example1.com example1.com;

    root /var/www/example1;
    index index.html index.htm;

    location / {
        try_files $uri $uri/ =404;
    }
}

# è™šæ‹Ÿä¸»æœº 2
server {
    listen 80;
    server_name www.example2.com example2.com;

    root /var/www/example2;
    index index.html index.htm;

    location / {
        try_files $uri $uri/ =404;
    }
}
```

### é€šé…ç¬¦åŸŸå

```nginx
# åŒ¹é…æ‰€æœ‰å­åŸŸå
server {
    listen 80;
    server_name *.example.com;

    root /var/www/example;
    index index.html;

    location / {
        try_files $uri $uri/ =404;
    }
}

# åŒ¹é…æ‰€æœ‰ä»¥ example å¼€å¤´çš„åŸŸå
server {
    listen 80;
    server_name example.*;

    # ...
}
```

### æ­£åˆ™è¡¨è¾¾å¼åŸŸå

```nginx
# ä½¿ç”¨æ­£åˆ™åŒ¹é…åŸŸå
server {
    listen 80;
    server_name ~^www\.example\.com$;

    # ...
}

# æ•è·åŸŸåéƒ¨åˆ†
server {
    listen 80;
    server_name ~^(www\.)?(?<domain>.+)$;

    root /var/www/$domain;
    index index.html;
}
```

### å¤šåŸŸåå…±äº«é…ç½®

```nginx
server {
    listen 80;
    server_name example1.com www.example1.com
                example2.com www.example2.com
                example3.com www.example3.com;

    root /var/www/shared;
    index index.html;
}
```

---

## åŸºäºç«¯å£çš„è™šæ‹Ÿä¸»æœº

### ä¸åŒç«¯å£ä¸åŒç½‘ç«™

```nginx
# HTTP ç½‘ç«™
server {
    listen 80;
    server_name example.com;

    root /var/www/http;
    index index.html;
}

# HTTPS ç½‘ç«™
server {
    listen 443 ssl;
    server_name example.com;

    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;

    root /var/www/https;
    index index.html;
}

# ç®¡ç†åå°
server {
    listen 8080;
    server_name example.com;

    root /var/www/admin;
    index index.html;

    # è®¿é—®æ§åˆ¶
    allow 192.168.1.0/24;
    deny all;
}
```

### åŒä¸€åŸŸåä¸åŒç«¯å£

```nginx
# ç½‘ç«™ç«¯å£
server {
    listen 80;
    listen 8080;
    server_name example.com;

    root /var/www/website;
    index index.html;
}

# API ç«¯å£
server {
    listen 9000;
    server_name example.com;

    root /var/www/api;
    index index.php;

    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    location ~ \.php$ {
        fastcgi_pass unix:/var/run/php/php7.4-fpm.sock;
        fastcgi_index index.php;
        include fastcgi_params;
    }
}
```

---

## åŸºäº IP çš„è™šæ‹Ÿä¸»æœº

### ä¸åŒ IP ä¸åŒç½‘ç«™

```nginx
# ç›‘å¬æ‰€æœ‰ IP çš„ 80 ç«¯å£
server {
    listen 80;
    server_name example.com;

    root /var/www/example;
    index index.html;
}

# ç›‘å¬ç‰¹å®š IP çš„ 80 ç«¯å£
server {
    listen 192.168.1.100:80;
    server_name example.com;

    root /var/www/example-ip1;
    index index.html;
}

# ç›‘å¬å¦ä¸€ä¸ª IP çš„ 80 ç«¯å£
server {
    listen 192.168.1.101:80;
    server_name example.com;

    root /var/www/example-ip2;
    index index.html;
}
```

### IPv6 è™šæ‹Ÿä¸»æœº

```nginx
server {
    listen 80;
    listen [::]:80 ipv6only=on;  # IPv6
    server_name example.com;

    root /var/www/example;
    index index.html;
}
```

---

## é»˜è®¤è™šæ‹Ÿä¸»æœº

### é…ç½®é»˜è®¤è™šæ‹Ÿä¸»æœº

```nginx
# é»˜è®¤è™šæ‹Ÿä¸»æœºï¼ˆæ•è·æ‰€æœ‰æœªåŒ¹é…çš„åŸŸåï¼‰
server {
    listen 80 default_server;  # default_server æ ‡è®°
    listen [::]:80 default_server;

    server_name _;  # æ— æ•ˆçš„åŸŸåï¼Œè¡¨ç¤ºåŒ¹é…æ‰€æœ‰

    root /var/www/default;
    index index.html;

    return 404;  # æˆ–è€…é‡å®šå‘åˆ°ä¸»é¡µ
}
```

### æ‹’ç»æœªåŒ¹é…çš„åŸŸå

```nginx
# é»˜è®¤è™šæ‹Ÿä¸»æœº - æ‹’ç»è®¿é—®
server {
    listen 80 default_server;
    listen [::]:80 default_server;

    server_name _;

    # è¿”å› 444ï¼ˆNginx ç‰¹æ®ŠçŠ¶æ€ç ï¼Œç«‹å³å…³é—­è¿æ¥ï¼‰
    return 444;
}

# æˆ–è€…è¿”å› 404
server {
    listen 80 default_server;
    server_name _;

    return 404;
}

# æˆ–è€…é‡å®šå‘åˆ°ä¸»ç«™
server {
    listen 80 default_server;
    server_name _;

    return 301 http://www.example.com$request_uri;
}
```

---

## è™šæ‹Ÿä¸»æœºæœ€ä½³å®è·µ

### åˆ†ç¦»é…ç½®æ–‡ä»¶

```bash
# åˆ›å»ºç›®å½•ç»“æ„
/etc/nginx/
â”œâ”€â”€ nginx.conf                    # ä¸»é…ç½®æ–‡ä»¶
â”œâ”€â”€ sites-available/              # å¯ç”¨ç«™ç‚¹é…ç½®
â”‚   â”œâ”€â”€ example1.com
â”‚   â”œâ”€â”€ example2.com
â”‚   â””â”€â”€ default
â””â”€â”€ sites-enabled/                # å¯ç”¨ç«™ç‚¹é…ç½®
    â”œâ”€â”€ example1.com -> ../sites-available/example1.com
    â””â”€â”€ example2.com -> ../sites-available/example2.com
```

### Include æ–¹å¼

```nginx
# nginx.conf
http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # åŸºç¡€é…ç½®
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;

    # è™šæ‹Ÿä¸»æœºé…ç½®
    include /etc/nginx/sites-enabled/*;
}
```

### ç¤ºä¾‹ç«™ç‚¹é…ç½®

```nginx
# /etc/nginx/sites-available/example.com
server {
    listen 80;
    server_name example.com www.example.com;

    root /var/www/example.com;
    index index.html index.htm;

    # è®¿é—®æ—¥å¿—
    access_log /var/log/nginx/example.com.access.log main;
    error_log /var/log/nginx/example.com.error.log warn;

    # å­—ç¬¦ç¼–ç 
    charset utf-8;

    # Gzip å‹ç¼©
    gzip on;
    gzip_types text/plain text/css application/json application/javascript;

    location / {
        try_files $uri $uri/ =404;
    }

    # é™æ€æ–‡ä»¶ç¼“å­˜
    location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # éšè—æ–‡ä»¶
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    # é”™è¯¯é¡µé¢
    error_page 404 /404.html;
    error_page 500 502 503 504 /50x.html;

    location = /50x.html {
        root /usr/share/nginx/html;
    }
}

# å¯ç”¨ç«™ç‚¹
# sudo ln -s /etc/nginx/sites-available/example.com /etc/nginx/sites-enabled/
```

### HTTPS è™šæ‹Ÿä¸»æœº

```nginx
# HTTP é‡å®šå‘åˆ° HTTPS
server {
    listen 80;
    server_name example.com www.example.com;

    # é‡å®šå‘åˆ° HTTPS
    return 301 https://$server_name$request_uri;
}

# HTTPS è™šæ‹Ÿä¸»æœº
server {
    listen 443 ssl http2;
    server_name example.com www.example.com;

    root /var/www/example.com;
    index index.html;

    # SSL é…ç½®
    ssl_certificate /etc/ssl/certs/example.com.crt;
    ssl_certificate_key /etc/ssl/private/example.com.key;

    # SSL ä¼˜åŒ–
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512;
    ssl_prefer_server_ciphers off;

    # SSL ä¼šè¯ç¼“å­˜
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    location / {
        try_files $uri $uri/ =404;
    }
}
```

### æ³›åŸŸåé…ç½®

```nginx
# æ³›åŸŸåè™šæ‹Ÿä¸»æœº
server {
    listen 80;
    server_name *.example.com;

    # æå–å­åŸŸå
    if ($host ~* ^(.+)\.example\.com$) {
        set $subdomain $1;
    }

    root /var/www/$subdomain;
    index index.html;

    location / {
        try_files $uri $uri/ =404;
    }
}

# æˆ–è€…ä½¿ç”¨æ­£åˆ™
server {
    listen 80;
    server_name ~^(?<subdomain>.+)\.example\.com$;

    root /var/www/$subdomain;
    index index.html;

    location / {
        try_files $uri $uri/ =404;
    }
}
```

### å¤šåŸŸåå…±äº«é…ç½®

```nginx
# å…±äº«é…ç½®çš„è™šæ‹Ÿä¸»æœº
server {
    listen 80;
    server_name
        example1.com www.example1.com
        example2.com www.example2.com
        example3.com www.example3.com;

    root /var/www/shared;
    index index.html;

    location / {
        try_files $uri $uri/ =404;
    }
}
```

### å¼€å‘ç¯å¢ƒè™šæ‹Ÿä¸»æœº

```nginx
# å¼€å‘ç¯å¢ƒé…ç½®
server {
    listen 80;
    server_name dev.example.com;

    root /var/www/dev;
    index index.html;

    # å¼€å‘ç¯å¢ƒé…ç½®
    error_log /var/log/nginx/dev.error.log debug;
    access_log /var/log/nginx/dev.access.log;

    # ç¦ç”¨ç¼“å­˜
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    add_header Pragma "no-cache";
    add_header Expires "0";

    location / {
        try_files $uri $uri/ =404;
    }

    # API ä»£ç†åˆ°å¼€å‘æœåŠ¡å™¨
    location /api/ {
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # WebSocket ä»£ç†
    location /ws/ {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
```

---

## ğŸ”§ é«˜çº§æŠ€å·§

### åŠ¨æ€è™šæ‹Ÿä¸»æœº

```nginx
# æ ¹æ®åŸŸåè‡ªåŠ¨é€‰æ‹©ç›®å½•
server {
    listen 80;
    server_name ~^(www\.)?(?<domain>.+)$;

    root /var/www/$domain;
    index index.html;

    location / {
        try_files $uri $uri/ =404;
    }
}
```

### è™šæ‹Ÿä¸»æœºæ¨¡æ¿

```nginx
# ä½¿ç”¨ map é…ç½®ä¸åŒå‚æ•°
map $host $root_path {
    default /var/www/default;
    example1.com /var/www/example1;
    example2.com /var/www/example2;
    ~*\.example\.com /var/www/example;
}

server {
    listen 80;
    server_name _;

    root $root_path;
    index index.html;

    location / {
        try_files $uri $uri/ =404;
    }
}
```

### æµé‡åˆ†å‘

```nginx
# æ ¹æ®æ¥æºåˆ†é…ä¸åŒåç«¯
map $http_referer $backend {
    default backend_main;
    ~*google\.com backend_google;
    ~*baidu\.com backend_baidu;
    ~*wechat backend_wechat;
}

upstream backend_main { server 127.0.0.1:8000; }
upstream backend_google { server 127.0.0.1:8001; }
upstream backend_baidu { server 127.0.0.1:8002; }
upstream backend_wechat { server 127.0.0.1:8003; }

server {
    listen 80;
    server_name example.com;

    location / {
        proxy_pass http://$backend;
    }
}
```

---

## ğŸ“š ç›¸å…³é“¾æ¥

- [é…ç½®æ–‡ä»¶ç»“æ„](../02-é…ç½®ç®¡ç†/é…ç½®æ–‡ä»¶ç»“æ„.md)
- [Location åŒ¹é…è§„åˆ™](./Location-åŒ¹é…è§„åˆ™.md)
- [SSL/TLS é…ç½®](../04-é«˜çº§åŠŸèƒ½/SSL-TLS-é…ç½®.md)
- [ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²](../08-éƒ¨ç½²å®è·µ/ç”Ÿäº§ç¯å¢ƒéƒ¨ç½².md)

---

**æ ‡ç­¾**: #nginx #è™šæ‹Ÿä¸»æœº #server #é…ç½® #éƒ¨ç½²
