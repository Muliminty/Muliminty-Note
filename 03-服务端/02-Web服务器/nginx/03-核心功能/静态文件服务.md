# Nginx é™æ€æ–‡ä»¶æœåŠ¡

> Nginx é™æ€æ–‡ä»¶æœåŠ¡é…ç½®å’Œä¼˜åŒ–

---

## ğŸ“‹ ç›®å½•

- [åŸºç¡€é…ç½®](#åŸºç¡€é…ç½®)
- [æ–‡ä»¶ç±»å‹å¤„ç†](#æ–‡ä»¶ç±»å‹å¤„ç†)
- [ç›®å½•æµè§ˆ](#ç›®å½•æµè§ˆ)
- [ç¼“å­˜æ§åˆ¶](#ç¼“å­˜æ§åˆ¶)
- [èŒƒå›´è¯·æ±‚](#èŒƒå›´è¯·æ±‚)
- [æ–‡ä»¶å‹ç¼©](#æ–‡ä»¶å‹ç¼©)
- [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)

---

## åŸºç¡€é…ç½®

### æœ€ç®€å•çš„é™æ€æ–‡ä»¶æœåŠ¡

```nginx
server {
    listen 80;
    server_name static.example.com;

    root /var/www/static;
    index index.html index.htm;

    location / {
        try_files $uri $uri/ =404;
    }
}
```

### å¤šç›®å½•é™æ€æ–‡ä»¶æœåŠ¡

```nginx
server {
    listen 80;
    server_name assets.example.com;

    # é™æ€èµ„æºç›®å½•
    location /images/ {
        root /var/www/assets;
        try_files $uri $uri/ =404;
    }

    location /css/ {
        root /var/www/assets;
        try_files $uri $uri/ =404;
    }

    location /js/ {
        root /var/www/assets;
        try_files $uri $uri/ =404;
    }

    location /fonts/ {
        root /var/www/assets;
        try_files $uri $uri/ =404;
    }
}
```

### ä½¿ç”¨åˆ«å (Alias)

```nginx
server {
    listen 80;
    server_name assets.example.com;

    # Alias æ–¹å¼
    location /images/ {
        alias /var/www/static/images/;  # æ³¨æ„æœ€åçš„æ–œæ 
    }

    # å¤šä¸ªç›®å½•åˆå¹¶
    location /assets/ {
        alias /var/www/static/;  # /assets/logo.png â†’ /var/www/static/logo.png
    }
}
```

**Root vs Alias**:

```nginx
# Root æ–¹å¼
location /images/ {
    root /var/www/static;  # /images/logo.png â†’ /var/www/static/images/logo.png
}

# Alias æ–¹å¼
location /images/ {
    alias /var/www/static/images/;  # /images/logo.png â†’ /var/www/static/images/logo.png
}
```

---

## æ–‡ä»¶ç±»å‹å¤„ç†

### MIME ç±»å‹é…ç½®

```nginx
http {
    include mime.types;  # åŒ…å« MIME ç±»å‹å®šä¹‰
    default_type application/octet-stream;  # é»˜è®¤ç±»å‹

    # è‡ªå®šä¹‰ MIME ç±»å‹
    types {
        text/html                             html htm shtml;
        text/css                              css;
        text/xml                              xml rss;
        image/gif                             gif;
        image/jpeg                            jpeg jpg;
        application/javascript                js;
        application/json                      json map;
        font/woff2                            woff2;
        font/woff                             woff;
        font/ttf                              ttf;
        font/otf                              otf;
        font/eot                              eot;
        image/svg+xml                         svg svgz;
        image/x-icon                          ico;
    }
}
```

### é»˜è®¤æ–‡ä»¶ (Index)

```nginx
server {
    listen 80;
    server_name example.com;

    root /var/www/html;

    # é»˜è®¤é¦–é¡µ
    index index.html index.htm index.php;

    location / {
        try_files $uri $uri/ @index;
    }

    location @index {
        rewrite ^ /index.html break;
    }
}
```

### é»˜è®¤æ–‡æ¡£å¤„ç†

```nginx
server {
    root /var/www/html;

    # æ–¹å¼ 1: ä½¿ç”¨ try_files
    location / {
        try_files $uri $uri/ /index.html;
    }

    # æ–¹å¼ 2: ä½¿ç”¨ error_page
    location / {
        try_files $uri $uri/ =404;
        error_page 404 /index.html;
    }

    # æ–¹å¼ 3: ä½¿ç”¨ rewrite (SPA åº”ç”¨)
    location / {
        try_files $uri $uri/ @spa;
    }

    location @spa {
        rewrite ^ /index.html break;
    }
}
```

---

## ç›®å½•æµè§ˆ

### å¯ç”¨ç›®å½•æµè§ˆ

```nginx
server {
    listen 80;
    server_name files.example.com;

    root /var/www/files;

    location / {
        autoindex on;                          # å¯ç”¨ç›®å½•æµè§ˆ
        autoindex_exact_size off;              # äººæ€§åŒ–æ˜¾ç¤ºæ–‡ä»¶å¤§å°
        autoindex_localtime on;                # æ˜¾ç¤ºæœ¬åœ°æ—¶é—´
        autoindex_format html;                 # HTML æ ¼å¼
    }
}
```

### ç›®å½•æµè§ˆç¾åŒ–

```nginx
server {
    listen 80;
    server_name files.example.com;

    root /var/www/files;

    location / {
        autoindex on;
        autoindex_exact_size off;
        autoindex_localtime on;

        # æ·»åŠ å¤´éƒ¨ä¿¡æ¯
        add_header X-Frame-Options "SAMEORIGIN" always;

        # éšè—ç‰¹å®šæ–‡ä»¶
        location ~ /\. {
            deny all;
        }

        location ~ \.tmp$ {
            deny all;
        }
    }
}
```

### FancyIndex ç¾åŒ–ï¼ˆéœ€è¦ç¬¬ä¸‰æ–¹æ¨¡å—ï¼‰

```nginx
server {
    listen 80;
    server_name files.example.com;

    root /var/www/files;

    location / {
        fancyindex on;                          # å¯ç”¨ FancyIndex
        fancyindex_exact_size off;              # äººæ€§åŒ–å¤§å°
        fancyindex_localtime on;                # æœ¬åœ°æ—¶é—´
        fancyindex_name_length 255;             # æ–‡ä»¶åé•¿åº¦
        fancyindex_header /fancyindex/header.html;
        fancyindex_footer /fancyindex/footer.html;
        fancyindex_css_href /fancyindex/style.css;
    }
}
```

---

## ç¼“å­˜æ§åˆ¶

### åŸºç¡€ç¼“å­˜é…ç½®

```nginx
server {
    listen 80;
    server_name static.example.com;

    root /var/www/static;

    # æ ¹æ®æ–‡ä»¶ç±»å‹è®¾ç½®ç¼“å­˜
    location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
        expires 1y;                          # ç¼“å­˜ 1 å¹´
        add_header Cache-Control "public, immutable";
    }

    location ~* \.(woff|woff2|ttf|otf|eot|svg)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # HTML æ–‡ä»¶ç¼“å­˜è¾ƒçŸ­æ—¶é—´
    location ~* \.html$ {
        expires 1h;
        add_header Cache-Control "public, must-revalidate";
    }
}
```

### åŠ¨æ€ç¼“å­˜æ§åˆ¶

```nginx
server {
    root /var/www/static;

    # ä½¿ç”¨ map è®¾ç½®ç¼“å­˜æ—¶é—´
    map $request_uri $cache_time {
        default 0;                           # ä¸ç¼“å­˜
        ~^/static/ 1y;                       # é™æ€èµ„æºç¼“å­˜ 1 å¹´
        ~*\.(jpg|jpeg|png|gif|css|js)$ 1y;  # å›¾ç‰‡å’Œæ ·å¼ç¼“å­˜ 1 å¹´
        ~*\.html$ 1h;                        # HTML ç¼“å­˜ 1 å°æ—¶
    }

    location / {
        expires $cache_time;
        try_files $uri $uri/ =404;
    }
}
```

### æµè§ˆå™¨ç¼“å­˜æ§åˆ¶

```nginx
server {
    root /var/www/static;

    # ç‰ˆæœ¬åŒ–æ–‡ä»¶ï¼ˆå¸¦ç‰ˆæœ¬å·ï¼‰
    location ~* \.v\d+\.(js|css)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # ä¸ç¼“å­˜çš„æ–‡ä»¶
    location ~* \.nocache\.(js|css)$ {
        expires -1;                          # ä¸ç¼“å­˜
        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";
    }

    # é€šç”¨é™æ€èµ„æº
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
```

### ç¼“å­˜æ¸…ç†

```nginx
# æ¸…ç†ç¼“å­˜æ¥å£ï¼ˆéœ€è¦ nginx-plus æˆ–ç¬¬ä¸‰æ–¹æ¨¡å—ï¼‰
server {
    listen 80;
    server_name static.example.com;

    location / {
        root /var/www/static;
        try_files $uri $uri/ =404;
    }

    # ç¼“å­˜æ¸…ç†æ¥å£
    location ~ /purge(/.*) {
        allow 127.0.0.1;          # åªå…è®¸æœ¬åœ°è®¿é—®
        allow 192.168.1.0/24;     # å…è®¸å†…ç½‘
        deny all;                 # æ‹’ç»å…¶ä»–

        proxy_cache_purge cache_one $1$is_args$args;
    }
}
```

---

## èŒƒå›´è¯·æ±‚

### å¯ç”¨èŒƒå›´è¯·æ±‚

```nginx
server {
    listen 80;
    server_name static.example.com;

    root /var/www/static;

    # é»˜è®¤å·²å¯ç”¨èŒƒå›´è¯·æ±‚
    location ~* \.(mp4|mp3|pdf)$ {
        # å¯¹äºå¤§æ–‡ä»¶ï¼Œå¯ç”¨å¼‚æ­¥ I/O
        aio on;
        directio 512k;

        # å¯ç”¨çº¿ç¨‹æ± ï¼ˆå¦‚æœç¼–è¯‘æ—¶åŒ…å«ï¼‰
        # thread_pool default threads=32 max_queue=65536;
        # aio threads=default;
    }
}
```

### è§†é¢‘æµåª’ä½“

```nginx
server {
    listen 80;
    server_name video.example.com;

    root /var/www/videos;

    # MP4 æµåª’ä½“
    location ~* \.mp4$ {
        mp4;                      # å¯ç”¨ MP4 æ¨¡å—
        mp4_buffer_size 1m;       # MP4 ç¼“å†²åŒºå¤§å°
        mp4_max_buffer_size 10m;  # MP4 æœ€å¤§ç¼“å†²åŒº
    }

    # FLV æµåª’ä½“
    location ~* \.flv$ {
        flv;                      # å¯ç”¨ FLV æ¨¡å—
    }

    # HLS æµåª’ä½“
    location /hls/ {
        types {
            application/vnd.apple.mpegurl m3u8;
            video/mp2t ts;
        }
        root /var/www/hls;
        add_header Cache-Control no-cache;
        add_header Access-Control-Allow-Origin *;
    }
}
```

---

## æ–‡ä»¶å‹ç¼©

### Gzip å‹ç¼©

```nginx
http {
    gzip on;                           # å¯ç”¨ Gzip
    gzip_vary on;                      # æ·»åŠ  Vary å¤´
    gzip_min_length 1024;              # æœ€å°å‹ç¼©å¤§å°
    gzip_comp_level 6;                 # å‹ç¼©çº§åˆ«ï¼ˆ1-9ï¼‰

    # å‹ç¼©ç±»å‹
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/javascript
        application/json
        application/xml+rss
        application/atom+xml
        image/svg+xml;

    # ç¦ç”¨ IE6 å‹ç¼©
    gzip_disable "msie6";

    # ä»£ç†è¯·æ±‚å‹ç¼©
    gzip_proxied any;

    # åˆ†ç‰‡å‹ç¼©ï¼ˆHTTP/1.1ï¼‰
    gzip_http_version 1.1;

    # ä½¿ç”¨ç£ç›˜ç¼“å­˜å‹ç¼©ç»“æœ
    # gzip_static on;  # éœ€è¦é¢„å‹ç¼©æ–‡ä»¶
}
```

### Brotli å‹ç¼©ï¼ˆéœ€è¦ç¬¬ä¸‰æ–¹æ¨¡å—ï¼‰

```nginx
http {
    # Brotli å‹ç¼©
    brotli on;
    brotli_comp_level 6;               # å‹ç¼©çº§åˆ«ï¼ˆ1-11ï¼‰
    brotli_min_length 100;             # æœ€å°å‹ç¼©å¤§å°

    # Brotli å‹ç¼©ç±»å‹
    brotli_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/javascript
        application/json
        application/xml+rss
        application/atom+xml
        image/svg+xml
        font/opentype
        font/ttf;

    # Brotli é™æ€æ–‡ä»¶
    brotli_static on;
}
```

### é¢„å‹ç¼©æ–‡ä»¶

```bash
# åˆ›å»ºé¢„å‹ç¼©æ–‡ä»¶
gzip -k -9 index.html  # ä¿ç•™åŸæ–‡ä»¶ï¼Œåˆ›å»º index.html.gz
brotli -k -q 11 index.html  # ä¿ç•™åŸæ–‡ä»¶ï¼Œåˆ›å»º index.html.br
```

```nginx
server {
    root /var/www/html;

    # è‡ªåŠ¨é€‰æ‹©æœ€ä½³å‹ç¼©æ ¼å¼
    location ~* \.(html|css|js|xml|json)$ {
        # ä¼˜å…ˆä½¿ç”¨ Brotli
        add_header Vary "Accept-Encoding";

        # Brotli é™æ€æ–‡ä»¶
        brotli_static on;
        brotli_types *;

        # Gzip é™æ€æ–‡ä»¶
        gzip_static on;
        gzip_types *;

        expires 1d;
    }
}
```

---

## æ€§èƒ½ä¼˜åŒ–

### æ–‡ä»¶ä¼ è¾“ä¼˜åŒ–

```nginx
http {
    # å¯ç”¨ sendfile
    sendfile on;

    # ä¼˜åŒ–åŒ…å‘é€
    tcp_nopush on;    # ä¸ sendfile ä¸€èµ·ä½¿ç”¨
    tcp_nodelay on;   # ç¦ç”¨ Nagle ç®—æ³•

    # æ–‡ä»¶ç¼“å†²åŒºå¤§å°
    output_buffers 1 32k;

    # å¼‚æ­¥ I/O
    aio on;
    directio 4m;      # å¤§äº 4M çš„æ–‡ä»¶ä½¿ç”¨ç›´æ¥ I/O

    # çº¿ç¨‹æ± ï¼ˆéœ€è¦ç¼–è¯‘æ—¶åŒ…å«ï¼‰
    # thread_pool default threads=32 max_queue=65536;
    # aio threads=default;
}
```

### ç¼“å­˜ä¼˜åŒ–

```nginx
http {
    # æ‰“å¼€æ–‡ä»¶ç¼“å­˜
    open_file_cache max=10000 inactive=30s;
    open_file_cache_valid 60s;
    open_file_cache_min_uses 2;
    open_file_cache_errors on;

    # æ–‡ä»¶æè¿°ç¬¦ç¼“å­˜
    open_file_cache max=65536 inactive=60s;
}

server {
    listen 80;
    server_name static.example.com;

    root /var/www/static;

    location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";

        # æ–‡ä»¶ç¼“å­˜
        open_file_cache_valid 30d;
        open_file_cache_min_uses 5;
    }
}
```

### è®¿é—®æ§åˆ¶

```nginx
server {
    root /var/www/static;

    # é™åˆ¶è®¿é—®
    location ~ /\. {
        deny all;                          # ç¦æ­¢è®¿é—®éšè—æ–‡ä»¶
        access_log off;
        log_not_found off;
    }

    location ~ \.php$ {
        deny all;                          # ç¦æ­¢ç›´æ¥è®¿é—® PHP æ–‡ä»¶
    }

    location ~ \.sh$ {
        deny all;                          # ç¦æ­¢è®¿é—®è„šæœ¬æ–‡ä»¶
    }

    location ~ /private/ {
        internal;                          # åªå…è®¸å†…éƒ¨è®¿é—®
    }

    # é™åˆ¶ç‰¹å®š IP
    location /admin/ {
        allow 192.168.1.0/24;              # å…è®¸å†…ç½‘
        deny all;                          # æ‹’ç»å…¶ä»–
    }
}
```

### é˜²ç›—é“¾

```nginx
server {
    root /var/www/static;

    # é˜²ç›—é“¾
    location ~* \.(jpg|jpeg|png|gif|bmp|swf|flv|rar|zip|doc|pdf|gz|bz2|exe|mp4|mkv|avi|rmvb)$ {
        valid_referers none blocked server_names
                       *.example.com
                       ~\.google\. ~\.baidu\.;

        if ($invalid_referer) {
            return 403;
            # æˆ–è€…è¿”å›å…¶ä»–å›¾ç‰‡
            # rewrite ^/ https://example.com/forbidden.png;
        }

        expires 7d;
        access_log off;
    }
}
```

### ä¸‹è½½é™é€Ÿ

```nginx
server {
    root /var/www/static;

    # ä¸‹è½½é™é€Ÿ
    location ~* \.(mp4|mp3|zip|rar|exe)$ {
        limit_rate 1m;              # é™é€Ÿ 1MB/s
        limit_rate_after 5m;        # ä¸‹è½½ 5MB åå¼€å§‹é™é€Ÿ

        expires 7d;
        access_log off;
    }
}
```

### è·¨åŸŸé…ç½®

```nginx
server {
    root /var/www/static;

    # è·¨åŸŸèµ„æºå…±äº«ï¼ˆCORSï¼‰
    location ~* \.(ttf|ttc|otf|eot|woff|woff2|svg)$ {
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
        add_header Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept, Authorization";

        # å¤„ç†é¢„æ£€è¯·æ±‚
        if ($request_method = 'OPTIONS') {
            return 204;
        }

        expires 1y;
    }

    # å›¾ç‰‡è·¨åŸŸ
    location ~* \.(jpg|jpeg|png|gif|bmp|webp)$ {
        add_header Access-Control-Allow-Origin *;
        expires 1y;
    }
}
```

---

## ğŸ”§ é«˜çº§æŠ€å·§

### å¤šä¸ªç›®å½•åˆå¹¶

```nginx
server {
    listen 80;
    server_name assets.example.com;

    # æ ¹æ®æ–‡ä»¶ç±»å‹ä»ä¸åŒç›®å½•æä¾›
    location ~* \.(jpg|jpeg|png|gif)$ {
        root /var/www/images;
        try_files $uri @fallback;
    }

    location ~* \.(css|js)$ {
        root /var/www/static;
        try_files $uri @fallback;
    }

    location ~* \.(woff|woff2|ttf|eot)$ {
        root /var/www/fonts;
        try_files $uri @fallback;
    }

    location @fallback {
        # å›é€€åˆ°é»˜è®¤ç›®å½•
        root /var/www/default;
        try_files $uri =404;
    }
}
```

### æ ¹æ® Referer æä¾›ä¸åŒèµ„æº

```nginx
server {
    root /var/www/static;

    # æ ¹æ® Referer è®¾ç½®ä¸åŒçš„èµ„æºç›®å½•
    map $http_referer $static_dir {
        default "default";
        ~*example1\.com "example1";
        ~*example2\.com "example2";
    }

    location ~* \.(css|js|png|jpg|jpeg|gif)$ {
        root /var/www/$static_dir;
        try_files $uri @default;
    }

    location @default {
        root /var/www/default;
        try_files $uri =404;
    }
}
```

### åŠ¨æ€ç”Ÿæˆç¼©ç•¥å›¾

```nginx
server {
    root /var/www/images;

    # åŠ¨æ€ç”Ÿæˆç¼©ç•¥å›¾ï¼ˆéœ€è¦é…åˆåç«¯è„šæœ¬ï¼‰
    location ~* ^/thumb/(\d+)x(\d+)/(.*)$ {
        set $width $1;
        set $height $2;
        set $image $3;

        # æ£€æŸ¥ç¼©ç•¥å›¾æ˜¯å¦å­˜åœ¨
        try_files /cache/thumb/$width/${image} @generate_thumb;
    }

    location @generate_thumb {
        # è°ƒç”¨åç«¯è„šæœ¬ç”Ÿæˆç¼©ç•¥å›¾
        proxy_pass http://thumb_backend/generate?w=$width&h=$height&img=$image;
        proxy_cache thumb_cache;
        proxy_cache_valid 200 7d;
    }
}
```

### å›¾ç‰‡æ‡’åŠ è½½æ”¯æŒ

```nginx
server {
    root /var/www/images;

    # å ä½å›¾
    location ~* ^/placeholder/(\d+)x(\d+)\.png$ {
        empty_gif;  # è¿”å› 1x1 é€æ˜ GIF
        # æˆ–è€…è¿”å›æŒ‡å®šå¤§å°çš„å ä½å›¾
        # rewrite ^ /placeholder.png break;
    }

    # æ‡’åŠ è½½çœŸå®å›¾ç‰‡
    location ~* \.(jpg|jpeg|png|gif|webp)$ {
        # æ£€æŸ¥æ˜¯å¦æ˜¯æ‡’åŠ è½½è¯·æ±‚
        if ($http_x_lazy_load = "true") {
            # è¿”å›ä½è´¨é‡å›¾ç‰‡ï¼ˆéœ€è¦åç«¯æ”¯æŒï¼‰
            proxy_pass http://image_processor/low_quality?$request_uri;
            break;
        }

        try_files $uri =404;
    }
}
```

---

## ğŸ“š ç›¸å…³é“¾æ¥

- [åå‘ä»£ç†](../03-æ ¸å¿ƒåŠŸèƒ½/åå‘ä»£ç†.md)
- [ç¼“å­˜é…ç½®](../04-é«˜çº§åŠŸèƒ½/ç¼“å­˜é…ç½®.md)
- [æ€§èƒ½ä¼˜åŒ–](../05-æ€§èƒ½ä¼˜åŒ–/æ€§èƒ½è°ƒä¼˜.md)
- [ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²](../08-éƒ¨ç½²å®è·µ/ç”Ÿäº§ç¯å¢ƒéƒ¨ç½².md)

---

**æ ‡ç­¾**: #nginx #é™æ€æ–‡ä»¶ #ç¼“å­˜ #CDN #æ€§èƒ½
