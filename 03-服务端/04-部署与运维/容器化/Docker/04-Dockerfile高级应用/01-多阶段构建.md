# å¤šé˜¶æ®µæ„å»º

> ä½¿ç”¨å¤šé˜¶æ®µæ„å»ºå‡å°é•œåƒä½“ç§¯ï¼Œåˆ†ç¦»æ„å»ºå’Œè¿è¡Œç¯å¢ƒ

---

## ğŸ“‹ ç›®å½•

- [å¤šé˜¶æ®µæ„å»ºåŸç†](#å¤šé˜¶æ®µæ„å»ºåŸç†)
- [åŸºæœ¬è¯­æ³•](#åŸºæœ¬è¯­æ³•)
- [æ„å»ºé˜¶æ®µåˆ†ç¦»](#æ„å»ºé˜¶æ®µåˆ†ç¦»)
- [åªå¤åˆ¶å¿…è¦æ–‡ä»¶](#åªå¤åˆ¶å¿…è¦æ–‡ä»¶)
- [å®é™…åº”ç”¨æ¡ˆä¾‹](#å®é™…åº”ç”¨æ¡ˆä¾‹)
- [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

---

## å¤šé˜¶æ®µæ„å»ºåŸç†

### ä¸ºä»€ä¹ˆéœ€è¦å¤šé˜¶æ®µæ„å»º

ä¼ ç»Ÿæ„å»ºæ–¹å¼çš„é—®é¢˜ï¼š
- é•œåƒåŒ…å«æ„å»ºå·¥å…·å’Œä¾èµ–ï¼Œä½“ç§¯å¤§
- åŒ…å«æºä»£ç ï¼Œå®‰å…¨æ€§å·®
- æ„å»ºç¯å¢ƒå’Œè¿è¡Œç¯å¢ƒæ··åˆ

å¤šé˜¶æ®µæ„å»ºçš„ä¼˜åŠ¿ï¼š
- **å‡å°é•œåƒä½“ç§¯**ï¼šåªä¿ç•™è¿è¡Œæ—¶éœ€è¦çš„æ–‡ä»¶
- **æé«˜å®‰å…¨æ€§**ï¼šä¸åŒ…å«æ„å»ºå·¥å…·å’Œæºä»£ç 
- **ä¼˜åŒ–æ„å»ºç¼“å­˜**ï¼šæ„å»ºé˜¶æ®µå’Œè¿è¡Œé˜¶æ®µåˆ†ç¦»

---

## åŸºæœ¬è¯­æ³•

### åŸºæœ¬ç»“æ„

```dockerfile
# æ„å»ºé˜¶æ®µ
FROM node:16 AS builder
WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
RUN npm run build

# è¿è¡Œé˜¶æ®µ
FROM nginx:alpine
COPY --from=builder /app/dist /usr/share/nginx/html
```

### å‘½åæ„å»ºé˜¶æ®µ

```dockerfile
FROM node:16 AS builder
# ... æ„å»ºæ­¥éª¤

FROM nginx:alpine AS production
COPY --from=builder /app/dist /usr/share/nginx/html
```

---

## æ„å»ºé˜¶æ®µåˆ†ç¦»

### ç¤ºä¾‹ï¼šNode.js åº”ç”¨

```dockerfile
# æ„å»ºé˜¶æ®µ
FROM node:16 AS builder
WORKDIR /app

# å¤åˆ¶ä¾èµ–æ–‡ä»¶
COPY package*.json ./
RUN npm ci

# å¤åˆ¶æºä»£ç å¹¶æ„å»º
COPY . .
RUN npm run build

# è¿è¡Œé˜¶æ®µ
FROM node:16-alpine
WORKDIR /app

# åªå¤åˆ¶æ„å»ºäº§ç‰©å’Œè¿è¡Œæ—¶ä¾èµ–
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/package*.json ./

CMD ["node", "dist/index.js"]
```

### ç¤ºä¾‹ï¼šGo åº”ç”¨

```dockerfile
# æ„å»ºé˜¶æ®µ
FROM golang:1.18 AS builder
WORKDIR /app

# ä¸‹è½½ä¾èµ–
COPY go.mod go.sum ./
RUN go mod download

# æ„å»ºåº”ç”¨
COPY . .
RUN CGO_ENABLED=0 GOOS=linux go build -o app .

# è¿è¡Œé˜¶æ®µ
FROM alpine:latest
RUN apk --no-cache add ca-certificates
WORKDIR /root/

# åªå¤åˆ¶ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶
COPY --from=builder /app/app .
CMD ["./app"]
```

### ç¤ºä¾‹ï¼šPython åº”ç”¨

```dockerfile
# æ„å»ºé˜¶æ®µ
FROM python:3.9 AS builder
WORKDIR /app

# å®‰è£…ä¾èµ–
COPY requirements.txt .
RUN pip install --user -r requirements.txt

# è¿è¡Œé˜¶æ®µ
FROM python:3.9-slim
WORKDIR /app

# åªå¤åˆ¶å·²å®‰è£…çš„åŒ…
COPY --from=builder /root/.local /root/.local
COPY . .

# ç¡®ä¿ä½¿ç”¨ç”¨æˆ·å®‰è£…çš„åŒ…
ENV PATH=/root/.local/bin:$PATH

CMD ["python", "app.py"]
```

---

## åªå¤åˆ¶å¿…è¦æ–‡ä»¶

### ä½¿ç”¨ --from å¤åˆ¶

```dockerfile
# ä»æ„å»ºé˜¶æ®µå¤åˆ¶æ–‡ä»¶
COPY --from=builder /app/dist /usr/share/nginx/html

# ä»å…¶ä»–é•œåƒå¤åˆ¶æ–‡ä»¶
COPY --from=nginx:alpine /etc/nginx/nginx.conf /etc/nginx/nginx.conf
```

### å¤åˆ¶å¤šä¸ªæ–‡ä»¶

```dockerfile
FROM builder AS builder
# ... æ„å»ºæ­¥éª¤

FROM nginx:alpine
# å¤åˆ¶å¤šä¸ªæ–‡ä»¶
COPY --from=builder /app/dist /usr/share/nginx/html
COPY --from=builder /app/config /app/config
```

---

## å®é™…åº”ç”¨æ¡ˆä¾‹

### æ¡ˆä¾‹ 1ï¼šå‰ç«¯åº”ç”¨

```dockerfile
# æ„å»ºé˜¶æ®µ
FROM node:16 AS builder
WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY . .
RUN npm run build

# è¿è¡Œé˜¶æ®µ
FROM nginx:alpine
COPY --from=builder /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/nginx.conf
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

### æ¡ˆä¾‹ 2ï¼šJava åº”ç”¨

```dockerfile
# æ„å»ºé˜¶æ®µ
FROM maven:3.8-openjdk-17 AS builder
WORKDIR /app
COPY pom.xml .
RUN mvn dependency:go-offline
COPY src ./src
RUN mvn package -DskipTests

# è¿è¡Œé˜¶æ®µ
FROM openjdk:17-jre-slim
WORKDIR /app
COPY --from=builder /app/target/app.jar app.jar
EXPOSE 8080
CMD ["java", "-jar", "app.jar"]
```

### æ¡ˆä¾‹ 3ï¼šå¤šæœåŠ¡åº”ç”¨

```dockerfile
# å…±äº«æ„å»ºé˜¶æ®µ
FROM node:16 AS base
WORKDIR /app
COPY package*.json ./
RUN npm ci

# API æ„å»ºé˜¶æ®µ
FROM base AS api-builder
COPY api ./api
RUN npm run build:api

# Web æ„å»ºé˜¶æ®µ
FROM base AS web-builder
COPY web ./web
RUN npm run build:web

# è¿è¡Œé˜¶æ®µ
FROM nginx:alpine
COPY --from=api-builder /app/api/dist /usr/share/nginx/api
COPY --from=web-builder /app/web/dist /usr/share/nginx/html
```

---

## æœ€ä½³å®è·µ

### 1. å‘½åæ„å»ºé˜¶æ®µ

```dockerfile
# ä½¿ç”¨æœ‰æ„ä¹‰çš„åç§°
FROM node:16 AS builder
FROM nginx:alpine AS production
```

### 2. æœ€å°åŒ–æœ€ç»ˆé•œåƒ

```dockerfile
# åªå¤åˆ¶è¿è¡Œæ—¶éœ€è¦çš„æ–‡ä»¶
COPY --from=builder /app/dist /usr/share/nginx/html
# ä¸è¦å¤åˆ¶ node_modulesã€æºä»£ç ç­‰
```

### 3. åˆ©ç”¨æ„å»ºç¼“å­˜

```dockerfile
# å…ˆå¤åˆ¶ä¾èµ–æ–‡ä»¶ï¼ˆå˜åŒ–é¢‘ç‡ä½ï¼‰
COPY package*.json ./
RUN npm install

# å†å¤åˆ¶æºä»£ç ï¼ˆå˜åŒ–é¢‘ç‡é«˜ï¼‰
COPY . .
RUN npm run build
```

### 4. ä½¿ç”¨ç‰¹å®šç›®æ ‡

```bash
# åªæ„å»ºç‰¹å®šé˜¶æ®µ
docker build --target builder -t myapp:builder .

# æ„å»ºæœ€ç»ˆé•œåƒ
docker build --target production -t myapp:latest .
```

### 5. è°ƒè¯•æ„å»ºé˜¶æ®µ

```bash
# æ„å»ºåˆ°ç‰¹å®šé˜¶æ®µ
docker build --target builder -t myapp:builder .

# è¿è¡Œæ„å»ºé˜¶æ®µè¿›è¡Œè°ƒè¯•
docker run -it myapp:builder /bin/bash
```

---

## é«˜çº§æŠ€å·§

### ä½¿ç”¨å¤–éƒ¨é•œåƒä½œä¸ºæº

```dockerfile
# ä»å…¶ä»–é•œåƒå¤åˆ¶æ–‡ä»¶
COPY --from=nginx:alpine /etc/nginx/nginx.conf /etc/nginx/nginx.conf
COPY --from=node:16 /usr/local/bin/node /usr/local/bin/
```

### æ¡ä»¶æ„å»º

```dockerfile
# æ ¹æ®æ„å»ºå‚æ•°é€‰æ‹©é˜¶æ®µ
ARG BUILD_ENV=production
FROM node:16 AS builder
# ... æ„å»ºæ­¥éª¤

FROM node:16-alpine AS dev
COPY --from=builder /app .

FROM nginx:alpine AS production
COPY --from=builder /app/dist /usr/share/nginx/html

# æ ¹æ®å‚æ•°é€‰æ‹©æœ€ç»ˆé˜¶æ®µ
FROM ${BUILD_ENV}
```

---

## ğŸ“š å‚è€ƒèµ„æº

- [Docker å®˜æ–¹æ–‡æ¡£ - å¤šé˜¶æ®µæ„å»º](https://docs.docker.com/build/building/multi-stage/)
- [Dockerfile æœ€ä½³å®è·µ](https://docs.docker.com/develop/dev-best-practices/)

---

[[!MOC-Docker|è¿”å› Docker çŸ¥è¯†ä½“ç³»]]

#Docker #Dockerfile #å¤šé˜¶æ®µæ„å»º
