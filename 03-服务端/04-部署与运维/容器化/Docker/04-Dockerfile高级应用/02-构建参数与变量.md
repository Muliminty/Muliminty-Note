# æ„å»ºå‚æ•°ä¸å˜é‡

> Dockerfile ä¸­ ARG å’Œ ENV çš„ä½¿ç”¨ï¼Œæ„å»ºå‚æ•°ä¼ é€’

---

## ğŸ“‹ ç›®å½•

- [ARG æ„å»ºå‚æ•°](#arg-æ„å»ºå‚æ•°)
- [ENV ç¯å¢ƒå˜é‡](#env-ç¯å¢ƒå˜é‡)
- [ARG ä¸ ENV çš„åŒºåˆ«](#arg-ä¸-env-çš„åŒºåˆ«)
- [å‚æ•°ä¼ é€’](#å‚æ•°ä¼ é€’)
- [é»˜è®¤å€¼è®¾ç½®](#é»˜è®¤å€¼è®¾ç½®)
- [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

---

## ARG æ„å»ºå‚æ•°

### å®šä¹‰ ARG

```dockerfile
# å®šä¹‰æ„å»ºå‚æ•°
ARG VERSION=latest
ARG BUILD_DATE
ARG NODE_ENV=production
```

### ä½¿ç”¨ ARG

```dockerfile
# åœ¨ Dockerfile ä¸­ä½¿ç”¨
ARG VERSION
LABEL version=$VERSION

ARG BUILD_DATE
LABEL build-date=$BUILD_DATE

# åœ¨ RUN æŒ‡ä»¤ä¸­ä½¿ç”¨
ARG NODE_ENV
RUN echo "Building for $NODE_ENV"
```

### ARG ä½œç”¨åŸŸ

```dockerfile
# ARG åªåœ¨å®šä¹‰å®ƒçš„æ„å»ºé˜¶æ®µæœ‰æ•ˆ
FROM node:16 AS builder
ARG VERSION
# VERSION åœ¨è¿™ä¸ªé˜¶æ®µæœ‰æ•ˆ

FROM nginx:alpine
# VERSION åœ¨è¿™ä¸ªé˜¶æ®µæ— æ•ˆï¼Œéœ€è¦é‡æ–°å®šä¹‰
ARG VERSION
```

---

## ENV ç¯å¢ƒå˜é‡

### å®šä¹‰ ENV

```dockerfile
# å®šä¹‰ç¯å¢ƒå˜é‡
ENV NODE_ENV=production
ENV PORT=3000

# å®šä¹‰å¤šä¸ªç¯å¢ƒå˜é‡
ENV NODE_ENV=production \
    PORT=3000 \
    DEBUG=false
```

### ä½¿ç”¨ ENV

```dockerfile
# åœ¨ Dockerfile ä¸­ä½¿ç”¨
ENV PATH=$PATH:/usr/local/bin

# åœ¨ RUN æŒ‡ä»¤ä¸­ä½¿ç”¨
ENV APP_NAME=myapp
RUN echo "App name: $APP_NAME"
```

### ENV æŒä¹…æ€§

ENV å®šä¹‰çš„ç¯å¢ƒå˜é‡åœ¨å®¹å™¨è¿è¡Œæ—¶ä»ç„¶å­˜åœ¨ã€‚

```dockerfile
ENV NODE_ENV=production
# å®¹å™¨è¿è¡Œæ—¶ï¼ŒNODE_ENV ä»ç„¶å¯ç”¨
```

---

## ARG ä¸ ENV çš„åŒºåˆ«

### ä½œç”¨åŸŸ

| ç‰¹æ€§ | ARG | ENV |
|------|-----|-----|
| ä½œç”¨æ—¶é—´ | æ„å»ºæ—¶ | æ„å»ºæ—¶ + è¿è¡Œæ—¶ |
| ä½œç”¨èŒƒå›´ | å•ä¸ªæ„å»ºé˜¶æ®µ | æ‰€æœ‰åç»­é˜¶æ®µå’Œå®¹å™¨è¿è¡Œæ—¶ |
| å¯è¦†ç›– | æ˜¯ï¼ˆæ„å»ºæ—¶ï¼‰ | æ˜¯ï¼ˆè¿è¡Œæ—¶ï¼‰ |
| ç”¨é€” | æ„å»ºé…ç½® | è¿è¡Œæ—¶é…ç½® |

### ä½¿ç”¨åœºæ™¯

**ARG** é€‚ç”¨äºï¼š
- æ„å»ºæ—¶é…ç½®ï¼ˆç‰ˆæœ¬å·ã€æ„å»ºæ—¥æœŸï¼‰
- æ„å»ºé˜¶æ®µç‰¹å®šçš„è®¾ç½®
- ä¸éœ€è¦åœ¨è¿è¡Œæ—¶ä½¿ç”¨çš„å€¼

**ENV** é€‚ç”¨äºï¼š
- è¿è¡Œæ—¶é…ç½®ï¼ˆç¯å¢ƒå˜é‡ã€è·¯å¾„ï¼‰
- åº”ç”¨é…ç½®ï¼ˆæ•°æ®åº“è¿æ¥ã€API å¯†é’¥ï¼‰
- éœ€è¦åœ¨å®¹å™¨è¿è¡Œæ—¶ä½¿ç”¨çš„å€¼

---

## å‚æ•°ä¼ é€’

### ä¼ é€’ ARG

```bash
# ä¼ é€’å•ä¸ªå‚æ•°
docker build --build-arg VERSION=1.0.0 -t myapp:latest .

# ä¼ é€’å¤šä¸ªå‚æ•°
docker build \
  --build-arg VERSION=1.0.0 \
  --build-arg BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ') \
  -t myapp:latest .

# ä»ç¯å¢ƒå˜é‡ä¼ é€’
export VERSION=1.0.0
docker build --build-arg VERSION=$VERSION -t myapp:latest .
```

### ä¼ é€’ ENV

```bash
# ENV åœ¨ Dockerfile ä¸­å®šä¹‰ï¼Œè¿è¡Œæ—¶å¯ä»¥è¦†ç›–
docker run -e NODE_ENV=development myapp:latest

# ä»æ–‡ä»¶è¯»å–ç¯å¢ƒå˜é‡
docker run --env-file .env myapp:latest
```

### ARG è½¬ ENV

```dockerfile
# å°†æ„å»ºå‚æ•°è½¬æ¢ä¸ºç¯å¢ƒå˜é‡
ARG VERSION
ENV APP_VERSION=$VERSION

# è¿™æ ·å¯ä»¥åœ¨è¿è¡Œæ—¶ä½¿ç”¨
# docker run -e APP_VERSION=1.0.0 myapp:latest
```

---

## é»˜è®¤å€¼è®¾ç½®

### ARG é»˜è®¤å€¼

```dockerfile
# è®¾ç½®é»˜è®¤å€¼
ARG VERSION=latest
ARG NODE_ENV=production
ARG BUILD_DATE

# ä½¿ç”¨é»˜è®¤å€¼æˆ–ä¼ é€’æ–°å€¼
# docker build -t myapp:latest .  # ä½¿ç”¨é»˜è®¤å€¼
# docker build --build-arg VERSION=1.0.0 -t myapp:latest .  # è¦†ç›–é»˜è®¤å€¼
```

### ENV é»˜è®¤å€¼

```dockerfile
# è®¾ç½®é»˜è®¤å€¼
ENV NODE_ENV=production
ENV PORT=3000

# è¿è¡Œæ—¶å¯ä»¥è¦†ç›–
# docker run -e NODE_ENV=development myapp:latest
```

---

## æœ€ä½³å®è·µ

### 1. åˆç†ä½¿ç”¨ ARG å’Œ ENV

```dockerfile
# ARGï¼šæ„å»ºæ—¶é…ç½®
ARG VERSION=latest
ARG BUILD_DATE

# ENVï¼šè¿è¡Œæ—¶é…ç½®
ENV NODE_ENV=production
ENV PORT=3000
```

### 2. ä½¿ç”¨ ARG ä¼ é€’æ„å»ºä¿¡æ¯

```dockerfile
ARG VERSION
ARG BUILD_DATE
ARG GIT_COMMIT

LABEL version=$VERSION
LABEL build-date=$BUILD_DATE
LABEL git-commit=$GIT_COMMIT
```

### 3. ä½¿ç”¨ ENV è®¾ç½®åº”ç”¨é…ç½®

```dockerfile
ENV NODE_ENV=production
ENV DATABASE_URL=postgres://localhost/mydb
ENV REDIS_URL=redis://localhost:6379
```

### 4. å¤šé˜¶æ®µæ„å»ºä¸­çš„ ARG

```dockerfile
# åœ¨éœ€è¦çš„é˜¶æ®µå®šä¹‰ ARG
FROM node:16 AS builder
ARG NODE_ENV=production
# ... æ„å»ºæ­¥éª¤

FROM nginx:alpine
# å¦‚æœéœ€è¦ï¼Œé‡æ–°å®šä¹‰ ARG
ARG VERSION
ENV APP_VERSION=$VERSION
```

### 5. å®‰å…¨æ€§è€ƒè™‘

```dockerfile
# ä¸è¦åœ¨ Dockerfile ä¸­ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯
# ä½¿ç”¨ ARG æˆ–è¿è¡Œæ—¶ç¯å¢ƒå˜é‡
ARG DB_PASSWORD
ENV DATABASE_PASSWORD=$DB_PASSWORD

# æˆ–ä½¿ç”¨ secretsï¼ˆDocker BuildKitï¼‰
# RUN --mount=type=secret,id=db_password \
#   echo $DB_PASSWORD > /app/.env
```

---

## å®ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1ï¼šç‰ˆæœ¬åŒ–æ„å»º

```dockerfile
ARG VERSION=latest
FROM node:16
WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
RUN npm run build
LABEL version=$VERSION
```

æ„å»ºï¼š
```bash
docker build --build-arg VERSION=1.0.0 -t myapp:1.0.0 .
```

### ç¤ºä¾‹ 2ï¼šç¯å¢ƒç‰¹å®šæ„å»º

```dockerfile
ARG BUILD_ENV=production
FROM node:16
WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
RUN npm run build:$BUILD_ENV
ENV NODE_ENV=$BUILD_ENV
```

æ„å»ºï¼š
```bash
docker build --build-arg BUILD_ENV=development -t myapp:dev .
docker build --build-arg BUILD_ENV=production -t myapp:prod .
```

### ç¤ºä¾‹ 3ï¼šåŠ¨æ€é…ç½®

```dockerfile
ARG API_URL
ENV API_URL=$API_URL

ARG DATABASE_URL
ENV DATABASE_URL=$DATABASE_URL
```

æ„å»ºï¼š
```bash
docker build \
  --build-arg API_URL=https://api.example.com \
  --build-arg DATABASE_URL=postgres://db:5432/mydb \
  -t myapp:latest .
```

---

## ğŸ“š å‚è€ƒèµ„æº

- [Docker å®˜æ–¹æ–‡æ¡£ - ARG](https://docs.docker.com/engine/reference/builder/#arg)
- [Docker å®˜æ–¹æ–‡æ¡£ - ENV](https://docs.docker.com/engine/reference/builder/#env)

---

[[!MOC-Docker|è¿”å› Docker çŸ¥è¯†ä½“ç³»]]

#Docker #Dockerfile #ARG #ENV
