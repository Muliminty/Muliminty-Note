# å¥åº·æ£€æŸ¥é…ç½®

> Docker å®¹å™¨çš„å¥åº·æ£€æŸ¥é…ç½®ï¼Œä½¿ç”¨ HEALTHCHECK æŒ‡ä»¤

---

## ğŸ“‹ ç›®å½•

- [HEALTHCHECK è¯­æ³•](#healthcheck-è¯­æ³•)
- [å¥åº·æ£€æŸ¥è„šæœ¬](#å¥åº·æ£€æŸ¥è„šæœ¬)
- [å¥åº·çŠ¶æ€ç›‘æ§](#å¥åº·çŠ¶æ€ç›‘æ§)
- [è‡ªåŠ¨é‡å¯ç­–ç•¥](#è‡ªåŠ¨é‡å¯ç­–ç•¥)
- [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

---

## HEALTHCHECK è¯­æ³•

### åŸºæœ¬è¯­æ³•

```dockerfile
HEALTHCHECK [OPTIONS] CMD command
```

### é€‰é¡¹è¯´æ˜

- `--interval=DURATION`ï¼šæ£€æŸ¥é—´éš”ï¼ˆé»˜è®¤ 30sï¼‰
- `--timeout=DURATION`ï¼šè¶…æ—¶æ—¶é—´ï¼ˆé»˜è®¤ 30sï¼‰
- `--start-period=DURATION`ï¼šå¯åŠ¨å®½é™æœŸï¼ˆé»˜è®¤ 0sï¼‰
- `--retries=N`ï¼šå¤±è´¥é‡è¯•æ¬¡æ•°ï¼ˆé»˜è®¤ 3ï¼‰

### åŸºæœ¬ç¤ºä¾‹

```dockerfile
# ç®€å•çš„å¥åº·æ£€æŸ¥
HEALTHCHECK CMD curl -f http://localhost:80/ || exit 1

# å¸¦é€‰é¡¹çš„å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:80/ || exit 1
```

---

## å¥åº·æ£€æŸ¥è„šæœ¬

### HTTP å¥åº·æ£€æŸ¥

```dockerfile
# æ£€æŸ¥ HTTP ç«¯ç‚¹
HEALTHCHECK --interval=30s --timeout=3s \
  CMD curl -f http://localhost:8080/health || exit 1

# ä½¿ç”¨ wget
HEALTHCHECK CMD wget --no-verbose --tries=1 --spider http://localhost:8080/health || exit 1
```

### TCP å¥åº·æ£€æŸ¥

```dockerfile
# æ£€æŸ¥ TCP ç«¯å£
HEALTHCHECK --interval=30s --timeout=3s \
  CMD nc -z localhost 3306 || exit 1
```

### è‡ªå®šä¹‰è„šæœ¬

```dockerfile
# ä½¿ç”¨è‡ªå®šä¹‰è„šæœ¬
HEALTHCHECK --interval=30s --timeout=3s \
  CMD /app/healthcheck.sh || exit 1
```

### æ•°æ®åº“å¥åº·æ£€æŸ¥

```dockerfile
# MySQL å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=3s \
  CMD mysqladmin ping -h localhost || exit 1

# PostgreSQL å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=3s \
  CMD pg_isready -U postgres || exit 1
```

---

## å¥åº·çŠ¶æ€ç›‘æ§

### æŸ¥çœ‹å¥åº·çŠ¶æ€

```bash
# æŸ¥çœ‹å®¹å™¨å¥åº·çŠ¶æ€
docker ps

# æŸ¥çœ‹è¯¦ç»†å¥åº·æ£€æŸ¥ä¿¡æ¯
docker inspect --format='{{json .State.Health}}' my-container | jq

# æŸ¥çœ‹å¥åº·æ£€æŸ¥æ—¥å¿—
docker inspect --format='{{range .State.Health.Log}}{{.Output}}{{end}}' my-container
```

### å¥åº·çŠ¶æ€å€¼

- **starting**ï¼šå®¹å™¨å¯åŠ¨ä¸­
- **healthy**ï¼šå¥åº·æ£€æŸ¥é€šè¿‡
- **unhealthy**ï¼šå¥åº·æ£€æŸ¥å¤±è´¥

---

## è‡ªåŠ¨é‡å¯ç­–ç•¥

### ç»“åˆ --restart

```bash
# å¥åº·æ£€æŸ¥å¤±è´¥æ—¶é‡å¯
docker run -d \
  --name my-app \
  --restart=on-failure \
  myapp:latest
```

### Docker Compose ä¸­çš„å¥åº·æ£€æŸ¥

```yaml
version: '3.8'
services:
  web:
    image: nginx:latest
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 40s
```

---

## æœ€ä½³å®è·µ

### 1. åˆç†è®¾ç½®æ£€æŸ¥é—´éš”

```dockerfile
# æ ¹æ®åº”ç”¨ç‰¹æ€§è®¾ç½®
HEALTHCHECK --interval=30s --timeout=3s \
  CMD curl -f http://localhost:8080/health || exit 1
```

### 2. è®¾ç½®å¯åŠ¨å®½é™æœŸ

```dockerfile
# ç»™åº”ç”¨å¯åŠ¨æ—¶é—´
HEALTHCHECK --interval=30s --timeout=3s --start-period=60s \
  CMD curl -f http://localhost:8080/health || exit 1
```

### 3. ä½¿ç”¨è½»é‡çº§æ£€æŸ¥

```dockerfile
# ä½¿ç”¨è½»é‡çº§å‘½ä»¤ï¼Œé¿å…å½±å“æ€§èƒ½
HEALTHCHECK CMD curl -f http://localhost:8080/health || exit 1
```

### 4. æ£€æŸ¥å…³é”®æœåŠ¡

```dockerfile
# æ£€æŸ¥åº”ç”¨çš„å…³é”®åŠŸèƒ½
HEALTHCHECK CMD curl -f http://localhost:8080/api/health || exit 1
```

---

## å®ç”¨ç¤ºä¾‹

### Web åº”ç”¨

```dockerfile
FROM nginx:alpine
COPY . /usr/share/nginx/html
HEALTHCHECK --interval=30s --timeout=3s \
  CMD wget --no-verbose --tries=1 --spider http://localhost:80/ || exit 1
```

### API æœåŠ¡

```dockerfile
FROM node:16
WORKDIR /app
COPY . .
RUN npm install
HEALTHCHECK --interval=30s --timeout=3s --start-period=40s \
  CMD node healthcheck.js || exit 1
CMD ["node", "index.js"]
```

### æ•°æ®åº“

```dockerfile
FROM postgres:13
HEALTHCHECK --interval=30s --timeout=3s \
  CMD pg_isready -U postgres || exit 1
```

---

## ğŸ“š å‚è€ƒèµ„æº

- [Docker å®˜æ–¹æ–‡æ¡£ - HEALTHCHECK](https://docs.docker.com/engine/reference/builder/#healthcheck)
- [Docker å®˜æ–¹æ–‡æ¡£ - å¥åº·æ£€æŸ¥](https://docs.docker.com/engine/reference/run/#healthcheck)

---

[[!MOC-Docker|è¿”å› Docker çŸ¥è¯†ä½“ç³»]]

#Docker #Dockerfile #å¥åº·æ£€æŸ¥
