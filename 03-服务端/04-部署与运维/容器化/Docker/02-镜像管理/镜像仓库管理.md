# é•œåƒä»“åº“ç®¡ç†

> Docker é•œåƒä»“åº“çš„ä½¿ç”¨ä¸ç®¡ç†ï¼ŒåŒ…æ‹¬ Docker Hubã€ç§æœ‰ä»“åº“ç­‰

---

## ğŸ“‹ ç›®å½•

- [Docker Hub ä½¿ç”¨](#docker-hub-ä½¿ç”¨)
- [ç§æœ‰ä»“åº“æ­å»º](#ç§æœ‰ä»“åº“æ­å»º)
- [é•œåƒæ¨é€ä¸æ‹‰å–](#é•œåƒæ¨é€ä¸æ‹‰å–)
- [é•œåƒç‰ˆæœ¬ç®¡ç†](#é•œåƒç‰ˆæœ¬ç®¡ç†)
- [é•œåƒå®‰å…¨æ‰«æ](#é•œåƒå®‰å…¨æ‰«æ)
- [ä»“åº“æœ€ä½³å®è·µ](#ä»“åº“æœ€ä½³å®è·µ)

---

## Docker Hub ä½¿ç”¨

### æ³¨å†Œä¸ç™»å½•

```bash
# æ³¨å†Œè´¦å·
# è®¿é—® https://hub.docker.com æ³¨å†Œ

# ç™»å½• Docker Hub
docker login

# ä½¿ç”¨ç”¨æˆ·åç™»å½•
docker login -u username

# ä½¿ç”¨è®¿é—®ä»¤ç‰Œç™»å½•
echo $DOCKER_TOKEN | docker login -u username --password-stdin
```

### æœç´¢é•œåƒ

```bash
# æœç´¢é•œåƒ
docker search nginx

# é™åˆ¶æœç´¢ç»“æœ
docker search --limit 5 nginx

# åªæ˜¾ç¤ºå®˜æ–¹é•œåƒ
docker search --filter "is-official=true" nginx

# åªæ˜¾ç¤ºè‡ªåŠ¨æ„å»ºçš„é•œåƒ
docker search --filter "is-automated=true" nginx
```

### æ‹‰å–é•œåƒ

```bash
# æ‹‰å–å®˜æ–¹é•œåƒ
docker pull nginx

# æ‹‰å–ç”¨æˆ·é•œåƒ
docker pull username/myapp:latest

# æ‹‰å–æŒ‡å®šç‰ˆæœ¬
docker pull nginx:1.21
```

---

## ç§æœ‰ä»“åº“æ­å»º

### Docker Registry

Docker å®˜æ–¹æä¾›çš„ç§æœ‰ä»“åº“å®ç°ã€‚

#### å¿«é€Ÿå¯åŠ¨

```bash
# å¯åŠ¨ Registry
docker run -d -p 5000:5000 --name registry registry:2

# ä½¿ç”¨ HTTPSï¼ˆéœ€è¦è¯ä¹¦ï¼‰
docker run -d -p 5000:5000 \
  -v /path/to/certs:/certs \
  -e REGISTRY_HTTP_TLS_CERTIFICATE=/certs/domain.crt \
  -e REGISTRY_HTTP_TLS_PRIVATE_KEY=/certs/domain.key \
  --name registry registry:2
```

#### é…ç½®è®¤è¯

```bash
# ä½¿ç”¨ htpasswd åˆ›å»ºè®¤è¯æ–‡ä»¶
docker run --rm --entrypoint htpasswd httpd:2 \
  -Bbn username password > auth/htpasswd

# å¯åŠ¨å¸¦è®¤è¯çš„ Registry
docker run -d -p 5000:5000 \
  -v $(pwd)/auth:/auth \
  -e "REGISTRY_AUTH=htpasswd" \
  -e "REGISTRY_AUTH_HTPASSWD_PATH=/auth/htpasswd" \
  -e "REGISTRY_AUTH_HTPASSWD_REALM=Registry Realm" \
  --name registry registry:2
```

#### ä½¿ç”¨ç§æœ‰ä»“åº“

```bash
# æ ‡è®°é•œåƒ
docker tag myapp:latest localhost:5000/myapp:latest

# æ¨é€é•œåƒ
docker push localhost:5000/myapp:latest

# æ‹‰å–é•œåƒ
docker pull localhost:5000/myapp:latest
```

### Harbor

ä¼ä¸šçº§å®¹å™¨é•œåƒä»“åº“ï¼Œæä¾›æ›´å¤šåŠŸèƒ½ã€‚

#### åŠŸèƒ½ç‰¹æ€§

- Web UI ç®¡ç†ç•Œé¢
- é•œåƒæ‰«æå’Œæ¼æ´æ£€æµ‹
- é•œåƒå¤åˆ¶å’ŒåŒæ­¥
- RBAC æƒé™ç®¡ç†
- å®¡è®¡æ—¥å¿—

#### å®‰è£… Harbor

```bash
# ä¸‹è½½ Harbor
wget https://github.com/goharbor/harbor/releases/download/v2.7.0/harbor-offline-installer-v2.7.0.tgz
tar xvf harbor-offline-installer-v2.7.0.tgz

# é…ç½® Harbor
cd harbor
cp harbor.yml.tmpl harbor.yml
# ç¼–è¾‘ harbor.yml é…ç½®æ–‡ä»¶

# å®‰è£… Harbor
./install.sh
```

#### ä½¿ç”¨ Harbor

```bash
# ç™»å½• Harbor
docker login harbor.example.com

# æ¨é€é•œåƒ
docker tag myapp:latest harbor.example.com/project/myapp:latest
docker push harbor.example.com/project/myapp:latest

# æ‹‰å–é•œåƒ
docker pull harbor.example.com/project/myapp:latest
```

---

## é•œåƒæ¨é€ä¸æ‹‰å–

### æ¨é€é•œåƒ

```bash
# æ ‡è®°é•œåƒ
docker tag myapp:latest username/myapp:latest

# æ¨é€é•œåƒ
docker push username/myapp:latest

# æ¨é€å¤šä¸ªæ ‡ç­¾
docker push username/myapp:latest
docker push username/myapp:v1.0.0

# æ¨é€æ‰€æœ‰æ ‡ç­¾
docker push username/myapp --all-tags
```

### æ‹‰å–é•œåƒ

```bash
# æ‹‰å–æœ€æ–°ç‰ˆæœ¬
docker pull username/myapp:latest

# æ‹‰å–æŒ‡å®šç‰ˆæœ¬
docker pull username/myapp:v1.0.0

# æ‹‰å–æ‰€æœ‰æ ‡ç­¾
docker pull username/myapp --all-tags
```

### é•œåƒå‘½åè§„èŒƒ

```
[ä»“åº“åœ°å€/][ç”¨æˆ·å/]é•œåƒå[:æ ‡ç­¾]
```

ç¤ºä¾‹ï¼š
- `nginx:latest` - Docker Hub å®˜æ–¹é•œåƒ
- `username/myapp:v1.0` - ç”¨æˆ·è‡ªå®šä¹‰é•œåƒ
- `registry.example.com/project/app:latest` - ç§æœ‰ä»“åº“é•œåƒ

---

## é•œåƒç‰ˆæœ¬ç®¡ç†

### æ ‡ç­¾ç­–ç•¥

#### è¯­ä¹‰åŒ–ç‰ˆæœ¬

```bash
# ä¸»ç‰ˆæœ¬å·.æ¬¡ç‰ˆæœ¬å·.ä¿®è®¢å·
docker tag myapp:latest myapp:1.0.0
docker tag myapp:latest myapp:1.1.0
docker tag myapp:latest myapp:2.0.0
```

#### ç¯å¢ƒæ ‡ç­¾

```bash
# å¼€å‘ç¯å¢ƒ
docker tag myapp:latest myapp:dev

# æµ‹è¯•ç¯å¢ƒ
docker tag myapp:latest myapp:test

# ç”Ÿäº§ç¯å¢ƒ
docker tag myapp:latest myapp:prod
```

#### Git æ ‡ç­¾

```bash
# ä½¿ç”¨ Git commit SHA
docker tag myapp:latest myapp:$(git rev-parse --short HEAD)

# ä½¿ç”¨ Git æ ‡ç­¾
docker tag myapp:latest myapp:$(git describe --tags)
```

### ç‰ˆæœ¬ç®¡ç†æœ€ä½³å®è·µ

1. **ä½¿ç”¨è¯­ä¹‰åŒ–ç‰ˆæœ¬**ï¼šéµå¾ª SemVer è§„èŒƒ
2. **ä¿ç•™ latest æ ‡ç­¾**ï¼šæŒ‡å‘æœ€æ–°ç¨³å®šç‰ˆæœ¬
3. **ä½¿ç”¨ç‰¹å®šç‰ˆæœ¬**ï¼šç”Ÿäº§ç¯å¢ƒä½¿ç”¨å…·ä½“ç‰ˆæœ¬å·
4. **å®šæœŸæ¸…ç†æ—§ç‰ˆæœ¬**ï¼šåˆ é™¤ä¸å†ä½¿ç”¨çš„é•œåƒç‰ˆæœ¬

---

## é•œåƒå®‰å…¨æ‰«æ

### Docker Scout

Docker å®˜æ–¹å®‰å…¨æ‰«æå·¥å…·ã€‚

```bash
# æ‰«æé•œåƒæ¼æ´
docker scout cves nginx:latest

# æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š
docker scout cves --format json nginx:latest

# æ¯”è¾ƒä¸¤ä¸ªé•œåƒ
docker scout compare nginx:1.20 nginx:1.21
```

### Trivy

å¼€æºå®‰å…¨æ‰«æå·¥å…·ã€‚

```bash
# å®‰è£… Trivy
brew install trivy  # macOS
# æˆ–
wget https://github.com/aquasecurity/trivy/releases/download/v0.40.0/trivy_0.40.0_Linux-64bit.tar.gz

# æ‰«æé•œåƒ
trivy image nginx:latest

# æ‰«æå¹¶ç”ŸæˆæŠ¥å‘Š
trivy image -f json -o report.json nginx:latest
```

### Harbor å®‰å…¨æ‰«æ

Harbor å†…ç½®å®‰å…¨æ‰«æåŠŸèƒ½ã€‚

1. åœ¨ Harbor Web UI ä¸­é€‰æ‹©é•œåƒ
2. ç‚¹å‡»"æ‰«æ"æŒ‰é’®
3. æŸ¥çœ‹æ‰«æç»“æœå’Œæ¼æ´è¯¦æƒ…

---

## ä»“åº“æœ€ä½³å®è·µ

### 1. é•œåƒå‘½åè§„èŒƒ

- ä½¿ç”¨æœ‰æ„ä¹‰çš„åç§°
- éµå¾ªå‘½åçº¦å®š
- ä½¿ç”¨ç‰ˆæœ¬æ ‡ç­¾è€Œé latest

### 2. è®¿é—®æ§åˆ¶

- ä½¿ç”¨è®¤è¯å’Œæˆæƒ
- é™åˆ¶æ¨é€æƒé™
- å®šæœŸå®¡æŸ¥è®¿é—®æƒé™

### 3. é•œåƒæ¸…ç†

```bash
# åˆ é™¤æœªä½¿ç”¨çš„é•œåƒ
docker image prune -a

# åˆ é™¤ç‰¹å®šæ ‡ç­¾
docker rmi username/myapp:old-tag
```

### 4. é•œåƒå¤‡ä»½

```bash
# å¯¼å‡ºé•œåƒ
docker save -o myapp.tar username/myapp:latest

# å¯¼å…¥é•œåƒ
docker load -i myapp.tar
```

### 5. é•œåƒåŒæ­¥

```bash
# ä½¿ç”¨ Harbor é•œåƒå¤åˆ¶åŠŸèƒ½
# åœ¨ Harbor Web UI ä¸­é…ç½®å¤åˆ¶è§„åˆ™

# æˆ–ä½¿ç”¨è„šæœ¬åŒæ­¥
docker pull source-registry.com/myapp:latest
docker tag source-registry.com/myapp:latest target-registry.com/myapp:latest
docker push target-registry.com/myapp:latest
```

---

## å¸¸è§é—®é¢˜

### 1. æ¨é€å¤±è´¥ï¼šunauthorized

**é—®é¢˜**ï¼šæœªç™»å½•æˆ–è®¤è¯å¤±è´¥ã€‚

**è§£å†³**ï¼š
```bash
# é‡æ–°ç™»å½•
docker login

# æ£€æŸ¥è®¤è¯ä¿¡æ¯
cat ~/.docker/config.json
```

### 2. æ¨é€å¤±è´¥ï¼šdenied

**é—®é¢˜**ï¼šæ²¡æœ‰æ¨é€æƒé™ã€‚

**è§£å†³**ï¼š
- æ£€æŸ¥ä»“åº“æƒé™è®¾ç½®
- ç¡®è®¤é•œåƒåç§°æ­£ç¡®
- è”ç³»ä»“åº“ç®¡ç†å‘˜

### 3. æ‹‰å–é€Ÿåº¦æ…¢

**é—®é¢˜**ï¼šç½‘ç»œé—®é¢˜æˆ–é•œåƒæºé—®é¢˜ã€‚

**è§£å†³**ï¼š
```bash
# é…ç½®é•œåƒåŠ é€Ÿå™¨ï¼ˆä¸­å›½ç”¨æˆ·ï¼‰
# ç¼–è¾‘ /etc/docker/daemon.json
{
  "registry-mirrors": [
    "https://docker.mirrors.ustc.edu.cn",
    "https://hub-mirror.c.163.com"
  ]
}

# é‡å¯ Docker
sudo systemctl restart docker
```

---

## ğŸ“š å‚è€ƒèµ„æº

- [Docker Hub æ–‡æ¡£](https://docs.docker.com/docker-hub/)
- [Docker Registry æ–‡æ¡£](https://docs.docker.com/registry/)
- [Harbor æ–‡æ¡£](https://goharbor.io/docs/)
- [Docker Scout æ–‡æ¡£](https://docs.docker.com/scout/)

---

[[!MOC-Docker|è¿”å› Docker çŸ¥è¯†ä½“ç³»]]

#Docker #é•œåƒä»“åº“ #Registry #Harbor
