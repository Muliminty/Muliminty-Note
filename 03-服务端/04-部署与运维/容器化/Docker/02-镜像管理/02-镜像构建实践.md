# é•œåƒæ„å»ºå®è·µ

> Docker é•œåƒæ„å»ºçš„å®è·µæŠ€å·§å’Œæœ€ä½³å®è·µ

---

## ğŸ“‹ ç›®å½•

- [æ„å»ºä¸Šä¸‹æ–‡](#æ„å»ºä¸Šä¸‹æ–‡)
- [.dockerignore æ–‡ä»¶](#dockerignore-æ–‡ä»¶)
- [æ„å»ºç¼“å­˜æœºåˆ¶](#æ„å»ºç¼“å­˜æœºåˆ¶)
- [æ„å»ºå‚æ•°ä¼ é€’](#æ„å»ºå‚æ•°ä¼ é€’)
- [å¤šæ¶æ„æ„å»º](#å¤šæ¶æ„æ„å»º)
- [æ„å»ºä¼˜åŒ–æŠ€å·§](#æ„å»ºä¼˜åŒ–æŠ€å·§)
- [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## æ„å»ºä¸Šä¸‹æ–‡

### ä»€ä¹ˆæ˜¯æ„å»ºä¸Šä¸‹æ–‡

æ„å»ºä¸Šä¸‹æ–‡æ˜¯ Docker æ„å»ºæ—¶çš„å·¥ä½œç›®å½•ï¼ŒDockerfile ä¸­çš„ `COPY` å’Œ `ADD` æŒ‡ä»¤åªèƒ½è®¿é—®æ„å»ºä¸Šä¸‹æ–‡ä¸­çš„æ–‡ä»¶ã€‚

```bash
# å½“å‰ç›®å½•ä½œä¸ºæ„å»ºä¸Šä¸‹æ–‡
docker build -t myapp:latest .

# æŒ‡å®šç›®å½•ä½œä¸ºæ„å»ºä¸Šä¸‹æ–‡
docker build -t myapp:latest /path/to/build/context

# ä½¿ç”¨è¿œç¨‹ URL ä½œä¸ºæ„å»ºä¸Šä¸‹æ–‡
docker build -t myapp:latest https://github.com/user/repo.git
```

### æ„å»ºä¸Šä¸‹æ–‡å¤§å°

æ„å»ºä¸Šä¸‹æ–‡ä¼šè¢«å‘é€åˆ° Docker å®ˆæŠ¤è¿›ç¨‹ï¼Œè¿‡å¤§çš„ä¸Šä¸‹æ–‡ä¼šå½±å“æ„å»ºé€Ÿåº¦ã€‚

```bash
# æŸ¥çœ‹æ„å»ºä¸Šä¸‹æ–‡å¤§å°
du -sh .

# ä¼˜åŒ–æ„å»ºä¸Šä¸‹æ–‡
# 1. ä½¿ç”¨ .dockerignore æ’é™¤ä¸å¿…è¦çš„æ–‡ä»¶
# 2. åªå¤åˆ¶å¿…è¦çš„æ–‡ä»¶
```

---

## .dockerignore æ–‡ä»¶

### ä½œç”¨

`.dockerignore` æ–‡ä»¶ç”¨äºæ’é™¤æ„å»ºä¸Šä¸‹æ–‡ä¸­ä¸éœ€è¦çš„æ–‡ä»¶ï¼Œç±»ä¼¼äº `.gitignore`ã€‚

### è¯­æ³•è§„åˆ™

```dockerignore
# æ³¨é‡Š
# æ’é™¤æ–‡ä»¶
*.log
*.tmp

# æ’é™¤ç›®å½•
node_modules/
.git/
.vscode/

# æ’é™¤ç‰¹å®šæ–‡ä»¶
README.md
Dockerfile

# ä½¿ç”¨é€šé…ç¬¦
*.md
test/*.js

# æ’é™¤ä½†åŒ…å«ç‰¹å®šæ–‡ä»¶
*.md
!README.md
```

### ç¤ºä¾‹

```dockerignore
# Git ç›¸å…³
.git
.gitignore
.gitattributes

# å¼€å‘å·¥å…·
.vscode/
.idea/
*.swp
*.swo

# ä¾èµ–å’Œæ„å»ºäº§ç‰©
node_modules/
dist/
build/
*.log

# æµ‹è¯•æ–‡ä»¶
test/
*.test.js
coverage/

# æ–‡æ¡£
*.md
docs/

# ç¯å¢ƒé…ç½®
.env
.env.local
```

---

## æ„å»ºç¼“å­˜æœºåˆ¶

### ç¼“å­˜åŸç†

Docker ä½¿ç”¨å±‚ç¼“å­˜æœºåˆ¶ï¼Œå¦‚æœ Dockerfile ä¸­çš„æŒ‡ä»¤æ²¡æœ‰å˜åŒ–ï¼Œä¼šå¤ç”¨ä¹‹å‰çš„å±‚ã€‚

### ç¼“å­˜å¤±æ•ˆ

ä»¥ä¸‹æƒ…å†µä¼šå¯¼è‡´ç¼“å­˜å¤±æ•ˆï¼š
1. Dockerfile æŒ‡ä»¤å‘ç”Ÿå˜åŒ–
2. æ„å»ºä¸Šä¸‹æ–‡ä¸­çš„æ–‡ä»¶å‘ç”Ÿå˜åŒ–ï¼ˆCOPY/ADDï¼‰
3. ä½¿ç”¨ `--no-cache` å‚æ•°

```bash
# ä¸ä½¿ç”¨ç¼“å­˜æ„å»º
docker build --no-cache -t myapp:latest .

# ä½¿ç”¨ç‰¹å®šç¼“å­˜æº
docker build --cache-from myapp:previous -t myapp:latest .
```

### ä¼˜åŒ–ç¼“å­˜ä½¿ç”¨

```dockerfile
# å¥½çš„åšæ³•ï¼šå…ˆå¤åˆ¶ä¾èµ–æ–‡ä»¶ï¼Œåˆ©ç”¨ç¼“å­˜
COPY package.json package-lock.json ./
RUN npm install
COPY . .

# ä¸å¥½çš„åšæ³•ï¼šå…ˆå¤åˆ¶æ‰€æœ‰æ–‡ä»¶
COPY . .
RUN npm install
```

---

## æ„å»ºå‚æ•°ä¼ é€’

### ARG æ„å»ºå‚æ•°

```dockerfile
# å®šä¹‰æ„å»ºå‚æ•°
ARG VERSION=latest
ARG BUILD_DATE
ARG NODE_ENV=production

# ä½¿ç”¨æ„å»ºå‚æ•°
LABEL version=$VERSION
ENV NODE_ENV=$NODE_ENV
```

### ä¼ é€’æ„å»ºå‚æ•°

```bash
# ä¼ é€’å•ä¸ªå‚æ•°
docker build --build-arg VERSION=1.0.0 -t myapp:latest .

# ä¼ é€’å¤šä¸ªå‚æ•°
docker build \
  --build-arg VERSION=1.0.0 \
  --build-arg BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ') \
  -t myapp:latest .

# ä»ç¯å¢ƒå˜é‡ä¼ é€’
export VERSION=1.0.0
docker build --build-arg VERSION=$VERSION -t myapp:latest .
```

### ARG ä¸ ENV çš„åŒºåˆ«

- **ARG**ï¼šæ„å»ºæ—¶å˜é‡ï¼Œæ„å»ºåä¸å­˜åœ¨
- **ENV**ï¼šè¿è¡Œæ—¶å˜é‡ï¼Œå®¹å™¨è¿è¡Œæ—¶å­˜åœ¨

```dockerfile
ARG BUILD_VERSION
ENV APP_VERSION=$BUILD_VERSION
```

---

## å¤šæ¶æ„æ„å»º

### Buildx å¤šæ¶æ„æ„å»º

```bash
# å®‰è£… buildx
docker buildx create --use

# æ„å»ºå¤šæ¶æ„é•œåƒ
docker buildx build \
  --platform linux/amd64,linux/arm64 \
  -t username/myapp:latest \
  --push .

# æŸ¥çœ‹æ”¯æŒçš„å¹³å°
docker buildx inspect --bootstrap
```

### å¹³å°ç‰¹å®šæ„å»º

```bash
# ä¸ºç‰¹å®šå¹³å°æ„å»º
docker buildx build \
  --platform linux/arm64 \
  -t myapp:arm64 \
  --load .
```

---

## æ„å»ºä¼˜åŒ–æŠ€å·§

### 1. å‡å°‘é•œåƒå±‚æ•°

```dockerfile
# å¥½çš„åšæ³•ï¼šåˆå¹¶ RUN æŒ‡ä»¤
RUN apt-get update && \
    apt-get install -y nginx && \
    rm -rf /var/lib/apt/lists/*

# ä¸å¥½çš„åšæ³•ï¼šå¤šä¸ª RUN æŒ‡ä»¤
RUN apt-get update
RUN apt-get install -y nginx
RUN rm -rf /var/lib/apt/lists/*
```

### 2. ä½¿ç”¨å¤šé˜¶æ®µæ„å»º

```dockerfile
# æ„å»ºé˜¶æ®µ
FROM node:16 AS builder
WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
RUN npm run build

# è¿è¡Œé˜¶æ®µ
FROM nginx:alpine
COPY --from=builder /app/dist /usr/share/nginx/html
```

### 3. åˆç†ä½¿ç”¨ç¼“å­˜

```dockerfile
# å…ˆå¤åˆ¶ä¾èµ–æ–‡ä»¶ï¼ˆå˜åŒ–é¢‘ç‡ä½ï¼‰
COPY package.json package-lock.json ./
RUN npm install

# å†å¤åˆ¶æºä»£ç ï¼ˆå˜åŒ–é¢‘ç‡é«˜ï¼‰
COPY . .
```

### 4. æ¸…ç†ä¸å¿…è¦çš„æ–‡ä»¶

```dockerfile
RUN apt-get update && \
    apt-get install -y nginx && \
    rm -rf /var/lib/apt/lists/* && \
    apt-get clean
```

### 5. ä½¿ç”¨ .dockerignore

ç¡®ä¿ `.dockerignore` æ–‡ä»¶æ’é™¤ä¸å¿…è¦çš„æ–‡ä»¶ï¼Œå‡å°æ„å»ºä¸Šä¸‹æ–‡ã€‚

---

## æ„å»ºè¾“å‡ºæ§åˆ¶

### è¾“å‡ºæ ¼å¼

```bash
# é™é»˜æ„å»ºï¼ˆåªæ˜¾ç¤ºé”™è¯¯ï¼‰
docker build -q -t myapp:latest .

# è¯¦ç»†è¾“å‡º
docker build --progress=plain -t myapp:latest .

# JSON è¾“å‡º
docker build --progress=json -t myapp:latest .
```

### æ„å»ºæ—¥å¿—

```bash
# ä¿å­˜æ„å»ºæ—¥å¿—
docker build -t myapp:latest . 2>&1 | tee build.log
```

---

## å¸¸è§é—®é¢˜

### 1. æ„å»ºä¸Šä¸‹æ–‡è¿‡å¤§

**é—®é¢˜**ï¼šæ„å»ºä¸Šä¸‹æ–‡åŒ…å«å¤§é‡æ–‡ä»¶ï¼Œå¯¼è‡´æ„å»ºç¼“æ…¢ã€‚

**è§£å†³**ï¼š
- ä½¿ç”¨ `.dockerignore` æ’é™¤ä¸å¿…è¦çš„æ–‡ä»¶
- åªå¤åˆ¶å¿…è¦çš„æ–‡ä»¶åˆ°æ„å»ºä¸Šä¸‹æ–‡

### 2. ç¼“å­˜å¤±æ•ˆ

**é—®é¢˜**ï¼šæ¯æ¬¡æ„å»ºéƒ½é‡æ–°ä¸‹è½½ä¾èµ–ã€‚

**è§£å†³**ï¼š
- åˆç†ç»„ç»‡ Dockerfile æŒ‡ä»¤é¡ºåº
- å…ˆå¤åˆ¶ä¾èµ–æ–‡ä»¶ï¼Œå†å¤åˆ¶æºä»£ç 

### 3. æ„å»ºå¤±è´¥

**é—®é¢˜**ï¼šæ„å»ºè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ã€‚

**è§£å†³**ï¼š
```bash
# æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯
docker build --progress=plain -t myapp:latest .

# ä½¿ç”¨ä¸­é—´é•œåƒè°ƒè¯•
docker build --target builder -t myapp:builder .
docker run -it myapp:builder /bin/bash
```

### 4. æƒé™é—®é¢˜

**é—®é¢˜**ï¼šæ„å»ºæ—¶æ–‡ä»¶æƒé™ä¸æ­£ç¡®ã€‚

**è§£å†³**ï¼š
```dockerfile
# è®¾ç½®æ­£ç¡®çš„æ–‡ä»¶æƒé™
COPY --chown=user:user app /app
RUN chmod +x /app/entrypoint.sh
```

---

## å®ç”¨è„šæœ¬

### æ„å»ºè„šæœ¬ç¤ºä¾‹

```bash
#!/bin/bash
# build.sh

IMAGE_NAME="myapp"
VERSION=${1:-latest}
REGISTRY="registry.example.com"

echo "Building ${IMAGE_NAME}:${VERSION}"

docker build \
  --build-arg BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ') \
  --build-arg VERSION=${VERSION} \
  -t ${IMAGE_NAME}:${VERSION} \
  -t ${IMAGE_NAME}:latest \
  -t ${REGISTRY}/${IMAGE_NAME}:${VERSION} \
  .

echo "Build complete: ${IMAGE_NAME}:${VERSION}"
```

---

## ğŸ“š å‚è€ƒèµ„æº

- [Docker å®˜æ–¹æ–‡æ¡£ - æ„å»ºé•œåƒ](https://docs.docker.com/engine/reference/commandline/build/)
- [Dockerfile æœ€ä½³å®è·µ](https://docs.docker.com/develop/dev-best-practices/)
- [.dockerignore æ–‡ä»¶](https://docs.docker.com/engine/reference/builder/#dockerignore-file)

---

[[!MOC-Docker|è¿”å› Docker çŸ¥è¯†ä½“ç³»]]

#Docker #é•œåƒæ„å»º #æ„å»ºå®è·µ
