# é•œåƒä¼˜åŒ–ç­–ç•¥

> å‡å°é•œåƒä½“ç§¯ã€æå‡æ„å»ºé€Ÿåº¦çš„ä¼˜åŒ–ç­–ç•¥

---

## ğŸ“‹ ç›®å½•

- [é€‰æ‹©åˆé€‚çš„åŸºç¡€é•œåƒ](#é€‰æ‹©åˆé€‚çš„åŸºç¡€é•œåƒ)
- [å‡å°‘é•œåƒå±‚æ•°](#å‡å°‘é•œåƒå±‚æ•°)
- [åˆå¹¶ RUN æŒ‡ä»¤](#åˆå¹¶-run-æŒ‡ä»¤)
- [æ¸…ç†ä¸å¿…è¦çš„æ–‡ä»¶](#æ¸…ç†ä¸å¿…è¦çš„æ–‡ä»¶)
- [ä½¿ç”¨å¤šé˜¶æ®µæ„å»º](#ä½¿ç”¨å¤šé˜¶æ®µæ„å»º)
- [é•œåƒå¤§å°åˆ†æå·¥å…·](#é•œåƒå¤§å°åˆ†æå·¥å…·)
- [ä¼˜åŒ–å®è·µæ¡ˆä¾‹](#ä¼˜åŒ–å®è·µæ¡ˆä¾‹)

---

## é€‰æ‹©åˆé€‚çš„åŸºç¡€é•œåƒ

### Alpine vs æ ‡å‡†é•œåƒ

**Alpine Linux** æ˜¯ä¸€ä¸ªåŸºäº musl libc å’Œ BusyBox çš„è½»é‡çº§ Linux å‘è¡Œç‰ˆã€‚

```dockerfile
# ä½¿ç”¨ Alpineï¼ˆä½“ç§¯å°ï¼Œçº¦ 5MBï¼‰
FROM alpine:latest

# ä½¿ç”¨æ ‡å‡†é•œåƒï¼ˆä½“ç§¯å¤§ï¼Œçº¦ 100MB+ï¼‰
FROM ubuntu:20.04
```

### é•œåƒå¤§å°å¯¹æ¯”

| åŸºç¡€é•œåƒ | å¤§å° | ç‰¹ç‚¹ |
|---------|------|------|
| alpine:latest | ~5MB | æœ€å°ï¼Œä½†å…¼å®¹æ€§å¯èƒ½æœ‰é—®é¢˜ |
| debian:bullseye-slim | ~80MB | å¹³è¡¡ä½“ç§¯å’Œå…¼å®¹æ€§ |
| ubuntu:20.04 | ~72MB | å…¼å®¹æ€§å¥½ï¼Œä½“ç§¯è¾ƒå¤§ |
| node:16-alpine | ~170MB | Node.js + Alpine |
| node:16 | ~900MB | Node.js æ ‡å‡†é•œåƒ |

### é€‰æ‹©å»ºè®®

- **ç”Ÿäº§ç¯å¢ƒ**ï¼šä¼˜å…ˆä½¿ç”¨ Alpine æˆ– slim ç‰ˆæœ¬
- **å¼€å‘ç¯å¢ƒ**ï¼šå¯ä»¥ä½¿ç”¨æ ‡å‡†é•œåƒï¼Œå·¥å…·æ›´å…¨
- **å…¼å®¹æ€§è¦æ±‚é«˜**ï¼šä½¿ç”¨æ ‡å‡†é•œåƒ

---

## å‡å°‘é•œåƒå±‚æ•°

### å±‚æ•°é™åˆ¶

Docker é•œåƒæœ€å¤šæ”¯æŒ 127 å±‚ï¼Œä½†å®é™…å»ºè®®æ§åˆ¶åœ¨ 10-20 å±‚ä»¥å†…ã€‚

### ä¼˜åŒ–æ–¹æ³•

```dockerfile
# ä¸å¥½çš„åšæ³•ï¼šå¤šä¸ªæŒ‡ä»¤åˆ›å»ºå¤šä¸ªå±‚
RUN apt-get update
RUN apt-get install -y nginx
RUN apt-get install -y curl
RUN rm -rf /var/lib/apt/lists/*

# å¥½çš„åšæ³•ï¼šåˆå¹¶æŒ‡ä»¤å‡å°‘å±‚æ•°
RUN apt-get update && \
    apt-get install -y nginx curl && \
    rm -rf /var/lib/apt/lists/*
```

---

## åˆå¹¶ RUN æŒ‡ä»¤

### åŸåˆ™

å°†ç›¸å…³çš„æ“ä½œåˆå¹¶åˆ°ä¸€ä¸ª RUN æŒ‡ä»¤ä¸­ï¼Œå‡å°‘é•œåƒå±‚æ•°ã€‚

```dockerfile
# ä¸å¥½çš„åšæ³•
RUN apt-get update
RUN apt-get install -y python3
RUN apt-get install -y pip
RUN pip install flask

# å¥½çš„åšæ³•
RUN apt-get update && \
    apt-get install -y python3 pip && \
    pip install flask && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*
```

### æ³¨æ„äº‹é¡¹

- ä½¿ç”¨ `&&` è¿æ¥å‘½ä»¤ï¼Œç¡®ä¿å‰ä¸€ä¸ªå‘½ä»¤æˆåŠŸæ‰æ‰§è¡Œä¸‹ä¸€ä¸ª
- ä½¿ç”¨ `\` è¿›è¡Œæ¢è¡Œï¼Œæé«˜å¯è¯»æ€§
- åœ¨æœ€åæ¸…ç†ç¼“å­˜å’Œä¸´æ—¶æ–‡ä»¶

---

## æ¸…ç†ä¸å¿…è¦çš„æ–‡ä»¶

### æ¸…ç†åŒ…ç®¡ç†å™¨ç¼“å­˜

```dockerfile
# Debian/Ubuntu
RUN apt-get update && \
    apt-get install -y nginx && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# CentOS/RHEL
RUN yum install -y nginx && \
    yum clean all && \
    rm -rf /var/cache/yum

# Alpine
RUN apk add --no-cache nginx && \
    rm -rf /var/cache/apk/*
```

### æ¸…ç†æ„å»ºä¾èµ–

```dockerfile
# å¤šé˜¶æ®µæ„å»ºä¸­ï¼Œåªä¿ç•™è¿è¡Œæ—¶éœ€è¦çš„æ–‡ä»¶
FROM node:16 AS builder
WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
RUN npm run build

FROM nginx:alpine
# åªå¤åˆ¶æ„å»ºäº§ç‰©ï¼Œä¸å¤åˆ¶ node_modules
COPY --from=builder /app/dist /usr/share/nginx/html
```

### åˆ é™¤ä¸´æ—¶æ–‡ä»¶

```dockerfile
RUN wget https://example.com/file.tar.gz && \
    tar -xzf file.tar.gz && \
    rm file.tar.gz  # åˆ é™¤ä¸‹è½½çš„å‹ç¼©åŒ…
```

---

## ä½¿ç”¨å¤šé˜¶æ®µæ„å»º

### åŸºæœ¬è¯­æ³•

```dockerfile
# æ„å»ºé˜¶æ®µ
FROM node:16 AS builder
WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
RUN npm run build

# è¿è¡Œé˜¶æ®µ
FROM nginx:alpine
COPY --from=builder /app/dist /usr/share/nginx/html
```

### ä¼˜åŠ¿

1. **å‡å°é•œåƒä½“ç§¯**ï¼šåªä¿ç•™è¿è¡Œæ—¶éœ€è¦çš„æ–‡ä»¶
2. **æé«˜å®‰å…¨æ€§**ï¼šä¸åŒ…å«æ„å»ºå·¥å…·å’Œæºä»£ç 
3. **ä¼˜åŒ–æ„å»ºç¼“å­˜**ï¼šæ„å»ºé˜¶æ®µå’Œè¿è¡Œé˜¶æ®µåˆ†ç¦»

### å¤šé˜¶æ®µæ„å»ºç¤ºä¾‹

```dockerfile
# Go åº”ç”¨å¤šé˜¶æ®µæ„å»º
FROM golang:1.18 AS builder
WORKDIR /app
COPY go.mod go.sum ./
RUN go mod download
COPY . .
RUN CGO_ENABLED=0 GOOS=linux go build -o app .

FROM alpine:latest
RUN apk --no-cache add ca-certificates
WORKDIR /root/
COPY --from=builder /app/app .
CMD ["./app"]
```

---

## é•œåƒå¤§å°åˆ†æå·¥å…·

### docker history

æŸ¥çœ‹é•œåƒå„å±‚å¤§å°ã€‚

```bash
# æŸ¥çœ‹é•œåƒæ„å»ºå†å²
docker history nginx:latest

# äººç±»å¯è¯»æ ¼å¼
docker history --human nginx:latest

# ä¸æˆªæ–­è¾“å‡º
docker history --no-trunc nginx:latest
```

### docker images

æŸ¥çœ‹é•œåƒæ€»å¤§å°ã€‚

```bash
# æŸ¥çœ‹æ‰€æœ‰é•œåƒå¤§å°
docker images

# æŒ‰å¤§å°æ’åº
docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}" | sort -k3 -h
```

### dive

ç¬¬ä¸‰æ–¹å·¥å…·ï¼Œå¯è§†åŒ–åˆ†æé•œåƒå±‚ã€‚

```bash
# å®‰è£… dive
brew install dive  # macOS
# æˆ–
wget https://github.com/wagoodman/dive/releases/download/v0.10.0/dive_0.10.0_linux_amd64.tar.gz

# ä½¿ç”¨ dive åˆ†æé•œåƒ
dive nginx:latest
```

### docker system df

æŸ¥çœ‹ Docker ç³»ç»Ÿå ç”¨ç©ºé—´ã€‚

```bash
# æŸ¥çœ‹ç©ºé—´ä½¿ç”¨æƒ…å†µ
docker system df

# è¯¦ç»†æŸ¥çœ‹
docker system df -v
```

---

## ä¼˜åŒ–å®è·µæ¡ˆä¾‹

### Node.js åº”ç”¨ä¼˜åŒ–

#### ä¼˜åŒ–å‰

```dockerfile
FROM node:16
WORKDIR /app
COPY . .
RUN npm install
RUN npm run build
CMD ["npm", "start"]
```

**é—®é¢˜**ï¼š
- åŒ…å« node_modulesï¼ˆä½“ç§¯å¤§ï¼‰
- åŒ…å«æºä»£ç 
- åŒ…å«æ„å»ºå·¥å…·

#### ä¼˜åŒ–å

```dockerfile
# æ„å»ºé˜¶æ®µ
FROM node:16 AS builder
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production
COPY . .
RUN npm run build

# è¿è¡Œé˜¶æ®µ
FROM node:16-alpine
WORKDIR /app
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/package*.json ./
CMD ["node", "dist/index.js"]
```

**ä¼˜åŒ–æ•ˆæœ**ï¼š
- ä½¿ç”¨ Alpine åŸºç¡€é•œåƒ
- åˆ†ç¦»æ„å»ºå’Œè¿è¡Œç¯å¢ƒ
- åªä¿ç•™è¿è¡Œæ—¶éœ€è¦çš„æ–‡ä»¶

### Python åº”ç”¨ä¼˜åŒ–

#### ä¼˜åŒ–å‰

```dockerfile
FROM python:3.9
WORKDIR /app
COPY . .
RUN pip install -r requirements.txt
CMD ["python", "app.py"]
```

#### ä¼˜åŒ–å

```dockerfile
FROM python:3.9-slim
WORKDIR /app
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt
COPY . .
CMD ["python", "app.py"]
```

**ä¼˜åŒ–ç‚¹**ï¼š
- ä½¿ç”¨ slim ç‰ˆæœ¬
- ä½¿ç”¨ `--no-cache-dir` ä¸ç¼“å­˜ pip åŒ…
- å…ˆå¤åˆ¶ requirements.txtï¼Œåˆ©ç”¨ç¼“å­˜

---

## å…¶ä»–ä¼˜åŒ–æŠ€å·§

### 1. ä½¿ç”¨ç‰¹å®šæ ‡ç­¾

```dockerfile
# å¥½çš„åšæ³•ï¼šä½¿ç”¨å…·ä½“ç‰ˆæœ¬
FROM node:16.14.2-alpine

# ä¸å¥½çš„åšæ³•ï¼šä½¿ç”¨ latest
FROM node:latest
```

### 2. æœ€å°åŒ–æ–‡ä»¶å¤åˆ¶

```dockerfile
# åªå¤åˆ¶å¿…è¦çš„æ–‡ä»¶
COPY package.json package-lock.json ./
COPY src/ ./src/
# è€Œä¸æ˜¯ COPY . .
```

### 3. ä½¿ç”¨ .dockerignore

æ’é™¤ä¸å¿…è¦çš„æ–‡ä»¶ï¼Œå‡å°æ„å»ºä¸Šä¸‹æ–‡ã€‚

```dockerignore
node_modules/
.git/
*.md
test/
.env
```

### 4. å‹ç¼©æ–‡ä»¶ç³»ç»Ÿ

```dockerfile
# ä½¿ç”¨å‹ç¼©å·¥å…·
RUN tar -czf /tmp/data.tar.gz /data && \
    rm -rf /data && \
    mkdir /data && \
    tar -xzf /tmp/data.tar.gz -C /data && \
    rm /tmp/data.tar.gz
```

---

## ä¼˜åŒ–æ£€æŸ¥æ¸…å•

- [ ] ä½¿ç”¨ Alpine æˆ– slim åŸºç¡€é•œåƒ
- [ ] åˆå¹¶ RUN æŒ‡ä»¤å‡å°‘å±‚æ•°
- [ ] æ¸…ç†åŒ…ç®¡ç†å™¨ç¼“å­˜
- [ ] ä½¿ç”¨å¤šé˜¶æ®µæ„å»º
- [ ] åˆ é™¤ä¸´æ—¶æ–‡ä»¶å’Œæ„å»ºä¾èµ–
- [ ] ä½¿ç”¨ .dockerignore æ’é™¤ä¸å¿…è¦æ–‡ä»¶
- [ ] ä½¿ç”¨ç‰¹å®šç‰ˆæœ¬æ ‡ç­¾è€Œé latest
- [ ] åªå¤åˆ¶å¿…è¦çš„æ–‡ä»¶
- [ ] åˆ†æé•œåƒå¤§å°ï¼Œæ‰¾å‡ºå ç”¨å¤§çš„å±‚

---

## ğŸ“š å‚è€ƒèµ„æº

- [Docker å®˜æ–¹æ–‡æ¡£ - æœ€ä½³å®è·µ](https://docs.docker.com/develop/dev-best-practices/)
- [Docker é•œåƒä¼˜åŒ–æŒ‡å—](https://docs.docker.com/build/guide/)
- [dive å·¥å…·](https://github.com/wagoodman/dive)

---

[[!MOC-Docker|è¿”å› Docker çŸ¥è¯†ä½“ç³»]]

#Docker #é•œåƒä¼˜åŒ– #æ€§èƒ½ä¼˜åŒ–
