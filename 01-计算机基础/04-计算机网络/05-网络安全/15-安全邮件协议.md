# å®‰å…¨é‚®ä»¶åè®®ï¼ˆSecure Email Protocolsï¼‰

> å®‰å…¨é‚®ä»¶åè®®æä¾›ç”µå­é‚®ä»¶çš„åŠ å¯†ã€ç­¾åå’Œè®¤è¯åŠŸèƒ½ï¼Œç¡®ä¿é‚®ä»¶é€šä¿¡çš„æœºå¯†æ€§ã€å®Œæ•´æ€§å’ŒçœŸå®æ€§

---

## å®‰å…¨é‚®ä»¶æ¦‚è¿°

ç”µå­é‚®ä»¶åœ¨è®¾è®¡ä¹‹åˆç¼ºä¹å®‰å…¨æœºåˆ¶ï¼Œå®‰å…¨é‚®ä»¶åè®®é€šè¿‡åŠ å¯†å’Œç­¾åæŠ€æœ¯ä¸ºé‚®ä»¶ç³»ç»Ÿæä¾›å®‰å…¨ä¿æŠ¤ã€‚

### é‚®ä»¶å®‰å…¨éœ€æ±‚

1. **æœºå¯†æ€§**ï¼šé˜²æ­¢æœªæˆæƒè®¿é—®é‚®ä»¶å†…å®¹
2. **å®Œæ•´æ€§**ï¼šç¡®ä¿é‚®ä»¶å†…å®¹æœªè¢«ç¯¡æ”¹
3. **è®¤è¯**ï¼šéªŒè¯å‘ä»¶äººèº«ä»½
4. **ä¸å¯å¦è®¤**ï¼šé˜²æ­¢å‘ä»¶äººå¦è®¤å‘é€é‚®ä»¶
5. **ä¼ è¾“å®‰å…¨**ï¼šä¿æŠ¤é‚®ä»¶ä¼ è¾“è¿‡ç¨‹

### é‚®ä»¶æ”»å‡»ç±»å‹

- **çªƒå¬**ï¼šæˆªè·é‚®ä»¶å†…å®¹
- **ç¯¡æ”¹**ï¼šä¿®æ”¹é‚®ä»¶å†…å®¹
- **ä¼ªé€ **ï¼šä¼ªé€ å‘ä»¶äººèº«ä»½
- **é‡æ”¾**ï¼šé‡å¤å‘é€é‚®ä»¶
- **åƒåœ¾é‚®ä»¶**ï¼šå¤§é‡å‘é€åƒåœ¾é‚®ä»¶

---

## S/MIMEåè®®

S/MIMEï¼ˆSecure/Multipurpose Internet Mail Extensionsï¼‰æ˜¯åŸºäºå…¬é’¥å¯†ç å­¦çš„é‚®ä»¶å®‰å…¨æ ‡å‡†ã€‚

### S/MIMEæ¶æ„

```
é‚®ä»¶å‘é€æµç¨‹ï¼š
åŸå§‹é‚®ä»¶
    â”‚
    â–¼
[ç­¾å/åŠ å¯†]
    â”‚
    â–¼
S/MIMEé‚®ä»¶
    â”‚
    â–¼
[ä¼ è¾“]
    â”‚
    â–¼
S/MIMEé‚®ä»¶
    â”‚
    â–¼
[è§£å¯†/éªŒè¯]
    â”‚
    â–¼
åŸå§‹é‚®ä»¶
```

### S/MIMEåŠŸèƒ½

#### æ•°å­—ç­¾å

1. **é‚®ä»¶å“ˆå¸Œ**ï¼šè®¡ç®—é‚®ä»¶å†…å®¹çš„å“ˆå¸Œå€¼
2. **ç§é’¥ç­¾å**ï¼šç”¨å‘ä»¶äººç§é’¥ç­¾åå“ˆå¸Œå€¼
3. **é™„åŠ ç­¾å**ï¼šå°†ç­¾åé™„åŠ åˆ°é‚®ä»¶
4. **éªŒè¯**ï¼šæ”¶ä»¶äººç”¨å‘ä»¶äººå…¬é’¥éªŒè¯ç­¾å

#### åŠ å¯†

1. **ç”Ÿæˆå¯†é’¥**ï¼šç”Ÿæˆéšæœºå¯¹ç§°å¯†é’¥
2. **å¯¹ç§°åŠ å¯†**ï¼šç”¨å¯¹ç§°å¯†é’¥åŠ å¯†é‚®ä»¶å†…å®¹
3. **å¯†é’¥åŠ å¯†**ï¼šç”¨æ”¶ä»¶äººå…¬é’¥åŠ å¯†å¯¹ç§°å¯†é’¥
4. **ç»„åˆ**ï¼šç»„åˆåŠ å¯†é‚®ä»¶å’ŒåŠ å¯†å¯†é’¥

### S/MIMEè¯ä¹¦

#### è¯ä¹¦ç±»å‹

- **ä¸ªäººè¯ä¹¦**ï¼šç”¨äºä¸ªäººé‚®ä»¶ç­¾åå’ŒåŠ å¯†
- **ä¼ä¸šè¯ä¹¦**ï¼šç”¨äºä¼ä¸šé‚®ä»¶ç­¾åå’ŒåŠ å¯†
- **CAè¯ä¹¦**ï¼šç”¨äºéªŒè¯å…¶ä»–è¯ä¹¦

#### è¯ä¹¦ç”³è¯·

```
è¯ä¹¦ç”³è¯·æµç¨‹ï¼š
1. ç”Ÿæˆå¯†é’¥å¯¹
2. åˆ›å»ºè¯ä¹¦è¯·æ±‚(CSR)
3. å‘CAæäº¤CSR
4. CAéªŒè¯èº«ä»½
5. CAç­¾å‘è¯ä¹¦
6. å®‰è£…è¯ä¹¦
```

#### è¯ä¹¦æ ¼å¼

- **PEM**ï¼šBase64ç¼–ç æ ¼å¼
- **DER**ï¼šäºŒè¿›åˆ¶ç¼–ç æ ¼å¼
- **PFX/P12**ï¼šåŒ…å«ç§é’¥çš„è¯ä¹¦æ ¼å¼

### S/MIMEå®ç°

#### Outlooké…ç½®

1. è·å–å¹¶å®‰è£…è¯ä¹¦
2. é…ç½®ä¿¡ä»»è®¾ç½®
3. è®¾ç½®é»˜è®¤å®‰å…¨é€‰é¡¹
4. å¯ç”¨/ç¦ç”¨ç­¾åå’ŒåŠ å¯†

#### Thunderbirdé…ç½®

1. æ‰“å¼€è´¦æˆ·è®¾ç½®
2. é€‰æ‹©å®‰å…¨é€‰é¡¹
3. å¯¼å…¥è¯ä¹¦
4. é…ç½®ç­¾åå’ŒåŠ å¯†

---

## PGPåè®®

PGPï¼ˆPretty Good Privacyï¼‰æ˜¯å¦ä¸€ç§æµè¡Œçš„é‚®ä»¶å®‰å…¨åè®®ï¼ŒåŸºäºä¿¡ä»»ç½‘ç»œæ¨¡å‹ã€‚

### PGPå†å²

```
1991: Phil Zimmermannå‘å¸ƒPGP 1.0
1993: PGP 2.0å‘å¸ƒ
1997: PGP 5.0å‘å¸ƒï¼ˆå•†ä¸šç‰ˆæœ¬ï¼‰
1997: GnuPGï¼ˆGPGï¼‰é¡¹ç›®å¯åŠ¨
2007: OpenPGPæ ‡å‡†(RFC 4880)å‘å¸ƒ
```

### PGP vs S/MIME

| ç‰¹æ€§ | S/MIME | PGP |
|------|--------|-----|
| è¯ä¹¦æ¨¡å‹ | å±‚æ¬¡CA | ä¿¡ä»»ç½‘ç»œ |
| å¯†é’¥ç®¡ç† | é›†ä¸­ | å»ä¸­å¿ƒåŒ– |
| æ˜“ç”¨æ€§ | å¥½ | ä¸­ç­‰ |
| æ ‡å‡†åŒ–ç¨‹åº¦ | é«˜ | é«˜ |
| å•†ä¸šæ”¯æŒ | å¤š | è¾ƒå°‘ |

### PGPæ“ä½œ

#### å¯†é’¥ç”Ÿæˆ

```bash
# GPGå¯†é’¥ç”Ÿæˆ
gpg --full-generate-key

# é€‰æ‹©å¯†é’¥ç±»å‹
# RSA and RSA (default)
# å¯†é’¥é•¿åº¦: 4096
# æœ‰æ•ˆæœŸ: 0 (æ°¸ä¸è¿‡æœŸ)
# ç”¨æˆ·ä¿¡æ¯: Name, Email, Comment
```

#### å¯†é’¥ç®¡ç†

```bash
# åˆ—å‡ºå¯†é’¥
gpg --list-keys
gpg --list-secret-keys

# å¯¼å‡ºå…¬é’¥
gpg --armor --export user@example.com > public_key.asc

# å¯¼å…¥å¯†é’¥
gpg --import public_key.asc

# ä¿¡ä»»å¯†é’¥
gpg --edit-key user@example.com
> trust
> 5 (I trust ultimately)
> save
```

#### é‚®ä»¶æ“ä½œ

```bash
# ç­¾åé‚®ä»¶
gpg --clearsign message.txt > signed_message.txt

# åŠ å¯†é‚®ä»¶
gpg --encrypt --sign -r recipient@example.com message.txt

# è§£å¯†é‚®ä»¶
gpg --decrypt encrypted_message.gpg

# éªŒè¯ç­¾å
gpg --verify signed_message.txt
```

---

## é‚®ä»¶ä¼ è¾“å®‰å…¨

### SMTPå®‰å…¨

#### STARTTLS

åœ¨SMTPè¿æ¥ä¸Šå¯åŠ¨TLSåŠ å¯†ã€‚

```
SMTPä¼šè¯æµç¨‹ï¼š
EHLO client.example.com
250-STARTTLS
250 OK
STARTTLS
220 Ready to start TLS
[TLSæ¡æ‰‹å¼€å§‹]
[åŠ å¯†ä¼ è¾“]
```

#### SMTPS

ä½¿ç”¨SSL/TLSçš„SMTPåè®®ï¼ˆç«¯å£465ï¼‰ã€‚

#### é…ç½®ç¤ºä¾‹

```bash
# Postfixé…ç½®
# /etc/postfix/main.cf
smtp_tls_security_level = encrypt
smtpd_tls_security_level = encrypt
smtp_tls_note_starttls_offer = yes
smtpd_tls_received_header = yes
smtpd_tls_cert_file = /etc/ssl/certs/server.crt
smtpd_tls_key_file = /etc/ssl/private/server.key
```

### IMAP/POP3å®‰å…¨

#### IMAPS/POP3S

ä½¿ç”¨SSL/TLSçš„IMAP/POP3åè®®ï¼ˆç«¯å£993/995ï¼‰ã€‚

#### é…ç½®ç¤ºä¾‹

```bash
# Dovecoté…ç½®
# /etc/dovecot/dovecot.conf
ssl = required
ssl_cert = </etc/ssl/certs/dovecot.pem
ssl_key = </etc/ssl/private/dovecot.pem
ssl_ca = </etc/ssl/certs/ca.pem
```

---

## DKIMå’ŒDMARC

### DKIMï¼ˆDomainKeys Identified Mailï¼‰

DKIMæä¾›é‚®ä»¶åŸŸç­¾åéªŒè¯ï¼Œé˜²æ­¢åŸŸåä¼ªé€ ã€‚

#### DKIMå·¥ä½œåŸç†

1. **ç­¾å**ï¼šå‘é€æœåŠ¡å™¨ç”¨ç§é’¥ç­¾åé‚®ä»¶å¤´éƒ¨
2. **å‘å¸ƒ**ï¼šå‘é€æœåŠ¡å™¨å‘å¸ƒå…¬é’¥åˆ°DNS
3. **éªŒè¯**ï¼šæ¥æ”¶æœåŠ¡å™¨è·å–å…¬é’¥éªŒè¯ç­¾å

#### DKIMç­¾åç»“æ„

```
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
  d=example.com; s=selector; t=1642586400;
  h=from:to:subject:date;
  bh=base64(body hash);
  b=base64(signature)
```

#### é…ç½®ç¤ºä¾‹

```bash
# OpenDKIMé…ç½®
# /etc/opendkim.conf
Domain example.com
KeyFile /etc/opendkim/keys/example.com.selector.private
Selector selector
SOCKET inet:12345@localhost

# DNSè®°å½•
selector._domainkey.example.com IN TXT "v=DKIM1; k=rsa; p=public_key"
```

### DMARCï¼ˆDomain-based Message Authentication, Reporting, and Conformanceï¼‰

DMARCåŸºäºSPFå’ŒDKIMæä¾›åŸŸçº§åˆ«è®¤è¯ç­–ç•¥ã€‚

#### DMARCè®°å½•

```
_dmarc.example.com IN TXT "v=DMARC1; p=quarantine; rua=mailto:dmarc@example.com"
```

#### DMARCå‚æ•°

- **v=DMARC1**ï¼šç‰ˆæœ¬
- **p=none|quarantine|reject**ï¼šå¤„ç†ç­–ç•¥
- **rua**ï¼šèšåˆæŠ¥å‘Šé‚®ç®±
- **ruf**ï¼šå–è¯æŠ¥å‘Šé‚®ç®±
- **pct**ï¼šåº”ç”¨ç­–ç•¥çš„é‚®ä»¶ç™¾åˆ†æ¯”

---

## é‚®ä»¶å®‰å…¨æœ€ä½³å®è·µ

### 1. é‚®ä»¶åŠ å¯†

#### ç«¯åˆ°ç«¯åŠ å¯†

```bash
# ä½¿ç”¨S/MIMEåŠ å¯†é‚®ä»¶
1. è·å–æ”¶ä»¶äººè¯ä¹¦
2. åŠ å¯†é‚®ä»¶å†…å®¹
3. å‘é€åŠ å¯†é‚®ä»¶

# ä½¿ç”¨PGPåŠ å¯†é‚®ä»¶
1. è·å–æ”¶ä»¶äººå…¬é’¥
2. åŠ å¯†é‚®ä»¶å†…å®¹
3. å‘é€åŠ å¯†é‚®ä»¶
```

#### ä¼ è¾“åŠ å¯†

```bash
# é…ç½®é‚®ä»¶æœåŠ¡å™¨ä½¿ç”¨TLS
smtp_tls_security_level = encrypt
smtpd_tls_security_level = encrypt
```

### 2. é‚®ä»¶ç­¾å

#### S/MIMEç­¾å

```bash
# Outlooké…ç½®
1. å®‰è£…æ•°å­—è¯ä¹¦
2. å¯ç”¨"ä¸ºæ‰€æœ‰å¾…å‘é‚®ä»¶æ·»åŠ æ•°å­—ç­¾å"
3. å‘é€é‚®ä»¶
```

#### PGPç­¾å

```bash
# ä½¿ç”¨GPGç­¾å
gpg --clearsign message.txt
```

### 3. ååƒåœ¾é‚®ä»¶

#### SPFï¼ˆSender Policy Frameworkï¼‰

```dns
example.com IN TXT "v=spf1 mx -all"
```

#### ååƒåœ¾é‚®ä»¶é…ç½®

```bash
# Postfixååƒåœ¾é‚®ä»¶é…ç½®
# /etc/postfix/main.cf
smtpd_recipient_restrictions = 
  permit_mynetworks,
  permit_sasl_authenticated,
  reject_unauth_destination,
  reject_unknown_sender_domain,
  reject_rbl_client zen.spamhaus.org
```

---

## é‚®ä»¶å®‰å…¨è§£å†³æ–¹æ¡ˆ

### 1. ä¼ä¸šé‚®ä»¶ç½‘å…³

#### åŠŸèƒ½ç‰¹ç‚¹

- **åƒåœ¾é‚®ä»¶è¿‡æ»¤**ï¼šè¯†åˆ«å’Œè¿‡æ»¤åƒåœ¾é‚®ä»¶
- **æ¶æ„è½¯ä»¶é˜²æŠ¤**ï¼šæ‰«æé™„ä»¶å’Œé“¾æ¥
- **æ•°æ®ä¸¢å¤±é˜²æŠ¤**ï¼šé˜²æ­¢æ•æ„Ÿæ•°æ®æ³„éœ²
- **åŠ å¯†ç­–ç•¥**ï¼šè‡ªåŠ¨åŠ å¯†æ•æ„Ÿé‚®ä»¶

#### ä¸»è¦äº§å“

- **Microsoft Exchange Online Protection**
- **Mimecast Email Security**
- **Proofpoint Email Protection**
- **Cisco Email Security**

### 2. é‚®ä»¶åŠ å¯†æœåŠ¡

#### äº‘ç«¯åŠ å¯†

- **Virtru**ï¼šåŸºäºç­–ç•¥çš„é‚®ä»¶åŠ å¯†
- **Zix**ï¼šä¼ä¸šé‚®ä»¶åŠ å¯†
- **Inky**ï¼šå®‰å…¨é‚®ä»¶å®¢æˆ·ç«¯

#### ç«¯åˆ°ç«¯åŠ å¯†

- **ProtonMail**ï¼šåŠ å¯†é‚®ä»¶æœåŠ¡
- **Tutanota**ï¼šç«¯åˆ°ç«¯åŠ å¯†é‚®ä»¶
- **Mailvelope**ï¼šæµè§ˆå™¨é‚®ä»¶åŠ å¯†

---

## é‚®ä»¶å®‰å…¨æ•…éšœæ’æŸ¥

### 1. è¯ä¹¦é—®é¢˜

#### è¯ä¹¦éªŒè¯å¤±è´¥

```bash
# æ£€æŸ¥è¯ä¹¦
openssl s_client -connect mail.example.com:587 -starttls smtp

# éªŒè¯è¯ä¹¦é“¾
openssl verify -CAfile ca.pem cert.pem
```

#### S/MIMEè¯ä¹¦é—®é¢˜

```bash
# æ£€æŸ¥è¯ä¹¦æœ‰æ•ˆæœŸ
openssl x509 -in cert.pem -noout -dates

# éªŒè¯è¯ä¹¦é“¾
openssl verify -CAfile ca.pem intermediate.pem cert.pem
```

### 2. é…ç½®é—®é¢˜

#### é‚®ä»¶æœåŠ¡å™¨æµ‹è¯•

```bash
# æµ‹è¯•SMTPè¿æ¥
telnet mail.example.com 587
EHLO test.example.com
STARTTLS

# æµ‹è¯•TLSç‰ˆæœ¬
nmap --script ssl-enum-ciphers -p 587 mail.example.com
```

#### DKIMæµ‹è¯•

```bash
# æµ‹è¯•DKIMç­¾å
opendkim-testkey -d example.com -s selector -k /path/to/private.key
```

---

## é‚®ä»¶å®‰å…¨æœªæ¥è¶‹åŠ¿

### 1. åŠ å¯†æŠ€æœ¯å‘å±•

#### åé‡å­å¯†ç 

- **åé‡å­å¯†é’¥äº¤æ¢**ï¼šæŠµå¾¡é‡å­æ”»å‡»
- **æ··åˆåŠ å¯†**ï¼šç»å…¸ä¸é‡å­ç®—æ³•ç»“åˆ
- **æ ‡å‡†åŒ–è¿›ç¨‹**ï¼šæ¨åŠ¨åé‡å­æ ‡å‡†

#### ç«¯åˆ°ç«¯åŠ å¯†

- **é»˜è®¤åŠ å¯†**ï¼šé‚®ä»¶é»˜è®¤ç«¯åˆ°ç«¯åŠ å¯†
- **é›¶çŸ¥è¯†è¯æ˜**ï¼šéšç§ä¿æŠ¤æŠ€æœ¯
- **åŒæ€åŠ å¯†**ï¼šäº‘ç«¯åŠ å¯†å¤„ç†

### 2. èº«ä»½éªŒè¯å‘å±•

#### æ— å¯†ç è®¤è¯

- **FIDO/WebAuthn**ï¼šç”Ÿç‰©è¯†åˆ«è®¤è¯
- **å¤šå› ç´ è®¤è¯**ï¼šæ›´å®‰å…¨çš„2FA
- **è¿ç»­è®¤è¯**ï¼šæŒç»­éªŒè¯èº«ä»½

#### å»ä¸­å¿ƒåŒ–èº«ä»½

- **åŒºå—é“¾èº«ä»½**ï¼šåŸºäºDIDçš„èº«ä»½ç³»ç»Ÿ
- **è‡ªç®¡ç†èº«ä»½**ï¼šç”¨æˆ·æ§åˆ¶çš„èº«ä»½
- **å¯éªŒè¯å‡­è¯**ï¼šå¯éªŒè¯çš„æ•°å­—å‡­è¯

### 3. é‚®ä»¶å®‰å…¨ç­–ç•¥

#### é›¶ä¿¡ä»»é‚®ä»¶

- **æŒç»­éªŒè¯**ï¼šæ¯æ¬¡è®¿é—®éƒ½éªŒè¯
- **æœ€å°æƒé™**ï¼šæœ€å°å¿…è¦æƒé™
- **å¾®åˆ†æ®µ**ï¼šç»†ç²’åº¦è®¿é—®æ§åˆ¶

---

## ğŸ”— ç›¸å…³é“¾æ¥

- [ç½‘ç»œå®‰å…¨åŸºç¡€](./01-ç½‘ç»œå®‰å…¨åŸºç¡€.md)
- [å¯¹ç§°åŠ å¯†](./04-å¯¹ç§°åŠ å¯†.md)
- [éå¯¹ç§°åŠ å¯†](./05-éå¯¹ç§°åŠ å¯†.md)
- [æ•°å­—ç­¾å](./07-æ•°å­—ç­¾å.md)

---

**æœ€åæ›´æ–°**ï¼š2025-01-26
**ç»´æŠ¤è§„èŒƒ**ï¼šè¯¦è§ [ç¬”è®°è§„èŒƒæ–‡æ¡£](../../../../../.cursorrules)

#é‚®ä»¶å®‰å…¨ #S/MIME #PGP #DKIM #é‚®ä»¶åŠ å¯†