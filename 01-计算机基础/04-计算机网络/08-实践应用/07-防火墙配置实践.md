# é˜²ç«å¢™é…ç½®å®è·µï¼ˆFirewall Configuration Practiceï¼‰

> é€šè¿‡å®é™…æ¡ˆä¾‹å­¦ä¹ å¦‚ä½•é…ç½®å’Œç®¡ç†å„ç§é˜²ç«å¢™ï¼ŒåŒ…æ‹¬ä¼ä¸šçº§é˜²ç«å¢™å’Œä¸ªäººé˜²ç«å¢™

---

## é˜²ç«å¢™é…ç½®æ¦‚è¿°

é˜²ç«å¢™æ˜¯ç½‘ç»œå®‰å…¨çš„ç¬¬ä¸€é“é˜²çº¿ï¼Œæ­£ç¡®é…ç½®é˜²ç«å¢™å¯¹ä¿æŠ¤ç½‘ç»œå®‰å…¨è‡³å…³é‡è¦ã€‚æœ¬ç« èŠ‚é€šè¿‡å®é™…æ¡ˆä¾‹æ¼”ç¤ºé˜²ç«å¢™çš„é…ç½®å’Œç®¡ç†ã€‚

### é˜²ç«å¢™ç±»å‹

- **ç½‘ç»œå±‚é˜²ç«å¢™**ï¼šåŸºäºIPåœ°å€ã€ç«¯å£è¿‡æ»¤
- **åº”ç”¨å±‚é˜²ç«å¢™**ï¼šåŸºäºåº”ç”¨å†…å®¹è¿‡æ»¤
- **çŠ¶æ€æ£€æµ‹é˜²ç«å¢™**ï¼šè·Ÿè¸ªè¿æ¥çŠ¶æ€
- **ä¸‹ä¸€ä»£é˜²ç«å¢™**ï¼šé›†æˆå¤šç§å®‰å…¨åŠŸèƒ½

### é…ç½®åŸåˆ™

1. **æœ€å°æƒé™åŸåˆ™**ï¼šåªå…è®¸å¿…è¦æµé‡é€šè¿‡
2. **é»˜è®¤æ‹’ç»**ï¼šé»˜è®¤æ‹’ç»æ‰€æœ‰æµé‡ï¼Œæ˜ç¡®å…è®¸éœ€è¦çš„æµé‡
3. **åˆ†å±‚é˜²å¾¡**ï¼šéƒ¨ç½²å¤šé“é˜²çº¿
4. **å®šæœŸå®¡è®¡**ï¼šå®šæœŸå®¡è®¡è§„åˆ™æœ‰æ•ˆæ€§
5. **æ—¥å¿—è®°å½•**ï¼šè®°å½•æ‰€æœ‰é˜²ç«å¢™æ´»åŠ¨

---

## ä¸ªäººé˜²ç«å¢™é…ç½®

### 1. Windowsé˜²ç«å¢™é…ç½®

#### åŸºæœ¬è®¾ç½®

```powershell
# æŸ¥çœ‹é˜²ç«å¢™çŠ¶æ€
Get-NetFirewallProfile

# å¯ç”¨é˜²ç«å¢™
Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled True

# å…è®¸åº”ç”¨é€šè¿‡é˜²ç«å¢™
New-NetFirewallRule -DisplayName "MyApp" -Direction Inbound -Program "C:\MyApp\MyApp.exe" -Action Allow -Protocol TCP -LocalPort 8080

# å…è®¸ç«¯å£
New-NetFirewallRule -DisplayName "Allow HTTP" -Direction Inbound -Protocol TCP -LocalPort 80 -Action Allow
```

#### é«˜çº§é…ç½®

```powershell
# åˆ›å»ºå…¥ç«™è§„åˆ™
New-NetFirewallRule -DisplayName "Block Malicious IP" -Direction Inbound -RemoteAddress 192.168.100.0/24 -Action Block

# åˆ›å»ºå‡ºç«™è§„åˆ™
New-NetFirewallRule -DisplayName "Restrict Outbound" -Direction Outbound -RemoteAddress 10.0.0.0/8 -Action Block

# è®¾ç½®æ—¥å¿—
Set-NetFirewallProfile -Profile Domain -LogFileName "%systemroot%\system32\LogFiles\Firewall\pfirewall.log" -LogMaxSize 4096 -LogAllowed True -LogBlocked True
```

### 2. Linuxé˜²ç«å¢™é…ç½®

#### iptablesé…ç½®

```bash
# æŸ¥çœ‹å½“å‰è§„åˆ™
iptables -L -n -v

# æ¸…ç©ºæ‰€æœ‰è§„åˆ™
iptables -F
iptables -X
iptables -t nat -F

# è®¾ç½®é»˜è®¤ç­–ç•¥
iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT ACCEPT

# å…è®¸æœ¬åœ°å›ç¯
iptables -A INPUT -i lo -j ACCEPT

# å…è®¸å·²å»ºç«‹è¿æ¥
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# å…è®¸SSH
iptables -A INPUT -p tcp --dport 22 -j ACCEPT

# å…è®¸HTTP/HTTPS
iptables -A INPUT -p tcp --dport 80 -j ACCEPT
iptables -A INPUT -p tcp --dport 443 -j ACCEPT

# è®°å½•å¹¶æ‹’ç»å…¶ä»–
iptables -A INPUT -j LOG --log-prefix "iptables-drop: "
iptables -A INPUT -j DROP

# ä¿å­˜è§„åˆ™
iptables-save > /etc/iptables/rules.v4
```

#### UFWé…ç½®

```bash
# å¯ç”¨UFW
ufw enable

# è®¾ç½®é»˜è®¤ç­–ç•¥
ufw default deny incoming
ufw default allow outgoing

# å…è®¸SSH
ufw allow 22/tcp

# å…è®¸HTTP/HTTPS
ufw allow 80/tcp
ufw allow 443/tcp

# é™åˆ¶SSHå°è¯•
ufw limit 22/tcp

# æŸ¥çœ‹çŠ¶æ€
ufw status verbose

# åˆ é™¤è§„åˆ™
ufw delete allow 80/tcp
```

---

## ä¼ä¸šçº§é˜²ç«å¢™é…ç½®

### 1. Cisco ASAé˜²ç«å¢™é…ç½®

#### åŸºæœ¬é…ç½®

```cisco
# é…ç½®ä¸»æœºåå’ŒåŸŸå
hostname ASA-5505
domain-name example.com

# é…ç½®æ¥å£
interface Ethernet0/0
 nameif outside
 security-level 0
 ip address 203.0.113.1 255.255.255.0
!
interface Ethernet0/1
 nameif inside
 security-level 100
 ip address 192.168.1.1 255.255.255.0

# é…ç½®NAT
nat (inside,outside) source dynamic any interface

# é…ç½®è®¿é—®è§„åˆ™
access-list OUTSIDE_IN extended permit tcp any host 203.0.113.10 eq 80
access-list OUTSIDE_IN extended permit tcp any host 203.0.113.10 eq 443
access-group OUTSIDE_IN in interface outside

# é…ç½®é»˜è®¤è·¯ç”±
route outside 0.0.0.0 0.0.0.0 203.0.113.254

# ä¿å­˜é…ç½®
write memory
```

#### é«˜çº§é…ç½®

```cisco
# é…ç½®å¯¹è±¡
object network OBJ_WEB_SERVER
 host 192.168.1.10
 nat (inside,outside) static interface service tcp www www

# é…ç½®æœåŠ¡ç»„
object-group service HTTPS-SERVICES
 service-object tcp
  port-object eq https
  port-object eq 8080

# é…ç½®æ—¶é—´èŒƒå›´
time-range BUSINESS_HOURS
 periodic weekdays 08:00 to 18:00

# åŸºäºæ—¶é—´çš„è®¿é—®æ§åˆ¶
access-list OUTSIDE_IN extended permit tcp any object OBJ_WEB_SERVER object-group HTTPS-SERVICES time-range BUSINESS_HOURS

# é…ç½®VPN
access-list VPN_SPLIT_TUNNEL standard permit ip 192.168.1.0 255.255.255.0
group-policy DfltGrpPolicy attributes
 split-tunnel-policy tunnelspecified
 split-tunnel-network-list value VPN_SPLIT_TUNNEL
```

### 2. Palo Altoé˜²ç«å¢™é…ç½®

#### åŸºæœ¬é…ç½®

```xml
# é…ç½®æ¥å£
<interface>
  <ethernet>
    <layer3>
      <units>
        <unit>
          <name>ethernet1/1</name>
          <ip>
            <entry>
              <ip>192.168.1.1/24</ip>
            </entry>
          </ip>
          <layer3>
            <units>
              <unit>
                <name>ethernet1/1</name>
                <ip>
                  <entry>
                    <ip>203.0.113.1/24</ip>
                  </entry>
                </ip>
              </unit>
            </units>
          </layer3>
        </unit>
      </units>
    </layer3>
  </ethernet>
</interface>

# é…ç½®å®‰å…¨ç­–ç•¥
<rulebase>
  <rules>
    <entry name="Allow-Web">
      <from>
        <member>untrust</member>
      </from>
      <to>
        <member>trust</member>
      </to>
      <source>
        <member>any</member>
      </source>
      <destination>
        <member>web-servers</member>
      </destination>
      <application>
        <member>web-browsing</member>
      </application>
      <action>allow</action>
    </entry>
  </rules>
</rulebase>
```

#### é«˜çº§é…ç½®

```xml
# é…ç½®å®‰å…¨é…ç½®æ–‡ä»¶
<security>
  <profiles>
    <entry name="strict-profile">
      <virus>
        <threat>yes</threat>
        <action>default</action>
      </virus>
      <spyware>
        <threat>yes</threat>
        <action>default</action>
      </spyware>
      <vulnerability>
        <threat>yes</threat>
        <action>default</action>
      </vulnerability>
    </entry>
  </profiles>
</security>

# é…ç½®QoS
<qos>
  <profiles>
    <entry name="voip-profile">
      <class>
        <name>voice</name>
        <priority>high</priority>
        <rate-limit>
          <bandwidth>1000</bandwidth>
          <burst>125</burst>
        </rate-limit>
      </class>
    </entry>
  </profiles>
</qos>
```

---

## Webåº”ç”¨é˜²ç«å¢™é…ç½®

### 1. ModSecurityé…ç½®

#### å®‰è£…é…ç½®

```bash
# å®‰è£…ModSecurity
apt-get install libapache2-mod-security2

# å¯ç”¨æ¨¡å—
a2enmod security2
systemctl restart apache2

# é…ç½®æ–‡ä»¶ä½ç½®
/etc/modsecurity/modsecurity.conf-recommended
```

#### åŸºæœ¬é…ç½®

```apache
# å¯ç”¨ModSecurityå¼•æ“
SecRuleEngine On

# è®¾ç½®è¯·æ±‚ä½“é™åˆ¶
SecRequestBodyAccess On
SecRequestBodyLimit 13107200
SecRequestBodyNoFilesLimit 131072

# åŸºæœ¬è§„åˆ™
SecRule ARGS "@detectSQLi" \
    "id:1001,phase:2,block,msg:'SQL Injection Attack Detected',\
    tag:'application-multi',tag:'language-multi',tag:'platform-multi',\
    tag:'attack-sqli'"

SecRule ARGS "@detectXSS" \
    "id:1002,phase:2,block,msg:'XSS Attack Detected',\
    tag:'application-multi',tag:'language-multi',tag:'platform-multi',\
    tag:'attack-xss'"

# è‡ªå®šä¹‰è§„åˆ™
SecRule REQUEST_HEADERS:User-Agent "@pmFromFile user_agents.data" \
    "id:1003,phase:1,deny,status:403,msg:'Blocked Malicious User-Agent'"

SecRule ARGS "@pmFromFile bad_params.data" \
    "id:1004,phase:2,deny,status:403,msg:'Blocked Bad Parameter'"
```

### 2. Nginx + ModSecurityé…ç½®

#### å®‰è£…é…ç½®

```bash
# ç¼–è¯‘Nginxæ”¯æŒModSecurity
./configure --add-module=/path/to/ModSecurity-nginx
make && make install

# é…ç½®Nginx
server {
    listen 80;
    server_name example.com;
    
    # å¯ç”¨ModSecurity
    ModSecurityEnabled on;
    ModSecurityConfig /etc/nginx/modsecurity.conf;
    
    location / {
        root /var/www/html;
        index index.html;
    }
}
```

---

## é˜²ç«å¢™ç›‘æ§ä¸æ—¥å¿—

### 1. æ—¥å¿—åˆ†æ

#### iptablesæ—¥å¿—åˆ†æ

```bash
# å®æ—¶æŸ¥çœ‹æ—¥å¿—
tail -f /var/log/kern.log | grep "iptables-drop"

# åˆ†æè¢«æ‹’ç»çš„è¿æ¥
grep "iptables-drop" /var/log/kern.log | awk '{print $8}' | sort | uniq -c | sort -nr

# æŸ¥çœ‹ç‰¹å®šIPçš„æ´»åŠ¨
grep "iptables-drop" /var/log/kern.log | grep "192.168.1.100"
```

#### Webåº”ç”¨é˜²ç«å¢™æ—¥å¿—åˆ†æ

```bash
# ModSecurityå®¡è®¡æ—¥å¿—
tail -f /var/log/apache2/modsec_audit.log

# åˆ†ææ”»å‡»æ¨¡å¼
grep "id:\"1001\"" /var/log/apache2/modsec_audit.log | wc -l
grep "id:\"1002\"" /var/log/apache2/modsec_audit.log | wc -l
```

### 2. å®æ—¶ç›‘æ§

#### å¼€æºç›‘æ§æ–¹æ¡ˆ

```bash
# ä½¿ç”¨fail2bané˜²æ­¢æš´åŠ›ç ´è§£
apt-get install fail2ban

# é…ç½®fail2ban
cp /etc/fail2ban/jail.conf /etc/fail2ban/jail.local

# å¯ç”¨SSHä¿æŠ¤
[sshd]
enabled = true
port = ssh
filter = sshd
logpath = /var/log/auth.log
maxretry = 3
bantime = 3600

# å¯åŠ¨æœåŠ¡
systemctl start fail2ban
systemctl enable fail2ban
```

#### å•†ä¸šç›‘æ§æ–¹æ¡ˆ

- **SIEMç³»ç»Ÿ**ï¼šSplunkã€ELK Stack
- **é˜²ç«å¢™ç®¡ç†å¹³å°**ï¼šPalo Alto Panoramaã€Cisco FMC
- **äº‘å®‰å…¨å¹³å°**ï¼šAWS WAFã€Azure Firewall
- **å¨èƒæƒ…æŠ¥å¹³å°**ï¼šAlienVault OTXã€MISP

---

## é˜²ç«å¢™æœ€ä½³å®è·µ

### 1. è§„åˆ™ç®¡ç†

- **è§„åˆ™åˆ†ç»„**ï¼šæŒ‰åŠŸèƒ½åˆ†ç»„ç®¡ç†è§„åˆ™
- **å‘½åè§„èŒƒ**ï¼šä½¿ç”¨æ¸…æ™°çš„è§„åˆ™å‘½å
- **æ–‡æ¡£è®°å½•**ï¼šè®°å½•æ¯ä¸ªè§„åˆ™çš„ç”¨é€”
- **å®šæœŸå®¡æŸ¥**ï¼šå®šæœŸå®¡æŸ¥è§„åˆ™æœ‰æ•ˆæ€§

### 2. æ€§èƒ½ä¼˜åŒ–

- **è§„åˆ™ä¼˜åŒ–**ï¼šä¼˜åŒ–è§„åˆ™é¡ºåºå’Œç»“æ„
- **ç¡¬ä»¶åŠ é€Ÿ**ï¼šä½¿ç”¨ä¸“ç”¨ç¡¬ä»¶åŠ é€Ÿ
- **è´Ÿè½½å‡è¡¡**ï¼šéƒ¨ç½²é˜²ç«å¢™é›†ç¾¤
- **ç¼“å­˜ä¼˜åŒ–**ï¼šä¼˜åŒ–è¿æ¥ç¼“å­˜

### 3. å®‰å…¨åŠ å›º

- **æœ€å°æš´éœ²**ï¼šæœ€å°åŒ–æš´éœ²çš„æœåŠ¡å’Œç«¯å£
- **å®šæœŸæ›´æ–°**ï¼šå®šæœŸæ›´æ–°é˜²ç«å¢™è½¯ä»¶
- **å¤šé‡é˜²æŠ¤**ï¼šéƒ¨ç½²å¤šå±‚é˜²æŠ¤æªæ–½
- **åº”æ€¥å“åº”**ï¼šåˆ¶å®šåº”æ€¥å“åº”è®¡åˆ’

---

## é˜²ç«å¢™é…ç½®æ¡ˆä¾‹

### 1. ä¸­å°ä¼ä¸šç½‘ç»œ

#### ç½‘ç»œæ¶æ„

```
Internet
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   é˜²ç«å¢™       â”‚
â”‚   (ä¼ä¸šçº§)      â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    äº¤æ¢æœº       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚è´¢åŠ¡éƒ¨â”‚ â”‚æŠ€æœ¯éƒ¨â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### é˜²ç«å¢™è§„åˆ™

```bash
# è´¢åŠ¡éƒ¨è§„åˆ™
iptables -A FORWARD -s 192.168.1.0/24 -d 192.168.10.0/24 -p tcp --dport 443 -j ACCEPT
iptables -A FORWARD -s 192.168.10.0/24 -d 192.168.1.0/24 -p tcp --dport 3306 -j ACCEPT

# æŠ€æœ¯éƒ¨è§„åˆ™
iptables -A FORWARD -s 192.168.1.0/24 -d 192.168.20.0/24 -p tcp --dport 22 -j ACCEPT
iptables -A FORWARD -s 192.168.20.0/24 -d 192.168.1.0/24 -p tcp --dport 80 -j ACCEPT

# é»˜è®¤æ‹’ç»
iptables -A FORWARD -j DROP
```

### 2. WebæœåŠ¡å™¨ä¿æŠ¤

#### ç½‘ç»œæ¶æ„

```
Internet
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   WAF/é˜²ç«å¢™     â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   è´Ÿè½½å‡è¡¡å™¨     â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   WebæœåŠ¡å™¨     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### WAFè§„åˆ™

```apache
# é˜²æ­¢SQLæ³¨å…¥
SecRule ARGS "@rx (?i:(union.*select|select.*union))" \
    "phase:2,block,id:'1001',msg:'SQL Injection Attack'"

# é˜²æ­¢XSS
SecRule ARGS "@rx (?i:(<script|javascript:|onload=))" \
    "phase:2,block,id:'1002',msg:'XSS Attack'"

# é˜²æ­¢ç›®å½•éå†
SecRule ARGS "@rx (?:\.\./|\.\.\\\)" \
    "phase:2,block,id:'1003',msg:'Directory Traversal Attack'"

# é˜²æ­¢å‘½ä»¤æ³¨å…¥
SecRule ARGS "@rx (;|\||&|`|\$\()" \
    "phase:2,block,id:'1004',msg:'Command Injection Attack'"
```

---

## ğŸ”— ç›¸å…³é“¾æ¥

- [é˜²ç«å¢™æŠ€æœ¯](../05-ç½‘ç»œå®‰å…¨/08-é˜²ç«å¢™æŠ€æœ¯.md)
- [ç½‘ç»œæ•…éšœæ’æŸ¥æ–¹æ³•](./04-ç½‘ç»œæ•…éšœæ’æŸ¥æ–¹æ³•.md)
- [VPNæ­å»ºå®è·µ](./08-VPNæ­å»ºå®è·µ.md)
- [æ¸—é€æµ‹è¯•åŸºç¡€](./09-æ¸—é€æµ‹è¯•åŸºç¡€.md)

---

**æœ€åæ›´æ–°**ï¼š2025-01-26
**ç»´æŠ¤è§„èŒƒ**ï¼šè¯¦è§ [ç¬”è®°è§„èŒƒæ–‡æ¡£](../../../../../.cursorrules)

#é˜²ç«å¢™é…ç½® #ç½‘ç»œå®‰å…¨ #å®è·µæ¡ˆä¾‹ #iptables #WAF