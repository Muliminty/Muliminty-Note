# Kubernetesç½‘ç»œæ¨¡å‹ï¼ˆKubernetes Network Modelï¼‰

> Kubernetesç½‘ç»œæ¨¡å‹æ˜¯Kubernetesé›†ç¾¤çš„ç½‘ç»œæ¶æ„å’Œå®ç°æ–¹å¼ï¼Œä¸ºPodæä¾›ç½‘ç»œé€šä¿¡å’ŒæœåŠ¡å‘ç°èƒ½åŠ›

---

## Kubernetesç½‘ç»œæ¦‚è¿°

Kubernetesç½‘ç»œæ˜¯Kubernetesé›†ç¾¤çš„åŸºç¡€è®¾æ–½ï¼Œä¸ºPodæä¾›ç½‘ç»œè¿æ¥ã€æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡èƒ½åŠ›ã€‚Kubernetesç½‘ç»œéµå¾ªç‰¹å®šçš„è®¾è®¡åŸåˆ™ï¼Œç¡®ä¿å®¹å™¨åŒ–åº”ç”¨çš„çµæ´»æ€§å’Œå¯ç§»æ¤æ€§ã€‚

### Kubernetesç½‘ç»œè®¾è®¡åŸåˆ™

Kubernetesç½‘ç»œè®¾è®¡éµå¾ªä»¥ä¸‹å››ä¸ªæ ¸å¿ƒåŸåˆ™ï¼š

1. **Podé—´æ— NATé€šä¿¡**ï¼šæ‰€æœ‰Podéƒ½å¯ä»¥åœ¨æ— éœ€NATçš„æƒ…å†µä¸‹ä¸æ‰€æœ‰å…¶ä»–Podé€šä¿¡
2. **Nodeä¸Podé€šä¿¡**ï¼šèŠ‚ç‚¹ä¸é›†ç¾¤ä¸­çš„æ‰€æœ‰Podå¯ä»¥ç›´æ¥é€šä¿¡
3. **IPåœ°å€å¹³ç­‰**ï¼šPodçœ‹åˆ°çš„IPåœ°å€ä¸å…¶ä»–Podæˆ–èŠ‚ç‚¹çœ‹åˆ°çš„IPåœ°å€ç›¸åŒ
4. **å‡ºå‘é€šä¿¡**ï¼šå‡ºå‘é€šä¿¡å¯ä»¥ä½¿ç”¨NAT

### Kubernetesç½‘ç»œæ¨¡å‹

```
Kubernetesç½‘ç»œæ¨¡å‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         å¤–éƒ¨ç½‘ç»œ                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚Load â”‚ â”‚Ingressâ”‚ â”‚NodePortâ”‚       â”‚
â”‚  â”‚Balancerâ”‚ â”‚       â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Kubernetesé›†ç¾¤              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚      Service              â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”â”‚  â”‚
â”‚  â”‚  â”‚ SVC1â”‚ â”‚ SVC2â”‚ â”‚ SVC3â”‚â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚       Podç½‘ç»œ              â”‚  â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”â”‚  â”‚
â”‚  â”‚ â”‚Pod Aâ”‚ â”‚Pod Bâ”‚ â”‚Pod Câ”‚â”‚  â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Kubernetesç½‘ç»œç»„ä»¶

### 1. Podç½‘ç»œ

Podç½‘ç»œæ˜¯Kubernetesä¸­æœ€åŸºæœ¬çš„ç½‘ç»œå•å…ƒï¼Œä¸ºPodæä¾›IPåœ°å€å’Œç½‘ç»œè¿æ¥ã€‚

#### Podç½‘ç»œæ¶æ„

```
Podç½‘ç»œç»“æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             Pod                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚        Pauseå®¹å™¨          â”‚  â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚  â”‚
â”‚  â”‚   â”‚     eth0       â”‚     â”‚  â”‚
â”‚  â”‚   â”‚ 10.244.1.10/24 â”‚     â”‚  â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚       åº”ç”¨å®¹å™¨           â”‚  â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚  â”‚
â”‚  â”‚   â”‚   ç½‘ç»œå‘½åç©ºé—´     â”‚     â”‚  â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Podç½‘ç»œç‰¹ç‚¹

- **Pauseå®¹å™¨**ï¼šæ¯ä¸ªPodéƒ½æœ‰ä¸€ä¸ªPauseå®¹å™¨ï¼Œè´Ÿè´£ç»´æŠ¤ç½‘ç»œå‘½åç©ºé—´
- **å…±äº«ç½‘ç»œ**ï¼šPodå†…çš„æ‰€æœ‰å®¹å™¨å…±äº«ç½‘ç»œå‘½åç©ºé—´
- **ç‹¬ç«‹IP**ï¼šæ¯ä¸ªPodæœ‰ç‹¬ç«‹çš„IPåœ°å€
- **ç«¯å£å…±äº«**ï¼šPodå†…çš„å®¹å™¨ä¸èƒ½ä½¿ç”¨ç›¸åŒç«¯å£

### 2. Serviceç½‘ç»œ

Serviceæ˜¯Kubernetesä¸­çš„ç½‘ç»œæŠ½è±¡ï¼Œä¸ºä¸€ç»„Podæä¾›ç¨³å®šçš„è®¿é—®å…¥å£ã€‚

#### Serviceç±»å‹

- **ClusterIP**ï¼šé›†ç¾¤å†…éƒ¨è®¿é—®ï¼Œåˆ†é…è™šæ‹ŸIP
- **NodePort**ï¼šé€šè¿‡èŠ‚ç‚¹çš„é™æ€ç«¯å£æš´éœ²æœåŠ¡
- **LoadBalancer**ï¼šé€šè¿‡äº‘æœåŠ¡å•†çš„è´Ÿè½½å‡è¡¡å™¨æš´éœ²æœåŠ¡
- **ExternalName**ï¼šå°†æœåŠ¡æ˜ å°„åˆ°å¤–éƒ¨DNSåç§°

#### Serviceç½‘ç»œå®ç°

```
Serviceç½‘ç»œå®ç°ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Service                  â”‚
â”‚    ClusterIP: 10.96.0.100       â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚    â”‚     iptables       â”‚        â”‚
â”‚    â”‚   æˆ–IPVSè§„åˆ™       â”‚        â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚              â”‚                   â”‚
â”‚              â–¼                   â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚    â”‚       ç›®æ ‡Pod       â”‚        â”‚
â”‚    â”‚ 10.244.1.10:8080   â”‚        â”‚
â”‚    â”‚ 10.244.1.11:8080   â”‚        â”‚
â”‚    â”‚ 10.244.1.12:8080   â”‚        â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. Ingressç½‘ç»œ

Ingressæ˜¯Kubernetesä¸­ç®¡ç†å¤–éƒ¨è®¿é—®çš„APIå¯¹è±¡ï¼Œæä¾›HTTP/HTTPSè·¯ç”±è§„åˆ™ã€‚

#### Ingressæ¶æ„

```
Ingressç½‘ç»œæ¶æ„ï¼š
å¤–éƒ¨è¯·æ±‚
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Ingress      â”‚
â”‚    Controller   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚  Nginx     â”‚ â”‚
â”‚ â”‚  æˆ–Traefik  â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Service     â”‚
â”‚   ClusterIP    â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Pod       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Kubernetesç½‘ç»œå®ç°

### 1. ç½‘ç»œæ’ä»¶ï¼ˆCNIæ’ä»¶ï¼‰

Kubernetesé€šè¿‡CNIï¼ˆContainer Network Interfaceï¼‰æ’ä»¶å®ç°ç½‘ç»œåŠŸèƒ½ã€‚

#### CNIå·¥ä½œæµç¨‹

```
CNIå·¥ä½œæµç¨‹ï¼š
1. åˆ›å»ºPod
    â”‚
    â–¼
2. Kubeletè°ƒç”¨CNIæ’ä»¶
    â”‚
    â–¼
3. CNIæ’ä»¶é…ç½®ç½‘ç»œ
    â”‚
    â–¼
4. è¿”å›ç½‘ç»œé…ç½®
    â”‚
    â–¼
5. Podå¯åŠ¨
```

#### ä¸»æµCNIæ’ä»¶

| æ’ä»¶åç§° | å®ç°æ–¹å¼ | ç‰¹ç‚¹ | é€‚ç”¨åœºæ™¯ |
|---------|---------|------|----------|
| Flannel | VXLAN/UDP | ç®€å•æ˜“ç”¨ | ä¸­å°å‹é›†ç¾¤ |
| Calico | BGP/IP-in-IP | ç½‘ç»œç­–ç•¥æ”¯æŒ | éœ€è¦ç»†ç²’åº¦æ§åˆ¶ |
| Weave | Weave Net | è‡ªåŠ¨å‘ç° | åŠ¨æ€ç¯å¢ƒ |
| Canal | Flannel+Calico | ç»“åˆä¸¤è€…ä¼˜åŠ¿ | éœ€è¦ç­–ç•¥+è¦†ç›–ç½‘ç»œ |
| Cilium | eBPF | é«˜æ€§èƒ½ | é«˜æ€§èƒ½éœ€æ±‚ |

### 2. ç½‘ç»œç­–ç•¥

ç½‘ç»œç­–ç•¥æ˜¯Kubernetesä¸­æ§åˆ¶Podé—´é€šä¿¡çš„è§„åˆ™ã€‚

#### ç½‘ç»œç­–ç•¥ç¤ºä¾‹

```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: test-network-policy
  namespace: default
spec:
  podSelector:
    matchLabels:
      role: db
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          role: frontend
    ports:
    - protocol: TCP
      port: 6379
  egress:
  - to:
    - podSelector:
        matchLabels:
          role: backend
    ports:
    - protocol: TCP
      port: 8080
```

### 3. DNSæœåŠ¡

Kubernetesæä¾›å†…ç½®DNSæœåŠ¡ï¼Œå®ç°æœåŠ¡å‘ç°ã€‚

#### DNSæœåŠ¡æ¶æ„

```
Kubernetes DNSæ¶æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    kube-dns     â”‚
â”‚    æˆ–CoreDNS     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ DNSæœåŠ¡     â”‚ â”‚
â”‚  â”‚   SkyDNS    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ å¥åº·æ£€æŸ¥    â”‚ â”‚
â”‚  â”‚  sidecar    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     API Server â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Kubernetesç½‘ç»œé€šä¿¡æ¨¡å¼

### 1. åŒèŠ‚ç‚¹Podé€šä¿¡

åŒèŠ‚ç‚¹ä¸Šçš„Podé€šä¿¡é€šè¿‡ç½‘ç»œæ¡¥æˆ–è™šæ‹Ÿäº¤æ¢æœºå®ç°ã€‚

#### åŒèŠ‚ç‚¹é€šä¿¡æ¶æ„

```
åŒèŠ‚ç‚¹Podé€šä¿¡ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           èŠ‚ç‚¹                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚       ç½‘æ¡¥         â”‚         â”‚
â”‚  â”‚   (cni0)         â”‚         â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”   â”‚         â”‚
â”‚  â”‚  â”‚PodA â”‚ â”‚PodB â”‚   â”‚         â”‚
â”‚  â”‚  â”‚10.1 â”‚ â”‚10.2 â”‚   â”‚         â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜   â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. è·¨èŠ‚ç‚¹Podé€šä¿¡

è·¨èŠ‚ç‚¹Podé€šä¿¡é€šè¿‡è¦†ç›–ç½‘ç»œæˆ–åº•å±‚ç½‘ç»œå®ç°ã€‚

#### è·¨èŠ‚ç‚¹é€šä¿¡æ¶æ„ï¼ˆOverlayï¼‰

```
è·¨èŠ‚ç‚¹Podé€šä¿¡ï¼ˆOverlayï¼‰ï¼š
èŠ‚ç‚¹A                    èŠ‚ç‚¹B
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   PodA      â”‚        â”‚   PodB      â”‚
â”‚ 10.244.1.2  â”‚        â”‚ 10.244.2.3  â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                    â”‚
      â–¼                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç½‘æ¡¥cni0    â”‚        â”‚  ç½‘æ¡¥cni0    â”‚
â”‚ 10.244.1.1  â”‚        â”‚ 10.244.2.1  â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                    â”‚
      â–¼                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ VTEPè®¾å¤‡     â”‚        â”‚ VTEPè®¾å¤‡     â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                    â”‚
      â””â”€â”€â”€â”€â”€ è¦†ç›–ç½‘ç»œ â”€â”€â”€â”€â”˜
             â”‚
             â–¼
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚  ç‰©ç†ç½‘ç»œ   â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. Podä¸Serviceé€šä¿¡

Podé€šè¿‡kube-proxyå®ç°çš„è´Ÿè½½å‡è¡¡è®¿é—®Serviceã€‚

#### Serviceè®¿é—®æµç¨‹

```
Podè®¿é—®Serviceï¼š
PodA
  â”‚
  â”‚ è¯·æ±‚ ClusterIP:10.96.0.100
  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   PodA         â”‚
â”‚ 10.244.1.2     â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æœ¬åœ°DNSè§£æ     â”‚
â”‚ myservice â†’   â”‚
â”‚ 10.96.0.100   â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  iptables/IPVS â”‚
â”‚   è´Ÿè½½å‡è¡¡     â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç›®æ ‡Pod       â”‚
â”‚ 10.244.2.3     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Kubernetesç½‘ç»œä¼˜åŒ–

### 1. æ€§èƒ½ä¼˜åŒ–

#### ç½‘ç»œå‚æ•°è°ƒæ•´

```yaml
# Podç½‘ç»œå‚æ•°
apiVersion: v1
kind: Pod
metadata:
  name: network-optimized
spec:
  securityContext:
    sysctls:
    - name: net.core.rmem_max
      value: "134217728"
    - name: net.core.wmem_max
      value: "134217728"
```

#### é«˜æ€§èƒ½ç½‘ç»œæ’ä»¶

- **Cilium**ï¼šåŸºäºeBPFçš„é«˜æ€§èƒ½ç½‘ç»œæ’ä»¶
- **DPDK**ï¼šæ•°æ®å¹³é¢å¼€å‘å¥—ä»¶
- **SR-IOV**ï¼šå•æ ¹I/Oè™šæ‹ŸåŒ–
- **XDP**ï¼šeXpress Data Path

### 2. å®‰å…¨ä¼˜åŒ–

#### ç½‘ç»œç­–ç•¥

```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: deny-all
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-specific
spec:
  podSelector:
    matchLabels:
      app: myapp
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: allowed-namespace
```

#### Podå®‰å…¨ç­–ç•¥

```yaml
apiVersion: policy/v1beta1
kind: PodSecurityPolicy
metadata:
  name: restricted
spec:
  privileged: false
  allowPrivilegeEscalation: false
  requiredDropCapabilities:
    - ALL
  volumes:
    - 'configMap'
    - 'emptyDir'
    - 'projected'
    - 'secret'
    - 'downwardAPI'
    - 'persistentVolumeClaim'
```

### 3. å¯è§‚å¯Ÿæ€§

#### ç½‘ç»œç›‘æ§

```yaml
# ç½‘ç»œç›‘æ§å·¥å…·
apiVersion: apps/v1
kind: Deployment
metadata:
  name: network-monitor
spec:
  template:
    spec:
      containers:
      - name: monitor
        image: network-monitor
        args:
        - --source=kubernetes
        - --metrics-address=0.0.0.0:9100
```

#### ç½‘ç»œæ—¥å¿—

```yaml
# ç½‘ç»œæ—¥å¿—æ”¶é›†
apiVersion: v1
kind: DaemonSet
metadata:
  name: network-logger
spec:
  template:
    spec:
      containers:
      - name: logger
        image: network-logger
        args:
        - --source=/var/log/network
        - --output=elasticsearch
```

---

## Kubernetesç½‘ç»œæ•…éšœæ’æŸ¥

### 1. ç½‘ç»œè¿æ¥é—®é¢˜

#### å¸¸è§é—®é¢˜

- **Podæ— æ³•è®¿é—®å¤–éƒ¨**ï¼šæ£€æŸ¥DNSå’Œè·¯ç”±
- **Podé—´æ— æ³•é€šä¿¡**ï¼šæ£€æŸ¥ç½‘ç»œæ’ä»¶å’Œç­–ç•¥
- **Serviceæ— æ³•è®¿é—®**ï¼šæ£€æŸ¥Serviceå’ŒEndpoint
- **Ingressæ— æ³•è®¿é—®**ï¼šæ£€æŸ¥Ingressé…ç½®

#### æ’æŸ¥å·¥å…·

```bash
# æ£€æŸ¥Podç½‘ç»œé…ç½®
kubectl exec -it <pod> -- ip addr

# æ£€æŸ¥è·¯ç”±è¡¨
kubectl exec -it <pod> -- ip route

# æµ‹è¯•DNSè§£æ
kubectl exec -it <pod> -- nslookup kubernetes.default

# æ£€æŸ¥ç½‘ç»œè¿æ¥
kubectl exec -it <pod> -- telnet <target-ip> <port>
```

### 2. æ€§èƒ½é—®é¢˜

#### æ€§èƒ½æŒ‡æ ‡

- **ç½‘ç»œå»¶è¿Ÿ**ï¼šPodé—´é€šä¿¡å»¶è¿Ÿ
- **ååé‡**ï¼šç½‘ç»œå¸¦å®½åˆ©ç”¨ç‡
- **ä¸¢åŒ…ç‡**ï¼šç½‘ç»œæ•°æ®åŒ…ä¸¢å¤±ç‡
- **è¿æ¥æ•°**ï¼šå¹¶å‘è¿æ¥æ•°

#### ä¼˜åŒ–æ–¹æ³•

- **è°ƒæ•´èµ„æºé™åˆ¶**ï¼šå¢åŠ CPUå’Œå†…å­˜
- **ä¼˜åŒ–ç½‘ç»œæ’ä»¶**ï¼šé€‰æ‹©åˆé€‚çš„ç½‘ç»œæ’ä»¶
- **è°ƒæ•´ç½‘ç»œå‚æ•°**ï¼šä¼˜åŒ–å†…æ ¸ç½‘ç»œå‚æ•°
- **ä½¿ç”¨æœ¬åœ°ç¼“å­˜**ï¼šå‡å°‘ç½‘ç»œè¯·æ±‚

---

## Kubernetesç½‘ç»œå‘å±•è¶‹åŠ¿

### 1. eBPFç½‘ç»œ

- **é«˜æ€§èƒ½**ï¼šåŸºäºeBPFçš„é«˜æ€§èƒ½ç½‘ç»œ
- **å¯ç¼–ç¨‹**ï¼šå¯ç¼–ç¨‹ç½‘ç»œæ•°æ®å¹³é¢
- **è§‚æµ‹æ€§**ï¼šå†…ç½®å¯è§‚æµ‹æ€§èƒ½åŠ›
- **å®‰å…¨æ€§**ï¼šå¢å¼ºå®‰å…¨éš”ç¦»

### 2. æœåŠ¡ç½‘æ ¼é›†æˆ

- **æ·±åº¦é›†æˆ**ï¼šä¸Istioç­‰æœåŠ¡ç½‘æ ¼æ·±åº¦é›†æˆ
- **æµé‡ç®¡ç†**ï¼šé«˜çº§æµé‡ç®¡ç†èƒ½åŠ›
- **å®‰å…¨ç­–ç•¥**ï¼šç²¾ç»†çš„å®‰å…¨ç­–ç•¥æ§åˆ¶
- **å¯è§‚æµ‹æ€§**ï¼šå…¨é¢çš„å¯è§‚æµ‹æ€§æ”¯æŒ

### 3. å¤šé›†ç¾¤ç½‘ç»œ

- **è·¨é›†ç¾¤é€šä¿¡**ï¼šæ”¯æŒå¤šé›†ç¾¤é—´é€šä¿¡
- **å…¨å±€æœåŠ¡**ï¼šå…¨å±€æœåŠ¡å‘ç°å’Œè®¿é—®
- **ç»Ÿä¸€ç®¡ç†**ï¼šå¤šé›†ç¾¤ç½‘ç»œç»Ÿä¸€ç®¡ç†
- **æ•…éšœè½¬ç§»**ï¼šè‡ªåŠ¨æ•…éšœè½¬ç§»å’Œæ¢å¤

---

## ğŸ”— ç›¸å…³é“¾æ¥

- [å®¹å™¨ç½‘ç»œæ¦‚è¿°](./01-å®¹å™¨ç½‘ç»œæ¦‚è¿°.md)
- [CNIï¼ˆå®¹å™¨ç½‘ç»œæ¥å£ï¼‰](./02-CNIå®¹å™¨ç½‘ç»œæ¥å£.md)
- [ç½‘ç»œæ’ä»¶](./04-ç½‘ç»œæ’ä»¶.md)
- [ç½‘ç»œç­–ç•¥](./11-ç½‘ç»œç­–ç•¥.md)

---

**æœ€åæ›´æ–°**ï¼š2025-01-26
**ç»´æŠ¤è§„èŒƒ**ï¼šè¯¦è§ [ç¬”è®°è§„èŒƒæ–‡æ¡£](../../../../../.cursorrules)

#Kubernetes #Podç½‘ç»œ #Service #CNI #ç½‘ç»œç­–ç•¥