# WSL ç½‘ç»œé…ç½®

> WSL ç½‘ç»œæ¨¡å¼ã€ç«¯å£è½¬å‘ã€ä»£ç†é…ç½®å’Œç½‘ç»œæ•…éšœæ’æŸ¥

---

## ğŸ“‹ ç›®å½•

- [ç½‘ç»œæ¶æ„](#ç½‘ç»œæ¶æ„)
- [æŸ¥çœ‹ç½‘ç»œä¿¡æ¯](#æŸ¥çœ‹ç½‘ç»œä¿¡æ¯)
- [ç«¯å£è½¬å‘](#ç«¯å£è½¬å‘)
- [ä»£ç†é…ç½®](#ä»£ç†é…ç½®)
- [é˜²ç«å¢™é…ç½®](#é˜²ç«å¢™é…ç½®)
- [ç½‘ç»œæ•…éšœæ’æŸ¥](#ç½‘ç»œæ•…éšœæ’æŸ¥)

---

## ç½‘ç»œæ¶æ„

### WSL 1 ç½‘ç»œ

- **ç½‘ç»œæ¨¡å¼**ï¼šä¸ Windows å…±äº«ç½‘ç»œå †æ ˆ
- **IP åœ°å€**ï¼šä¸ Windows ä¸»æœºä½¿ç”¨ç›¸åŒçš„ IP åœ°å€
- **ç«¯å£è®¿é—®**ï¼šç›´æ¥è®¿é—®ï¼Œæ— éœ€ç«¯å£è½¬å‘
- **æ€§èƒ½**ï¼šç½‘ç»œæ€§èƒ½è¾ƒå¥½

### WSL 2 ç½‘ç»œ

- **ç½‘ç»œæ¨¡å¼**ï¼šè™šæ‹Ÿç½‘ç»œï¼Œä½¿ç”¨ NATï¼ˆç½‘ç»œåœ°å€è½¬æ¢ï¼‰
- **IP åœ°å€**ï¼šç‹¬ç«‹çš„ IP åœ°å€ï¼ˆé€šå¸¸ä¸º 172.x.x.xï¼‰
- **ç«¯å£è®¿é—®**ï¼šéœ€è¦é…ç½®ç«¯å£è½¬å‘æ‰èƒ½ä» Windows è®¿é—®
- **æ€§èƒ½**ï¼šç½‘ç»œæ€§èƒ½ä¼˜ç§€ï¼Œä½†éœ€è¦é¢å¤–é…ç½®

### ç½‘ç»œæ¨¡å¼å¯¹æ¯”

| ç‰¹æ€§ | WSL 1 | WSL 2 |
|------|-------|-------|
| IP åœ°å€ | ä¸ Windows ç›¸åŒ | ç‹¬ç«‹ IPï¼ˆ172.x.x.xï¼‰ |
| ç«¯å£è½¬å‘ | ä¸éœ€è¦ | éœ€è¦ |
| ç½‘ç»œæ€§èƒ½ | è‰¯å¥½ | ä¼˜ç§€ |
| é˜²ç«å¢™ | å…±äº« Windows é˜²ç«å¢™ | ç‹¬ç«‹é˜²ç«å¢™è§„åˆ™ |

---

## æŸ¥çœ‹ç½‘ç»œä¿¡æ¯

### æŸ¥çœ‹ IP åœ°å€

```bash
# æŸ¥çœ‹æ‰€æœ‰ç½‘ç»œæ¥å£
ip addr show
# æˆ–
ifconfig

# æŸ¥çœ‹ä¸» IP åœ°å€
hostname -I

# æŸ¥çœ‹ IPv4 åœ°å€
ip -4 addr show

# æŸ¥çœ‹ç‰¹å®šæ¥å£
ip addr show eth0
```

### æŸ¥çœ‹ç½‘ç»œæ¥å£

```bash
# åˆ—å‡ºæ‰€æœ‰ç½‘ç»œæ¥å£
ip link show

# æŸ¥çœ‹æ¥å£çŠ¶æ€
ip link show eth0

# å¯ç”¨/ç¦ç”¨æ¥å£
sudo ip link set eth0 up
sudo ip link set eth0 down
```

### æŸ¥çœ‹è·¯ç”±è¡¨

```bash
# æŸ¥çœ‹è·¯ç”±è¡¨
ip route show
# æˆ–
route -n

# æŸ¥çœ‹é»˜è®¤ç½‘å…³
ip route | grep default
```

### æŸ¥çœ‹ DNS é…ç½®

```bash
# æŸ¥çœ‹ DNS æœåŠ¡å™¨
cat /etc/resolv.conf

# æµ‹è¯• DNS è§£æ
nslookup google.com
dig google.com
```

### æŸ¥çœ‹ç½‘ç»œè¿æ¥

```bash
# æŸ¥çœ‹ç›‘å¬ç«¯å£
netstat -tuln
# æˆ–
ss -tuln

# æŸ¥çœ‹æ´»åŠ¨è¿æ¥
netstat -tun
ss -tun

# æŸ¥çœ‹ç‰¹å®šç«¯å£
netstat -tuln | grep 3000
ss -tuln | grep 3000
```

### æŸ¥çœ‹ Windows ä¸»æœº IP

```bash
# æŸ¥çœ‹ Windows ä¸»æœº IPï¼ˆä» WSL 2ï¼‰
cat /etc/resolv.conf | grep nameserver | awk '{print $2}'

# æˆ–ä½¿ç”¨è„šæœ¬
ip route show | grep -i default | awk '{ print $3}'
```

---

## ç«¯å£è½¬å‘

### è‡ªåŠ¨ç«¯å£è½¬å‘

WSL 2 æ”¯æŒè‡ªåŠ¨ç«¯å£è½¬å‘ï¼ˆéœ€è¦ Windows 11 æˆ– Windows 10 ç‰ˆæœ¬ 2004+ï¼‰ã€‚

#### å¯ç”¨è‡ªåŠ¨ç«¯å£è½¬å‘

åœ¨ `.wslconfig` ä¸­é…ç½®ï¼š
```ini
[wsl2]
localhostForwarding=true
```

#### å·¥ä½œåŸç†

- WSL 2 è‡ªåŠ¨æ£€æµ‹ç›‘å¬ç«¯å£
- è‡ªåŠ¨åœ¨ Windows ä¸»æœºä¸Šåˆ›å»ºç«¯å£è½¬å‘è§„åˆ™
- ä» Windows è®¿é—® `localhost:port` ä¼šè‡ªåŠ¨è½¬å‘åˆ° WSL 2

### æ‰‹åŠ¨ç«¯å£è½¬å‘

#### æ–¹æ³•ä¸€ï¼šä½¿ç”¨ netshï¼ˆPowerShellï¼‰

```powershell
# è·å– WSL 2 IP åœ°å€
$wslIp = (wsl hostname -I).Trim()

# è½¬å‘ç«¯å£ 3000
netsh interface portproxy add v4tov4 `
    listenport=3000 `
    listenaddress=0.0.0.0 `
    connectport=3000 `
    connectaddress=$wslIp

# æŸ¥çœ‹æ‰€æœ‰ç«¯å£è½¬å‘è§„åˆ™
netsh interface portproxy show all

# åˆ é™¤ç«¯å£è½¬å‘
netsh interface portproxy delete v4tov4 listenport=3000 listenaddress=0.0.0.0
```

#### æ–¹æ³•äºŒï¼šä½¿ç”¨è„šæœ¬è‡ªåŠ¨é…ç½®

åˆ›å»º `portproxy.ps1`ï¼š
```powershell
# è·å– WSL 2 IP åœ°å€
$wslIp = (wsl hostname -I).Trim()
Write-Host "WSL IP: $wslIp"

# å®šä¹‰è¦è½¬å‘çš„ç«¯å£
$ports = @(3000, 8080, 5000, 3306, 5432)

foreach ($port in $ports) {
    # åˆ é™¤ç°æœ‰è§„åˆ™ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    netsh interface portproxy delete v4tov4 listenport=$port listenaddress=0.0.0.0 2>$null
    
    # æ·»åŠ æ–°è§„åˆ™
    netsh interface portproxy add v4tov4 `
        listenport=$port `
        listenaddress=0.0.0.0 `
        connectport=$port `
        connectaddress=$wslIp
    
    Write-Host "Forwarded port $port to $wslIp"
}

Write-Host "Port forwarding configured successfully"
```

#### æ–¹æ³•ä¸‰ï¼šä½¿ç”¨ SSH éš§é“

```bash
# åœ¨ WSL 2 ä¸­è®¾ç½® SSH æœåŠ¡å™¨
sudo apt install openssh-server
sudo service ssh start

# åœ¨ Windows ä¸­ä½¿ç”¨ SSH ç«¯å£è½¬å‘
ssh -L 3000:localhost:3000 username@wsl_ip
```

### åŠ¨æ€ç«¯å£è½¬å‘è„šæœ¬

åˆ›å»º `update-portproxy.ps1`ï¼ˆåœ¨ Windows å¯åŠ¨æ—¶è¿è¡Œï¼‰ï¼š

```powershell
# æ£€æŸ¥ WSL æ˜¯å¦è¿è¡Œ
$wslStatus = wsl --list --verbose | Select-String "Running"

if ($wslStatus) {
    $wslIp = (wsl hostname -I).Trim()
    
    # æ›´æ–°ç«¯å£è½¬å‘è§„åˆ™
    $ports = @(3000, 8080, 5000)
    
    foreach ($port in $ports) {
        netsh interface portproxy delete v4tov4 listenport=$port listenaddress=0.0.0.0 2>$null
        netsh interface portproxy add v4tov4 `
            listenport=$port `
            listenaddress=0.0.0.0 `
            connectport=$port `
            connectaddress=$wslIp
    }
}
```

### ä»å¤–éƒ¨è®¿é—® WSL æœåŠ¡

```powershell
# 1. é…ç½®ç«¯å£è½¬å‘ï¼ˆå¦‚ä¸Šï¼‰
# 2. é…ç½® Windows é˜²ç«å¢™è§„åˆ™
New-NetFirewallRule -DisplayName "WSL Port 3000" `
    -Direction Inbound `
    -LocalPort 3000 `
    -Protocol TCP `
    -Action Allow
```

---

## ä»£ç†é…ç½®

### åœ¨ WSL ä¸­é…ç½®ä»£ç†

#### æ–¹æ³•ä¸€ï¼šç¯å¢ƒå˜é‡

```bash
# ä¸´æ—¶è®¾ç½®ï¼ˆå½“å‰ä¼šè¯ï¼‰
export http_proxy="http://proxy.example.com:8080"
export https_proxy="http://proxy.example.com:8080"
export no_proxy="localhost,127.0.0.1"

# æ°¸ä¹…è®¾ç½®ï¼ˆæ·»åŠ åˆ° ~/.bashrcï¼‰
echo 'export http_proxy="http://proxy.example.com:8080"' >> ~/.bashrc
echo 'export https_proxy="http://proxy.example.com:8080"' >> ~/.bashrc
echo 'export no_proxy="localhost,127.0.0.1"' >> ~/.bashrc
source ~/.bashrc
```

#### æ–¹æ³•äºŒï¼šapt ä»£ç†é…ç½®

```bash
# ç¼–è¾‘ apt é…ç½®æ–‡ä»¶
sudo nano /etc/apt/apt.conf.d/95proxies

# æ·»åŠ ä»£ç†é…ç½®
Acquire::http::Proxy "http://proxy.example.com:8080";
Acquire::https::Proxy "http://proxy.example.com:8080";
```

#### æ–¹æ³•ä¸‰ï¼šä½¿ç”¨ Windows ä»£ç†

```bash
# è·å– Windows ä¸»æœº IP
WIN_IP=$(cat /etc/resolv.conf | grep nameserver | awk '{print $2}')

# è®¾ç½®ä»£ç†ä¸º Windows ä¸»æœºï¼ˆå¦‚æœ Windows ä¸Šæœ‰ä»£ç†ï¼‰
export http_proxy="http://$WIN_IP:8080"
export https_proxy="http://$WIN_IP:8080"
```

### Git ä»£ç†é…ç½®

```bash
# å…¨å±€é…ç½®
git config --global http.proxy http://proxy.example.com:8080
git config --global https.proxy http://proxy.example.com:8080

# ä»…å¯¹ç‰¹å®šåŸŸåé…ç½®
git config --global http.https://github.com.proxy http://proxy.example.com:8080

# å–æ¶ˆä»£ç†
git config --global --unset http.proxy
git config --global --unset https.proxy
```

### npm ä»£ç†é…ç½®

```bash
# è®¾ç½®ä»£ç†
npm config set proxy http://proxy.example.com:8080
npm config set https-proxy http://proxy.example.com:8080

# å–æ¶ˆä»£ç†
npm config delete proxy
npm config delete https-proxy
```

---

## é˜²ç«å¢™é…ç½®

### Windows é˜²ç«å¢™

#### å…è®¸ WSL è®¿é—®

```powershell
# å…è®¸ WSL ç½‘ç»œè®¿é—®
New-NetFirewallRule -DisplayName "WSL" `
    -Direction Inbound `
    -InterfaceAlias "vEthernet (WSL)" `
    -Action Allow
```

#### å…è®¸ç‰¹å®šç«¯å£

```powershell
# å…è®¸ç«¯å£ 3000
New-NetFirewallRule -DisplayName "WSL Port 3000" `
    -Direction Inbound `
    -LocalPort 3000 `
    -Protocol TCP `
    -Action Allow
```

### Linux é˜²ç«å¢™ï¼ˆiptablesï¼‰

```bash
# æŸ¥çœ‹é˜²ç«å¢™è§„åˆ™
sudo iptables -L

# å…è®¸ç«¯å£ 3000
sudo iptables -A INPUT -p tcp --dport 3000 -j ACCEPT

# ä¿å­˜è§„åˆ™ï¼ˆUbuntu/Debianï¼‰
sudo iptables-save | sudo tee /etc/iptables/rules.v4
```

---

## ç½‘ç»œæ•…éšœæ’æŸ¥

### æ— æ³•è®¿é—®äº’è”ç½‘

```bash
# 1. æ£€æŸ¥ç½‘ç»œè¿æ¥
ping 8.8.8.8

# 2. æ£€æŸ¥ DNS è§£æ
nslookup google.com
dig google.com

# 3. æ£€æŸ¥ DNS é…ç½®
cat /etc/resolv.conf

# 4. æ£€æŸ¥è·¯ç”±
ip route show

# 5. é‡å¯ç½‘ç»œï¼ˆå¦‚æœå¯èƒ½ï¼‰
sudo service networking restart
```

### æ— æ³•è®¿é—® Windows ä¸»æœº

```bash
# 1. è·å– Windows ä¸»æœº IP
WIN_IP=$(cat /etc/resolv.conf | grep nameserver | awk '{print $2}')

# 2. æµ‹è¯•è¿æ¥
ping $WIN_IP

# 3. æµ‹è¯•ç«¯å£
telnet $WIN_IP 3389  # RDP
```

### ç«¯å£è½¬å‘ä¸å·¥ä½œ

```powershell
# 1. æ£€æŸ¥ç«¯å£è½¬å‘è§„åˆ™
netsh interface portproxy show all

# 2. æ£€æŸ¥ WSL IP åœ°å€
wsl hostname -I

# 3. æ£€æŸ¥é˜²ç«å¢™è§„åˆ™
Get-NetFirewallRule | Where-Object DisplayName -like "*WSL*"

# 4. æµ‹è¯•ç«¯å£
Test-NetConnection -ComputerName localhost -Port 3000
```

### DNS è§£æé—®é¢˜

```bash
# 1. æ£€æŸ¥ /etc/resolv.conf
cat /etc/resolv.conf

# 2. å¦‚æœè¢«è‡ªåŠ¨è¦†ç›–ï¼Œç¦ç”¨è‡ªåŠ¨ç”Ÿæˆ
sudo nano /etc/wsl.conf
# æ·»åŠ ï¼š
[network]
generateResolvConf = false

# 3. æ‰‹åŠ¨é…ç½® DNS
sudo nano /etc/resolv.conf
# æ·»åŠ ï¼š
nameserver 8.8.8.8
nameserver 8.8.4.4
```

### ç½‘ç»œæ€§èƒ½é—®é¢˜

```bash
# 1. æ£€æŸ¥ç½‘ç»œæ¥å£é€Ÿåº¦
ethtool eth0

# 2. æµ‹è¯•ç½‘ç»œé€Ÿåº¦
# å®‰è£… iperf3
sudo apt install iperf3

# åœ¨æœåŠ¡å™¨ç«¯
iperf3 -s

# åœ¨å®¢æˆ·ç«¯
iperf3 -c server_ip
```

---

## é«˜çº§ç½‘ç»œé…ç½®

### é™æ€ IP é…ç½®

WSL 2 é»˜è®¤ä½¿ç”¨ DHCPï¼Œä½†å¯ä»¥é€šè¿‡è„šæœ¬è®¾ç½®é™æ€ IPï¼š

```bash
# åˆ›å»ºç½‘ç»œé…ç½®è„šæœ¬
sudo nano /usr/local/bin/wsl-static-ip.sh

#!/bin/bash
# è·å– Windows ä¸»æœº IP
WIN_IP=$(cat /etc/resolv.conf | grep nameserver | awk '{print $2}')
# è®¾ç½®é™æ€ IPï¼ˆéœ€è¦æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´ï¼‰
sudo ip addr add 172.20.0.2/20 dev eth0
sudo ip route del default
sudo ip route add default via $WIN_IP
```

### ç½‘ç»œæ¡¥æ¥

WSL 2 æ”¯æŒé•œåƒç½‘ç»œæ¨¡å¼ï¼ˆWindows 11ï¼‰ï¼š

```ini
# åœ¨ .wslconfig ä¸­
[wsl2]
networkingMode=mirrored
```

### VPN å…¼å®¹æ€§

æŸäº› VPN å¯èƒ½ä¸ WSL 2 ç½‘ç»œå†²çªï¼š

```bash
# å¦‚æœ VPN å¯¼è‡´ç½‘ç»œé—®é¢˜ï¼Œå°è¯•ï¼š
# 1. é‡å¯ WSL
wsl --shutdown
wsl

# 2. æ£€æŸ¥è·¯ç”±è¡¨
ip route show

# 3. æ‰‹åŠ¨æ·»åŠ è·¯ç”±ï¼ˆå¦‚æœéœ€è¦ï¼‰
sudo ip route add <network> via <gateway>
```

---

## ğŸ“š å‚è€ƒèµ„æº

- [WSL ç½‘ç»œæ–‡æ¡£](https://learn.microsoft.com/zh-cn/windows/wsl/networking)
- [WSL 2 ç½‘ç»œæ¨¡å¼](https://learn.microsoft.com/zh-cn/windows/wsl/networking#accessing-a-wsl-2-distribution-from-your-local-area-network-lan)

---

[[!MOC-WSL|è¿”å› WSL çŸ¥è¯†ä½“ç³»]]

#WSL #ç½‘ç»œé…ç½® #ç«¯å£è½¬å‘ #ä»£ç†
