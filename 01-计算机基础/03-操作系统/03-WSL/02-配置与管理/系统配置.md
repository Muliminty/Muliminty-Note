# WSL ç³»ç»Ÿé…ç½®

> WSL ç³»ç»Ÿé…ç½®æ–‡ä»¶ã€èµ„æºé™åˆ¶å’Œç½‘ç»œé…ç½®

---

## ğŸ“‹ ç›®å½•

- [å…¨å±€é…ç½®ï¼ˆ.wslconfigï¼‰](#å…¨å±€é…ç½®wslconfig)
- [å‘è¡Œç‰ˆé…ç½®ï¼ˆwsl.confï¼‰](#å‘è¡Œç‰ˆé…ç½®wslconf)
- [èµ„æºé™åˆ¶](#èµ„æºé™åˆ¶)
- [ç½‘ç»œé…ç½®](#ç½‘ç»œé…ç½®)
- [å¯åŠ¨é…ç½®](#å¯åŠ¨é…ç½®)

---

## å…¨å±€é…ç½®ï¼ˆ.wslconfigï¼‰

`.wslconfig` æ–‡ä»¶ç”¨äºé…ç½®æ‰€æœ‰ WSL å‘è¡Œç‰ˆçš„å…¨å±€è®¾ç½®ï¼Œä½äº Windows ç”¨æˆ·ç›®å½•ä¸‹ã€‚

### æ–‡ä»¶ä½ç½®

```
C:\Users\YourUsername\.wslconfig
```

### é…ç½®ç¤ºä¾‹

```ini
[wsl2]
# å†…å­˜é™åˆ¶ï¼ˆå•ä½ï¼šMBï¼‰
memory=4GB

# CPU æ ¸å¿ƒæ•°é™åˆ¶
processors=4

# äº¤æ¢ç©ºé—´å¤§å°ï¼ˆå•ä½ï¼šMBï¼‰
swap=2GB

# äº¤æ¢æ–‡ä»¶è·¯å¾„
swapFile=C:\\Users\\YourUsername\\AppData\\Local\\Temp\\swap.vhdx

# æœ¬åœ°ä¸»æœºè½¬å‘
localhostForwarding=true

# å†…æ ¸å‘½ä»¤è¡Œå‚æ•°
kernelCommandLine=sysctl.vm.max_map_count=262144

# åµŒå¥—è™šæ‹ŸåŒ–ï¼ˆç”¨äºåœ¨ WSL ä¸­è¿è¡Œè™šæ‹Ÿæœºï¼‰
nestedVirtualization=false

# è°ƒè¯•æ§åˆ¶å°
debugConsole=false

# ä½¿ç”¨è‡ªå®šä¹‰å†…æ ¸
# kernel=C:\\Users\\YourUsername\\kernel

# ä½¿ç”¨è‡ªå®šä¹‰ init
# initCommand=C:\\Users\\YourUsername\\init
```

### é…ç½®è¯´æ˜

#### memory
- **é»˜è®¤å€¼**ï¼šWindows æ€»å†…å­˜çš„ 50% æˆ– 8GBï¼ˆå–è¾ƒå°å€¼ï¼‰
- **è¯´æ˜**ï¼šé™åˆ¶ WSL 2 å¯ä»¥ä½¿ç”¨çš„æœ€å¤§å†…å­˜
- **ç¤ºä¾‹**ï¼š`memory=4GB`ã€`memory=8192MB`

#### processors
- **é»˜è®¤å€¼**ï¼šæ‰€æœ‰å¯ç”¨ CPU æ ¸å¿ƒ
- **è¯´æ˜**ï¼šé™åˆ¶ WSL 2 å¯ä»¥ä½¿ç”¨çš„ CPU æ ¸å¿ƒæ•°
- **ç¤ºä¾‹**ï¼š`processors=4`ã€`processors=2`

#### swap
- **é»˜è®¤å€¼**ï¼šå†…å­˜å¤§å°çš„ 25%
- **è¯´æ˜**ï¼šäº¤æ¢ç©ºé—´å¤§å°
- **ç¤ºä¾‹**ï¼š`swap=2GB`ã€`swap=4096MB`

#### swapFile
- **é»˜è®¤å€¼**ï¼š`%USERPROFILE%\AppData\Local\Temp\swap.vhdx`
- **è¯´æ˜**ï¼šäº¤æ¢æ–‡ä»¶çš„ä½ç½®
- **æ³¨æ„**ï¼šä½¿ç”¨åŒåæ–œæ  `\\` æˆ–æ­£æ–œæ  `/`

#### localhostForwarding
- **é»˜è®¤å€¼**ï¼š`true`
- **è¯´æ˜**ï¼šæ˜¯å¦è‡ªåŠ¨è½¬å‘ localhost ç«¯å£
- **ç”¨é€”**ï¼šå…è®¸ä» Windows è®¿é—® WSL ä¸­è¿è¡Œçš„æœåŠ¡

#### kernelCommandLine
- **è¯´æ˜**ï¼šä¼ é€’ç»™ Linux å†…æ ¸çš„å‘½ä»¤è¡Œå‚æ•°
- **å¸¸ç”¨å‚æ•°**ï¼š
  - `sysctl.vm.max_map_count=262144` - å¢åŠ è™šæ‹Ÿå†…å­˜æ˜ å°„é™åˆ¶ï¼ˆElasticsearch ç­‰éœ€è¦ï¼‰

### åº”ç”¨é…ç½®

```powershell
# ä¿®æ”¹ .wslconfig åï¼Œéœ€è¦é‡å¯ WSL
wsl --shutdown

# ç„¶åé‡æ–°å¯åŠ¨
wsl
```

---

## å‘è¡Œç‰ˆé…ç½®ï¼ˆwsl.confï¼‰

`wsl.conf` æ–‡ä»¶ç”¨äºé…ç½®ç‰¹å®šå‘è¡Œç‰ˆçš„è®¾ç½®ï¼Œä½äº Linux æ–‡ä»¶ç³»ç»Ÿä¸­ã€‚

### æ–‡ä»¶ä½ç½®

```
/etc/wsl.conf
```

### é…ç½®ç¤ºä¾‹

```ini
# ç½‘ç»œé…ç½®
[network]
# ç”Ÿæˆ /etc/hosts æ–‡ä»¶
generateHosts = true
# ç”Ÿæˆ /etc/resolv.conf æ–‡ä»¶
generateResolvConf = true
# ä¸»æœºå
hostname = MyWSLHost

# ç”¨æˆ·é…ç½®
[user]
# é»˜è®¤ç”¨æˆ·ï¼ˆå¯åŠ¨ WSL æ—¶ä½¿ç”¨çš„ç”¨æˆ·ï¼‰
default = username

# å¯åŠ¨é…ç½®
[boot]
# å¯åŠ¨æ—¶æ‰§è¡Œçš„å‘½ä»¤
command = "service docker start"

# äº’æ“ä½œæ€§é…ç½®
[interop]
# å¯ç”¨ä¸ Windows çš„äº’æ“ä½œæ€§
enabled = true
# é™„åŠ  Windows è·¯å¾„åˆ° PATH
appendWindowsPath = true

# è‡ªåŠ¨æŒ‚è½½é…ç½®
[automount]
# å¯ç”¨è‡ªåŠ¨æŒ‚è½½ Windows é©±åŠ¨å™¨
enabled = true
# æŒ‚è½½ç‚¹æ ¹ç›®å½•
root = /mnt/
# æŒ‚è½½é€‰é¡¹
options = "metadata,umask=22,fmask=11"
# è·¨æ–‡ä»¶ç³»ç»Ÿæ“ä½œ
crossDistro = false
```

### é…ç½®è¯´æ˜

#### [network]
- **generateHosts**ï¼šæ˜¯å¦è‡ªåŠ¨ç”Ÿæˆ `/etc/hosts` æ–‡ä»¶
- **generateResolvConf**ï¼šæ˜¯å¦è‡ªåŠ¨ç”Ÿæˆ `/etc/resolv.conf` æ–‡ä»¶
- **hostname**ï¼šè®¾ç½®ä¸»æœºå

#### [user]
- **default**ï¼šè®¾ç½®é»˜è®¤ç”¨æˆ·ï¼ˆå¯åŠ¨ WSL æ—¶ä½¿ç”¨çš„ç”¨æˆ·ï¼‰

#### [boot]
- **command**ï¼šWSL å¯åŠ¨æ—¶æ‰§è¡Œçš„å‘½ä»¤ï¼ˆæ¯æ¬¡å¯åŠ¨éƒ½ä¼šæ‰§è¡Œï¼‰

#### [interop]
- **enabled**ï¼šæ˜¯å¦å¯ç”¨ Windows äº’æ“ä½œæ€§ï¼ˆè¿è¡Œ .exe æ–‡ä»¶ï¼‰
- **appendWindowsPath**ï¼šæ˜¯å¦å°† Windows è·¯å¾„æ·»åŠ åˆ° PATH

#### [automount]
- **enabled**ï¼šæ˜¯å¦è‡ªåŠ¨æŒ‚è½½ Windows é©±åŠ¨å™¨
- **root**ï¼šæŒ‚è½½ç‚¹æ ¹ç›®å½•ï¼ˆé»˜è®¤ `/mnt/`ï¼‰
- **options**ï¼šæŒ‚è½½é€‰é¡¹
  - `metadata`ï¼šå¯ç”¨æ–‡ä»¶å…ƒæ•°æ®
  - `umask=22`ï¼šç›®å½•æƒé™æ©ç ï¼ˆ755ï¼‰
  - `fmask=11`ï¼šæ–‡ä»¶æƒé™æ©ç ï¼ˆ644ï¼‰
- **crossDistro**ï¼šæ˜¯å¦è·¨å‘è¡Œç‰ˆå…±äº«æŒ‚è½½

### åº”ç”¨é…ç½®

```bash
# ç¼–è¾‘é…ç½®æ–‡ä»¶
sudo nano /etc/wsl.conf

# ä¿®æ”¹åéœ€è¦é‡å¯ WSL
# åœ¨ Windows PowerShell ä¸­
wsl --shutdown
wsl
```

---

## èµ„æºé™åˆ¶

### æŸ¥çœ‹å½“å‰èµ„æºä½¿ç”¨

```bash
# æŸ¥çœ‹å†…å­˜ä½¿ç”¨
free -h

# æŸ¥çœ‹ CPU ä¿¡æ¯
lscpu
nproc  # æ˜¾ç¤ºå¯ç”¨ CPU æ ¸å¿ƒæ•°

# æŸ¥çœ‹ç£ç›˜ä½¿ç”¨
df -h

# æŸ¥çœ‹è¿›ç¨‹èµ„æºä½¿ç”¨
top
htop
```

### é™åˆ¶èµ„æºä½¿ç”¨

#### é€šè¿‡ .wslconfig é™åˆ¶

```ini
[wsl2]
# é™åˆ¶å†…å­˜ä¸º 4GB
memory=4GB

# é™åˆ¶ CPU æ ¸å¿ƒæ•°ä¸º 2
processors=2

# é™åˆ¶äº¤æ¢ç©ºé—´ä¸º 2GB
swap=2GB
```

#### é€šè¿‡ cgroup é™åˆ¶ï¼ˆåœ¨ Linux ä¸­ï¼‰

```bash
# åˆ›å»º cgroup
sudo mkdir -p /sys/fs/cgroup/memory/mygroup
sudo mkdir -p /sys/fs/cgroup/cpu/mygroup

# è®¾ç½®å†…å­˜é™åˆ¶ï¼ˆ1GBï¼‰
echo 1073741824 | sudo tee /sys/fs/cgroup/memory/mygroup/memory.limit_in_bytes

# è®¾ç½® CPU é™åˆ¶ï¼ˆ50%ï¼‰
echo 50000 | sudo tee /sys/fs/cgroup/cpu/mygroup/cpu.cfs_quota_us
echo 100000 | sudo tee /sys/fs/cgroup/cpu/mygroup/cpu.cfs_period_us
```

---

## ç½‘ç»œé…ç½®

### æŸ¥çœ‹ç½‘ç»œä¿¡æ¯

```bash
# æŸ¥çœ‹ IP åœ°å€
ip addr show
hostname -I

# æŸ¥çœ‹ç½‘ç»œæ¥å£
ip link show

# æŸ¥çœ‹è·¯ç”±è¡¨
ip route show

# æŸ¥çœ‹ DNS é…ç½®
cat /etc/resolv.conf
```

### é…ç½® DNS

#### æ–¹æ³•ä¸€ï¼šä¿®æ”¹ /etc/resolv.conf

```bash
# ç¼–è¾‘ DNS é…ç½®
sudo nano /etc/resolv.conf

# æ·»åŠ  DNS æœåŠ¡å™¨
nameserver 8.8.8.8
nameserver 8.8.4.4
```

**æ³¨æ„**ï¼šå¦‚æœ `generateResolvConf = true`ï¼Œæ­¤æ–‡ä»¶ä¼šè¢«è‡ªåŠ¨è¦†ç›–ã€‚

#### æ–¹æ³•äºŒï¼šé€šè¿‡ wsl.conf é…ç½®

```ini
[network]
generateResolvConf = false
```

ç„¶åæ‰‹åŠ¨ç¼–è¾‘ `/etc/resolv.conf`ã€‚

### ç«¯å£è½¬å‘

WSL 2 ä½¿ç”¨è™šæ‹Ÿç½‘ç»œï¼Œéœ€è¦é…ç½®ç«¯å£è½¬å‘æ‰èƒ½ä» Windows è®¿é—® WSL ä¸­çš„æœåŠ¡ã€‚

#### è‡ªåŠ¨ç«¯å£è½¬å‘ï¼ˆæ¨èï¼‰

åœ¨ `.wslconfig` ä¸­å¯ç”¨ï¼š
```ini
[wsl2]
localhostForwarding=true
```

#### æ‰‹åŠ¨ç«¯å£è½¬å‘

```powershell
# åœ¨ PowerShellï¼ˆç®¡ç†å‘˜æƒé™ï¼‰ä¸­
# è½¬å‘ç«¯å£ 3000
netsh interface portproxy add v4tov4 listenport=3000 listenaddress=0.0.0.0 connectport=3000 connectaddress=$(wsl hostname -I)

# æŸ¥çœ‹ç«¯å£è½¬å‘è§„åˆ™
netsh interface portproxy show all

# åˆ é™¤ç«¯å£è½¬å‘
netsh interface portproxy delete v4tov4 listenport=3000 listenaddress=0.0.0.0
```

#### ä½¿ç”¨è„šæœ¬è‡ªåŠ¨é…ç½®

åˆ›å»º `portproxy.ps1`ï¼š
```powershell
$wslIp = (wsl hostname -I).Trim()
$ports = @(3000, 8080, 5000)

foreach ($port in $ports) {
    netsh interface portproxy add v4tov4 `
        listenport=$port `
        listenaddress=0.0.0.0 `
        connectport=$port `
        connectaddress=$wslIp
    Write-Host "Forwarded port $port to $wslIp"
}
```

---

## å¯åŠ¨é…ç½®

### è®¾ç½®é»˜è®¤å‘è¡Œç‰ˆ

```powershell
# æŸ¥çœ‹æ‰€æœ‰å‘è¡Œç‰ˆ
wsl --list

# è®¾ç½®é»˜è®¤å‘è¡Œç‰ˆ
wsl --set-default Ubuntu-22.04
```

### è®¾ç½®é»˜è®¤ç”¨æˆ·

```powershell
# æ–¹æ³•ä¸€ï¼šä½¿ç”¨å‘è¡Œç‰ˆé…ç½®å·¥å…·
ubuntu config --default-user username

# æ–¹æ³•äºŒï¼šä¿®æ”¹ wsl.conf
# åœ¨ /etc/wsl.conf ä¸­è®¾ç½®
[user]
default = username
```

### å¯åŠ¨æ—¶è‡ªåŠ¨æ‰§è¡Œå‘½ä»¤

åœ¨ `/etc/wsl.conf` ä¸­é…ç½®ï¼š
```ini
[boot]
command = "service docker start && service nginx start"
```

### å»¶è¿Ÿå¯åŠ¨

```powershell
# è®¾ç½® WSL åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶ä¸è‡ªåŠ¨å¯åŠ¨
# éœ€è¦ä¿®æ”¹ Windows æ³¨å†Œè¡¨æˆ–ä½¿ç”¨ä»»åŠ¡è®¡åˆ’ç¨‹åº
```

---

## é…ç½®æ–‡ä»¶ä¼˜å…ˆçº§

1. **å…¨å±€é…ç½®**ï¼š`.wslconfig`ï¼ˆWindows ç”¨æˆ·ç›®å½•ï¼‰
2. **å‘è¡Œç‰ˆé…ç½®**ï¼š`/etc/wsl.conf`ï¼ˆLinux æ–‡ä»¶ç³»ç»Ÿï¼‰
3. **ç”¨æˆ·é…ç½®**ï¼š`~/.bashrc`ã€`~/.profile` ç­‰

---

## ğŸ“š å‚è€ƒèµ„æº

- [WSL é…ç½®æ–‡ä»¶æ–‡æ¡£](https://learn.microsoft.com/zh-cn/windows/wsl/wsl-config)
- [WSL ç½‘ç»œé…ç½®](https://learn.microsoft.com/zh-cn/windows/wsl/networking)

---

[[!MOC-WSL|è¿”å› WSL çŸ¥è¯†ä½“ç³»]]

#WSL #ç³»ç»Ÿé…ç½® #èµ„æºé™åˆ¶ #ç½‘ç»œé…ç½®
